<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VibeBeans - Upgraded</title>
  <style>
    :root {
      --bg: #0b1020;
      --surface: #111827;
      --card: rgba(255,255,255,0.08);
      --text: #e8f0ff;
      --muted: #a5b4fc;
      --accent: #7dd3fc;
      --green: #10b981;
      --red: #ef4444;
      --shadow: 0 6px 20px rgba(0,0,0,.25);
      --bean: #ffd166;
      --ring: rgba(125,211,252,.6);
    }
    html[data-theme="chill"] { /* mood tweaks for accessibility */ }
    html[data-theme="energetic"] { }
    html[data-theme="serene"] { }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto;
      background: radial-gradient(circle at 20% -10%, rgba(255,255,255,.05), rgba(0,0,0,0) 40%), radial-gradient(circle at 100% 0%, rgba(255,255,255,.04), rgba(0,0,0,0) 40%), var(--bg);
      color: var(--text);
      line-height: 1.4;
      overflow-x: hidden;
    }
    .app { max-width: 1100px; margin: 22px auto; padding: 0 16px 60px; position: relative; }
    header { display:flex; align-items:center; justify-content: space-between; padding:12px 14px; border-radius:12px; background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15); box-shadow: var(--shadow); }
    .brand { display:flex; align-items:center; gap:12px; }
    .brand .logo { width:40px; height:40px; border-radius:9px; background: conic-gradient(from 180deg at 50% 50%, #60a5fa, #34d399, #f472b6, #60a5fa); display:inline-block; }
    h1 { font-size:1.4rem; margin:0; letter-spacing:.5px; }
    .subtitle { font-size:.82rem; color: var(--muted); }
    .theme-switcher { display:flex; gap:8px; align-items:center; }
    .theme-switcher button { padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.25); background: rgba(255,255,255,.08); color: var(--text); cursor:pointer; }
    .theme-switcher button.active { background: var(--accent); color:#041018; font-weight:600; border:1px solid rgba(0,0,0,.2); }
    .grid { display:grid; gap:16px; grid-template-columns: 1.1fr 0.9fr; margin-top:16px; }
    .card { background: var(--card); border:1px solid rgba(255,255,255,.15); border-radius:12px; padding:16px; box-shadow: var(--shadow); }
    .card h3 { margin:0 0 8px 0; font-size:1.05rem; }
    .row { display:flex; align-items:center; justify-content: space-between; gap:12px; }
    .balance { font-size:1.2rem; font-weight:600; }
    #jobTitle { font-weight:700; font-size:1.05rem; margin:6px 0; }
    #jobDesc { color: var(--muted); margin:2px 0 6px; }
    .progress { height:12px; width:100%; background: rgba(255,255,255,.15); border-radius:999px; overflow:hidden; margin:8px 0 6px; border:1px solid rgba(255,255,255,.25); }
    .progress-fill { height:100%; width:0%; background: linear-gradient(90deg, #22c55e, #2dd4bf); transition: width .1s linear; }
    button { padding:10px 14px; border-radius:8px; border:none; cursor:pointer; background: rgba(255,255,255,.10); color: var(--text); border:1px solid rgba(255,255,255,.25); }
    button.primary { background: var(--accent); color:#041018; font-weight:700; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .muted { color: var(--muted); font-size:.92rem; }
    .log { list-style:none; padding:0; margin:0; max-height:210px; overflow:auto; }
    .log li { padding:6px 0; border-bottom:1px dashed rgba(255,255,255,.15); font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.9rem; }
    .log .credit { color:#a7f3d0; }
    .log .note { font-style: italic; color: var(--muted); }
    .next-job { margin-top:6px; padding:8px; border-radius:6px; background: rgba(255,255,255,.05); color: var(--muted); font-size:.92rem; }
    .notice { margin-top:8px; padding:8px; border-radius:6px; background: rgba(125,211,252,.15); color:#eaffff; font-size:.92rem; }
    .ambient { display:flex; flex-direction:column; gap:8px; }

    /* Upgrades & Shop section inside right card */
    .upgrade-section { display:flex; flex-direction:column; gap:10px; padding-top:4px; border-top:1px solid rgba(255,255,255,.15); margin-top:8px; }
    .upgrade-item { display:flex; justify-content:space-between; align-items:center; padding:8px 6px; border-bottom:1px dashed rgba(255,255,255,.15); }
    .upgrade-item:last-child { border-bottom: none; }
    .upgrade-info { display:flex; flex-direction:column; gap:2px; }
    .upgrade-name { font-weight:650; }
    .upgrade-desc { font-size:.92rem; color:var(--muted); }
    .upgrade-cost { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.92rem; padding:4px 8px; border-radius:6px; background: rgba(255,255,255,.15); }
    .shop-totals { font-size:.92rem; color:var(--muted); }

    /* Confetti / particles layer for celebrations */
    #confettiLayer { position: fixed; pointer-events: none; left:0; top:0; width:100%; height:100%; overflow: hidden; z-index: 9999; }
    .confettiPiece { position: absolute; width: 10px; height: 14px; border-radius: 2px; opacity: 0; transform: translateY(-20px) rotate(0deg); animation: confettiFall 2s ease-out forwards; }
    @keyframes confettiFall {
      0% { opacity: 1; transform: translateY(-20px) rotate(0deg); }
      100% { opacity: 0; transform: translateY(700px) rotate(720deg); }
    }

    /* Ambient visual hint (soft glow) */
    .ambientGlow {
      position: absolute; right: -40px; top: -40px; width: 140px; height: 140px; border-radius: 50%; filter: blur(40px);
      background: radial-gradient(circle at 30% 30%, rgba(125,211,252,.8), rgba(125,211,252,0) 60%);
      animation: floatGlow 6s ease-in-out infinite;
    }
    @keyframes floatGlow {
      0% { transform: translate(0,0) scale(1); opacity:.6; }
      50% { transform: translate(15px,-10px) scale(1.05); opacity:.9; }
      100% { transform: translate(0,0) scale(1); opacity:.6; }
    }

    /* responsive */
    @media (max-width: 860px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="app" role="main">
    <header aria-label="VibeBeans header">
      <div class="brand" aria-label="Brand">
        <span class="logo" aria-label="VibeBeans logo"></span>
        <div>
          <h1>VibeBeans</h1>
          <div class="subtitle">A vibe-coded reward loop: Accept job, work, complete, earn 1,000 beans</div>
        </div>
      </div>

      <div class="theme-switcher" aria-label="Mood themes">
        <button data-theme="chill" class="active" aria-pressed="true">Chill</button>
        <button data-theme="energetic" aria-pressed="false">Energetic</button>
        <button data-theme="serene" aria-pressed="false">Serene</button>
      </div>
    </header>

    <section class="grid" aria-label="Game panels">
      <section class="card" aria-label="Wallet and current job">
        <div class="row" style="align-items:baseline;">
          <div class="balance" id="balanceLabel">Balance: <span id="balanceValue">0</span> Beans</div>
          <div class="muted" style="font-size: .85rem;">Mood: <span id="moodLabel">Chill</span></div>
        </div>

        <div style="margin-top:8px;">
          <div class="muted" style="font-size:.92rem;">Current Job</div>
          <div id="jobTitle" aria-live="polite">None</div>
          <div id="jobDesc"></div>

          <div class="progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-fill" id="progressFill" style="width:0%;"></div>
          </div>

          <div class="row" style="gap:8px; margin-top:6px;">
            <button id="acceptBtn" aria-label="Accept Job">Accept Job</button>
            <button id="workBtn" disabled aria-label="Start Working">Start Working</button>
            <button id="completeBtn" disabled aria-label="Complete Job">Complete Job</button>
          </div>

          <div id="pendingNotice" class="notice" style="display:none;" aria-live="polite"></div>
        </div>
      </section>

      <section class="card ambient" aria-label="Next job and details">
        <h3 style="margin:0 0 8px 0;">Next Job & Upgrades</h3>

        <div id="nextJobTitle" class="muted" style="font-size:.95rem; margin-bottom:6px;">Pending: None</div>
        <div id="nextJobPreview" class="next-job" style="display:none;"></div>

        <hr style="border:none; height:1px; background: rgba(255,255,255,.15); margin:10px 0;">

        <div class="ambientGlow" aria-hidden="true"></div>

        <div class="ambient" style="gap:8px;">
          <div class="muted" style="font-size:.92rem;">Ambient sound</div>
          <button id="soundBtn" aria-pressed="false" style="width: auto; align-self:flex-start;">Ambient: Off</button>
        </div>

        <div class="upgrade-section" aria-label="Upgrades shop">
          <h3 style="margin:6px 0 6px 0;">Upgrades & Shop</h3>
          <div id="upgradeList" class="log" style="max-height: 180px; overflow:auto; padding:4px 6px; border-radius:8px; border:1px solid rgba(255,255,255,.15);"></div>

          <div class="row shop-totals" style="margin-top:6px;">
            <span>Speed: <strong id="spdMulLabel">1.00x</strong></span>
            <span>Earnings: <strong id="earnMulLabel">1.00x</strong></span>
          </div>
        </div>
      </section>
    </section>

    <section class="grid" style="grid-template-columns:1fr;" aria-label="Transaction log">
      <section class="card" aria-label="Transaction log">
        <h3 style="margin:0 0 8px 0;">Transaction Log</h3>
        <ul id="logList" class="log" aria-label="Transaction list"></ul>
      </section>
    </section>
  </div>

  <!-- Visual confetti layer -->
  <div id="confettiLayer" aria-hidden="true"></div>

  <script>
    // VibeBeans enhanced logic (vanilla JS)

    // State
    let balance = 0;
    let currentJob = null;
    let pendingJob = null;
    let isWorking = false;
    let progress = 0; // 0 - 100
    let loopReq = null;

    // Ambients
    let ambient = { ctx: null, master: null, osc1: null, osc2: null, lfo: null, lfoGain: null, started: false, muted: true };

    // Upgrades
    const upgrades = [
      { id:'effEng', name:'Efficiency Engine', type:'speed', value:0.20, cost:5000, purchased:0, desc:'Boost speed by 20% per upgrade' },
      { id:'earnBee', name:'Beans Booster', type:'earnings', value:0.30, cost:8000, purchased:0, desc:'Earn 30% more beans per completed job' },
      { id:'tempo', name:'Tempo Tuner', type:'speed', value:0.15, cost:6000, purchased:0, desc:'Additional 15% speed boost' },
      { id:'pulse', name:'Pulse Mod', type:'earnings', value:0.10, cost:5000, purchased:0, desc:'Small earnings uplift' }
    ];

    // DOM refs
    const balanceValueEl = document.getElementById('balanceValue');
    const moodLabelEl = document.getElementById('moodLabel');
    const balanceLabelEl = document.getElementById('balanceLabel');
    const acceptBtn = document.getElementById('acceptBtn');
    const workBtn = document.getElementById('workBtn');
    const completeBtn = document.getElementById('completeBtn');
    const progressFill = document.getElementById('progressFill');
    const jobTitleEl = document.getElementById('jobTitle');
    const jobDescEl = document.getElementById('jobDesc');
    const nextJobTitleEl = document.getElementById('nextJobTitle');
    const nextJobPreviewEl = document.getElementById('nextJobPreview');
    const pendingNoticeEl = document.getElementById('pendingNotice');
    const logListEl = document.getElementById('logList');
    const soundBtn = document.getElementById('soundBtn');
    const upgradeListEl = document.getElementById('upgradeList');
    const spdMulLabel = document.getElementById('spdMulLabel');
    const earnMulLabel = document.getElementById('earnMulLabel');
    const logEventsTarget = logListEl; // reuse
    const confettiLayer = document.getElementById('confettiLayer');

    // Theme handling
    const themeButtons = Array.from(document.querySelectorAll('.theme-switcher button'));
    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      moodLabelEl.textContent = theme.charAt(0).toUpperCase() + theme.slice(1);
      themeButtons.forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-theme') === theme);
        btn.setAttribute('aria-pressed', btn.getAttribute('data-theme') === theme ? 'true' : 'false');
      });
    }
    (function initTheme(){
      const preferred = 'chill';
      applyTheme(preferred);
      themeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const t = btn.getAttribute('data-theme');
          applyTheme(t);
        });
      });
    })();

    // Helpers
    function saveState() {
      const state = {
        balance,
        upgrades: upgrades.map(u => ({ id: u.id, purchased: u.purchased, cost: u.cost })),
        currentJob,
        pendingJob,
        progress
      };
      localStorage.setItem('vibeBeans_state', JSON.stringify(state));
    }
    function loadState() {
      try {
        const raw = localStorage.getItem('vibeBeans_state');
        if (!raw) return;
        const s = JSON.parse(raw);
        balance = s.balance ?? 0;
        balanceValueEl.textContent = balance.toString();
        // restore upgrades
        s.upgrades?.forEach(saved => {
          const u = upgrades.find(x => x.id === saved.id);
          if (u) {
            u.purchased = saved.purchased ?? 0;
            u.cost = saved.cost ?? u.cost;
          }
        });
        currentJob = s.currentJob ?? null;
        pendingJob = s.pendingJob ?? null;
        progress = s.progress ?? 0;
      } catch(e){
        console.error('Load state failed', e);
      }
    }

    // Logging
    function addLogEntry(type, amount, note) {
      const ts = new Date().toLocaleTimeString();
      const text = `${ts} - ${type.toUpperCase()} ${amount.toLocaleString()} Beans${note ? ` • ${note}` : ''}`;
      const li = document.createElement('li');
      li.textContent = text;
      if (type === 'credit') li.classList.add('credit');
      li.setAttribute('data-entry', text);
      logListEl.prepend(li);
    }

    // Upgrades helpers
    function getTotalSpeedMul() {
      let m = 1;
      upgrades.forEach(u => {
        if (u.type === 'speed') m *= (1 + u.value * u.purchased);
      });
      return m;
    }
    function getTotalEarningsMul() {
      let m = 1;
      upgrades.forEach(u => {
        if (u.type === 'earnings') m *= (1 + u.value * u.purchased);
      });
      return m;
    }
    function renderUpgrades() {
      upgradeListEl.innerHTML = '';
      upgrades.forEach((u, idx) => {
        const item = document.createElement('div');
        item.className = 'upgrade-item';
        const left = document.createElement('div');
        left.className = 'upgrade-info';
        const name = document.createElement('div');
        name.className = 'upgrade-name';
        name.textContent = u.name;
        const desc = document.createElement('div');
        desc.className = 'upgrade-desc';
        desc.textContent = u.desc;
        const right = document.createElement('div');
        right.style.display = 'flex'; right.style.alignItems = 'center'; right.style.gap = '8px';
        const costLabel = document.createElement('span');
        costLabel.className = 'upgrade-cost';
        costLabel.textContent = `Cost: ${u.cost.toLocaleString()}`;
        const buyBtn = document.createElement('button');
        buyBtn.textContent = 'Buy';
        buyBtn.style.padding = '6px 10px';
        buyBtn.disabled = balance < u.cost;
        buyBtn.addEventListener('click', () => {
          if (balance < u.cost) return;
          balance -= u.cost;
          balanceValueEl.textContent = balance.toString();
          u.purchased += 1;
          // price curve
          u.cost = Math.floor(u.cost * 1.25);
          renderUpgrades();
          renderShopTotals();
          addLogEntry('credit', -0, `Purchased ${u.name}`); // keep log parity; real balance adjust above
          // Recalculate effects visually
          // Update confetti to celebrate purchase
          spawnConfettiAtRandom();
          saveState();
        });
        left.appendChild(name);
        left.appendChild(desc);
        right.appendChild(costLabel);
        right.appendChild(buyBtn);
        item.appendChild(left);
        item.appendChild(right);
        upgradeListEl.appendChild(item);
      });
      // After rendering, update balance to reflect possible purchase
      // ensure any disabled states reflect current balance
      renderShopTotals();
    }

    function renderShopTotals() {
      spdMulLabel.textContent = getTotalSpeedMul().toFixed(2) + 'x';
      earnMulLabel.textContent = getTotalEarningsMul().toFixed(2) + 'x';
      // disable/enable all buy buttons based on balance
      const btns = upgradeListEl.querySelectorAll('button');
      upgrades.forEach((u, idx) => {
        const b = btns[idx];
        if (b) b.disabled = balance < u.cost;
      });
    }

    // Work loop
    let lastTime = null;
    function loop(ts) {
      if (!isWorking) {
        lastTime = null;
        return;
      }
      if (lastTime == null) lastTime = ts;
      const delta = (ts - lastTime) / 1000;
      lastTime = ts;

      const speedMul = getTotalSpeedMul();
      const durationBase = currentJob.durationSec;
      const durationEffective = durationBase / speedMul;
      const speed = (100 / durationEffective) * 1;
      progress += delta * speed;
      if (progress >= 100) {
        progress = 100;
        isWorking = false;
      }

      updateUI();
      if (isWorking) {
        loopReq = requestAnimationFrame(loop);
      } else {
        loopReq = null;
      }
    }

    // Update UI helper
    function updateUI() {
      if (currentJob) {
        jobTitleEl.textContent = currentJob.title;
        jobDescEl.textContent = currentJob.description;
      } else {
        jobTitleEl.textContent = 'None';
        jobDescEl.textContent = '';
      }

      progressFill.style.width = progress + '%';
      progressFill.setAttribute('aria-valuenow', progress.toFixed(0));

      // States
      acceptBtn.disabled = !!currentJob || !pendingJob;
      workBtn.disabled = !currentJob || isWorking;
      completeBtn.disabled = !currentJob || progress < 100;

      // Pending notice
      if (!currentJob && pendingJob) {
        pendingNoticeEl.style.display = 'block';
        pendingNoticeEl.textContent = `New job ready: ${pendingJob.title}. Click "Accept Job" to start.`;
        nextJobTitleEl.textContent = pendingJob.title;
        nextJobPreviewEl.style.display = 'block';
        nextJobPreviewEl.textContent = pendingJob.description;
      } else {
        pendingNoticeEl.style.display = 'none';
        nextJobTitleEl.textContent = currentJob ? currentJob.title : 'None';
        nextJobPreviewEl.style.display = 'none';
      }
    }

    // Accept Job
    acceptBtn.addEventListener('click', () => {
      if (currentJob) return;
      if (pendingJob) {
        currentJob = pendingJob;
        pendingJob = generateJob();
        progress = 0;
        isWorking = false;
        loopReq = null;
        updateUI();
      } else {
        currentJob = generateJob();
        progress = 0;
        isWorking = false;
        loopReq = null;
        updateUI();
      }
    });

    // Start / Pause Work
    workBtn.addEventListener('click', () => {
      if (!currentJob) return;
      if (!isWorking) {
        isWorking = true;
        lastTime = null;
        updateUI();
        loopReq = requestAnimationFrame(loop);
        workBtn.textContent = 'Pause Work';
      } else {
        isWorking = false;
        updateUI();
        if (loopReq) {
          cancelAnimationFrame(loopReq);
          loopReq = null;
        }
        workBtn.textContent = 'Start Working';
      }
    });

    // Complete Job
    completeBtn.addEventListener('click', () => {
      if (!currentJob || progress < 100) return;
      const earningsMul = getTotalEarningsMul();
      const beansEarned = Math.floor(currentJob.baseBeans * earningsMul);
      // baseBeans can scale with job; ensure default base
      const baseBeans = 1000;
      const totalEarn = Math.floor(baseBeans * earningsMul);
      balance += totalEarn;
      balanceValueEl.textContent = balance.toString();

      // Log and celebrate
      addLogEntry('credit', totalEarn, `for completing "${currentJob.title}"`);
      renderShopTotals();
      saveState();

      // Reset
      currentJob = null;
      progress = 0;
      isWorking = false;
      if (loopReq) {
        cancelAnimationFrame(loopReq);
        loopReq = null;
      }

      // Seed next
      pendingJob = generateJob();

      updateUI();
      pendingNoticeEl.textContent = `Job complete. New job queued: ${pendingJob.title}. Accept to begin.`;
      pendingNoticeEl.style.display = 'block';

      // Confetti celebration
      spawnConfettiAtPoint( (window.innerWidth / 2), 80 );
    });

    // Ambient sound
    function initAmbient() {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if (!AudioCtx) return;
      if (ambient.ctx) return;
      ambient.ctx = new AudioCtx();
      ambient.master = ambient.ctx.createGain();
      ambient.master.gain.value = 0;
      ambient.master.connect(ambient.ctx.destination);

      ambient.osc1 = ambient.ctx.createOscillator();
      ambient.osc1.type = 'sine';
      ambient.osc1.frequency.value = 140;

      ambient.osc2 = ambient.ctx.createOscillator();
      ambient.osc2.type = 'triangle';
      ambient.osc2.frequency.value = 220;

      const g1 = ambient.ctx.createGain(); g1.gain.value = 0.25;
      const g2 = ambient.ctx.createGain(); g2.gain.value = 0.15;

      ambient.osc1.connect(g1);
      ambient.osc2.connect(g2);
      g1.connect(ambient.master);
      g2.connect(ambient.master);

      ambient.osc1.start();
      ambient.osc2.start();

      ambient.lfo = ambient.ctx.createOscillator();
      ambient.lfo.frequency.value = 0.04;
      ambient.lfoGain = ambient.ctx.createGain();
      ambient.lfoGain.gain.value = 60;
      ambient.lfo.connect(ambient.lfoGain);
      ambient.lfoGain.connect(ambient.osc1.frequency);
      ambient.lfoGain.connect(ambient.osc2.frequency);
      ambient.lfo.start();

      ambient.master.connect(ambient.ctx.destination);
      ambient.muted = true;
    }

    function startAmbient() {
      if (!ambient.ctx) initAmbient();
      if (!ambient.ctx) return;
      ambient.master.gain.value = 0.08;
      ambient.muted = false;
      if (ambient.ctx.state === 'suspended') ambient.ctx.resume();
      soundBtn.textContent = 'Ambient: On';
      soundBtn.setAttribute('aria-pressed','true');
    }

    function stopAmbient() {
      if (!ambient.ctx) return;
      ambient.master.gain.value = 0;
      ambient.muted = true;
      soundBtn.textContent = 'Ambient: Off';
      soundBtn.setAttribute('aria-pressed','false');
    }

    soundBtn.addEventListener('click', () => {
      if (!ambient.ctx) initAmbient();
      if (ambient.muted || ambient.master.gain.value === 0) {
        startAmbient();
      } else {
        stopAmbient();
      }
    });

    // Keyboard shortcuts
    window.addEventListener('keydown', (e) => {
      if (e.key.toLowerCase() === 'a') { acceptBtn.click(); }
      if (e.key.toLowerCase() === 'w') { workBtn.click(); }
      if (e.key.toLowerCase() === 'c') { completeBtn.click(); }
    });

    // Random-friendly job generator
    function generateJob() {
      const titles = [
        'Deliver the package', 'Repair the drone', 'Calibrate the sensors',
        'Tune the console', 'Polish the interface', 'Assemble mood-module',
        'Run the wellness check'
      ];
      const descriptions = [
        'A quick tidy-up task for Valware; ensure on-time delivery.',
        'Perform precise calibration to ensure stable readings.',
        'Patch a UI glitch and restore smooth flow.',
        'Tighten loose ends and polish transitions for vibe.',
        'Run diagnostics and log results for records.',
        'Assemble a lightweight mood module for vibe beans.',
        'Verify system health and log results for records.'
      ];
      const i = Math.floor(Math.random() * titles.length);
      const durationSec = 20 + Math.floor(Math.random() * 60);
      const difficulty = 0.8 + Math.random() * 0.6;
      return {
        title: titles[i],
        description: descriptions[i % descriptions.length],
        durationSec,
        difficulty,
        baseBeans: 1000
      };
    }

    // Logging init: seed first pending job
    function initSeed() {
      pendingJob = generateJob();
    }

    // Confetti
    function spawnConfettiAtPoint(x, y) {
      const colors = ['#f472b6','#93c5fd','#34d399','#f59e0b','#a78bfa','#22c55e'];
      const pieces = 40;
      for (let i = 0; i < pieces; i++) {
        const p = document.createElement('div');
        p.className = 'confettiPiece';
        p.style.left = (x + (Math.random()*200 - 100)) + 'px';
        p.style.top = (y + (Math.random()*40 - 20)) + 'px';
        p.style.width = (Math.random()*8 + 6) + 'px';
        p.style.height = (Math.random()*10 + 8) + 'px';
        p.style.background = colors[Math.floor(Math.random()*colors.length)];
        p.style.transform = 'rotate(' + (Math.random()*360) + 'deg)';
        p.style.animationDelay = (Math.random()*0.5) + 's';
        confettiLayer.appendChild(p);
        // remove after animation
        p.addEventListener('animationend', () => { p.remove(); });
      }
    }

    function spawnConfettiAtRandom() {
      spawnConfettiAtPoint(window.innerWidth/2, 100);
    }

    // Initialize
    function init() {
      loadState();
      // seed first pending job if none
      if (!pendingJob && !currentJob) pendingJob = generateJob();
      balanceValueEl.textContent = balance.toString();
      renderUpgrades();
      renderShopTotals();
      // seed UI
      updateUI();
      // save on unload
      window.addEventListener('beforeunload', saveState);
      // show initial pending
      if (pendingJob) {
        nextJobTitleEl.textContent = pendingJob.title;
        nextJobPreviewEl.textContent = pendingJob.description;
        nextJobPreviewEl.style.display = 'block';
      }
    }

    // Kickoff
    init();
  </script>
</body>
</html>