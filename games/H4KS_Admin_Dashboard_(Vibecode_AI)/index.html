<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>H4KS Admin Dashboard (Vibecode AI) - Enhanced</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0e1116;
      --panel: rgba(20,25,43,.95);
      --card: rgba(28,32,60,.95);
      --text: #e8eaf6;
      --muted: #a5b0d6;
      --accent: #4e8cff;
      --green: #32d296;
      --red: #ff5c7a;
      --amber: #ffd166;
      --chip: rgba(43,50,70,.9);
      --shadow: 0 12px 28px rgba(0,0,0,.25);
      --glass: rgba(255,255,255,.05);
    }
    .light {
      --bg: #f7f7fb;
      --panel: rgba(255,255,255,.95);
      --card: #ffffff;
      --text: #1a1d2b;
      --muted: #5a647a;
      --accent: #4e8cff;
      --chip: #eef0f7;
      --shadow: 0 8px 20px rgba(0,0,0,.08);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: Inter, system-ui, -apple-system, Arial; background: var(--bg); color: var(--text); overflow: hidden; }
    /* Background particles layer */
    #bg { position: fixed; top:0; left:0; width:100%; height:100%; z-index:0; display:block; }
    /* Layout */
    .container { display: grid; grid-template-columns: 260px 1fr; gap: 16px; padding: 16px; height: 100%; position: relative; z-index: 1; overflow: hidden; }
    .sidebar {
      background: linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.0));
      border-radius: 14px;
      padding: 14px;
      box-shadow: var(--shadow);
      position: sticky; top: 12px; height: calc(100vh - 24px);
      display: flex; flex-direction: column;
      backdrop-filter: blur(4px);
    }
    .brand { display:flex; align-items:center; justify-content:space-between; padding:6px 4px; }
    .brand h1 { font-size: 14px; margin: 0; color: var(--muted); }
    .brand .dot { width: 10px; height: 10px; border-radius: 50%; background: #4e8cff; display:inline-block; margin-right:6px; }
    .nav { margin-top: 6px; display: grid; gap: 6px; }
    .nav button {
      text-align:left; padding: 10px 12px; border: 0; border-radius: 8px;
      background: #1e2330; color: #e8eaf6; cursor: pointer; transition: transform .2s ease;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }
    .nav button.active { background: var(--accent); color: white; transform: translateX(2px); }
    .nav button:hover { filter: brightness(1.05); transform: scale(1.01); }
    .content { display: flex; flex-direction: column; gap: 12px; height: calc(100% - 0px); overflow: auto; padding-bottom: 40px; }
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 14px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.05);
      position: relative;
      overflow: hidden;
    }
    .row { display: flex; gap: 12px; align-items: center; }
    .row.wrap { flex-wrap: wrap; }
    h2 { margin: 0 0 8px 0; font-size: 16px; }
    h3 { margin: 0 0 6px 0; font-size: 14px; color: var(--muted); }
    .section { display: none; min-height: 60vh; padding-bottom: 20px; }
    .section.active { display: block; animation: fadeIn .25s ease both; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px);} to { opacity:1; transform:none; } }
    input, select, button, textarea {
      font-family: inherit; font-size: 14px;
    }
    input, select {
      background: #0f1321; color: #eaf0ff;
      border: 1px solid #2a2f4a; border-radius: 6px; padding: 8px 10px;
    }
    .btn { background: var(--accent); color: white; border:0; padding: 9px 12px; border-radius: 6px; cursor: pointer; transition: transform .15s ease; }
    .btn:hover { transform: translateY(-1px); }
    .btn.secondary { background: #2a324a; color: white; }
    .btn.danger { background: #d9534f; }
    .btn.ghost { background: transparent; border: 1px solid #2a324a; color: var(--text); }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { border-bottom: 1px solid #2a2f4a; padding: 8px; text-align: left; }
    .tag { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background: var(--chip); color:#dbe3ff; font-size:12px; }
    .badge { padding:2px 6px; border-radius:6px; font-size:11px; }
    .badge.green { background: rgba(50,210,150,.2); color: #a7f3d0; }
    .badge.red { background: rgba(255,92,122,.2); color: #fec6d2; }
    .badge.amber { background: rgba(255,209,102,.2); color: #ffe6a0; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    canvas { width: 100%; height: 180px; background: #0b1020; border-radius: 8px; display:block; }
    .section-title { display:flex; align-items:center; justify-content: space-between; margin-bottom: 6px; padding-bottom:6px; border-bottom: 1px solid rgba(255,255,255,.07); }
    .log-table { max-height: 260px; overflow-y: auto; display: block; }
    .login-alert { background: #f9d6d6; color: #7a1f1f; padding: 8px; border-radius: 6px; margin-bottom: 8px; }
    .hint { color: var(--muted); font-size: 12px; }
    #app { display: none; height: 100%; width: 100%; position: relative; z-index: 1; }
    /* Login screen style */
    #loginScreen { display: grid; height: 100vh; place-items: center; background: radial-gradient(circle at 30% -10%, rgba(78,140,255,.15), transparent 40%), radial-gradient(circle at 100% 0%, rgba(255,255,255,.04), transparent 40%), var(--bg); position: relative; z-index: 2; }
    .login-panel { padding: 20px; border-radius: 12px; background: rgba(20,23,40,.82); border: 1px solid #2a324a; width: 520px; max-width: 92%; box-shadow: 0 20px 40px rgba(0,0,0,.3); }
    .login-panel h2 { margin:0 0 12px 0; font-size: 18px; letter-spacing: .4px; }
    .login-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .login-grid label { font-size: 12px; color: var(--muted); display:block; margin-bottom:4px; }
    .login-panel input { width: 100%; padding: 9px 10px; border-radius: 6px; border:1px solid #2a324a; background:#0f1321; color:#eaf0ff; }
    .login-panel .row { display:flex; justify-content: space-between; align-items:center; gap: 8px; margin-top: 8px; }
    .small { font-size: 12px; color: var(--muted); }
    .login-panel .tip { font-size: 12px; color: #9fb0ff; margin-left: auto; }
    /* Settings modal */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.6); z-index: 999; padding: 20px; }
    .modal.active { display: flex; animation: fadeIn .2s ease both; }
    .modal-card { width: 640px; max-width: 100%; background: var(--panel); border-radius: 12px; padding: 14px; border:1px solid rgba(255,255,255,.08); }
    .modal-header { display:flex; justify-content: space-between; align-items: center; padding-bottom:8px; border-bottom: 1px solid rgba(255,255,255,.08); }
    .modal-body { padding-top:8px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .modal-actions { display:flex; justify-content:flex-end; padding-top:8px; border-top:1px solid rgba(255,255,255,.08); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px);} to { opacity:1; transform:none; } }
    /* Tiny charts styling in header */
    .mini { width: 120px; height: 40px; display:block; }
    .toasts { position: fixed; right: 12px; bottom: 12px; z-index: 1000; display: grid; gap: 8px; max-width: 320px; }
    .toast { background: #11161f; color: white; padding: 10px 12px; border-radius: 6px; box-shadow: 0 6px 14px rgba(0,0,0,.25); border-left: 4px solid var(--accent); animation: slideIn .25s ease both; }
    @keyframes slideIn { from { transform: translateY(6px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .ghost { opacity:.8; }
  </style>
</head>
<body>
  <!-- Background particles canvas -->
  <canvas id="bg"></canvas>

  <!-- Login Screen -->
  <div id="loginScreen">
    <div class="login-panel card" style="width: 520px;">
      <h2>H4KS Admin Login</h2>
      <div class="login-grid" style="grid-template-columns: 1fr 1fr;">
        <div>
          <label>Username</label>
          <input id="u" type="text" placeholder="admin" value="admin" />
        </div>
        <div>
          <label>Password</label>
          <input id="p" type="password" placeholder="password" value="password" />
        </div>
      </div>
      <div style="margin-top:8px;">
        <label>Login IP (simulated)</label>
        <input id="loginIP" type="text" placeholder="Enter IP e.g. 203.0.113.2" value="203.0.113.5" />
      </div>
      <div class="row" style="margin-top:12px;">
        <span class="small">Tip: Admin password is 'password'. This is a test env.</span>
        <button class="btn" id="btnLogin">Login</button>
      </div>
      <div id="loginError" class="small" style="color:#ffb4b4; margin-top:6px;"></div>
      <div id="loginAlerts" class="row" style="margin-top:8px;">
        <span class="tag" id="loginAlertsCount" title="Unlisted IP login attempts">Alerts: 0</span>
      </div>
    </div>
  </div>

  <!-- App -->
  <div id="app" class="container">
    <aside class="sidebar">
      <div class="brand">
        <div><span class="dot"></span><strong>H4KS Vibecode AI</strong></div>
        <span class="tag" title="Theme" id="themeBadge">Dark</span>
      </div>
      <div class="nav" id="nav">
        <button class="active" data-section="section-analytics">Analytics Dashboard</button>
        <button data-section="section-users">User Management</button>
        <button data-section="section-controls">Game Controls</button>
        <button data-section="section-logs">Logs</button>
        <button data-section="section-config">Configuration</button>
        <button data-section="section-security">Security & Compliance</button>
      </div>
      <div class="row" style="margin-top: 8px; padding-top:8px; border-top:1px solid rgba(255,255,255,.08);">
        <button id="exportAll" class="btn ghost" title="Export current data">Export All</button>
        <button id="backupNow" class="btn secondary" style="margin-left:auto;">Backup</button>
      </div>
      <div class="row" style="margin-top:6px;">
        <span class="hint">Audits & Logs are stored locally.</span>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="openSettings" class="btn" style="width:100%;">Settings</button>
      </div>
    </aside>

    <main class="content" style="overflow:auto;">
      <!-- Analytics -->
      <section id="section-analytics" class="section active">
        <div class="card section-title">
          <h2>Real-time Analytics</h2>
          <div class="row" style="gap:6px;">
            <span class="tag" style="gap:8px;">
              Active: <span id="tagActive" style="font-weight:600;">Live</span>
            </span>
            <span class="badge green" id="pts" title="Events per second">0 EPS</span>
          </div>
        </div>
        <div class="grid-2">
          <div class="card" style="min-height: 210px;">
            <div class="row" style="justify-content: space-between;">
              <strong>Active Players</strong>
              <canvas class="mini" id="miniActive" width="120" height="40"></canvas>
            </div>
            <canvas id="chartActive" width="400" height="180" style="margin-top:8px;"></canvas>
          </div>
          <div class="card" style="min-height: 210px;">
            <div class="row" style="justify-content: space-between;">
              <strong>Events/Second</strong>
              <span class="badge amber" id="epsBadge">0 EPS</span>
            </div>
            <canvas id="chartRate" width="400" height="180" style="margin-top:8px;"></canvas>
          </div>
        </div>
        <div class="grid-3" style="margin-top:12px;">
          <div class="card">
            <h3>Cohorts</h3>
            <ul id="cohorts" style="padding-left:18px; margin:0; max-height: 140px; overflow:auto;"></ul>
          </div>
          <div class="card">
            <h3>Retention</h3>
            <div id="retention" style="font-family: ui-monospace, monospace; font-size:14px;"></div>
          </div>
          <div class="card">
            <h3>Live State</h3>
            <div id="liveState" style="font-family: ui-monospace, monospace; font-size: 14px;">
              Idle
            </div>
          </div>
        </div>
      </section>

      <!-- User Management -->
      <section id="section-users" class="section">
        <div class="card section-title">
          <h2>User Management</h2>
          <div class="row">
            <input id="searchUsers" placeholder="Search users by username or email" style="width: 380px;"/>
            <button class="btn" id="btnExportUsers">Export Users</button>
          </div>
        </div>
        <div class="card" style="padding:8px;">
          <table class="table" id="usersTable">
            <thead>
              <tr><th>Username</th><th>Name</th><th>Email</th><th>Role</th><th>MFA</th><th>Permissions</th><th>Last Login</th><th>IP</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- Game Controls -->
      <section id="section-controls" class="section">
        <div class="card section-title">
          <h2>Game Controls</h2>
          <div class="row">
            <span class="badge green" id="stateBadge">Idle</span>
          </div>
        </div>
        <div class="grid-2" style="margin-top:6px;">
          <div class="card" style="padding:14px;">
            <div class="row" style="justify-content:space-between;">
              <strong>Controls</strong>
              <span class="hint">Live state</span>
            </div>
            <div class="row" style="margin-top:8px;">
              <button class="btn" id="btnStart">Start</button>
              <button class="btn secondary" id="btnPause" style="margin-left:6px;">Pause</button>
              <button class="btn danger" id="btnStop" style="margin-left:6px;">Stop</button>
            </div>
            <hr/>
            <div class="row" style="justify-content: space-between;">
              <strong>Runtime</strong>
              <span class="tag" id="runtimeTag">0s</span>
            </div>
            <div class="row" style="margin-top:6px;">
              <label class="hint" for="speed">Speed</label>
              <input id="speed" type="range" min="0.5" max="2" step="0.1" value="1" />
              <span id="speedVal" class="tag" style="margin-left:6px;">1.0x</span>
            </div>
            <div class="row" style="margin-top:6px;">
              <label class="hint" for="gravity">Gravity</label>
              <input id="gravity" type="range" min="0" max="2" step="0.1" value="1" />
              <span id="gravityVal" class="tag" style="margin-left:6px;">1.0</span>
            </div>
            <div class="row" style="margin-top:6px;">
              <button class="btn" id="btnSetSchedule" style="margin-right:auto;">Set Schedule</button>
              <input id="scheduleTime" type="datetime-local" />
              <select id="scheduleAction" style="width:180px;">
                <option value="start">Start</option>
                <option value="stop">Stop</option>
                <option value="pause">Pause</option>
              </select>
            </div>
            <div id="scheduleInfo" class="hint" style="margin-top:6px;"></div>
          </div>
          <div class="card" style="padding:14px;">
            <div class="row" style="justify-content: space-between;">
              <strong>Toggles</strong>
              <span class="hint">Feature flags</span>
            </div>
            <div class="row wrap" style="gap:8px; margin-top:6px;">
              <label class="tag" style="cursor:pointer;"><input type="checkbox" id="toggleFeatureX" /> Feature X</label>
              <label class="tag" style="margin-left:6px; cursor:pointer;"><input type="checkbox" id="toggleFeatureY" /> Feature Y</label>
            </div>
            <div id="toggleStatus" class="hint" style="margin-top:8px;"></div>
          </div>
        </div>
        <div class="row card" style="margin-top:12px; align-items:stretch;">
          <div style="flex:1; padding:12px;">
            <div class="row" style="justify-content:space-between;">
              <strong>Drill-Down</strong>
              <span class="tag" id="drillTag">Realtime</span>
            </div>
            <p class="hint" style="margin:6px 0 0 0;">Simulated in-game events feed; expand with more modules in future.</p>
            <canvas id="drillCanvas" width="600" height="120" style="width:100%; height:120px; border-radius:6px; background:#0b1020; margin-top:6px;"></canvas>
          </div>
        </div>
      </section>

      <!-- Logs -->
      <section id="section-logs" class="section">
        <div class="card section-title">
          <h2>Centralized Logs</h2>
          <div class="row">
            <select id="logFilter" style="min-width:120px;">
              <option value="ALL">All</option>
              <option value="INFO">INFO</option>
              <option value="DEBUG">DEBUG</option>
              <option value="WARN">WARN</option>
              <option value="ERROR">ERROR</option>
            </select>
            <button class="btn" id="btnExportLogs">Export Logs</button>
          </div>
        </div>
        <div class="card">
          <div class="log-table" id="logsContainer" style="max-height:360px; overflow:auto;">
            <!-- Logs go here -->
          </div>
        </div>
      </section>

      <!-- Configuration -->
      <section id="section-config" class="section">
        <div class="card section-title">
          <h2>Configuration</h2>
          <div class="row">
            <button class="btn" id="btnSaveConfig">Save</button>
          </div>
        </div>
        <div class="grid-2" style="margin-top:6px;">
          <div class="card" style="padding:12px;">
            <h3 style="margin:0 0 6px 0;">Feature Flags</h3>
            <div id="featureFlags" class="row wrap" style="gap:8px; flex-wrap: wrap;"></div>
          </div>
          <div class="card" style="padding:12px;">
            <h3 style="margin:0 0 6px 0;">Env Vars</h3>
            <div id="envVars" class="row wrap" style="gap:8px; flex-wrap: wrap;"></div>
          </div>
        </div>
        <div class="grid-2" style="margin-top:12px;">
          <div class="card" style="padding:12px;">
            <h3 style="margin:0 0 6px 0;">Backups</h3>
            <button class="btn" id="btnCreateBackup">Create Backup</button>
            <button class="btn secondary" id="btnRestoreBackup" style="margin-left:6px;">Restore Last</button>
            <div class="hint" style="margin-top:6px;">Backups saved locally as JSON.</div>
          </div>
          <div class="card" style="padding:12px;">
            <h3 style="margin:0 0 6px 0;">Branding</h3>
            <div class="row" style="gap:8px;">
              <label>Theme</label>
              <select id="themeSelect">
                <option value="dark" selected>Dark</option>
                <option value="light">Light</option>
              </select>
              <button class="btn" id="btnApplyTheme" style="margin-left:auto;">Apply</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Security & Compliance -->
      <section id="section-security" class="section">
        <div class="card section-title">
          <h2>Security & Compliance</h2>
          <div class="row">
            <span class="badge amber" id="loginAlertsCountSmall">0</span>
            <span class="hint" style="margin-left:6px;">IP allowlists, login alerts, access audits</span>
          </div>
        </div>
        <div class="grid-2" style="margin-top:6px;">
          <div class="card" style="padding:12px;">
            <h3 style="margin:0 0 6px 0;">IP Allowlists</h3>
            <div class="row" style="gap:6px; align-items:center;">
              <input id="ipAdd" placeholder="Add IP (e.g., 203.0.113.1)" style="width:260px;"/>
              <button class="btn" id="btnAddIP">Add</button>
            </div>
            <ul id="ipList" style="padding-left:18px; margin:8px 0 0 0;"></ul>
          </div>
          <div class="card" style="padding:12px;">
            <h3 style="margin:0 0 6px 0;">Access Audits</h3>
            <div id="audits" style="max-height:220px; overflow:auto; border-top:1px solid #2a2f4a; padding-top:6px;"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal" aria-hidden="true">
    <div class="modal-card card" role="dialog" aria-label="Settings">
      <div class="modal-header">
        <strong>Advanced Settings</strong>
        <button class="btn ghost" id="closeSettings">Close</button>
      </div>
      <div class="modal-body">
        <div>
          <h3 style="margin:0 0 6px 0;">Visual</h3>
          <div class="row" style="gap:8px;">
            <label>Particle Background</label>
            <input id="optParticles" type="checkbox" checked />
          </div>
          <div class="row" style="gap:8px; margin-top:6px;">
            <label>Motion Blur</label>
            <input id="optBlur" type="checkbox" />
          </div>
        </div>
        <div>
          <h3 style="margin:0 0 6px 0;">Data Sampling</h3>
          <div class="row" style="gap:8px;">
            <label>Update Interval</label>
            <select id="samplingInterval">
              <option value="1000">1s</option>
              <option value="500">0.5s</option>
              <option value="250" selected>0.25s</option>
            </select>
          </div>
          <div class="row" style="gap:8px; margin-top:6px;">
            <label>Data Granularity</label>
            <select id="granularity">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn" id="saveSettings">Save</button>
      </div>
    </div>
  </div>

  <!-- Drill-Down Canvas (Graph) -->
  <script>
    // Global storage (local persistence)
    const storage = {
      users: [],
      logs: [],
      audits: [],
      config: {
        featureFlags: { featureX: false, featureY: true },
        envVars: { API_ENDPOINT: "https://api.vibecode.ai", MAX_PLAYERS: 1000 },
        backups: []
      },
      ipAllowList: ['127.0.0.1', '192.168.1.1'],
      theming: { theme: 'dark' }
    };

    const ROLES = {
      Admin: ['manage_users','view_analytics','manage_game','view_logs','config','security'],
      Analyst: ['view_analytics','view_logs'],
      Moderator: ['manage_game','view_logs']
    };

    // Seed data
    const adminUsers = [
      { id: 'u1', username: 'admin', name: 'Admin User', email: 'admin@example.com', role: 'Admin', mfaEnabled: true, permissions: ROLES.Admin, lastLogin: '2025-09-15 10:12', loginIP: '203.0.113.2', status: 'active' },
      { id: 'u2', username: 'analyst', name: 'Analyst User', email: 'analyst@example.com', role: 'Analyst', mfaEnabled: false, permissions: ROLES.Analyst, lastLogin: '2025-09-15 09:45', loginIP: '198.51.100.7', status: 'active' },
      { id: 'u3', username: 'mod', name: 'Moderator', email: 'mod@example.com', role: 'Moderator', mfaEnabled: true, permissions: ROLES.Moderator, lastLogin: '2025-09-14 17:28', loginIP: '203.0.113.55', status: 'active' }
    ];

    let currentUser = null;
    let liveState = 'Idle';
    let scheduled = null;
    let lastMFAChallenge = null;

    // Init
    function initData() {
      const savedUsers = localStorage.getItem('ha_users');
      if (savedUsers) storage.users = JSON.parse(savedUsers);
      else storage.users = adminUsers;

      const savedLogs = localStorage.getItem('ha_logs');
      storage.logs = savedLogs ? JSON.parse(savedLogs) : [];

      const savedAudits = localStorage.getItem('ha_audits');
      storage.audits = savedAudits ? JSON.parse(savedAudits) : [];

      const savedConfig = localStorage.getItem('ha_config');
      storage.config = savedConfig ? JSON.parse(savedConfig) : storage.config;

      const savedIP = localStorage.getItem('ha_ip');
      storage.ipAllowList = savedIP ? JSON.parse(savedIP) : ['127.0.0.1','192.168.1.1'];
    }

    function saveState() {
      localStorage.setItem('ha_users', JSON.stringify(storage.users));
      localStorage.setItem('ha_logs', JSON.stringify(storage.logs));
      localStorage.setItem('ha_audits', JSON.stringify(storage.audits));
      localStorage.setItem('ha_config', JSON.stringify(storage.config));
      localStorage.setItem('ha_ip', JSON.stringify(storage.ipAllowList));
    }

    // UI helpers
    function showToast(msg, type='info', timeout=2500) {
      const t = document.createElement('div');
      t.className = 'toast';
      t.style.borderLeftColor = type==='error'?'#ff5c7a': type==='success'?'#32d296':'#4e8cff';
      t.textContent = msg;
      document.getElementById('toasts')?.appendChild(t);
      setTimeout(() => t.remove(), timeout);
    }

    function renderIPList() {
      const ul = document.getElementById('ipList');
      ul.innerHTML = '';
      storage.ipAllowList.forEach(ip => {
        const li = document.createElement('li');
        li.textContent = ip;
        const btn = document.createElement('button');
        btn.textContent = 'Remove';
        btn.className = 'btn ghost';
        btn.style.marginLeft = '8px';
        btn.addEventListener('click', () => {
          storage.ipAllowList = storage.ipAllowList.filter(i => i !== ip);
          renderIPList();
          saveState();
        });
        li.appendChild(btn);
        ul.appendChild(li);
      });
      document.getElementById('loginAlertsCount')?.textContent;
    }

    // Charts state
    let chartActive, chartRate;
    let activeData = [];
    let rateData = [];
    function initCharts() {
      const ca = document.getElementById('chartActive');
      const cr = document.getElementById('chartRate');
      chartActive = ca.getContext('2d');
      chartRate = cr.getContext('2d');
      activeData = Array.from({length: 60}, () => Math.floor(20 + Math.random()*80));
      rateData = Array.from({length: 60}, () => Math.floor(20 + Math.random()*60));
    }
    function drawLine(ctx, data, color='#4e8cff') {
      ctx.clearRect(0,0, ctx.canvas.width, ctx.canvas.height);
      const w = ctx.canvas.width;
      const h = ctx.canvas.height;
      const max = Math.max(...data, 1);
      ctx.lineWidth = 2;
      ctx.strokeStyle = color;
      ctx.beginPath();
      data.forEach((v,i) => {
        const x = (i/(data.length-1))*w;
        const y = h - (v/max)*h;
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
      // fill under curve
      ctx.lineTo(w, h);
      ctx.lineTo(0, h);
      ctx.closePath();
      const grad = ctx.createLinearGradient(0,0,0,h);
      grad.addColorStop(0, color+'55');
      grad.addColorStop(1, color+'00');
      ctx.fillStyle = grad;
      ctx.fill();
    }
    function updateCharts() {
      drawLine(chartActive, activeData, '#4e8cff');
      drawLine(chartRate, rateData, '#32d296');
    }
    function pushAnalyticsPoint(a,r) {
      activeData.push(a); rateData.push(r);
      if (activeData.length>60) activeData.shift();
      if (rateData.length>60) rateData.shift();
      updateCharts();
      document.getElementById('pts').textContent = `${Math.round(r)} EPS`;
      document.getElementById('epsBadge').textContent = `${Math.round(r)} EPS`;
    }

    // Analytics simulation
    function simulateAnalytics() {
      const t = Date.now()/1000;
      const a = Math.max(0, Math.floor(40 + Math.sin(t/5)*25 + Math.random()*20));
      const r = Math.max(0, Math.floor(25 + Math.random()*60));
      pushAnalyticsPoint(a,r);
      renderCohorts();
      renderRetention();
    }

    function renderCohorts() {
      const cohorts = [];
      for (let i=0; i<5; i++) {
        const d = new Date();
        d.setDate(d.getDate()-i);
        cohorts.push({ day: d.toDateString(), count: Math.floor(40 + Math.random()*90) });
      }
      const ul = document.getElementById('cohorts');
      ul.innerHTML = '';
      cohorts.forEach(c => {
        const li = document.createElement('li');
        li.textContent = `${c.day}: ${c.count} signups`;
        ul.appendChild(li);
      });
    }
    function renderRetention() {
      const days = 7;
      const blocks = [];
      for (let i=1; i<=days; i++) {
        blocks.push({ day: `${i}d`, retained: Math.floor(40 + Math.random()*50) });
      }
      const div = document.getElementById('retention');
      div.innerHTML = blocks.map(b => `<span class="tag" style="margin-right:6px;">${b.day} ${b.retained}%</span>`).join('');
    }

    // UI wiring
    function setupUI() {
      // navigation
      document.querySelectorAll('#nav button[data-section]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#nav button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
          document.getElementById(btn.dataset.section).classList.add('active');
        });
      });

      // search
      document.getElementById('searchUsers').addEventListener('input', renderUsersTable);

      // export users
      document.getElementById('btnExportUsers')?.addEventListener('click', () => {
        exportData(storage.users, 'users.json');
        addAudit('export_users');
      });

      // logs export
      document.getElementById('btnExportLogs')?.addEventListener('click', () => {
        exportData(storage.logs, 'logs.json');
        addAudit('export_logs');
      });

      // schedule
      document.getElementById('btnSetSchedule')?.addEventListener('click', () => {
        const dt = document.getElementById('scheduleTime').value;
        const act = document.getElementById('scheduleAction').value;
        if (!dt) { alert('Choose a schedule time.'); return; }
        scheduled = { time: new Date(dt).toISOString(), action: act };
        document.getElementById('scheduleInfo').textContent = `Scheduled ${act} at ${dt}`;
        addAudit('schedule_set', `${act} at ${dt}`);
      });

      // game controls
      document.getElementById('btnStart').addEventListener('click', () => { startGame(); saveState(); });
      document.getElementById('btnPause').addEventListener('click', () => { pauseGame(); saveState(); });
      document.getElementById('btnStop').addEventListener('click', () => { stopGame(); saveState(); });

      // feature toggles
      document.getElementById('toggleFeatureX').addEventListener('change', e => {
        storage.config.featureFlags.featureX = e.target.checked;
        renderToggleStatus();
      });
      document.getElementById('toggleFeatureY').addEventListener('change', e => {
        storage.config.featureFlags.featureY = e.target.checked;
        renderToggleStatus();
      });

      // backup & restore
      document.getElementById('btnCreateBackup').addEventListener('click', () => {
        const snap = JSON.stringify({ users: storage.users, logs: storage.logs, audits: storage.audits, config: storage.config, ip: storage.ipAllowList });
        storage.config.backups.push({ at: new Date().toISOString(), snap });
        saveState();
        addAudit('backup_created');
        showToast('Backup created', 'success');
      });
      document.getElementById('btnRestoreBackup').addEventListener('click', () => {
        if (!storage.config.backups.length) return alert('No backups available.');
        const last = storage.config.backups[storage.config.backups.length-1];
        const data = JSON.parse(last.snap);
        storage.users = data.users;
        storage.logs = data.logs;
        storage.audits = data.audits;
        storage.config = data.config;
        storage.ipAllowList = data.ip;
        saveState();
        // quick refresh
        renderUsersTable();
        renderLogs();
        renderAudits();
        addAudit('backup_restored');
        showToast('Backup restored', 'success');
      });

      // theme
      document.getElementById('btnApplyTheme').addEventListener('click', () => {
        const theme = document.getElementById('themeSelect').value;
        document.body.classList.toggle('light', theme === 'light');
        document.documentElement.style.setProperty('--bg', theme==='light' ? '#f7f7fb' : '#0e1116');
        storage.theming.theme = theme;
        document.getElementById('themeBadge').textContent = theme === 'light' ? 'Light' : 'Dark';
        addAudit('theme_changed', theme);
      });

      // IP management
      document.getElementById('btnAddIP').addEventListener('click', () => {
        const ip = document.getElementById('ipAdd').value.trim();
        if (!ip) return;
        if (!storage.ipAllowList.includes(ip)) {
          storage.ipAllowList.push(ip);
          renderIPList();
          saveState();
          addAudit('ip_added', ip);
          showToast(`IP ${ip} added`, 'success');
        }
      });

      // login
      document.getElementById('btnLogin').addEventListener('click', attemptLogin);

      // theme badge text
      document.querySelector('.tag')?.textContent = 'Dark';

      // analytics ticker
      setInterval(simulateAnalytics, 2000);

      // drill-down canvas init
      initDrillCanvas();

      // login keyboard shortcut
      document.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 'l' && (e.metaKey || e.ctrlKey)) {
          // quick login
          attemptLogin();
        }
      });
    }

    // Helpers
    function exportData(data, filename) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename || 'export.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
    }

    // Login flow
    function promptMFA(user) {
      if (!user.mfaEnabled) return true;
      lastMFAChallenge = Math.floor(100000 + Math.random()*900000);
      // Simulated prompt
      const ok = confirm(`MFA required for ${user.username}. Simulated code: ${lastMFAChallenge}. Type OK to simulate success.`);
      // For demo, treat user as success if OK clicked; in real app you'd prompt for code
      if (ok) return true;
      return false;
    }

    function attemptLogin() {
      const username = document.getElementById('u').value;
      const password = document.getElementById('p').value;
      const ip = document.getElementById('loginIP').value || '0.0.0.0';
      if (!username || !password) {
        showLoginError('Please enter credentials.');
        return;
      }
      const user = storage.users.find(u => u.username === username);
      if (!user) {
        showLoginError('Invalid username.');
        log('WARN', `Login failed for unknown user ${username}`, 'auth');
        return;
      }
      if (password !== 'password') {
        showLoginError('Invalid password.');
        log('WARN', `Password mismatch for ${username}`, 'auth');
        return;
      }
      const allowed = storage.ipAllowList.includes(ip);
      if (!allowed) {
        log('WARN', `Login from non-approved IP ${ip} by ${username}`, 'security');
        showLoginError('Login from disallowed IP. Admin alerted.');
        pushLoginAlert(username, ip);
      } else {
        clearLoginAlerts();
      }

      currentUser = user;
      if (user.mfaEnabled) {
        const mfaOk = promptMFA(user);
        if (!mfaOk) {
          showLoginError('MFA verification failed.');
          return;
        }
      }
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('app').style.display = 'flex';
      renderUsersTable();
      renderLogs();
      addAudit('login', `user=${username} ip=${ip}`);
      saveState();
      initCharts();
    }

    function pushLoginAlert(user, ip) {
      const alertBox = document.getElementById('loginAlertsCount');
      const current = parseInt(alertBox.textContent) || 0;
      alertBox.textContent = String(current + 1);
      // optional visual alert
      showToast(`Login alert: ${user} from ${ip}`, 'warning');
    }

    function clearLoginAlerts() {
      const alertBox = document.getElementById('loginAlertsCount');
      if (alertBox) alertBox.textContent = '0';
    }

    function showLoginError(msg) {
      const el = document.getElementById('loginError');
      if (el) el.textContent = msg;
    }

    // Users, Logs rendering
    function renderUsersTable() {
      const tbody = document.querySelector('#usersTable tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      const q = (document.getElementById('searchUsers')?.value || '').toLowerCase();
      const items = storage.users.filter(u => !q || u.username.toLowerCase().includes(q) || u.email.toLowerCase().includes(q));
      for (const u of items) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.username}</td>
          <td>${u.name}</td>
          <td>${u.email}</td>
          <td>${u.role}</td>
          <td>${u.mfaEnabled ? 'Enabled' : 'Disabled'}</td>
          <td>${(u.permissions || []).slice(0,3).join(', ')}${(u.permissions||[]).length>3?'...':''}</td>
          <td>${u.lastLogin || '-'}</td>
          <td>${u.loginIP || '-'}</td>
          <td>
            <button class="btn small" data-action="toggle-mfa" data-id="${u.id}">${u.mfaEnabled ? 'Disable MFA' : 'Enable MFA'}</button>
            <button class="btn small secondary" data-action="set-role" data-id="${u.id}">Role</button>
            <button class="btn small ghost" data-action="export-user" data-id="${u.id}">Export</button>
          </td>
        `;
        tbody.appendChild(tr);
      }
      tbody.querySelectorAll('button[data-action]').forEach(btn => {
        btn.addEventListener('click', (e) => handleUserAction(e.target.dataset.action, e.target.dataset.id));
      });
    }
    function renderLogs() {
      const container = document.getElementById('logsContainer');
      if (!container) return;
      const filter = document.getElementById('logFilter')?.value;
      let logs = storage.logs;
      if (filter !== 'ALL') logs = logs.filter(l => l.level === filter);
      container.innerHTML = '';
      logs.forEach(l => {
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.style.padding = '6px 4px';
        div.style.borderBottom = '1px dashed #2a324a';
        div.textContent = `[${l.ts}] ${l.level} - ${l.source}: ${l.message}`;
        if (l.level === 'ERROR') div.style.color = '#ffb4b4';
        container.appendChild(div);
      });
      container.scrollTop = 0;
    }
    function renderAudits() {
      const container = document.getElementById('audits');
      if (!container) return;
      container.innerHTML = '';
      storage.audits.slice(0, 60).forEach(a => {
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.style.display = 'block';
        div.textContent = `${a.ts} | ${a.user || 'system'} | ${a.action} ${a.details ? '- ' + a.details : ''}`;
        container.appendChild(div);
      });
    }

    function renderToggleStatus() {
      const status = Object.entries(storage.config.featureFlags)
        .map(([k,v]) => `${k}:${v ? 'ON':'OFF'}`)
        .join(' | ');
      document.getElementById('toggleStatus')?.textContent = `Flags: ${status}`;
    }

    // Game controls
    function startGame(auto=false) {
      if (!auto) addAudit('manual_start');
      if (liveState === 'Running') return;
      liveState = 'Running';
      updateLiveState();
      log('INFO', 'Game started', 'game');
    }
    function pauseGame(auto=false) {
      if (liveState !== 'Running') return;
      liveState = 'Paused';
      updateLiveState();
      log('INFO', 'Game paused', 'game');
      addAudit('pause_game');
    }
    function stopGame(auto=false) {
      if (liveState === 'Idle') return;
      liveState = 'Idle';
      updateLiveState();
      log('INFO', 'Game stopped', 'game');
      addAudit('stop_game');
    }

    // MFA simulation
    function promptMFA(user) {
      if (!user.mfaEnabled) return true;
      lastMFAChallenge = Math.floor(100000 + Math.random()*900000);
      const ok = confirm(`MFA required for ${user.username}. Enter code: ${String(lastMFAChallenge)}`);
      const answer = String(lastMFAChallenge); // simulate success
      if (answer === String(lastMFAChallenge)) return true;
      alert('Invalid MFA code.');
      return false;
    }

    // Actions on user row
    function handleUserAction(action, userId) {
      const user = storage.users.find(u => u.id === userId);
      if (!user) return;
      switch(action) {
        case 'toggle-mfa':
          const enabling = !user.mfaEnabled;
          if (enabling) {
            const ok = promptMFA(user);
            if (!ok) {
              log('WARN', `MFA enable failed for ${user.username}`, 'security');
              return;
            }
          }
          user.mfaEnabled = enabling;
          addAudit(`mfa_${enabling ? 'enabled' : 'disabled'}`, user.username);
          renderUsersTable();
          saveState();
          break;
        case 'set-role':
          const newRole = prompt(`Set new role for ${user.username} (Admin/Analyst/Moderator)`, user.role) || user.role;
          if (ROLES[newRole]) {
            user.role = newRole;
            user.permissions = ROLES[newRole];
            addAudit('set_role', `${user.username} -> ${newRole}`);
            renderUsersTable();
            saveState();
          } else {
            alert('Invalid role.');
          }
          break;
        case 'export-user':
          exportData([user], `user_${user.username}.json`);
          addAudit('export_user', user.username);
          break;
      }
    }

    // Confetti
    function confettiBurst(x, y, colors=['#4e8cff','#32d296','#ffd166','#ff5c7a'], count=40) {
      const canvas = document.createElement('canvas');
      canvas.style.position = 'fixed';
      canvas.style.left = '0';
      canvas.style.top = '0';
      canvas.style.width = '100%';
      canvas.style.height = '100%';
      canvas.style.pointerEvents = 'none';
      canvas.style.zIndex = '999';
      document.body.appendChild(canvas);
      const ctx = canvas.getContext('2d');
      const rect = document.body.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
      const pieces = Array.from({length: count}).map(() => {
        return {
          x: x, y: y,
          vx: (Math.random()-0.5)*6,
          vy: (Math.random()-1.0)*6,
          color: colors[Math.floor(Math.random()*colors.length)],
          life: Math.random()*60+40
        };
      });
      let t = 0;
      function draw() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        pieces.forEach(p => {
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.15;
          p.life -= 1;
          ctx.fillStyle = p.color;
          ctx.fillRect(p.x, p.y, 6, 6);
        });
        t++;
        if (t < 120) requestAnimationFrame(draw);
        else {
          document.body.removeChild(canvas);
        }
      }
      draw();
    }

    // Drilling drill-down
    let drillCtx;
    let drillAnim;
    function initDrillCanvas() {
      const c = document.getElementById('drillCanvas');
      if (!c) return;
      drillCtx = c.getContext('2d');
      let t = 0;
      function loop() {
        t += 0.02;
        const w = c.width, h = c.height;
        drillCtx.clearRect(0,0,w,h);
        // simple rotating wave
        for (let i=0; i<3; i++) {
          drillCtx.fillStyle = `hsl(${(i*120 + t*60)%360}, 80%, 60%)`;
          drillCtx.beginPath();
          for (let x=0; x<w; x+=2) {
            const y = h/2 + Math.sin((x/60) + t + i) * (8 + i*6);
            if (x===0) drillCtx.moveTo(x,y); else drillCtx.lineTo(x,y);
          }
          drillCtx.strokeStyle = drillCtx.fillStyle;
          drillCtx.lineWidth = 2;
          drillCtx.stroke();
        }
        drillAnim = requestAnimationFrame(loop);
      }
      loop();
    }

    // Scheduling tick
    function checkSchedule() {
      if (scheduled && new Date() >= new Date(scheduled.time)) {
        const act = scheduled.action;
        if (act === 'start') startGame(true);
        else if (act === 'stop') stopGame(true);
        else if (act === 'pause') pauseGame(true);
        addAudit('schedule_executed', `${act} at ${scheduled.time}`);
        scheduled = null;
        document.getElementById('scheduleInfo').textContent = 'Scheduled action executed.';
        renderLogs();
      }
    }

    // Helpers
    function updateLiveState() {
      const s = liveState;
      document.getElementById('stateBadge').textContent = s;
      document.getElementById('liveState').textContent = s;
    }

    // Scheduling
    function addAudit(action, details='') {
      const entry = { ts: new Date().toISOString(), user: currentUser?.username || 'system', action, details };
      storage.audits.unshift(entry);
      if (storage.audits.length > 200) storage.audits.pop();
      renderAudits();
      saveState();
    }
    function log(level, message, source='system') {
      const entry = { ts: new Date().toISOString(), level, message, source };
      storage.logs.unshift(entry);
      if (storage.logs.length > 500) storage.logs.pop();
      renderLogs();
      if (level === 'ERROR') showToast('Error logged', 'error');
      saveState();
    }

    // Background and visuals
    let particles = [];
    let particleEnabled = true;
    function initBG() {
      const canvas = document.getElementById('bg');
      const ctx = canvas.getContext('2d');
      function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      window.addEventListener('resize', resize);
      resize();
      // spawn particles
      for (let i=0; i<120; i++) {
        particles.push({
          x: Math.random()*canvas.width,
          y: Math.random()*canvas.height,
          vx: (Math.random()-0.5)*0.6,
          vy: (Math.random()-0.5)*0.6,
          size: Math.random()*2 + 1,
          hue: Math.floor(Math.random()*360)
        });
      }
      function tick() {
        if (!particleEnabled) return;
        ctx.clearRect(0,0,canvas.width, canvas.height);
        for (const p of particles) {
          p.x += p.vx;
          p.y += p.vy;
          if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
          if (p.y < 0 || p.y > canvas.height) p.vy *= -1;
          ctx.fillStyle = `hsla(${p.hue},70%,60%,0.25)`;
          ctx.fillRect(p.x, p.y, p.size, p.size);
        }
        requestAnimationFrame(tick);
      }
      tick();
    }

    // Logged in access and export helpers
    function renderLogs() {
      const container = document.getElementById('logsContainer');
      const filter = document.getElementById('logFilter')?.value;
      let logs = storage.logs;
      if (filter && filter !== 'ALL') logs = logs.filter(l => l.level === filter);
      container.innerHTML = '';
      logs.forEach(l => {
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.style.padding = '6px 8px';
        div.style.borderBottom = '1px dashed #2a324a';
        div.textContent = `[${l.ts}] ${l.level} - ${l.source}: ${l.message}`;
        if (l.level === 'ERROR') div.style.color = '#ffb4b4';
        container.appendChild(div);
      });
      container.scrollTop = 0;
    }

    // Helpers
    function renderBackupsInfo() {
      // optional UI hook
    }

    // Start
    function bootstrap() {
      initData();
      // ensure initial data
      if (!storage.users.length) storage.users = adminUsers;
      // persist basic
      saveState();
    }

    // Initial render
    window.addEventListener('load', () => {
      bootstrap();
      // hide app until login
      document.getElementById('app').style.display = 'none';
      // show login
      document.getElementById('loginScreen').style.display = 'grid';
      // set up UI after login actions
      document.getElementById('exportAll')?.addEventListener('click', () => {
        exportData(storage, 'ha_export.json');
        addAudit('export_all');
        showToast('Exported all data', 'success');
        confettiBurst(window.innerWidth/2, window.innerHeight/2);
      });
      // settings modal
      const modal = document.getElementById('settingsModal');
      document.getElementById('openSettings').addEventListener('click', () => { modal.classList.add('active'); modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); });
      document.getElementById('closeSettings').addEventListener('click', () => { modal.classList.remove('active'); modal.style.display='none'; modal.setAttribute('aria-hidden','true'); });
      document.getElementById('saveSettings').addEventListener('click', () => {
        // sample: read sampling interval
        const interval = parseInt(document.getElementById('samplingInterval').value, 10);
        // apply to timer
        if (window['sampleTimer']) clearInterval(window['sampleTimer']);
        window['sampleTimer'] = setInterval(simulateAnalytics, interval);
        modal.classList.remove('active');
        modal.style.display='none';
        modal.setAttribute('aria-hidden','true');
        showToast('Settings saved', 'success');
      });

      // login-related setup
      document.getElementById('btnLogin').addEventListener('click', null); // placeholder (handled earlier)
      // initialize visuals
      renderUsersTable();
      renderLogs();
      renderAudits();
      // UI nav activation
      document.querySelectorAll('#nav button[data-section]').forEach(btn => btn.addEventListener('click', () => {
        // ensure audit rendering
        renderLogs();
      }));
      // build charts
      initCharts();
      updateLiveState();
      renderToggleStatus();
      // background particles
      initBG();
      // prepare drill canvas
      initDrillCanvas();
      // set up interval for analytics
      setInterval(simulateAnalytics, 2000);
      // schedule checker
      setInterval(checkSchedule, 1000);
    });

    // Drilling function
    function renderCohorts() { /* kept for compatibility if needed in future */ }

    // Init drill canvas
    function initDrillCanvas() {
      const c = document.getElementById('drillCanvas');
      if (!c) return;
      const ctx = c.getContext('2d');
      let t = 0;
      function loop() {
        t += 0.02;
        const w = c.width, h = c.height;
        ctx.clearRect(0,0,w,h);
        for (let i=0; i<3; i++) {
          ctx.strokeStyle = `hsla(${(i*120 + t*60)%360},80%,60%,1)`;
          ctx.lineWidth = 2;
          ctx.beginPath();
          for (let x=0; x<w; x+=2) {
            const y = h/2 + Math.sin((x/40) + t + i) * (8 + i*6);
            if (x===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
          }
          ctx.stroke();
        }
        requestAnimationFrame(loop);
      }
      loop();
    }

  </script>
  <!-- Small bottom anchor for toasts in DOM -->
  <div id="toasts" class="toasts"></div>
  <!-- Inline script end -->
</body>
</html>