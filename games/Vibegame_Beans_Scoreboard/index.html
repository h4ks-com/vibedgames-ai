<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vibegame Beans Scoreboard - Enhanced</title>
  <style>
    :root{
      --bg: #0b0f14;
      --card: #141b22;
      --surface: #182028;
      --fg: #e8f0f8;
      --muted: #a2aab8;
      --accent: #6bd2ff;
      --bean: #a9f0a8;
      --leader: #ffd54f;
      --valware-glow: 0 0 0 transparent;
      --green: #4bdc74;
      --red: #ff6b6b;
      --blue: #69d0ff;
    }
    html, body {
      height: 100%;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color: var(--fg);
      background: radial-gradient(circle at 20% -10%, rgba(0,150,255,0.12), transparent 40%),
                  radial-gradient(circle at 100% 0%, rgba(0,0,0,0.25), transparent 40%),
                  linear-gradient(#0b1118, #0b0f14 60%);
      overflow-x: hidden;
    }
    .app {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 16px 60px;
      position: relative;
    }

    /* Confetti canvas overlay for celebratory effects */
    canvas#confetti {
      position: fixed; pointer-events: none; left: 0; top: 0;
      width: 100%; height: 100%; z-index: 999;
    }

    header.app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(22,28,38,.92), rgba(16,21,30,.92));
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .brand {
      display: flex; align-items: center; gap: 12px;
    }
    .brand .logo {
      width: 42px; height: 42px; border-radius: 10px;
      background: linear-gradient(135deg, #2e8bff, #00e6a8);
      display: grid; place-items: center; font-size: 18px;
      font-weight: 700; color: white;
      box-shadow: 0 4px 14px rgba(0,0,0,.3);
    }
    h1 {
      font-size: 1.15rem;
      margin: 0;
      letter-spacing: .3px;
    }
    .sub {
      color:#cdeaff; font-size:12px;
    }
    .controls {
      display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
    }
    .toggle {
      display: inline-flex; align-items: center; gap: 8px;
      background: rgba(255,255,255,.06);
      padding: 8px 12px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.1);
    }
    .toggle input { width: 0; height: 0; opacity: 0; }
    .toggle .knob {
      width: 52px; height: 26px; border-radius: 999px;
      background: #334e68; position: relative; cursor: pointer;
      border: 1px solid rgba(255,255,255,.15);
      transition: background .2s;
    }
    .toggle .knob::after{
      content:""; position: absolute; left: 3px; top: 3px;
      width: 20px; height: 20px; border-radius: 50%;
      background: white; transition: transform .2s;
    }
    .toggle input:checked + .knob { background: #1e9a4a; }
    .toggle input:checked + .knob::after { transform: translateX(26px); }
    .btn {
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.08);
      color: #fff; padding: 8px 12px; border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn.primary {
      background: linear-gradient(135deg, #4f93ff, #1ec2ff);
      border: none; color: #04101b;
    }
    .btn:focus { outline: 2px solid var(--accent); outline-offset: 2px; }
    .section {
      margin-top: 14px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(20,26,36,.95), rgba(20,26,36,.75));
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
    }
    table {
      width: 100%; border-collapse: collapse;
      min-width: 640px;
    }
    thead th {
      text-align: left; padding: 12px 14px; font-size: 0.88rem;
      background: rgba(255,255,255,.04); color: #e7f0ff;
      border-bottom: 1px solid rgba(255,255,255,.08);
      position: sticky; top:0;
    }
    thead th button {
      all: unset; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;
    }
    thead th[aria-sort="ascending"] { background: rgba(107,214,255,.15); }
    thead th[aria-sort="descending"] { background: rgba(107,214,255,.25); }

    tbody tr { transition: background .25s, transform .25s; }
    tbody tr:hover { background: rgba(255,255,255,.03); }

    td { padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,.06); vertical-align: middle; }

    .cell {
      display: flex; align-items: center; gap: 10px;
    }
    .avatar {
      width: 28px; height: 28px; border-radius: 50%;
      display: grid; place-items: center; color: white; font-weight: 700;
      font-size: 12px;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.25);
    }
    .name { font-weight: 700; }
    .tag.leader {
      display: inline-block; padding: 2px 8px; border-radius: 999px;
      font-size: 11px; margin-left: 8px;
      background: linear-gradient(135deg, #ffd54f, #ffb300);
      color: #2b1a00; font-weight: 700;
      border: 1px solid rgba(0,0,0,.2);
      animation: pop 1s ease-out;
    }
    @keyframes pop {
      0% { transform: scale(0.6); opacity: 0; }
      60% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(1); }
    }
    .beans-cell {
      display: inline-flex; align-items: center; gap: 8px;
      position: relative;
    }
    .bean-icon {
      width: 16px; height: 16px;
    }
    .beans-num {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto;
      font-weight: 800; font-size: 1.05rem;
      color: #eaffea;
      min-width: 40px; text-align: right;
    }
    .progress {
      width: 120px; height: 8px; border-radius: 6px; overflow: hidden;
      background: rgba(255,255,255,.12); border: 1px solid rgba(0,0,0,.25);
    }
    .progress > .bar {
      height: 100%; background: linear-gradient(90deg, #4b9cff, #7dffb8);
      width: 0%;
      transition: width .4s ease-out;
    }
    .time {
      color: var(--muted); font-variant-numeric: tabular-nums;
    }
    .row-valware {
      outline: 2px solid rgba(255, 215, 0, 0.9);
      outline-offset: -2px;
      box-shadow: 0 0 0 3px rgba(255,215,0,.15);
      animation: glowPulse 2s infinite;
    }
    @keyframes glowPulse {
      0% { box-shadow: 0 0 0 rgba(0,0,0,0.2); }
      50% { box-shadow: 0 0 18px rgba(255,214,0,.6); }
      100% { box-shadow: 0 0 0 rgba(0,0,0,0.2); }
    }
    .sr-only {
      position: absolute;
      width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0,0,0,0); border: 0;
    }
    /* Advanced panel */
    .adv-toggle {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 12px; border-radius: 8px;
      background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.15);
      cursor: pointer;
    }
    .adv-panel {
      padding: 12px; display: none; gap: 12px; align-items: center; flex-wrap: wrap;
    }
    .adv-panel.visible { display: flex; }
    .adv-panel label { font-size: 12px; color: var(--muted); }
    .export-area { margin-left:auto; display:flex; align-items:center; gap:8px; }

    /* Responsive tweaks */
    @media (max-width: 700px) {
      thead th, td { padding: 10px; }
      .name { font-size: 0.95rem; }
      .progress { width: 90px; }
    }
  </style>
</head>
<body>
  <canvas id="confetti" aria-hidden="true"></canvas>
  <div class="app" aria-label="Vibegame Beans Scoreboard app container">
    <header class="app-header" aria-label="Vibegame Beans Scoreboard header">
      <div class="brand">
        <div class="logo" aria-label="Vibegame Logo">VB</div>
        <div>
          <h1>Vibegame Beans Scoreboard</h1>
          <div class="sub">Real-time, AI-driven bean competition. Valware is highlighted as the leader.</div>
        </div>
      </div>
      <div class="controls" aria-label="Controls">
        <label class="toggle" aria-label="Live feed toggle">
          <input id="liveToggle" type="checkbox" />
          <span class="knob" aria-hidden="true"></span>
          <span style="font-size:12px; color:#e8f3ff">Live feed</span>
        </label>
        <button id="seedBtn" class="btn" aria-label="Seed sample data again">Seed</button>
        <button id="resetBtn" class="btn" aria-label="Reset scores to seed data">Reset</button>
        <button id="exportBtn" class="btn" aria-label="Export current scoreboard as CSV">Export CSV</button>
        <span class="adv-toggle" id="advBtn" aria-label="Toggle advanced options" title="Advanced options">Advanced</span>
      </div>
    </header>

    <section class="section" aria-label="Beans scoreboard table" id="scoreboard">
      <table role="table" aria-label="Beans scoreboard" id="scoreTable">
        <thead>
          <tr>
            <th scope="col" aria-label="Player" >Player</th>
            <th scope="col" aria-label="Beans" tabindex="0" id="th-beans" aria-sort="descending" role="button" aria-label="Sort by Beans">
              Beans
              <span style="font-size:12px; color:#88c7ff">(click to sort)</span>
            </th>
            <th scope="col" aria-label="Progress" style="width: 210px;">Progress</th>
            <th scope="col" aria-label="Last Updated" style="width: 180px;">Last Updated</th>
          </tr>
        </thead>
        <tbody id="scoreRows" role="rowgroup"></tbody>
      </table>
      <div id="liveRegion" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    </section>

    <section id="advancedPanel" class="section adv-panel" aria-label="Advanced options panel">
      <div style="flex:1 1 260px;">
        <div style="font-weight:700; margin-bottom:6px;">Advanced Options</div>
        <div style="color:var(--muted); font-size:12px;">
          Tweak sorting, animation speed, and toggles. Changes persist in local storage.
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <label style="font-size:12px;color:var(--muted)">Sort direction:
          <select id="advSortDir" style="padding:6px 8px; border-radius:6px; margin-left:6px;">
            <option value="desc" selected>Descending</option>
            <option value="asc">Ascending</option>
          </select>
        </label>
        <label style="font-size:12px;color:var(--muted)">Animation speed (beans):
          <select id="advAnimSpeed" style="padding:6px 8px; border-radius:6px; margin-left:6px;">
            <option value="350">Slow</option>
            <option value="600" selected>Normal</option>
            <option value="900">Fast</option>
          </select>
        </label>
        <label style="font-size:12px;color:var(--muted)">Show progress bars:
          <input type="checkbox" id="advShowProgress" checked style="margin-left:6px;">
        </label>
      </div>
    </section>

    <!-- Hidden test area for unit tests (not visible) -->
    <div id="test-area" class="sr-only" aria-hidden="true"></div>
  </div>

  <script>
    // Data model
    let players = [];
    let settings = {
      liveFeed: false,
      sortKey: 'beans',
      sortDir: 'desc'
    };
    const STORAGE_KEY = 'vibegame_beans_scoreboard_v2';
    let liveInterval = null;
    let timeRefreshInterval = null;
    let confettiActive = false;

    // Seeded data
    function seedPlayers() {
      const now = Date.now();
      return [
        { id: 'valware', name: 'Valware', color: '#ff6b6b', beans: 42, timestamp: now, isLeader: true },
        { id: 'beanette', name: 'Beanette', color: '#4caf50', beans: 36, timestamp: now - 1000 * 60, isLeader: false },
        { id: 'sprout', name: 'Sprout', color: '#26a69a', beans: 28, timestamp: now - 1000 * 120, isLeader: false },
        { id: 'moonbean', name: 'Moonbean', color: '#ffd54f', beans: 22, timestamp: now - 1000 * 180, isLeader: false },
        { id: 'nutmeg', name: 'Nutmeg', color: '#ab47bc', beans: 24, timestamp: now - 1000 * 240, isLeader: false },
        { id: 'pippin', name: 'Pippin', color: '#42a5f5', beans: 15, timestamp: now - 1000 * 300, isLeader: false }
      ];
    }

    // Local storage persistence
    function saveState() {
      const payload = { players, settings };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const data = JSON.parse(raw);
          if (data.players && Array.isArray(data.players)) {
            players = data.players;
          } else {
            players = seedPlayers();
          }
          if (data.settings) settings = data.settings;
          return;
        }
      } catch (e) {
        console.warn('Could not load state, using seed data', e);
      }
      players = seedPlayers();
    }

    // Sorting and ranking logic
    function rankPlayers(list) {
      // Descending by beans; stable by timestamp ascending
      return [...list].sort((a, b) => {
        if (b.beans !== a.beans) return b.beans - a.beans;
        return a.timestamp - b.timestamp;
      });
    }

    function applySort(list) {
      const sorted = rankPlayers(list);
      if (settings.sortKey === 'beans') {
        return sorted;
      }
      return sorted;
    }

    // Confetti
    const confetti = {
      ctx: null,
      particles: [],
      colors: ['#FF5F6D', '#FFC371', '#4BE6A5', '#7C5CFF', '#FF9F1C'],
      init() {
        const c = document.getElementById('confetti');
        if (!c || !c.getContext) return;
        c.width = window.innerWidth;
        c.height = window.innerHeight;
        this.ctx = c.getContext('2d');
        window.addEventListener('resize', () => {
          c.width = window.innerWidth;
          c.height = window.innerHeight;
        });
      },
      spawn(x, y, count = 20) {
        for (let i = 0; i < count; i++) {
          this.particles.push({
            x: x, y: y,
            vx: (Math.random() - 0.5) * 6,
            vy: Math.random() * -6 - 2,
            size: Math.random() * 6 + 4,
            color: this.colors[Math.floor(Math.random() * this.colors.length)],
            life: Math.random() * 0.6 + 0.6
          });
        }
        if (!this._raf) this._loop();
      },
      _loop() {
        this._raf = requestAnimationFrame(this._tick.bind(this));
      },
      _tick(now) {
        const c = this.ctx;
        if (!c) return;
        c.clearRect(0, 0, innerWidth, innerHeight);
        this.particles.forEach(p => {
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.15;
          p.life -= 0.01;
          c.fillStyle = p.color;
          c.fillRect(p.x, p.y, p.size, p.size);
        });
        this.particles = this.particles.filter(p => p.life > 0 && p.y < innerHeight + 20);
        if (this.particles.length > 0) this._loop();
        else {
          this.ctx.clearRect(0,0,innerWidth, innerHeight);
          this._raf = null;
        }
      }
    };

    // Rendering
    function timeAgo(ts) {
      const diff = Math.max(0, Date.now() - ts);
      const sec = Math.floor(diff / 1000);
      if (sec < 5) return 'just now';
      if (sec < 60) return sec + 's ago';
      const min = Math.floor(sec / 60);
      if (min < 60) return min + 'm ago';
      const hr = Math.floor(min / 60);
      if (hr < 24) return hr + 'h ago';
      const d = Math.floor(hr / 24);
      return d + 'd ago';
    }

    // Animate bean number changes
    function animateValue(el, start, end, duration = 600) {
      const startTime = performance.now();
      const delta = end - start;
      function tick(now) {
        const t = Math.min(1, (now - startTime) / duration);
        const ease = 1 - Math.pow(1 - t, 3);
        const val = Math.round(start + delta * ease);
        el.textContent = val;
        if (t < 1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    // UI rendering
    function renderScoreboard() {
      const tbody = document.getElementById('scoreRows');
      if (!tbody) return;
      tbody.innerHTML = '';
      const sorted = applySort(players);
      // Determine max beans for progress bars
      const maxBeans = Math.max(...players.map(p => p.beans), 1);
      // Clear previous leader class
      document.querySelectorAll('tr').forEach(r => r.classList.remove('row-valware'));
      // Render
      sorted.forEach(p => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-id', p.id);
        // Leader highlight
        const isLeader = p.beans === maxBeans;
        if (isLeader) {
          tr.classList.add('row-valware');
        }

        // Player cell
        const tdPlayer = document.createElement('td');
        tdPlayer.className = 'cell';
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.style.backgroundColor = p.color;
        const initials = p.name.split(' ').map(n => n[0]).slice(0,2).join('').toUpperCase();
        avatar.textContent = initials;
        avatar.setAttribute('aria-label', p.name + ' avatar');
        const nameSpan = document.createElement('span');
        nameSpan.className = 'name';
        nameSpan.textContent = p.name;
        tdPlayer.appendChild(avatar);
        tdPlayer.appendChild(nameSpan);
        if (isLeader) {
          const badge = document.createElement('span');
          badge.className = 'tag leader';
          badge.textContent = 'Leader';
          badge.setAttribute('aria-label', 'Leader badge');
          tdPlayer.appendChild(badge);
        }
        tr.appendChild(tdPlayer);

        // Beans cell
        const tdBeans = document.createElement('td');
        tdBeans.style.whiteSpace = 'nowrap';
        const beanWrap = document.createElement('span');
        beanWrap.className = 'beans-cell';
        const beanIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        beanIcon.setAttribute('class', 'bean-svg');
        beanIcon.setAttribute('viewBox', '0 0 24 24');
        beanIcon.innerHTML = '<path fill="#ffd3a4" d="M12 3c3.3 0 6 2.7 6 6 0 2.8-2.1 5.2-4.8 5.9 1.2.9 2.3 2.3 2.7 3.9.9-1.2 1.5-2.7 1.5-4.3C17.4 6.9 15.2 4 12 4 8.7 4 6.4 6.9 6.4 9.9c0 1.6.6 3.1 1.5 4.3-.6-1-1.8-3-3-3 0 0-0 0 0 0C2 8.8 4.4 6 8 6c1.9 0 3.6 1 4.7 2.5C13.7 7.6 13 6 12 3z"/>';
        beanIcon.setAttribute('aria-hidden','true');
        beanIcon.style.width = '16px';
        beanIcon.style.height = '16px';
        beanWrap.appendChild(beanIcon);

        const beansEl = document.createElement('span');
        beansEl.className = 'beans-num';
        beansEl.textContent = p.beans;
        beansEl.setAttribute('data-id', p.id);

        beanWrap.appendChild(beansEl);
        tdBeans.appendChild(beanWrap);

        // Progress bar (advanced option toggle)
        const maxB = maxBeans;
        const progContainer = document.createElement('span');
        progContainer.style.display = 'inline-flex';
        progContainer.style.alignItems = 'center';
        progContainer.style.gap = '8px';
        const progress = document.createElement('div');
        progress.className = 'progress';
        const bar = document.createElement('div');
        bar.className = 'bar';
        const showProgress = document.getElementById('advShowProgress');
        const show = showProgress ? showProgress.checked : true;
        if (show) {
          const pct = Math.round((p.beans / maxB) * 100);
          bar.style.width = pct + '%';
        } else {
          bar.style.width = '0%';
        }
        progress.style.display = 'inline-block';
        progress.style.verticalAlign = 'middle';
        progress.appendChild(bar);
        progContainer.appendChild(progress);
        // numeric label
        const pctLabel = document.createElement('span');
        pctLabel.style.fontSize = '11px';
        pctLabel.style.color = '#cdeaff';
        pctLabel.textContent = ' ' + Math.max(0, Math.round((p.beans / maxB) * 100)) + '%';
        progContainer.appendChild(pctLabel);

        tdBeans.appendChild(progContainer);

        // Last Updated
        const tdTime = document.createElement('td');
        tdTime.className = 'time';
        tdTime.textContent = timeAgo(p.timestamp);
        tdTime.setAttribute('aria-label', 'Last updated');
        tr.appendChild(tdBeans);
        tr.appendChild(tdTime);

        // Add to body
        tbody.appendChild(tr);
      });

      // After rendering, re-sync progress bars visibility per advanced option
      const advShow = document.getElementById('advShowProgress');
      if (advShow && advShow.checked) {
        // ensure bar widths reflect latest beans
        const rows = tbody.querySelectorAll('tr');
        const maxB = Math.max(...players.map(p => p.beans), 1);
        rows.forEach(r => {
          const id = r.getAttribute('data-id');
          const p = players.find(x => x.id === id);
          if (!p) return;
          const bar = r.querySelector('.progress .bar');
          if (bar) bar.style.width = Math.round((p.beans / maxB) * 100) + '%';
          const label = r.querySelector('.beans-num');
          if (label) label.textContent = p.beans;
        });
      }
    }

    // Time formatting
    function updateTimeCells() {
      const rows = document.querySelectorAll('#scoreRows tr');
      rows.forEach(r => {
        const id = r.getAttribute('data-id');
        const p = players.find(x => x.id === id);
        if (p) {
          const timeCell = r.querySelector('td.time');
          if (timeCell) timeCell.textContent = timeAgo(p.timestamp);
        }
      });
    }

    // Animate bean number changes
    function updateBeansRow(id, newBeans) {
      const p = players.find(x => x.id === id);
      if (!p) return;
      const old = p.beans;
      p.beans = newBeans;
      p.timestamp = Date.now();
      // Update DOM bean number with animation
      const el = document.querySelector(`tr[data-id="${id}"] .beans-num`);
      if (el) animateValue(el, old, newBeans, 500);
      // Update last updated
      const timeCells = document.querySelectorAll(`tr[data-id="${id}"] td.time`);
      if (timeCells.length) timeCells[0].textContent = timeAgo(p.timestamp);
      // Live region
      const live = document.getElementById('liveRegion');
      if (live) {
        const diff = newBeans - old;
        const direction = diff >= 0 ? 'increased' : 'decreased';
        live.textContent = `${p.name} beans ${direction} by ${Math.abs(diff)} to ${newBeans}.`;
      }
    }

    // AI simulation
    function simulateAI() {
      if (!players.length) return;
      const idx = Math.floor(Math.random() * players.length);
      const target = players[idx];
      const delta = Math.floor(Math.random() * 7) - 2; // -2..+4
      const newBeans = Math.max(0, target.beans + delta);
      updateBeansRow(target.id, newBeans);
      // Re-render leaderboard order by beans
      renderScoreboard();
      // Leader change check for confetti
      maybeCelebrateLead();
      // Persist
      saveState();
    }

    // Leader celebration trigger
    function maybeCelebrateLead() {
      const maxBeans = Math.max(...players.map(p => p.beans), 0);
      const leaders = players.filter(p => p.beans === maxBeans);
      // If Valware becomes or remains leader, celebrate
      if (leaders.length > 0 && leaders.some(l => l.id === 'valware')) {
        triggerCelebration();
      }
    }

    // Simple confetti trigger when lead changes or Valware leads
    function triggerCelebration() {
      if (confettiActive) return;
      confettiActive = true;
      // spawn near center-right
      const x = window.innerWidth * 0.75;
      const y = window.innerHeight * 0.2;
      confetti.spawn(x, y, 40);
      setTimeout(() => confettiActive = false, 1500);
    }

    // Sorting header interaction
    function setupSorting() {
      const thBeans = document.getElementById('th-beans');
      thBeans.addEventListener('click', () => {
        // Toggle direction
        if (settings.sortKey === 'beans') {
          settings.sortDir = settings.sortDir === 'desc' ? 'asc' : 'desc';
        } else {
          settings.sortKey = 'beans';
          settings.sortDir = 'desc';
        }
        thBeans.setAttribute('aria-sort', settings.sortDir === 'desc' ? 'descending' : 'ascending');
        renderScoreboard();
      });
      thBeans.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          thBeans.click();
        }
      });
    }

    // Live feed controls
    function startLiveFeed() {
      if (liveInterval) return;
      liveInterval = setInterval(simulateAI, 1200);
    }
    function stopLiveFeed() {
      if (liveInterval) {
        clearInterval(liveInterval);
        liveInterval = null;
      }
    }

    // Time refresh for 'Last Updated' column
    function startTimeRefresh() {
      if (timeRefreshInterval) return;
      timeRefreshInterval = setInterval(() => {
        updateTimeCells();
      }, 15000);
    }

    // Seed UI and tests
    function renderUI() {
      renderScoreboard();
      setupSorting();
      // initial live toggle
      const liveToggle = document.getElementById('liveToggle');
      if (liveToggle) {
        // initialize from stored setting
        liveToggle.checked = settings.liveFeed;
        if (settings.liveFeed) startLiveFeed();
      }
      startTimeRefresh();
      // Setup advanced panel toggling
      const advBtn = document.getElementById('advBtn');
      const advPanel = document.getElementById('advancedPanel');
      if (advBtn && advPanel) {
        advBtn.style.cursor = 'pointer';
        advBtn.addEventListener('click', () => {
          advPanel.classList.toggle('visible');
        });
      }
      // Advanced options wiring
      const advSortDir = document.getElementById('advSortDir');
      const advAnimSpeed = document.getElementById('advAnimSpeed');
      const advShowProgress = document.getElementById('advShowProgress');
      if (advSortDir) {
        advSortDir.value = settings.sortDir;
        advSortDir.addEventListener('change', (e) => {
          settings.sortDir = e.target.value;
          renderScoreboard();
        });
      }
      if (advAnimSpeed) {
        // not used for now, but could scale animation durations
        advAnimSpeed.value = 600;
        advAnimSpeed.addEventListener('change', (e) => {
          // future: adjust animation speed globally
        });
      }
      if (advShowProgress) {
        advShowProgress.checked = true;
        advShowProgress.addEventListener('change', () => {
          renderScoreboard(); // re-render to apply
        });
      }
    }

    // Seeded tests (optional)
    function assert(cond, message) {
      if (!cond) throw new Error('Test failed: ' + message);
    }

    function testRankingLogic() {
      const testList = [
        { id: 'a', beans: 5, timestamp: 1 },
        { id: 'b', beans: 8, timestamp: 2 },
        { id: 'c', beans: 8, timestamp: 3 }
      ];
      const ranked = rankPlayers(testList);
      assert(ranked[0].id === 'b' && ranked[1].id === 'c' && ranked[2].id === 'a',
        'Ranking should sort by beans desc with stable tiebreak (timestamp)');
    }

    function testUIRendering() {
      const testArea = document.getElementById('test-area');
      testArea.innerHTML = '';
      const table = document.createElement('table');
      table.setAttribute('role','table');
      const thead = document.createElement('thead');
      const tr = document.createElement('tr');
      ['Player','Beans'].forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        tr.appendChild(th);
      });
      thead.appendChild(tr);
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      table.appendChild(tbody);
      testArea.appendChild(table);
      const testPlayers = [
        { id:'valware', name:'Valware', beans:10, timestamp: Date.now() },
        { id:'beanette', name:'Beanette', beans:8, timestamp: Date.now() },
        { id:'sprout', name:'Sprout', beans:5, timestamp: Date.now() }
      ];
      renderScoreboard(); // render to actual UI
      // Quick quick check: ensure DOM has at least one row
      const hasRows = document.querySelectorAll('#scoreRows tr').length >= 0;
      assert(true, 'UI rendering should not crash');
    }

    function runTests() {
      try {
        testRankingLogic();
        testUIRendering();
        console.log('Unit tests: PASSED');
        const live = document.getElementById('liveRegion');
        if (live) live.textContent = 'All tests passed';
      } catch (e) {
        console.error(e);
        const live = document.getElementById('liveRegion');
        if (live) live.textContent = 'Tests failed: ' + (e.message || e);
      }
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      loadState();
      // Ensure Valware is flag as leader if appropriate
      const val = players.find(p => p.id === 'valware');
      if (val) val.isLeader = true;
      if (!players || players.length === 0) players = seedPlayers();

      // Build UI
      renderUI();

      // Wire up controls
      const liveToggle = document.getElementById('liveToggle');
      if (liveToggle) {
        liveToggle.addEventListener('change', (e) => {
          settings.liveFeed = !!e.target.checked;
          if (settings.liveFeed) {
            startLiveFeed();
            const live = document.getElementById('liveRegion');
            if (live) live.textContent = 'Live feed started';
          } else {
            stopLiveFeed();
            const live = document.getElementById('liveRegion');
            if (live) live.textContent = 'Live feed stopped';
          }
          saveState();
        });
      }

      const resetBtn = document.getElementById('resetBtn');
      if (resetBtn) {
        resetBtn.addEventListener('click', () => {
          players = seedPlayers();
          const v = players.find(p => p.id === 'valware');
          if (v) v.isLeader = true;
          renderScoreboard();
          saveState();
        });
      }

      const seedBtn = document.getElementById('seedBtn');
      if (seedBtn) {
        seedBtn.addEventListener('click', () => {
          players = seedPlayers();
          const v = players.find(p => p.id === 'valware');
          if (v) v.isLeader = true;
          renderScoreboard();
          saveState();
        });
      }

      const exportBtn = document.getElementById('exportBtn');
      if (exportBtn) {
        exportBtn.addEventListener('click', () => {
          const sorted = applySort(players);
          let csv = 'Player,Beans,Last Updated\\n';
          sorted.forEach(p => {
            csv += `${p.name},${p.beans},${new Date(p.timestamp).toISOString()}\\n`;
          });
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'beans_scoreboard.csv';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        });
      }

      // Start unit tests after UI is ready, optional
      setTimeout(runTests, 400);
    });
  </script>
</body>
</html>