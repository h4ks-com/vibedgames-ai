<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- CSP allowing Tailwind CDN, Prism CSS/JS, inline scripts/styles, external API calls -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src  'self' 'unsafe-inline'
                       https://cdn.tailwindcss.com
                       https://cdnjs.cloudflare.com;
          style-src   'self' 'unsafe-inline'
                       https://cdnjs.cloudflare.com;
          connect-src 'self'
                       https://g4f.cloud.mattf.one
                       https://s.h4ks.com/api/;
          frame-src   'self';
        ">

  <title>AI Vibe Web App Creator</title>

  <!-- Prism CSS theme from CDNJS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-tomorrow.min.css"
    integrity="sha512-4y8lMx5+XKj0ZTXMFGh832i6f9orddel+go2USi0nOwTARl4nGZ4WLgV0TlGj0vSTmZ9uQg6goHaT1FNVx3aYw=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Dark theme styling */
    body {
      background-color: #111827;
      color: #d1d5db;
    }

    /* Code output area */
    #codeOutput pre {
      white-space: pre-wrap;
      background: #1f2937;
      border: 1px solid #4b5563;
      padding: 10px;
      overflow: auto;
      flex: 1;              /* grow to fill available vertical space */
      box-sizing: border-box;
    }

    /* Spinner styling (no display setting here) */
    .spinner {
      margin: auto;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Hidden helper */
    .hidden { display: none; }

    /* Full height flex containers */
    #container { height: 100vh; display: flex; }
    #inputArea, #codeOutput, #previewArea {
      display: flex; flex-direction: column;
    }
    #inputArea, #codeOutput, #previewArea { flex: 1; }
  </style>

  <!-- Prism JS -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"
    integrity="sha512-2pHQhZLBPoYG2s1HKPylfB8VKc4OQpjpCcihLkBuR6DjVWRcFeZcNUMeeuqiD93/s09Wk0YCxbgoFbkYGU6+gQ=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
    defer
  ></script>
</head>
<body>
  <div id="container">
    <!-- Input Area -->
    <div id="inputArea" class="w-1/3 p-4 border-r border-gray-600">
      <h2 class="text-lg font-semibold text-gray-100 mb-2">Input Prompt</h2>
      <textarea id="promptInput"
                class="flex-1 p-2 rounded border border-gray-600 bg-gray-800 text-white mb-2"
                placeholder="Enter your prompt here…"></textarea>
      <button id="generateButton"
              class="p-2 bg-blue-600 text-white rounded hover:bg-blue-500 mb-2">
        Generate Code
      </button>
      <button id="publishButton"
              class="p-2 bg-purple-600 text-white rounded hover:bg-purple-500">
        Publish Game
      </button>
    </div>

    <!-- Code Output Area -->
    <div id="codeOutput" class="w-1/3 p-4 bg-gray-900 border-r border-gray-600 flex">
      <div class="flex flex-col w-full">
        <h2 class="text-lg font-semibold text-gray-100 mb-2">Code Output</h2>
        <pre><code id="codeOutputCode" class="language-html">Generated code will appear here…</code></pre>
        <button id="copyButton"
                class="mt-2 p-2 bg-green-600 text-white rounded hover:bg-green-500">
          Copy Code
        </button>
      </div>
    </div>

    <!-- Preview Area -->
    <div id="previewArea" class="w-1/3 p-4 bg-white flex flex-col">
      <h2 class="text-lg font-semibold text-gray-800 mb-2">Preview</h2>
      <div class="flex-1 flex justify-center items-center relative">
        <div class="spinner hidden" id="spinner"></div>
        <iframe id="previewFrame" class="w-full h-full border-none hidden"></iframe>
      </div>
    </div>
  </div>

  <script>
    const generateBtn   = document.getElementById('generateButton');
    const publishBtn    = document.getElementById('publishButton');
    const copyBtn       = document.getElementById('copyButton');
    const promptInput   = document.getElementById('promptInput');
    const spinner       = document.getElementById('spinner');
    const previewFrame  = document.getElementById('previewFrame');
    const codeElem      = document.getElementById('codeOutputCode');

    generateBtn.addEventListener('click', async () => {
      const prompt = promptInput.value.trim();
      if (!prompt) return alert("Please enter a prompt.");

      const fullPrompt = prompt + ". Everything should be done in a single HTML file for a web page.";

      // show spinner, hide preview
      spinner.classList.remove('hidden');
      previewFrame.classList.add('hidden');

      try {
        const res = await fetch('https://g4f.cloud.mattf.one/api/completions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages: [{ role: 'user', content: fullPrompt }] })
        });

        spinner.classList.add('hidden');

        if (!res.ok) {
          const err = await res.text();
          return alert("Error: " + err);
        }

        const data = await res.json();
        const text = data.completion || "";
        const match = /```(?:\w+)?\n([\s\S]*?)```/.exec(text);
        const code = (match && match[1]) ? match[1].trim() : text;

        // update code block and highlight
        codeElem.textContent = code;
        Prism.highlightElement(codeElem);

        // show preview
        previewFrame.classList.remove('hidden');
        const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;
        doc.open();
        doc.write(code);
        doc.close();
      } catch (e) {
        spinner.classList.add('hidden');
        alert("Network error: " + e);
      }
    });

    copyBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(codeElem.textContent)
        .then(() => alert("Code copied to clipboard!"))
        .catch(err => alert("Copy failed: " + err));
    });

    publishBtn.addEventListener('click', async () => {
      const form = new FormData();
      form.append('code', codeElem.textContent);

      try {
        const res = await fetch('https://s.h4ks.com/api/', {
          method: 'POST',
          body: form
        });
        if (!res.ok) {
          const err = await res.text();
          return alert("Publish error: " + err);
        }
        const result = await res.text();
        alert("Game published successfully: " + result);
      } catch (e) {
        alert("Publish network error: " + e);
      }
    });
  </script>
</body>
</html>
