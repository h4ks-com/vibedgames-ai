<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Headline Code Wars: Google Search Edition</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --panel-bg: #1e293b;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --success: #22c55e;
            --danger: #ef4444;
            --font-mono: 'Courier New', Courier, monospace;
            --font-sans: system-ui, -apple-system, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-sans);
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        header {
            background-color: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        h1 {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-badge {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            background: var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .loading-dot {
            width: 8px; height: 8px; background-color: var(--accent-primary);
            border-radius: 50%; animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1); } }

        /* Layout */
        main { display: grid; grid-template-columns: 1fr 350px; flex: 1; overflow: hidden; }
        @media (max-width: 900px) { main { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; } }

        /* Tournament Arena */
        #arena {
            padding: 2rem; display: flex; flex-direction: column;
            align-items: center; justify-content: center; position: relative;
            background-image: radial-gradient(circle at center, #1e293b 0%, #0f172a 70%);
            overflow-y: auto;
        }

        .headline-card {
            background: var(--panel-bg); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 1.5rem; width: 40%;
            display: flex; flex-direction: column; gap: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .headline-card.winner { border-color: var(--success); box-shadow: 0 0 20px rgba(34, 197, 94, 0.2); transform: scale(1.05); }
        .headline-card.loser { opacity: 0.5; filter: grayscale(100%); transform: scale(0.95); }

        .headline-text { font-size: 1.1rem; font-weight: 600; min-height: 3rem; display: flex; align-items: center; }

        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;
            font-family: var(--font-mono); font-size: 0.8rem; color: var(--text-muted);
            background: rgba(0, 0, 0, 0.2); padding: 0.5rem; border-radius: 6px;
        }
        .stat-item span:last-child { color: var(--text-main); float: right; }
        .score-display { font-size: 2.5rem; font-weight: 800; text-align: center; font-family: var(--font-mono); }

        .battle-container { display: flex; gap: 2rem; align-items: center; width: 100%; max-width: 900px; justify-content: center; }
        .vs-divider { font-size: 2rem; font-weight: 900; color: var(--text-muted); font-style: italic; }
        .controls { margin-top: 2rem; display: flex; gap: 1rem; }

        button {
            background: var(--accent-primary); color: white; border: none; padding: 0.75rem 1.5rem;
            border-radius: 6px; font-weight: 600; cursor: pointer; transition: background 0.2s;
        }
        button:hover { background: #2563eb; }
        button:disabled { background: var(--border-color); cursor: not-allowed; opacity: 0.7; }
        button.secondary { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); }
        button.secondary:hover { border-color: var(--text-main); color: var(--text-main); }

        /* Search Input */
        .search-box {
            display: flex; gap: 10px; margin-bottom: 2rem; justify-content: center;
        }
        input[type="text"] {
            background: var(--panel-bg); border: 1px solid var(--border-color);
            color: white; padding: 0.75rem 1rem; border-radius: 6px;
            font-family: var(--font-mono); width: 250px;
        }
        input[type="text"]:focus { outline: 2px solid var(--accent-primary); border-color: transparent; }

        /* Sidebar */
        #sidebar { background: var(--panel-bg); border-left: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; }
        @media (max-width: 900px) { #sidebar { border-left: none; border-top: 1px solid var(--border-color); } }

        .tabs { display: flex; border-bottom: 1px solid var(--border-color); }
        .tab-btn { flex: 1; padding: 1rem; background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--text-muted); font-weight: 600; }
        .tab-btn.active { color: var(--accent-primary); border-bottom-color: var(--accent-primary); background: rgba(59, 130, 246, 0.05); }

        .tab-content { flex: 1; overflow-y: auto; padding: 1rem; display: none; }
        .tab-content.active { display: block; }

        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border-color); }
        th { color: var(--text-muted); font-weight: 500; font-size: 0.8rem; text-transform: uppercase; }
        .rank-cell { font-family: var(--font-mono); width: 40px; color: var(--accent-secondary); }

        /* Tree */
        .tree-container { padding-bottom: 2rem; }
        .bracket-list { list-style: none; }
        .bracket-item { margin: 10px 0; position: relative; }
        .bracket-content {
            background: var(--bg-color); border: 1px solid var(--border-color); padding: 8px;
            border-radius: 4px; cursor: pointer; transition: all 0.2s;
        }
        .bracket-content:hover { border-color: var(--text-muted); }
        .bracket-children { margin-left: 20px; border-left: 1px solid var(--border-color); padding-left: 10px; display: none; }
        .bracket-item.expanded > .bracket-children { display: block; animation: slideDown 0.3s ease-out; }
        .bracket-toggle { display: inline-block; width: 16px; text-align: left; color: var(--accent-primary); font-weight: bold; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Modal & Logs */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal {
            background: var(--panel-bg); padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;
            text-align: center; border: 1px solid var(--border-color); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .code-block { background: #000; padding: 1rem; border-radius: 6px; font-family: var(--font-mono); text-align: left; margin: 1rem 0; color: #a5b4fc; font-size: 0.9rem; overflow-x: auto; }
        
        .console-log { font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-muted); margin-top: 1rem; padding: 0.5rem; background: #000; border-radius: 4px; max-height: 100px; overflow-y: auto; }
        .log-time { color: var(--accent-secondary); margin-right: 8px; }
        
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<header>
    <h1>Headline Code Wars: Google Search</h1>
    <div id="game-status" class="status-badge">
        <span id="status-dot" class="loading-dot hidden"></span>
        <span id="status-text">Ready</span>
    </div>
</header>

<main>
    <!-- Battle Arena -->
    <section id="arena">
        <div id="welcome-screen" class="fade-in" style="text-align: center;">
            <h2 style="margin-bottom: 1rem; font-size: 2rem;">Search & Destroy Tournament</h2>
            
            <div class="search-box">
                <input type="text" id="search-input" value="news" placeholder="Enter topic (e.g. AI, Crypto)">
            </div>

            <p style="color: var(--text-muted); margin-bottom: 2rem; max-width: 600px; margin-left: auto; margin-right: auto;">
                We will perform a live Google News search for your topic. 
                The top results will battle based on algorithmic complexity.
            </p>
            <button id="btn-start" onclick="game.startTournament()">Fetch Headlines & Start</button>
        </div>

        <div id="loading-spinner" class="hidden" style="text-align: center;">
            <div style="width: 40px; height: 40px; border: 4px solid var(--border-color); border-top: 4px solid var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem auto;"></div>
            <p style="color: var(--text-muted);">Executing Google Search...</p>
        </div>

        <div id="battle-view" class="hidden" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
            <div class="battle-container">
                <!-- Fighter A -->
                <div id="fighter-a-card" class="headline-card">
                    <div id="fighter-a-text" class="headline-text">Loading...</div>
                    <div class="stats-grid">
                        <div class="stat-item"><span>Entropy</span> <span id="fighter-a-entropy">0</span></div>
                        <div class="stat-item"><span>Sentiment</span> <span id="fighter-a-sentiment">0</span></div>
                        <div class="stat-item"><span>Length</span> <span id="fighter-a-length">0</span></div>
                        <div class="stat-item"><span>Hash</span> <span id="fighter-a-hash">0</span></div>
                    </div>
                    <div class="score-display" id="fighter-a-score">0</div>
                </div>

                <div class="vs-divider">VS</div>

                <!-- Fighter B -->
                <div id="fighter-b-card" class="headline-card">
                    <div id="fighter-b-text" class="headline-text">Loading...</div>
                    <div class="stats-grid">
                        <div class="stat-item"><span>Entropy</span> <span id="fighter-b-entropy">0</span></div>
                        <div class="stat-item"><span>Sentiment</span> <span id="fighter-b-sentiment">0</span></div>
                        <div class="stat-item"><span>Length</span> <span id="fighter-b-length">0</span></div>
                        <div class="stat-item"><span>Hash</span> <span id="fighter-b-hash">0</span></div>
                    </div>
                    <div class="score-display" id="fighter-b-score">0</div>
                </div>
            </div>

            <div class="controls">
                <button id="btn-next-battle" onclick="game.nextBattle()">Simulate Match</button>
                <button id="btn-auto" class="secondary" onclick="game.toggleAutoPlay()">Auto Play</button>
            </div>

            <div id="battle-log" class="console-log">
                <div class="log-entry">> System Ready...</div>
            </div>
        </div>
    </section>

    <!-- Sidebar -->
    <section id="sidebar">
        <div class="tabs">
            <button class="tab-btn active" onclick="ui.switchTab('rankings')">Rankings</button>
            <button class="tab-btn" onclick="ui.switchTab('tree')">Bracket Tree</button>
        </div>

        <div id="tab-rankings" class="tab-content active">
            <table id="ranking-table">
                <thead>
                    <tr>
                        <th style="width: 50px">#</th>
                        <th>Headline</th>
                        <th style="width: 60px; text-align: right;">Score</th>
                    </tr>
                </thead>
                <tbody id="ranking-body"></tbody>
            </table>
        </div>

        <div id="tab-tree" class="tab-content">
            <div id="bracket-root" class="tree-container">
                <p style="color: var(--text-muted); text-align: center; font-style: italic;">Start tournament to generate bracket tree.</p>
            </div>
        </div>
    </section>
</main>

<div id="winner-modal" class="modal-overlay">
    <div class="modal">
        <h2>üèÜ Search Champion</h2>
        <p>The most complex headline from your search.</p>
        <div class="code-block" id="winner-code">// Result pending...</div>
        <h3 id="winner-headline-text" style="margin: 1rem 0; color: var(--text-main);">Headline</h3>
        <p style="color: var(--accent-primary); font-family: var(--font-mono); font-size: 1.2rem;">Final Score: <span id="winner-final-score">0</span></p>
        <button onclick="location.reload()" style="margin-top: 2rem;">New Search</button>
    </div>
</div>

<style> @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } </style>

<script>
    /**
     * Data Fetching Logic
     * Uses Google News RSS Search API via a JSON proxy to bypass CORS
     */
    async function fetchGoogleHeadlines(query) {
        ui.updateStatus(`Searching Google for "${query}"...`, true);
        
        // Construct the Google News RSS Search URL
        const rssUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=en-US&gl=US&ceid=US:en`;
        const proxyUrl = 'https://api.rss2json.com/v1/api.json?rss_url=';

        try {
            const response = await fetch(`${proxyUrl}${encodeURIComponent(rssUrl)}`);
            if (!response.ok) throw new Error("Network response was not ok");
            
            const data = await response.json();
            
            // Clean titles (remove " - SourceName")
            const headlines = data.items
                .map(item => item.title.replace(/ - .*$/, ''))
                .filter(title => title.length > 10 && title.length < 100);

            if (headlines.length === 0) throw new Error("No results found");

            return headlines.slice(0, 16); 

        } catch (error) {
            console.error("Fetch error:", error);
            ui.log(`Error fetching for "${query}". Using fallback data.`);
            return FALLBACK_HEADLINES;
        }
    }

    const FALLBACK_HEADLINES = [
        "Local Cat Elected Mayor, Promises Infinite Tuna",
        "Scientists Discover Coffee Actually Makes You Smarter",
        "Stock Market Crashes Because Someone Spilled Latte",
        "AI Takes Over Customer Service, Asks How It Can Help",
        "Mars Colony Reports First Case of Space Boredom",
        "Time Travelers Protest Against Historical Inaccuracies",
        "Global Wi-Fi Signal Found in Ancient Pyramids",
        "Vegetables Launch Protest Against Being Boiled"
    ];

    /**
     * Core Logic: Statistical Analysis of Strings
     */
    const HeadlineAnalyzer = {
        hashCode: function(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash = hash & hash;
            }
            return Math.abs(hash);
        },
        getEntropy: function(str) {
            const freq = {};
            for(let char of str) freq[char] = (freq[char] || 0) + 1;
            let entropy = 0;
            for(let key in freq) {
                const p = freq[key] / str.length;
                entropy -= p * Math.log2(p);
            }
            return parseFloat(entropy.toFixed(2));
        },
        getSentiment: function(str) {
            const positive = ["win", "good", "best", "love", "smart", "infinite", "soar", "cute", "help", "growth", "rise", "gain", "breakthrough"];
            const negative = ["crashes", "broken", "protest", "boredom", "accidentally", "boiled", "fall", "loss", "drop", "death", "kill", "crisis", "fail"];
            
            let score = 50;
            str = str.toLowerCase();
            positive.forEach(w => { if(str.includes(w)) score += 5; });
            negative.forEach(w => { if(str.includes(w)) score -= 5; });
            return Math.min(100, Math.max(0, score));
        },
        calculateScore: function(str) {
            const hash = this.hashCode(str);
            const entropy = this.getEntropy(str);
            const sentiment = this.getSentiment(str);
            const length = str.length;
            const complexity = (entropy * 10) + (length * 0.5);
            const luck = (hash % 50); 
            const power = Math.floor(complexity + sentiment + luck);
            return {
                text: str,
                score: power,
                stats: { entropy: entropy, sentiment: sentiment, length: length, hash: hash }
            };
        }
    };

    /**
     * Game State Management
     */
    class TournamentGame {
        constructor() {
            this.headlines = [];
            this.brackets = [];
            this.currentRoundIndex = 0;
            this.currentMatchIndex = 0;
            this.isAutoPlaying = false;
        }

        async startTournament() {
            const searchTerm = document.getElementById('search-input').value || "news";
            
            // UI Transition
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('loading-spinner').classList.remove('hidden');

            // Fetch Data
            const rawTitles = await fetchGoogleHeadlines(searchTerm);
            
            // Process Data
            const shuffled = rawTitles.sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, 8);
            this.headlines = selected.map(h => HeadlineAnalyzer.calculateScore(h));
            
            this.initBracket();
            
            // UI Transition to Game
            document.getElementById('loading-spinner').classList.add('hidden');
            ui.showBattleView();
            this.updateRankings();
            this.loadMatch();
        }

        initBracket() {
            this.brackets = [];
            let round1 = [];
            for(let i=0; i<this.headlines.length; i+=2) {
                round1.push({
                    id: `r1-m${i/2}`,
                    p1: this.headlines[i],
                    p2: this.headlines[i+1],
                    winner: null,
                    round: 1
                });
            }
            this.brackets.push(round1);
            ui.log(`Tournament initialized. Source: Google Search for "${document.getElementById('search-input').value}"`);
        }

        getCurrentMatch() { return this.brackets[this.currentRoundIndex][this.currentMatchIndex]; }

        loadMatch() {
            if (this.currentRoundIndex >= this.brackets.length) { this.endTournament(); return; }
            const round = this.brackets[this.currentRoundIndex];
            if (this.currentMatchIndex >= round.length) { this.prepareNextRound(); return; }
            
            ui.updateArena(this.getCurrentMatch());
            ui.updateStatus(`Round ${this.currentRoundIndex + 1}, Match ${this.currentMatchIndex + 1}`);
        }

        prepareNextRound() {
            const currentRound = this.brackets[this.currentRoundIndex];
            const nextRoundMatches = [];
            for(let i=0; i<currentRound.length; i+=2) {
                const m1 = currentRound[i];
                const m2 = currentRound[i+1];
                nextRoundMatches.push({
                    id: `r${this.currentRoundIndex + 2}-m${i/2}`,
                    p1: m1.winner,
                    p2: m2.winner,
                    winner: null,
                    round: this.currentRoundIndex + 2,
                    parents: [m1.id, m2.id]
                });
            }
            this.brackets.push(nextRoundMatches);
            this.currentRoundIndex++;
            this.currentMatchIndex = 0;
            ui.renderTree(this.brackets);
            this.loadMatch();
        }

        simulateMatch() {
            const match = this.getCurrentMatch();
            if (match.p1.score > match.p2.score) match.winner = match.p1;
            else if (match.p2.score > match.p1.score) match.winner = match.p2;
            else match.winner = match.p1.stats.hash > match.p2.stats.hash ? match.p1 : match.p2;

            ui.showResult(match);
            ui.updateTreeNode(match);

            this.currentMatchIndex++;
            
            if (this.currentRoundIndex === this.brackets.length - 1 && 
                this.currentMatchIndex >= this.brackets[this.currentRoundIndex].length) {
                setTimeout(() => this.endTournament(), 1500);
            } else {
                if (this.isAutoPlaying) setTimeout(() => this.nextBattle(), 1500);
            }
        }

        nextBattle() {
            this.simulateMatch();
            if (this.currentRoundIndex < this.brackets.length && 
               !(this.currentRoundIndex === this.brackets.length - 1 && this.currentMatchIndex >= this.brackets[this.currentRoundIndex].length)) {
                 this.loadMatch();
            }
        }

        toggleAutoPlay() {
            this.isAutoPlaying = !this.isAutoPlaying;
            const btn = document.getElementById('btn-auto');
            if (this.isAutoPlaying) {
                btn.textContent = "Stop Auto"; btn.style.borderColor = "var(--danger)"; btn.style.color = "var(--danger)";
                document.getElementById('btn-next-battle').disabled = true;
                this.nextBattle();
            } else {
                btn.textContent = "Auto Play"; btn.style.borderColor = "var(--border-color)"; btn.style.color = "var(--text-muted)";
                document.getElementById('btn-next-battle').disabled = false;
            }
        }

        updateRankings() {
            const all = [...this.headlines].sort((a, b) => b.score - a.score);
            ui.renderRankings(all);
        }

        endTournament() {
            this.isAutoPlaying = false;
            const champion = this.brackets[this.brackets.length-1][0].winner;
            ui.showWinnerModal(champion);
        }
    }

    /**
     * UI Controller
     */
    const ui = {
        switchTab: (tabName) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const buttons = document.querySelectorAll('.tab-btn');
            if(tabName === 'rankings') buttons[0].classList.add('active');
            if(tabName === 'tree') buttons[1].classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        },
        updateStatus: (text, isLoading = false) => {
            document.getElementById('status-text').textContent = text;
            const dot = document.getElementById('status-dot');
            isLoading ? dot.classList.remove('hidden') : dot.classList.add('hidden');
        },
        showBattleView: () => {
            document.getElementById('battle-view').classList.remove('hidden');
            document.getElementById('battle-view').classList.add('fade-in');
        },
        updateArena: (match) => {
            const cardA = document.getElementById('fighter-a-card');
            const cardB = document.getElementById('fighter-b-card');
            cardA.className = 'headline-card'; cardB.className = 'headline-card';
            
            document.getElementById('fighter-a-text').textContent = match.p1.text;
            document.getElementById('fighter-b-text').textContent = match.p2.text;
            
            document.getElementById('fighter-a-entropy').textContent = match.p1.stats.entropy;
            document.getElementById('fighter-a-sentiment').textContent = match.p1.stats.sentiment + '%';
            document.getElementById('fighter-a-length').textContent = match.p1.stats.length;
            document.getElementById('fighter-a-hash').textContent = '0x' + match.p1.stats.hash.toString(16).substr(0,4);
            
            document.getElementById('fighter-b-entropy').textContent = match.p2.stats.entropy;
            document.getElementById('fighter-b-sentiment').textContent = match.p2.stats.sentiment + '%';
            document.getElementById('fighter-b-length').textContent = match.p2.stats.length;
            document.getElementById('fighter-b-hash').textContent = '0x' + match.p2.stats.hash.toString(16).substr(0,4);
            
            document.getElementById('fighter-a-score').textContent = match.p1.score;
            document.getElementById('fighter-b-score').textContent = match.p2.score;
            
            ui.log(`Battle: ${match.p1.text.substring(0,15)}... vs ${match.p2.text.substring(0,15)}...`);
        },
        showResult: (match) => {
            const cardA = document.getElementById('fighter-a-card');
            const cardB = document.getElementById('fighter-b-card');
            if (match.winner === match.p1) {
                cardA.classList.add('winner'); cardB.classList.add('loser');
                ui.log(`Winner: Score ${match.p1.score}`);
            } else {
                cardB.classList.add('winner'); cardA.classList.add('loser');
                ui.log(`Winner: Score ${match.p2.score}`);
            }
        },
        renderRankings: (sortedHeadlines) => {
            const tbody = document.getElementById('ranking-body');
            tbody.innerHTML = '';
            sortedHeadlines.forEach((h, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="rank-cell">${index + 1}</td><td>${h.text}</td><td style="text-align: right; font-family: var(--font-mono);">${h.score}</td>`;
                tbody.appendChild(tr);
            });
        },
        renderTree: (brackets) => {
            const root = document.getElementById('bracket-root');
            root.innerHTML = '';
            const findMatch = (id) => brackets.flat().find(m => m.id === id);
            
            const buildNode = (match) => {
                if (!match) return document.createElement('li');
                const li = document.createElement('li');
                li.className = 'bracket-item';
                
                const content = document.createElement('div');
                content.className = 'bracket-content';
                const winnerName = match.winner ? match.winner.text.substring(0, 18) + "..." : "Pending";
                const toggle = document.createElement('span');
                toggle.className = 'bracket-toggle';
                
                const hasChildren = match.parents && match.parents.length > 0;
                if (hasChildren) {
                    toggle.textContent = '[-]'; li.classList.add('expanded');
                    toggle.onclick = (e) => {
                        e.stopPropagation(); li.classList.toggle('expanded');
                        toggle.textContent = li.classList.contains('expanded') ? '[-]' : '[+]';
                    };
                } else toggle.textContent = '‚Ä¢';
                
                content.innerHTML = `<div style="font-size:0.7rem; color:var(--accent-secondary)">${match.id}</div><div style="font-weight:600">${winnerName}</div>`;
                content.prepend(toggle); li.appendChild(content);
                
                if (hasChildren) {
                    const ul = document.createElement('ul');
                    ul.className = 'bracket-list bracket-children';
                    match.parents.forEach(pid => { const pm = findMatch(pid); if(pm) ul.appendChild(buildNode(pm)); });
                    li.appendChild(ul);
                }
                return li;
            };
            
            const finalMatch = brackets[brackets.length-1][0];
            const ul = document.createElement('ul'); ul.className = 'bracket-list';
            ul.appendChild(buildNode(finalMatch)); root.appendChild(ul);
        },
        updateTreeNode: (match) => { /* Tree auto-renders on round advance */ },
        log: (msg) => {
            const logEl = document.getElementById('battle-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString([], {hour12: false});
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${msg}`;
            logEl.appendChild(entry); logEl.scrollTop = logEl.scrollHeight;
        },
        showWinnerModal: (winner) => {
            document.getElementById('winner-modal').classList.add('active');
            document.getElementById('winner-headline-text').textContent = winner.text;
            document.getElementById('winner-final-score').textContent = winner.score;
            document.getElementById('winner-code').textContent = `const champion = {\n  headline: "${winner.text.replace(/"/g, "'")}",\n  score: ${winner.score}\n};`;
        }
    };

    const game = new TournamentGame();
</script>
</body>
</html>