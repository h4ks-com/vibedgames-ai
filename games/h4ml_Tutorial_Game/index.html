<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>H4ML Tutorial Game - Enhanced</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f111a;
      --panel: #141923;
      --muted: #8b93a7;
      --fg: #e8eaf6;
      --accent: #66e0c7;
      --accent2: #7aa2ff;
      --good: #4bd37b;
      --bad: #e05a5a;
      --card: #1b1f2a;
      --border: #2a324a;
      --shadow: 0 6px 20px rgba(0,0,0,.25);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: Inter, system-ui, -apple-system, Arial; background: radial-gradient(circle at 20% -10%, rgba(102,224,199,0.15), transparent 40%), radial-gradient(circle at 100% 0, rgba(122,162,255,0.12), transparent 40%), var(--bg); color: var(--fg); overflow: hidden; }

    /* Animated background canvas */
    #bgCanvas { position: fixed; top:0; left:0; width:100%; height:100%; z-index:0; pointer-events:none; opacity:.6; }

    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 20px; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; background: rgba(20,25,35,0.95); z-index: 10;
      backdrop-filter: saturate(1.1) blur(2px);
    }
    header h1 { font-size: 20px; margin: 0; letter-spacing: .4px; }
    .header-right { display: flex; gap: 12px; align-items: center; }
    .badge { padding: 6px 12px; border-radius: 999px; background: #1e2540; color: #d6dcff; font-size: 12px; border: 1px solid #2b3563; display: inline-flex; align-items: center; gap:6px; }
    .btn { padding: 8px 12px; border-radius: 8px; border: 1px solid #2f3a7a; background: #1b2850; color: #e6e9ff; cursor: pointer; transition: transform .2s ease, background .2s ease; }
    .btn.secondary { background: #2a2a2a; border-color: #444; color: #ddd; }
    .btn.success { background: #144a2a; border-color: #226a43; color: #d7ffe7; }
    .btn.warning { background: #3a2a00; border-color: #8a5800; color: #ffd7a1; }

    .container {
      display: grid; grid-template-columns: 290px 1fr 360px; gap: 16px; padding: 16px; height: calc(100vh - 72px);
      position: relative; z-index: 1;
    }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 12px; overflow: auto; height: calc(100% - 4px); box-shadow: var(--shadow); }
    .panel-header { font-weight: bold; font-size: 14px; color: #e9edff; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .missions-list { display: flex; flex-direction: column; gap: 8px; }
    .mission-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px; border-radius: 8px; border: 1px solid var(--border);
      background: rgba(20,24,38,0.8); cursor: pointer;
      transition: transform .15s ease;
    }
    .mission-item:hover { transform: translateY(-1px); }
    .mission-item.active { outline: 2px solid var(--accent); background: rgba(102,224,199,0.15); }
    .mission-title { font-weight: 600; font-size: 13px; }
    .status { font-size: 12px; padding: 4px 8px; border-radius: 999px; }
    .status.locked { background: #2a2a2a; color: #7f7f7f; border: 1px solid #444; }
    .status.solved { background: #0a3; color: #fff; border: 1px solid #1e9a62; }
    .status.pending { background: #2e2e2e; color: #e6e6e6; border: 1px solid #444; }

    .editor { width: 100%; height: 260px; resize: vertical; background: #0a0e18; color: #e9f0ff; border: 1px solid #2c3a68; border-radius: 8px; padding: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .preview { min-height: 180px; border: 1px solid var(--border); border-radius: 8px; padding: 10px; background: #0b0f1a; white-space: pre-wrap; word-break: break-word; }

    .buttons { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .hint { font-size: 12px; color: var(--muted); margin-top: 6px; min-height: 18px; }

    .section { margin-bottom: 12px; }
    .section h3 { margin: 0 0 6px; font-size: 14px; }

    .reference-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .card { padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: rgba(18,23,40,0.9); }
    ul { padding-left: 18px; margin: 0; }
    li { margin: 6px 0; }

    .snippet { background: #0a0f1a; border: 1px solid #2c3a68; padding: 8px; border-radius: 6px; font-family: ui-monospace, monospace; white-space: pre; overflow: auto; max-height: 120px; }
    .snippet-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; }

    .achievements { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .achv { padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: #151a2b; }
    .achv.locked { opacity: .5; }
    .achv .name { font-weight: 600; font-size: 13px; }
    .achv .desc { font-size: 12px; color: var(--muted); }

    .progress { width: 100%; height: 12px; background: #1e1e2e; border-radius: 999px; overflow: hidden; border: 1px solid #2a2a5a; }
    .progress > span { display: block; height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); }

    /* Fancy floating icons */
    .glow {
      position: relative;
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(102,224,199,.15);
      border: 1px solid rgba(102,224,199,.5);
      animation: glow 2.5s infinite;
    }
    @keyframes glow {
      0%,100% { box-shadow: 0 0 6px rgba(102,224,199,.0); }
      50% { box-shadow: 0 0 14px rgba(102,224,199,.8); }
    }

    /* Responsive */
    @media (max-width: 1100px) {
      .container { grid-template-columns: 1fr; height: auto; overflow: auto; }
      #bgCanvas { display: none; }
      .header-right { flex-wrap: wrap; }
    }

    /* Confetti canvas overlay */
    #confettiLayer { position: fixed; pointer-events: none; left: 0; top: 0; width: 100%; height: 100%; z-index: 9999; overflow: hidden; }
    .confetto { position: absolute; width: 10px; height: 14px; border-radius: 2px; opacity: 0; transform: translateY(-20px) rotate(0deg); }

  </style>
</head>
<body>
  <canvas id="bgCanvas"></canvas>
  <div id="confettiLayer" aria-hidden="true"></div>

  <header>
    <div class="glow" style="font-weight:700; letter-spacing:.4px;">H4ML Enhanced Tutorial</div>
    <div class="header-right">
      <span class="badge" id="scoreBadge" title="Total points earned">Score: 0</span>
      <span class="badge" id="progressBadge" title="Missions completed">Missions: 0/0</span>
      <button class="btn" id="themeToggle" title="Toggle theme">Theme</button>
      <button class="btn secondary" id="exportBtn" title="Export state">Export</button>
    </div>
  </header>

  <div class="container" id="appContainer">
    <aside class="panel" id="leftPanel">
      <div class="panel-header">Missions</div>
      <div class="missions-list" id="missionsList"></div>
    </aside>

    <section class="panel" id="centerPanel">
      <div class="panel-header" id="centerPanelHeader">
        Mission View
        <span id="quickStats" style="font-size:12px; opacity:.8;"></span>
      </div>
      <div id="missionView" class="section" style="display: none;">
        <div id="missionDescription" class="card" style="margin-bottom:8px;"></div>
        <textarea id="editor" class="editor" spellcheck="false"></textarea>
        <div class="buttons">
          <button id="runBtn" class="btn">Run</button>
          <button id="hintBtn" class="btn secondary">Hint</button>
          <button id="resetBtn" class="btn secondary">Reset</button>
          <button id="celebrateBtn" class="btn success" title="Celebrate on success">Celebrate</button>
        </div>
        <div class="hint" id="hintArea"></div>
        <div class="section" style="margin-top:12px;">
          <div class="preview" id="previewArea"></div>
        </div>
        <div class="section" id="gradingFeedback" style="margin-top:8px; min-height: 20px;"></div>
      </div>

      <div id="referenceOverview" class="section" style="display:none;">
        <div class="section card" id="referenceGlossary">
          <h3>Glossary</h3>
          <ul id="glossaryList"></ul>
        </div>
        <div class="section card" id="referenceCheatsheet" style="margin-top:12px;">
          <h3>Syntax Cheatsheet</h3>
          <ul id="cheatsheetList"></ul>
        </div>
        <div class="section card" id="referenceExamples" style="margin-top:12px;">
          <h3>Example Snippets</h3>
          <div id="snippetsContainer"></div>
        </div>
      </div>
    </section>

    <aside class="panel" id="rightPanel">
      <div class="panel-header">Achievements</div>
      <div class="achievements" id="achievementsList"></div>
      <div class="panel-header" style="margin-top:8px;">Progress</div>
      <div class="progress" title="Progress">
        <span id="progressBar" style="width:0%"></span>
      </div>
      <div style="font-size:12px; color:var(--muted); margin-top:6px;">
        Unlocked as you complete missions. Some achievements require multiple steps.
      </div>
      <div class="panel-header" style="margin-top:8px; padding-top:6px;">Live Tips</div>
      <div id="liveTips" style="font-size:12px; color:var(--muted); padding-bottom:6px;">
        Pro tip: Curate your code to match the exact HTML; use Ctrl/Cmd + Enter to Run.
      </div>
    </aside>
  </div>

  <script>
    // Data definitions
    const MISSIONS = [
      {
        id: 1,
        title: "First Elements: Heading and Paragraph",
        description: "Create a heading and a paragraph using h4ml syntax. Use the lines below as your guide.",
        code: "h1: Welcome to H4ML\np: This is your first h4ml document.",
        expected: "<h1>Welcome to H4ML</h1><p>This is your first h4ml document.</p>",
        points: 10,
        hints: [
          "Each line uses the format 'tag: content'.",
          "Supported tags: h1, h2, h3, p, code."
        ]
      },
      {
        id: 2,
        title: "Subheading and Description",
        description: "Add a subheading and a paragraph to structure your content.",
        code: "h2: Features\np: H4ML is simple and offline-capable.",
        expected: "<h2>Features</h2><p>H4ML is simple and offline-capable.</p>",
        points: 15,
        hints: [
          "Line order matters for rendering.",
          "Try combining different tags."
        ]
      },
      {
        id: 3,
        title: "Inline Code Snippet",
        description: "Show a code snippet using the code tag.",
        code: "code: console.log('Hello, H4ML!');",
        expected: "<code>console.log('Hello, H4ML!');</code>",
        points: 20,
        hints: [
          "Use the tag 'code' for inline blocks.",
          "Keep content as plain text inside code."
        ]
      },
      {
        id: 4,
        title: "Composite: Multiple Elements",
        description: "Combine a heading, a paragraph, and a code snippet.",
        code: "h1: Deep Dive into H4ML\np: Learn by building small tasks.\ncode: print('That’s neat!')",
        expected: "<h1>Deep Dive into H4ML</h1><p>Learn by building small tasks.</p><code>print('That’s neat!')</code>",
        points: 30,
        hints: [
          "Each line creates one element in sequence.",
          "Whitespace is ignored between lines."
        ]
      },
      {
        id: 5,
        title: "List & Emphasis",
        description: "Create a paragraph with a long list represented by multiple lines.",
        code: "p: This is a paragraph.\ndiv: A container element\ncode: x = 42",
        expected: "<p>This is a paragraph.</p><div>A container element</div><code>x = 42</code>",
        points: 25,
        hints: [
          "You can use multiple tags on separate lines.",
          "The parser is line-based."
        ]
      },
      {
        id: 6,
        title: "Adventure: Interactive snippet",
        description: "Combine heading, a list, and a snippet for a mini-guide.",
        code: "h3: Mini-Guide\ndiv: Step 1\np: Finish steps to unlock rewards.\ncode: print('Ready')",
        expected: "<h3>Mini-Guide</h3><div>Step 1</div><p>Finish steps to unlock rewards.</p><code>print('Ready')</code>",
        points: 40,
        hints: [
          "Mix blocks to simulate a small section.",
          "You can use div for containers as needed."
        ]
      }
    ];

    const GLOSSARY = [
      { term: "H4ML", definition: "A minimal, offline-friendly markup language for building simple HTML-like structures." },
      { term: "Tag", definition: "The element name in h4ml (e.g., h1, p, code)." },
      { term: "Snippet", definition: "A small, copy-ready block of h4ml code used as an example." },
      { term: "Auto-grading", definition: "The system automatically checks your h4ml code against the expected structure." },
      { term: "Preview", definition: "The live rendering area showing the HTML equivalent of your h4ml." }
    ];

    const CHEATSHEET = [
      { tag: "h1", usage: "Largest heading" },
      { tag: "h2", usage: "Subheading" },
      { tag: "p", usage: "Paragraph text" },
      { tag: "code", usage: "Inline code block" }
    ];

    const SNIPPETS = [
      {
        title: "Basic Heading + Paragraph",
        code: "h1: Hello H4ML\np: This is a simple example.",
        note: "Try this in the editor and Run."
      },
      {
        title: "Subheading with Description",
        code: "h2: Subheading\np: A short description follows the heading.",
        note: "Great for section titles."
      }
    ];

    // UI elements
    const scoreBadge = document.getElementById("scoreBadge");
    const progressBadge = document.getElementById("progressBadge");
    const missionsListEl = document.getElementById("missionsList");
    const centerPanelHeader = document.getElementById("centerPanelHeader");
    const missionViewEl = document.getElementById("missionView");
    const missionDescriptionEl = document.getElementById("missionDescription");
    const editorEl = document.getElementById("editor");
    const previewArea = document.getElementById("previewArea");
    const runBtn = document.getElementById("runBtn");
    const hintBtn = document.getElementById("hintBtn");
    const resetBtn = document.getElementById("resetBtn");
    const hintArea = document.getElementById("hintArea");
    const gradingFeedback = document.getElementById("gradingFeedback");
    const referenceOverview = document.getElementById("referenceOverview");
    const glossaryList = document.getElementById("glossaryList");
    const cheatsheetList = document.getElementById("cheatsheetList");
    const snippetsContainer = document.getElementById("snippetsContainer");
    const achievementsList = document.getElementById("achievementsList");
    const progressBar = document.getElementById("progressBar");
    const celebrateBtn = document.getElementById("celebrateBtn");
    const exportBtn = document.getElementById("exportBtn");
    const themeToggle = document.getElementById("themeToggle");
    const liveTips = document.getElementById("liveTips");
    const quickStats = document.getElementById("quickStats");
    const bgCanvas = document.getElementById("bgCanvas");
    const confettiLayer = document.getElementById("confettiLayer");

    // State management with localStorage
    const STORAGE_KEY = "h4ml_tutorial_state_v2";

    let state = {
      missions: MISSIONS.reduce((acc, m) => {
        acc[m.id] = { solved: false, score: 0, hintsUsed: 0 };
        return acc;
      }, {}),
      score: 0,
      currentMissionId: MISSIONS[0].id,
      achievements: {
        rookie: false,
        adept: false,
        master: false
      },
      theme: "dark",
    };

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
      const s = localStorage.getItem(STORAGE_KEY);
      if (s) {
        try {
          const parsed = JSON.parse(s);
          state = Object.assign(state, parsed);
        } catch (e) {
          console.warn("Failed to parse saved state.", e);
        }
      }
    }

    // Simple render from h4ml
    function renderFromH4ML(code) {
      const lines = code.split(/\r?\n/).filter(l => l.trim().length > 0);
      const root = document.createElement("div");
      lines.forEach(line => {
        const [tagRaw, ...rest] = line.split(":");
        if (!tagRaw) return;
        const tag = tagRaw.trim();
        const content = rest.join(":").trim();
        if (!tag) return;
        // create element
        const el = document.createElement(tag);
        el.textContent = content;
        root.appendChild(el);
      });
      return root.innerHTML;
    }

    function normalizeHTML(html) {
      return html ? html.replace(/\s+/g, " ").trim() : "";
    }

    function countSolvedMissions() {
      let count = 0;
      MISSIONS.forEach(m => { if (state.missions[m.id].solved) count++; });
      return count;
    }

    function updateProgressUI() {
      const solved = countSolvedMissions();
      const total = MISSIONS.length;
      const pct = Math.round((solved / total) * 100);
      progressBar.style.width = pct + "%";
      progressBar.title = `Progress: ${solved}/${total} (${pct}%)`;
      progressBadge.textContent = `Missions: ${solved}/${total}`;
      scoreBadge.textContent = `Score: ${state.score}`;
      quickStats.textContent = `Solved ${solved}/${total}`;
    }

    // Compiler/Grader
    function gradeMission() {
      const m = MISSIONS.find(x => x.id === state.currentMissionId);
      if (!m) return;
      const userCode = editorEl.value;
      // Build actual HTML
      const actualHTML = renderFromH4ML(userCode);
      const expected = m.expected;
      const normalizedActual = normalizeHTML(actualHTML);
      const normalizedExpected = normalizeHTML(expected);

      if (normalizedActual === normalizedExpected) {
        // success
        if (!state.missions[m.id].solved) {
          state.missions[m.id].solved = true;
          state.score += m.points;
          updateProgressUI();
          updateAchievementsOnScore(state.score);
          // celebrate
          celebrate();
        }
        gradingFeedback.style.color = "var(--good)";
        gradingFeedback.textContent = "Nice! Your h4ml matches the expected output.";
        // update preview to show exactly the expected
        previewArea.innerHTML = m.expected;
        saveState();
        renderMissionsList();
      } else {
        gradingFeedback.style.color = "var(--bad)";
        gradingFeedback.textContent = "Not quite there. Try to match the exact structure.";
      }
    }

    function countOpenedMissions() {
      return MISSIONS.length;
    }

    function updateAchievementsOnScore(score) {
      // simple thresholds
      if (score >= 60 && !state.achievements.adept) {
        state.achievements.adept = true;
      }
      if (score >= 100 && !state.achievements.master) {
        state.achievements.master = true;
      }
      if (score >= 30 && !state.achievements.rookie) {
        state.achievements.rookie = true;
      }
      renderAchievementsTab();
      saveState();
    }

    function showHint() {
      const m = MISSIONS.find(x => x.id === state.currentMissionId);
      const hints = m?.hints || [];
      const used = state.missions[m.id].hintsUsed || 0;
      if (used < hints.length) {
        hintArea.textContent = "Hint: " + hints[used];
        state.missions[m.id].hintsUsed = used + 1;
      } else {
        hintArea.textContent = "No more hints for this mission.";
      }
      saveState();
    }

    function resetMission() {
      const m = MISSIONS.find(x => x.id === state.currentMissionId);
      if (m) editorEl.value = m.code;
      previewArea.innerHTML = "";
      gradingFeedback.textContent = "";
      hintArea.textContent = "";
    }

    // Reference rendering
    function renderReferenceTab() {
      referenceOverview.style.display = "block";
      missionViewEl.style.display = "none";

      // Glossary
      glossaryList.innerHTML = "";
      GLOSSARY.forEach(item => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${item.term}:</strong> ${item.definition}`;
        glossaryList.appendChild(li);
      });

      // Cheatsheet
      cheatsheetList.innerHTML = "";
      CHEATSHEET.forEach(item => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${item.tag}</strong> - ${item.usage}`;
        cheatsheetList.appendChild(li);
      });

      // Snippets
      snippetsContainer.innerHTML = "";
      SNIPPETS.forEach(s => {
        const wrap = document.createElement("div");
        wrap.style.marginBottom = "10px";
        wrap.innerHTML = `
          <div style="font-weight:600; margin-bottom:6px;">${s.title}</div>
          <pre class="snippet" id="snippet_${escapeSelector(s.title)}">${s.code}</pre>
          <div class="snippet-actions">
            <span style="font-size:12px; color:var(--muted)">${s.note}</span>
            <button data-snippet-title="${escapeSelector(s.title)}" class="copyBtn btn" style="padding:6px 10px;">Copy</button>
          </div>
        `;
        snippetsContainer.appendChild(wrap);
      });
      // attach copy events
      document.querySelectorAll(".copyBtn").forEach(btn => btn.addEventListener("click", (e) => {
        const title = e.currentTarget.getAttribute("data-snippet-title");
        const pre = document.getElementById(`snippet_${title}`);
        if (pre) copyToClipboard(pre.textContent);
      }));
    }

    function renderAchievementsTab() {
      // Right pane: show achievements
      achievementsList.innerHTML = "";
      const all = [
        { key: "rookie", name: "Rookie Builder", desc: "Complete first 3 missions." },
        { key: "adept", name: "Adept Builder", desc: "Reach 60+ points." },
        { key: "master", name: "Master Architect", desc: "Reach 100+ points." }
      ];
      all.forEach(a => {
        const isUnlocked = !!state.achievements[a.key];
        const el = document.createElement("div");
        el.className = "achv" + (isUnlocked ? "" : " locked");
        el.innerHTML = `
          <div class="name">${a.name}</div>
          <div class="desc">${a.desc}</div>
          <div style="font-size:11px; color:var(--muted); margin-top:4px;">
            ${isUnlocked ? "Unlocked" : "Locked"}
          </div>
        `;
        achievementsList.appendChild(el);
      });

      // progress bar
      const solved = countSolvedMissions();
      const total = MISSIONS.length;
      const pct = Math.round((solved / total) * 100);
      progressBar.style.width = pct + "%";
      progressBar.title = `Progress ${solved}/${total} (${pct}%)`;
      // live tips update
      liveTips.textContent = `Progress ${solved}/${total} - ${pct}% complete.`
    }

    function escapeSelector(str) {
      return str.replace(/[^a-z0-9_\-]/gi, "_");
    }

    function copyToClipboard(text) {
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
          flashMessage("Snippet copied to clipboard!");
        }).catch(() => {
          fallbackCopy(text);
        });
      } else {
        fallbackCopy(text);
      }
    }
    function flashMessage(msg) {
      // simple ephemeral notification
      const note = document.createElement("div");
      note.style.position = "fixed";
      note.style.bottom = "20px";
      note.style.left = "50%";
      note.style.transform = "translateX(-50%)";
      note.style.padding = "10px 14px";
      note.style.background = "rgba(0,0,0,.8)";
      note.style.color = "white";
      note.style.borderRadius = "8px";
      note.style.zIndex = "9999";
      note.style.fontSize = "13px";
      note.textContent = msg;
      document.body.appendChild(note);
      setTimeout(() => { note.remove(); }, 1500);
    }
    function fallbackCopy(text) {
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      try {
        document.execCommand("copy");
        flashMessage("Snippet copied to clipboard!");
      } catch (err) {
        alert("Copy failed. Please copy manually.");
      }
      document.body.removeChild(ta);
    }

    // Celebrations: simple confetti
    function celebrate() {
      const colors = ["#66e0c7", "#7aa2ff", "#ffd166", "#ef476f", "#06d6a0", "#3a86ff"];
      const count = 60;
      for (let i = 0; i < count; i++) {
        const el = document.createElement("div");
        el.className = "confetto";
        el.style.left = Math.random() * window.innerWidth + "px";
        el.style.top = (Math.random() * 20) + "px";
        el.style.width = (8 + Math.random() * 8) + "px";
        el.style.height = (10 + Math.random() * 12) + "px";
        el.style.background = colors[Math.floor(Math.random() * colors.length)];
        el.style.transform = "rotate(" + (Math.random() * 360) + "deg)";
        el.style.opacity = "0";
        confettiLayer.appendChild(el);

        // animate
        const duration = 1200 + Math.random() * 900;
        const endX = (Math.random() - 0.5) * 300;
        const endY = Math.floor(120 + Math.random() * 260);
        el.animate([
          { transform: "translateY(0px) translateX(0px)", opacity: 1 },
          { transform: `translateY(${endY}px) translateX(${endX}px) rotate(${Math.random() * 720}deg)`, opacity: 0 }
        ], { duration, easing: "ease-out" });
        // remove after animation
        setTimeout(() => el.remove(), duration);
      }
      // subtle glow
      confettiLayer.style.filter = "hue-rotate(" + (Math.random() * 360) + "deg)";
      setTimeout(() => { confettiLayer.style.filter = ""; }, 1200);
    }

    // References: selectors
    function renderMissionsList() {
      missionsListEl.innerHTML = "";
      MISSIONS.forEach((m) => {
        const isActive = state.currentMissionId === m.id;
        const li = document.createElement("div");
        li.className = "mission-item" + (isActive ? " active" : "");
        li.innerHTML = `
          <div style="display:flex;gap:8px; align-items:center;">
            <span style="width:12px;height:12px;border-radius:50%;display:inline-block;background:${state.missions[m.id].solved ? '#4bd37b' : '#3a3a3a'}"></span>
            <span class="mission-title">${m.title}</span>
          </div>
          <span class="status ${state.missions[m.id].solved ? "solved" : "pending"}" title="Status">
            ${state.missions[m.id].solved ? "Solved" : "Pending"}
          </span>
        `;
        li.addEventListener("click", () => {
          state.currentMissionId = m.id;
          showCurrentMission();
          saveState();
          renderMissionsList();
        });
        missionsListEl.appendChild(li);
      });
    }

    function selectMission(id) {
      state.currentMissionId = id;
      showCurrentMission();
      saveState();
      renderMissionsList();
    }

    function showCurrentMission() {
      const m = MISSIONS.find(x => x.id === state.currentMissionId);
      if (!m) return;
      centerPanelHeader.textContent = "Mission: " + m.title;
      missionDescriptionEl.innerHTML = `
        <strong>${m.title}</strong>
        <div style="font-size:12px; color:var(--muted);">${m.description}</div>
      `;
      editorEl.value = m.code;
      hintArea.textContent = "";
      previewArea.innerHTML = "";
      gradingFeedback.textContent = "";
      // show mission view
      missionViewEl.style.display = "block";
      referenceOverview.style.display = "none";
      celebrateBtn.style.display = "inline-block";
    }

    // Init
    function renderMissionsTab() {
      referenceOverview.style.display = "none";
      missionViewEl.style.display = "block";
      // Update lists
      renderMissionsList();
      showCurrentMission();
      // set header hints
      quickStats.textContent = "";
      updateProgressUI();
    }

    function renderReferenceTab() {
      referenceOverview.style.display = "block";
      missionViewEl.style.display = "none";
      renderReferenceTabContent();
    }

    function renderReferenceTabContent() {
      // Build static reference once
      glossaryList.innerHTML = "";
      GLOSSARY.forEach(item => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${item.term}:</strong> ${item.definition}`;
        glossaryList.appendChild(li);
      });
      cheatsheetList.innerHTML = "";
      CHEATSHEET.forEach(item => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${item.tag}</strong> - ${item.usage}`;
        cheatsheetList.appendChild(li);
      });
      snippetsContainer.innerHTML = "";
      SNIPPETS.forEach(s => {
        const wrap = document.createElement("div");
        wrap.style.marginBottom = "10px";
        wrap.innerHTML = `
          <div style="font-weight:600; margin-bottom:6px;">${s.title}</div>
          <pre class="snippet" id="snippet_${escapeSelector(s.title)}">${s.code}</pre>
          <div class="snippet-actions">
            <span style="font-size:12px; color:var(--muted)">${s.note}</span>
            <button data-snippet-title="${escapeSelector(s.title)}" class="copyBtn btn" style="padding:6px 10px;">Copy</button>
          </div>
        `;
        snippetsContainer.appendChild(wrap);
      });
      document.querySelectorAll(".copyBtn").forEach(btn => btn.addEventListener("click", (e) => {
        const title = e.currentTarget.getAttribute("data-snippet-title");
        const pre = document.getElementById(`snippet_${title}`);
        if (pre) copyToClipboard(pre.textContent);
      }));
    }

    // Keyboard shortcut
    editorEl.addEventListener("keydown", (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === "enter") {
        e.preventDefault();
        gradeMission();
      }
    });

    // UI Wiring
    runBtn.addEventListener("click", gradeMission);
    hintBtn.addEventListener("click", showHint);
    resetBtn.addEventListener("click", resetMission);
    celebrateBtn.addEventListener("click", celebrate);
    exportBtn.addEventListener("click", () => {
      const payload = {
        state,
        missions: MISSIONS.map(m => m.id)
      };
      const blob = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
      navigator.clipboard.writeText(blob).then(() => {
        flashMessage("Export string copied to clipboard!");
      });
    });

    themeToggle.addEventListener("click", () => {
      // simple theme toggle (dark/light)
      const root = document.documentElement;
      if (state.theme === "dark") {
        root.style.setProperty("--bg", "#f6f8fb");
        root.style.setProperty("--panel", "#ffffff");
        root.style.setProperty("--fg", "#0a0a0a");
        root.style.setProperty("--muted", "#555");
        root.style.setProperty("--border", "#e4e6f1");
        state.theme = "light";
      } else {
        root.style.removeProperty("--bg");
        root.style.removeProperty("--panel");
        root.style.removeProperty("--fg");
        root.style.removeProperty("--muted");
        root.style.removeProperty("--border");
        state.theme = "dark";
      }
      saveState();
    });

    // Init canvas background (particles)
    function initBackground() {
      const c = bgCanvas;
      const ctx = c.getContext("2d");
      let w = c.width = window.innerWidth;
      let h = c.height = window.innerHeight;
      const particles = [];
      for (let i = 0; i < 80; i++) {
        particles.push({
          x: Math.random() * w,
          y: Math.random() * h,
          vx: (Math.random() - 0.5) * 0.4,
          vy: (Math.random() - 0.5) * 0.4,
          r: Math.random() * 1.6 + 0.6,
          a: Math.random() * Math.PI * 2
        });
      }
      function resize() {
        w = c.width = window.innerWidth;
        h = c.height = window.innerHeight;
      }
      window.addEventListener("resize", resize);
      function loop() {
        ctx.clearRect(0, 0, w, h);
        for (const p of particles) {
          p.x += p.vx; p.y += p.vy;
          if (p.x < 0 || p.x > w) p.vx *= -1;
          if (p.y < 0 || p.y > h) p.vy *= -1;
          ctx.fillStyle = "rgba(102,224,199,0.35)";
          ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2); ctx.fill();
        }
        requestAnimationFrame(loop);
      }
      loop();
    }

    function init() {
      loadState();
      renderMissionsTab();
      renderAchievementsTab();
      updateProgressUI();
      initBackground();
      // initial reference content
      renderReferenceTabContent();
      window.addEventListener("storage", () => {
        loadState();
        renderMissionsList();
        renderAchievementsTab();
        updateProgressUI();
      });
    }

    // Copy text helper quick toast
    function flashToasty(msg) {
      flashMessage(msg);
    }

    // Basic toast
    function flashMessage(msg) {
      const t = document.createElement("div");
      t.style.position = "fixed";
      t.style.bottom = "20px";
      t.style.left = "50%";
      t.style.transform = "translateX(-50%)";
      t.style.padding = "10px 14px";
      t.style.background = "rgba(0,0,0,.8)";
      t.style.color = "white";
      t.style.borderRadius = "8px";
      t.style.zIndex = "9999";
      t.style.fontSize = "13px";
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 1800);
    }

    // Init on DOM ready
    function ready(fn) {
      if (document.readyState !== "loading") fn();
      else document.addEventListener("DOMContentLoaded", fn);
    }

    ready(() => {
      // extra: place default active
      loadState();
      // ensure counts
      updateProgressUI();
      // Build initial left list
      renderMissionsList();
      // show first mission by default
      showCurrentMission();

      // Attach default reference tab
      renderReferenceTabContent();

      // Keyboard: Ctrl/Cmd+R for quick refresh of mission
      document.addEventListener("keydown", (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === "r") {
          e.preventDefault();
          showCurrentMission();
        }
      });

      // confetti cleanup on hide
      confettiLayer.addEventListener("animationend", () => {
        confettiLayer.innerHTML = "";
      });

      // initial selection
      selectMission(state.currentMissionId);
    });

    // Confetti helper to be triggered on solve
    function celebrate() {
      // if not solved last mission, still celebrate
      if (!state.currentMissionId) return;
      celebrateVisuals();
      // small bounce animation on header
      centerPanelHeader.animate([{ transform: "translateY(-4px)" }, { transform: "translateY(0px)" }], { duration: 260, easing: "ease" });
      flashMessage("Great job! Mission completed!");
    }

    function celebrateVisuals() {
      // spawn confetti
      const colors = ["#66e0c7", "#7aa2ff", "#ffd166", "#ef476f", "#06d6a0", "#3a86ff"];
      const count = 60;
      for (let i = 0; i < count; i++) {
        const el = document.createElement("div");
        el.className = "confetto";
        el.style.left = Math.random() * window.innerWidth + "px";
        el.style.top = (Math.random() * 20) + "px";
        el.style.width = (8 + Math.random() * 8) + "px";
        el.style.height = (10 + Math.random() * 12) + "px";
        el.style.background = colors[Math.floor(Math.random() * colors.length)];
        el.style.transform = "rotate(" + (Math.random() * 360) + "deg)";
        el.style.opacity = "0";
        confettiLayer.appendChild(el);
        const duration = 1200 + Math.random() * 900;
        const endX = (Math.random() - 0.5) * 320;
        const endY = 120 + Math.random() * 260;
        el.animate([
          { transform: "translateY(0px) translateX(0px)", opacity: 1 },
          { transform: `translateY(${endY}px) translateX(${endX}px) rotate(${Math.random() * 720}deg)`, opacity: 0 }
        ], { duration, easing: "ease-out" });
        setTimeout(() => el.remove(), duration);
      }
    }

    // Helper: ensure snippet title compatibility
    function escapeSelector(str) {
      return str.replace(/[^a-z0-9_\-]/gi, "_");
    }

  </script>
</body>
</html>