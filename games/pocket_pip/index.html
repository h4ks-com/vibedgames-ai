<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pocket Pip</title>
<style>
:root{
  --bg:#f7f9fc;
  --card:#fff;
  --muted:#9aa5b1;
  --accent:#ffd6e0;
  --accent2:#c1f0ff;
  --glass:rgba(255,255,255,0.7);
  --primary:#ff9fb1;
  --soft-shadow: 0 6px 18px rgba(95,95,110,0.08);
  --round:14px;
  --font: "Comic Sans MS", "Trebuchet MS", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
body{margin:0;font-family:var(--font);background:linear-gradient(180deg,var(--bg), #eef6ff);color:#243;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px;transition:background 300ms}
.app{width:100%;max-width:1100px;display:grid;grid-template-columns:1fr 360px;gap:18px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.title{display:flex;align-items:center;gap:12px}
.logo{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--accent2));box-shadow:var(--soft-shadow);display:flex;align-items:center;justify-content:center;position:relative}
.logo svg{width:40px;height:40px;transform:translateY(-2px)}
.h1{font-size:20px;font-weight:700;color:#2b2b2b}
.controls{display:flex;gap:8px;align-items:center}
.big-btn{background:var(--card);border-radius:12px;padding:8px 10px;box-shadow:var(--soft-shadow);border:1px solid rgba(0,0,0,0.04);cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-weight:600}
.toggle{display:inline-flex;align-items:center;gap:8px}
.toggle input{width:40px;height:24px;appearance:none;border-radius:14px;background:linear-gradient(180deg,#e6eef7,#fff);box-shadow:inset 0 1px rgba(255,255,255,0.6);position:relative;cursor:pointer}
.toggle input:checked{background:linear-gradient(90deg,#ffd6e0,#c1f0ff)}
.toggle input:before{content:"";width:18px;height:18px;border-radius:50%;background:#fff;display:block;margin:3px;transition:transform 220ms}
.toggle input:checked:before{transform:translateX(16px)}
.panel{background:var(--card);border-radius:var(--round);padding:16px;box-shadow:var(--soft-shadow);border:1px solid rgba(255,255,255,0.6)}
.left{display:flex;flex-direction:column;gap:14px}
.card-center{display:flex;gap:14px;align-items:center;justify-content:space-between}
.mascot-card{flex:1;display:flex;gap:12px;align-items:center;padding:14px;border-radius:14px;position:relative;background:linear-gradient(180deg,#fff,#fff);box-shadow:var(--soft-shadow);border:1px solid rgba(0,0,0,0.03)}
.mascot-wrap{width:240px;height:240px;border-radius:12px;background:linear-gradient(180deg,#fefefe,#f9fdff);display:flex;align-items:center;justify-content:center;position:relative;overflow:visible}
.mascot-idle{animation:float 3s ease-in-out infinite}
@keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
.mascot-svg{width:200px;height:200px;filter:drop-shadow(0 6px 14px rgba(90,90,100,0.08))}
.info{flex:1;display:flex;flex-direction:column;gap:8px;padding:6px}
.name-row{display:flex;align-items:center;gap:8px}
.name{font-size:20px;font-weight:800}
.xpbar{height:12px;background:linear-gradient(90deg,#f0f6ff,#fef6fb);border-radius:12px;overflow:hidden;border:1px solid rgba(0,0,0,0.04)}
.xpfill{height:100%;background:linear-gradient(90deg,#ffd6e0,#c1f0ff);width:30%;transition:width 600ms cubic-bezier(.2,.9,.2,1)}
.heart{display:flex;align-items:center;gap:6px;font-weight:700}
.actions{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
.action-btn{background:linear-gradient(180deg,#fff,#fff);border-radius:12px;padding:12px 16px;box-shadow:0 8px 20px rgba(80,80,90,0.06);border:1px solid rgba(0,0,0,0.04);cursor:pointer;font-weight:700;display:inline-flex;align-items:center;gap:10px;transition:transform 160ms}
.action-btn:active{transform:scale(0.98)}
.action-btn.big{font-size:16px;padding:14px 18px;border-radius:16px}
.small{font-size:13px;color:var(--muted)}
.right{display:flex;flex-direction:column;gap:12px}
.store-list{display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto;padding-right:4px}
.item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:linear-gradient(180deg,#fff,#fff);border:1px solid rgba(0,0,0,0.04)}
.item .thumb{width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center}
.coins{background:linear-gradient(90deg,#ffd6e0,#ffe8f0);padding:6px 8px;border-radius:8px;font-weight:800}
.footer{display:flex;gap:8px;align-items:center;justify-content:space-between}
.modal{position:fixed;inset:0;background:rgba(10,12,16,0.28);display:none;align-items:center;justify-content:center;padding:18px;z-index:40}
.modal.show{display:flex}
.modal-card{background:var(--card);border-radius:14px;padding:18px;width:100%;max-width:760px;box-shadow:var(--soft-shadow);border:1px solid rgba(0,0,0,0.05)}
.close{position:absolute;right:18px;top:18px;border-radius:10px;border:0;background:var(--card);padding:8px;cursor:pointer}
.rhythm-area{display:flex;flex-direction:column;gap:12px;align-items:center}
.beat-row{display:flex;gap:10px}
.beat-dot{width:56px;height:56px;border-radius:14px;background:linear-gradient(180deg,#fff,#fbfbff);display:flex;align-items:center;justify-content:center;border:1px solid rgba(0,0,0,0.04);font-weight:800;transition:transform 140ms,box-shadow 140ms}
.beat-dot.active{transform:scale(1.1);box-shadow:0 8px 20px rgba(0,0,0,0.08)}
.score{font-size:22px;font-weight:800}
.photo-stage{display:flex;gap:12px}
.stage-left{width:360px;height:420px;background:linear-gradient(180deg,#fff,#f2fbff);border-radius:12px;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center}
.stage-right{flex:1;display:flex;flex-direction:column;gap:8px}
.sticker-palette{display:flex;flex-wrap:wrap;gap:8px;padding:6px;background:linear-gradient(180deg,#fff,#fff);border-radius:10px;border:1px solid rgba(0,0,0,0.03);max-height:120px;overflow:auto}
.sticker{width:56px;height:56px;border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px dashed rgba(0,0,0,0.05)}
.sticker.active{box-shadow:0 8px 20px rgba(0,0,0,0.08);transform:translateY(-4px)}
.stamp{position:absolute;cursor:grab}
.gallery{display:flex;flex-direction:column;gap:8px}
.snap{width:100%;height:120px;border-radius:10px;background:#fff;border:1px solid rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:center;overflow:hidden}
.confetti-canvas{position:fixed;inset:0;pointer-events:none;z-index:60}
.small-muted{font-size:12px;color:var(--muted)}
.badge{background:linear-gradient(90deg,#fff0,#fff0);padding:6px 10px;border-radius:999px;border:1px solid rgba(0,0,0,0.03)}
.lang{padding:6px 8px;border-radius:8px;background:var(--card);border:1px solid rgba(0,0,0,0.04)}
.muted{color:var(--muted);font-weight:600}

/* Mascot hand-drawn tiny animation accents */
.eye-blink{animation:blink 6s infinite}
@keyframes blink{0%,96%{transform:scaleY(1)}98%{transform:scaleY(0.1)}100%{transform:scaleY(1)}}

/* High contrast */
.high-contrast{filter:contrast(120%) saturate(120%)}
.big-text{font-size:18px}
.rounded-large{border-radius:22px}

/* Responsive */
@media(max-width:920px){
  .app{grid-template-columns:1fr}
  .right{order:2}
  .left{order:1}
  .mascot-wrap{width:200px;height:200px}
}
/* Tiny bouncy microinteraction on press */
.bouncy:active{transform:translateY(-2px) scale(0.98);transition:transform 120ms}
</style>
<body>
<div class="app" id="app">
  <div class="left">
    <div class="header">
      <div class="title">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
            <g>
              <circle cx="32" cy="32" r="22" fill="#fff0" stroke="#fff" stroke-opacity="0.6"/>
              <path d="M18 34c0-12 28-22 28-8s-12 20-14 22-14 2-14-14z" fill="#fff" opacity="0.14"/>
              <circle cx="26" cy="28" r="3" fill="#fff"/>
              <circle cx="38" cy="28" r="3" fill="#fff"/>
            </g>
          </svg>
        </div>
        <div>
          <div class="h1" id="titleText">Pocket Pip</div>
          <div class="small muted" id="subtitle">A cozy companion</div>
        </div>
      </div>
      <div class="controls">
        <div class="toggle" title="Mute audio">
          <label><input type="checkbox" id="muteToggle" aria-label="Mute audio"></label>
        </div>
        <div class="toggle" title="Day / Night">
          <label><input type="checkbox" id="themeToggle" aria-label="Toggle day/night"></label>
        </div>
        <div class="toggle" title="High contrast">
          <label><input type="checkbox" id="contrastToggle" aria-label="High contrast"></label>
        </div>
        <select id="langSel" class="lang" aria-label="Language">
          <option value="en">EN</option>
          <option value="es">ES</option>
        </select>
      </div>
    </div>

    <div class="panel mascot-card" role="region" aria-label="Mascot status">
      <div class="mascot-wrap panel-left" id="mascotWrap">
        <!-- SVG mascot -->
        <svg class="mascot-svg mascot-idle" viewBox="0 0 200 200" id="mascotSVG" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs>
            <filter id="wiggle"><feTurbulence baseFrequency="0.02" numOctaves="1" result="noise" /><feDisplacementMap in="SourceGraphic" in2="noise" scale="2"/></filter>
          </defs>
          <g id="bodyGroup">
            <path id="blob" d="M40 90 C40 35,160 30,160 95 C160 150,120 170,90 170 C60 170,40 145,40 90 Z" fill="#ffd6e0" stroke="#ff9fb1" stroke-width="3"/>
            <g transform="translate(0,-2)">
              <ellipse class="eye eye-left" cx="78" cy="88" rx="8" ry="9" fill="#2b2b2b"/>
              <ellipse class="eye eye-right" cx="116" cy="88" rx="8" ry="9" fill="#2b2b2b"/>
            </g>
            <path id="mouth" d="M86 110 Q100 120 114 110" stroke="#2b2b2b" stroke-width="4" fill="none" stroke-linecap="round" stroke-linejoin="round" />
            <g id="accessory" transform="translate(40,18)">
              <!-- outfit accessory -->
            </g>
          </g>
        </svg>
        <div style="position:absolute;left:8px;top:8px;font-size:12px;background:rgba(255,255,255,0.6);padding:6px 8px;border-radius:999px;border:1px solid rgba(0,0,0,0.03)" id="affectionLabel">‚ù§ 0</div>
      </div>

      <div class="info">
        <div class="name-row">
          <div>
            <div class="name" id="pipName" contenteditable="true" aria-label="Rename your companion">Pip</div>
            <div class="small-muted" id="statusText">Feeling cozy</div>
          </div>
        </div>
        <div>
          <div class="small">Affection</div>
          <div class="xpbar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="30">
            <div class="xpfill" id="xpFill" style="width:30%"></div>
          </div>
        </div>
        <div class="actions">
          <button class="action-btn big bouncy" id="feedBtn" aria-label="Feed Pip">üçé Feed</button>
          <button class="action-btn big bouncy" id="groomBtn" aria-label="Groom Pip">üõÅ Groom</button>
          <button class="action-btn big bouncy" id="playBtn" aria-label="Play with Pip">üéµ Play</button>
          <button class="action-btn big bouncy" id="photoBtn" aria-label="Photo booth">üì∏ Photo</button>
        </div>
        <div class="small-muted">Tip: Tap feed/groom for gentle interactions. Daily rewards help you collect stickers & outfits.</div>
      </div>
    </div>

    <div class="panel footer">
      <div class="small-muted">Coins: <span id="coins">0</span></div>
      <div style="display:flex;gap:6px">
        <button class="big-btn" id="dailyBtn">üéÅ Daily</button>
        <button class="big-btn" id="galleryBtn">üñº Gallery</button>
      </div>
    </div>
  </div>

  <div class="right">
    <div class="panel">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;flex-direction:column">
          <div class="small-muted">Collectibles</div>
          <div style="font-weight:800">Outfits & Stickers</div>
        </div>
        <div style="display:flex;gap:8px">
          <div class="coins badge" id="affCoins">0</div>
        </div>
      </div>

      <div class="store-list" id="storeList" aria-live="polite" aria-label="Store list">
        <!-- items inserted here -->
      </div>
    </div>

    <div class="panel gallery" id="galleryPanel">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:800">Snapshot Gallery</div>
        <div class="small-muted">(offline safe)</div>
      </div>
      <div id="galleryList" style="display:flex;gap:8px;flex-wrap:wrap;padding-top:8px"></div>
    </div>

    <div class="panel">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div class="small-muted">Settings</div>
          <div style="font-weight:800">Appearance & Audio</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          <label class="small-muted">Large Text<input type="checkbox" id="largeText" style="margin-left:8px"></label>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
        <div class="small-muted">Music</div>
        <div style="flex:1;display:flex;gap:8px;justify-content:flex-end">
          <button class="big-btn" id="musicToggle">Play</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modals -->
<div class="modal" id="modalRhythm" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-card" role="document">
    <button class="close" id="closeRhythm">‚úï</button>
    <div class="rhythm-area" id="rhythmArea">
      <div style="display:flex;align-items:center;justify-content:space-between;width:100%">
        <div class="score">Rhythm Tap</div>
        <div class="small-muted" id="rhythmHint">Tap the beats in time</div>
      </div>
      <div class="beat-row" id="beatRow" aria-live="polite"></div>
      <div style="display:flex;gap:8px">
        <button class="big-btn" id="startRhythm">Start</button>
        <div id="rhythmResult" class="small-muted">‚Äî</div>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="modalPhoto" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-card" role="document">
    <button class="close" id="closePhoto">‚úï</button>
    <div class="photo-stage">
      <div class="stage-left" id="stageLeft">
        <div id="photoCanvasArea" style="position:relative;width:320px;height:380px;">
          <!-- mascot preview -->
          <div id="stageMascot" style="position:absolute;left:20px;top:20px;width:280px;height:280px;display:flex;align-items:center;justify-content:center;">
            <!-- duplicate SVG drawn later -->
          </div>
          <!-- placed stickers -->
        </div>
      </div>
      <div class="stage-right">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Photo Booth</div>
          <div class="small-muted">Drag stickers onto the scene</div>
        </div>
        <div style="display:flex;gap:8px;">
          <select id="outfitSel" class="lang" aria-label="Choose outfit"></select>
          <button class="big-btn" id="saveSnap">Save</button>
          <button class="big-btn" id="shareSnap">Share</button>
        </div>
        <div class="small-muted">Stickers</div>
        <div class="sticker-palette" id="stickerPalette"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="big-btn" id="clearStickers">Clear</button>
          <button class="big-btn" id="addRandomSticker">Random</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="modalGallery" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-card" role="document">
    <button class="close" id="closeGallery">‚úï</button>
    <div style="display:flex;flex-direction:column;gap:8px">
      <div style="font-weight:800">Your Snapshots</div>
      <div id="galleryGrid" style="display:flex;gap:8px;flex-wrap:wrap"></div>
    </div>
  </div>
</div>

<canvas class="confetti-canvas" id="confettiCanvas"></canvas>

<script>
/* Pocket Pip - Vanilla JS Cozy Companion
   Features: feed, groom, play (rhythm), photo booth with stickers & outfits, collectibles, XP, daily, gallery, sound, music, theme, accessibility, offline snapshot caching (localStorage), service worker registration (inline).
*/

/* ----- State & Data ----- */
const LS_KEYS = {
  state: 'pp_state_v1',
  gallery: 'pp_gallery_v1',
  store: 'pp_store_v1',
  analytics: 'pp_analytics_v1'
};

const defaultState = {
  name: 'Pip',
  xp: 30,
  affection: 0,
  coins: 20,
  outfitsOwned: ['base'],
  stickersOwned: ['star','heart'],
  outfit: 'base',
  stickersOnStage: [],
  lastDaily: null,
  lang: 'en',
  mute: false,
  musicOn: false,
  highContrast: false,
  largeText: false,
  themeNight: false
};

let state = loadState() || defaultState;

/* basic store items */
const storeItems = [
  {id:'pinkHat', type:'outfit', name:{en:'Rosy Hat',es:'Sombrero Rosado'}, cost:30, desc:{en:'A cozy hat',es:'Un gorrito c√≥modo'}},
  {id:'blueScarf', type:'outfit', name:{en:'Cool Scarf',es:'Bufanda Chula'}, cost:25, desc:{en:'Keeps Pip warm',es:'Mantiene a Pip calentito'}},
  {id:'stickerPck1', type:'stickerPack', name:{en:'Cute Pack',es:'Pack Bonito'}, cost:15, contents:['flower','spark']},
  {id:'stickerPck2', type:'stickerPack', name:{en:'Fun Pack',es:'Pack Divertido'}, cost:12, contents:['moon','sun']}
];

const stickersData = {
  star:{id:'star',draw:drawStar},
  heart:{id:'heart',draw:drawHeart},
  flower:{id:'flower',draw:drawFlower},
  spark:{id:'spark',draw:drawSpark},
  moon:{id:'moon',draw:drawMoon},
  sun:{id:'sun',draw:drawSun}
};

const outfits = {
  base:{id:'base',name:{en:'Base',es:'Base'},apply:applyBase},
  pinkHat:{id:'pinkHat',name:{en:'Rosy Hat',es:'Sombrero Rosado'},apply:applyPinkHat},
  blueScarf:{id:'blueScarf',name:{en:'Cool Scarf',es:'Bufanda Chula'},apply:applyBlueScarf}
};

/* Gallery */
let gallery = JSON.parse(localStorage.getItem(LS_KEYS.gallery) || '[]');

/* Analytics (privacy-friendly) */
let analytics = JSON.parse(localStorage.getItem(LS_KEYS.analytics) || '{}');

/* ----- Helpers ----- */
function saveState(){ localStorage.setItem(LS_KEYS.state, JSON.stringify(state)); updateUI(); }
function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEYS.state)); }catch(e){return null;} }
function logEvent(k,v){ analytics[k]=(analytics[k]||0)+1; localStorage.setItem(LS_KEYS.analytics, JSON.stringify(analytics)); console.log('Analytics:',k,v||''); }
function _("k"){ const dict = {
  en:{
    dailyReady: "Daily reward ready!",
    alreadyClaimed: "Already claimed today",
    feedSuccess: "Yum! +5 XP",
    groomSuccess:"Sparkly! +6 XP",
    playWin: "Great rhythm! +10 XP",
    playLose: "Try again!",
    savedSnap:"Snapshot saved",
    purchaseOK:"Purchased!",
    notEnough:"Not enough coins"
  },
  es:{
    dailyReady: "¬°Recompensa diaria lista!",
    alreadyClaimed: "Ya reclamado hoy",
    feedSuccess: "¬°Delicioso! +5 XP",
    groomSuccess:"¬°Brillante! +6 XP",
    playWin: "¬°Gran ritmo! +10 XP",
    playLose: "¬°Int√©ntalo otra vez!",
    savedSnap:"Instant√°nea guardada",
    purchaseOK:"¬°Comprado!",
    notEnough:"No hay suficientes monedas"
  }
}; return dict[state.lang][k] || dict['en'][k]; }

/* UI Elements */
const xpFill = document.getElementById('xpFill');
const pipName = document.getElementById('pipName');
const affectionLabel = document.getElementById('affectionLabel');
const statusText = document.getElementById('statusText');
const coinsEl = document.getElementById('coins');
const storeList = document.getElementById('storeList');
const outfitSel = document.getElementById('outfitSel');
const stickerPalette = document.getElementById('stickerPalette');
const stageMascot = document.getElementById('stageMascot');
const stageLeft = document.getElementById('stageLeft');
const photoCanvasArea = document.getElementById('photoCanvasArea');
const galleryList = document.getElementById('galleryList');

const modalRhythm = document.getElementById('modalRhythm');
const modalPhoto = document.getElementById('modalPhoto');
const modalGallery = document.getElementById('modalGallery');
const modalConfettiCanvas = document.getElementById('confettiCanvas');

/* Sound & Music via WebAudio */
let audioCtx = null;
let musicNode = null;
function ensureAudio(){
  if(state.mute) return;
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
}
function playPing(freq=880, time=0.06){
  if(state.mute) return;
  ensureAudio();
  let o = audioCtx.createOscillator();
  let g = audioCtx.createGain();
  o.type='sine'; o.frequency.value=freq;
  g.gain.value=0.0001;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  g.gain.exponentialRampToValueAtTime(0.06,audioCtx.currentTime+0.02);
  g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+time);
  o.stop(audioCtx.currentTime+time+0.02);
}
function playSuccess(){
  playPing(700,0.14); setTimeout(()=>playPing(1000,0.12),80);
}
function playFail(){ playPing(180,0.12); }
function toggleMusic(on){
  if(on){
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    if(musicNode) return;
    const o1 = audioCtx.createOscillator();
    const o2 = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o1.type='sine'; o2.type='triangle';
    o1.frequency.value=220; o2.frequency.value=110;
    g.gain.value=0.03;
    o1.connect(g); o2.connect(g); g.connect(audioCtx.destination);
    o1.start(); o2.start();
    musicNode = {o1,o2,g};
  } else {
    if(musicNode){
      musicNode.o1.stop(); musicNode.o2.stop(); musicNode=null;
    }
  }
}

/* ----- Init UI ----- */
function updateUI(){
  document.body.classList.toggle('high-contrast', state.highContrast);
  document.body.classList.toggle('big-text', state.largeText);
  document.body.style.background = state.themeNight ? 'linear-gradient(180deg,#081425,#112233)' : 'linear-gradient(180deg,var(--bg), #eef6ff)';
  pipName.textContent = state.name;
  xpFill.style.width = Math.min(100, state.xp) + '%';
  affectionLabel.textContent = '‚ù§ ' + state.affection;
  statusText.textContent = state.affection>50 ? (state.lang==='es'?'Feliz':'Happy') : (state.lang==='es'?'Tranquilo':'Feeling cozy');
  coinsEl.textContent = state.coins;
  document.getElementById('muteToggle').checked = state.mute;
  document.getElementById('themeToggle').checked = state.themeNight;
  document.getElementById('contrastToggle').checked = state.highContrast;
  document.getElementById('largeText').checked = state.largeText;
  document.getElementById('langSel').value = state.lang;
  document.getElementById('musicToggle').textContent = state.musicOn ? 'Stop' : 'Play';
  // populate store
  renderStore();
  // populate outfit selector
  outfitSel.innerHTML = '';
  for(const k in outfits){
    const opt = document.createElement('option');
    opt.value = k; opt.textContent = outfits[k].name[state.lang] || outfits[k].name.en || k;
    outfitSel.appendChild(opt);
  }
  outfitSel.value = state.outfit;
  renderStickersPalette();
  renderStage();
  renderGallery();
}
function renderStore(){
  storeList.innerHTML = '';
  storeItems.forEach(it=>{
    const row = document.createElement('div'); row.className='item';
    const thumb = document.createElement('div'); thumb.className='thumb'; thumb.style.background = 'linear-gradient(90deg,#fff,#fff)';
    thumb.innerHTML = it.type==='outfit' ? '<svg width="44" height="44" viewBox="0 0 64 64"><circle cx="32" cy="24" r="8" fill="#ff9fb1"/><rect x="16" y="36" width="32" height="18" rx="4" fill="#ffd6e0"/></svg>' : '<div style="font-weight:800">üéÅ</div>';
    row.appendChild(thumb);
    const div = document.createElement('div'); div.style.flex='1';
    const title = document.createElement('div'); title.style.fontWeight='800'; title.textContent = it.name[state.lang] || it.name.en;
    const desc = document.createElement('div'); desc.className='small-muted'; desc.textContent = it.desc ? (it.desc[state.lang]||it.desc.en) : '';
    div.appendChild(title); div.appendChild(desc);
    row.appendChild(div);
    const buy = document.createElement('div'); buy.style.display='flex'; buy.style.flexDirection='column'; buy.style.alignItems='flex-end';
    const price = document.createElement('div'); price.className='coins'; price.textContent = it.cost;
    const btn = document.createElement('button'); btn.className='big-btn bouncy'; btn.textContent='Buy'; btn.onclick=()=>buyItem(it);
    buy.appendChild(price); buy.appendChild(btn);
    row.appendChild(buy);
    storeList.appendChild(row);
  });
}
function renderStickersPalette(){
  stickerPalette.innerHTML='';
  Object.keys(stickersData).forEach(k=>{
    const s = document.createElement('div'); s.className='sticker'; s.title=k;
    s.onclick = ()=>selectStickerToPlace(k,s);
    // draw small sticker with canvas
    const cvs = document.createElement('canvas'); cvs.width=56; cvs.height=56; s.appendChild(cvs);
    const ctx = cvs.getContext('2d');
    ctx.clearRect(0,0,56,56);
    stickersData[k].draw(ctx,28,28,24);
    stickerPalette.appendChild(s);
  });
}
function renderStage(){
  // draw mascot into stageMascot
  stageMascot.innerHTML = '';
  const svgClone = document.getElementById('mascotSVG').cloneNode(true);
  svgClone.removeAttribute('id');
  svgClone.style.width='220px'; svgClone.style.height='220px';
  // apply outfit accessory
  const acc = svgClone.querySelector('#accessory');
  acc.innerHTML=''; outfits[state.outfit].apply(acc);
  // tint body based on outfit
  const blob = svgClone.querySelector('#blob');
  blob && (blob.setAttribute('fill', state.outfit==='pinkHat' ? '#ffd6e0' : state.outfit==='blueScarf'? '#c1f0ff' : '#ffd6e0'));
  stageMascot.appendChild(svgClone);

  // place stickers
  // remove existing placed elements in photoCanvasArea
  // re-render stickers from state.stickersOnStage
  // each sticker: {id,x,y,scale,rot}
  // ensure stage area
  // remove previously appended stickers
  const existing = photoCanvasArea.querySelectorAll('.stamp'); existing.forEach(e=>e.remove());
  state.stickersOnStage.forEach((s,idx)=>{
    const el = document.createElement('div'); el.className='stamp'; el.style.left = s.x+'px'; el.style.top = s.y+'px';
    el.style.transform = `rotate(${s.rot}deg) scale(${s.scale})`;
    el.style.width='64px'; el.style.height='64px';
    el.setAttribute('data-id',s.id);
    el.setAttribute('data-idx',idx);
    el.style.touchAction='none';
    const cvs = document.createElement('canvas'); cvs.width=128;cvs.height=128;
    cvs.style.width='64px'; cvs.style.height='64px';
    const ctx = cvs.getContext('2d'); stickersData[s.id].draw(ctx,64,64,48);
    el.appendChild(cvs);
    makeDraggable(el);
    photoCanvasArea.appendChild(el);
  });
}
function renderGallery(){
  galleryList.innerHTML='';
  gallery.slice().reverse().forEach((dataUrl,idx)=>{
    const div = document.createElement('div'); div.className='snap'; div.style.width='120px'; div.style.height='90px';
    const img = document.createElement('img'); img.src=dataUrl; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
    div.appendChild(img);
    galleryList.appendChild(div);
  });
}

/* ----- Interactions ----- */
document.getElementById('feedBtn').addEventListener('click',()=>{
  state.xp = Math.min(100, state.xp + 5);
  state.affection = Math.min(100, state.affection + 2);
  playPing(600,0.08);
  toast(_("feedSuccess"));
  saveState();
  jiggleMascot('yum');
  awardCoins(1);
  logEvent('feed');
});

document.getElementById('groomBtn').addEventListener('click',()=>{
  state.xp = Math.min(100, state.xp + 6);
  state.affection = Math.min(100, state.affection + 3);
  playSuccess();
  toast(_("groomSuccess"));
  saveState();
  jiggleMascot('sparkle');
  awardCoins(2);
  logEvent('groom');
});

document.getElementById('playBtn').addEventListener('click',()=>{
  openRhythm();
  logEvent('play_open');
});

document.getElementById('photoBtn').addEventListener('click',()=>{
  openPhoto();
  logEvent('photo_open');
});

document.getElementById('dailyBtn').addEventListener('click',()=>{
  const today = new Date().toDateString();
  if(state.lastDaily === today){ toast(_("alreadyClaimed")); return; }
  state.lastDaily = today;
  state.coins += 10;
  state.affection = Math.min(100, state.affection + 5);
  saveState();
  playSuccess();
  runConfetti();
  toast(_("dailyReady"));
  logEvent('daily_claim');
});

document.getElementById('galleryBtn').addEventListener('click',()=> openGallery());

document.getElementById('muteToggle').addEventListener('change', (e)=>{ state.mute = e.target.checked; saveState(); if(state.mute) toggleMusic(false); });
document.getElementById('themeToggle').addEventListener('change', (e)=>{ state.themeNight = e.target.checked; saveState(); });
document.getElementById('contrastToggle').addEventListener('change', (e)=>{ state.highContrast = e.target.checked; saveState(); });
document.getElementById('largeText').addEventListener('change', (e)=>{ state.largeText = e.target.checked; saveState(); });
document.getElementById('langSel').addEventListener('change', (e)=>{ state.lang = e.target.value; saveState(); });

document.getElementById('musicToggle').addEventListener('click',()=>{
  state.musicOn = !state.musicOn;
  toggleMusic(state.musicOn);
  saveState();
});

/* Rename pip */
pipName.addEventListener('input', (e)=>{ state.name = e.target.textContent; saveState(); });

/* Store purchase */
function buyItem(it){
  if(state.coins < it.cost){ toast(_("notEnough")); playFail(); return; }
  state.coins -= it.cost;
  if(it.type==='outfit'){
    state.outfitsOwned.push(it.id);
    toast(_("purchaseOK"));
  } else if(it.type==='stickerPack'){
    it.contents.forEach(c=> state.stickersOwned.push(c));
    toast(_("purchaseOK"));
  }
  saveState();
  runConfetti();
  logEvent('purchase_'+it.id);
}

/* award coins as gentle progression */
function awardCoins(n){
  state.coins += n;
  saveState();
}

/* Tiny mascot jiggle on events */
function jiggleMascot(kind){
  const svg = document.getElementById('mascotSVG');
  svg.classList.remove('mascot-idle');
  svg.style.transformOrigin='50% 50%';
  svg.animate([{transform:'translateY(0)'},{transform:'translateY(-8px) rotate(-3deg)'},{transform:'translateY(0) rotate(0deg)'}],{duration:420, easing:'cubic-bezier(.2,.8,.2,1)'});
  setTimeout(()=>{ svg.classList.add('mascot-idle'); },500);
}

/* Toast */
let toastTimer = null;
function toast(msg){
  statusText.textContent = msg;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ statusText.textContent = state.affection>50 ? (state.lang==='es'?'Feliz':'Happy') : (state.lang==='es'?'Tranquilo':'Feeling cozy'); },2500);
}

/* ----- Rhythm Microgame ----- */
let rhythmSeq = [];
let rhythmIndex = 0;
let rhythmActive = false;
function openRhythm(){
  modalRhythm.classList.add('show');
  modalRhythm.setAttribute('aria-hidden','false');
  generateRhythm();
}
document.getElementById('closeRhythm').addEventListener('click', closeRhythm);
function closeRhythm(){ modalRhythm.classList.remove('show'); modalRhythm.setAttribute('aria-hidden','true'); rhythmActive=false; }

function generateRhythm(){
  rhythmSeq = [];
  const len = 6;
  for(let i=0;i<len;i++) rhythmSeq.push(Math.random()>0.5?1:0);
  const beatRow = document.getElementById('beatRow');
  beatRow.innerHTML = '';
  rhythmSeq.forEach((b,i)=>{
    const d = document.createElement('div'); d.className='beat-dot'; d.textContent = i+1;
    beatRow.appendChild(d);
  });
  document.getElementById('startRhythm').onclick = startRhythm;
  document.getElementById('rhythmResult').textContent = '‚Äî';
}

function startRhythm(){
  rhythmIndex = 0; rhythmActive=true;
  const beatRow = document.getElementById('beatRow').children;
  // play sequence with timings and accept taps
  let t = 0;
  for(let i=0;i<rhythmSeq.length;i++){
    setTimeout(((idx)=>{
      return ()=>{
        highlightBeat(idx);
        // register 'expected' beat if 1 else skip
        // record time
      };
    })(i), t);
    t += 700;
  }
  // setup tap listener
  const startT = performance.now();
  const taps = [];
  function onTap(){ if(!rhythmActive) return; const now = performance.now()-start; taps.push(now); playPing(700,0.06); }
  const start = performance.now();
  function highlightBeat(i){
    for(let j=0;j<beatRow.length;j++) beatRow[j].classList.remove('active');
    beatRow[i].classList.add('active');
    // small cue sound
    if(rhythmSeq[i]) playPing(900,0.06);
    if(i===rhythmSeq.length-1){
      setTimeout(()=>{ evaluateTaps(taps); rhythmActive=false; for(let j=0;j<beatRow.length;j++) beatRow[j].classList.remove('active'); },900);
    }
  }
  document.getElementById('modalRhythm').addEventListener('click', rhythmCapture);
  function rhythmCapture(e){
    if(e.target.classList.contains('beat-dot')){ onTap(); }
    else onTap();
  }
  // also accept spacebar
  function keyTap(e){ if(e.code==='Space') onTap(); }
  window.addEventListener('keydown', keyTap);
  // cleanup after sequence finished
  setTimeout(()=>{ document.getElementById('modalRhythm').removeEventListener('click', rhythmCapture); window.removeEventListener('keydown', keyTap); }, t+1200);
}

function evaluateTaps(taps){
  // simple evaluation: count taps near beats where rhythmSeq has 1
  const expectedTimes = [];
  let t=0;
  for(let i=0;i<rhythmSeq.length;i++){ if(rhythmSeq[i]) expectedTimes.push(t); t+=700;}
  let score = 0;
  expectedTimes.forEach(et=>{
    for(let i=0;i<taps.length;i++){
      if(Math.abs(taps[i]-et) < 220){ score++; taps.splice(i,1); break; }
    }
  });
  const result = document.getElementById('rhythmResult');
  if(score >= Math.ceil(expectedTimes.length*0.6)){
    result.textContent = _("playWin") + ' ('+score+'/'+expectedTimes.length+')';
    state.xp = Math.min(100, state.xp + 10);
    state.affection = Math.min(100, state.affection + 6);
    awardCoins(5);
    playSuccess();
  } else {
    result.textContent = _("playLose") + ' ('+score+'/'+expectedTimes.length+')';
    playFail();
  }
  saveState();
}

/* ----- Photo Booth ----- */
function openPhoto(){
  modalPhoto.classList.add('show'); modalPhoto.setAttribute('aria-hidden','false');
  renderStage();
}
document.getElementById('closePhoto').addEventListener('click', ()=>{ modalPhoto.classList.remove('show'); modalPhoto.setAttribute('aria-hidden','true'); });

document.getElementById('addRandomSticker').addEventListener('click', ()=>{
  const keys = Object.keys(stickersData);
  const id = keys[Math.floor(Math.random()*keys.length)];
  const s = {id,x:Math.random()*200+20,y:Math.random()*120+60,scale:0.6+Math.random()*0.8,rot:(Math.random()*40)-20};
  state.stickersOnStage.push(s);
  saveState();
  renderStage();
});
document.getElementById('clearStickers').addEventListener('click', ()=>{ state.stickersOnStage=[]; saveState(); renderStage(); });

function selectStickerToPlace(id,el){
  // add one at center by default and allow drag
  const s = {id,x:80,y:80,scale:0.8,rot:0};
  state.stickersOnStage.push(s);
  saveState();
  renderStage();
  el.classList.add('active');
  setTimeout(()=>el.classList.remove('active'),600);
}

/* make sticker draggable */
function makeDraggable(el){
  let isDown=false, startX=0, startY=0, origX=0, origY=0;
  el.addEventListener('pointerdown', (e)=>{
    el.setPointerCapture(e.pointerId);
    isDown=true;
    startX=e.clientX; startY=e.clientY;
    origX = parseFloat(el.style.left || 0); origY = parseFloat(el.style.top || 0);
    el.style.cursor='grabbing';
  });
  el.addEventListener('pointermove',(e)=>{
    if(!isDown) return;
    const dx = e.clientX - startX; const dy = e.clientY - startY;
    el.style.left = (origX + dx)+'px'; el.style.top = (origY + dy)+'px';
  });
  el.addEventListener('pointerup',(e)=>{
    isDown=false;
    el.style.cursor='grab';
    const idx = parseInt(el.getAttribute('data-idx'));
    const x = parseFloat(el.style.left); const y = parseFloat(el.style.top);
    state.stickersOnStage[idx].x = x; state.stickersOnStage[idx].y = y;
    saveState();
  });
}

/* Save snapshot: render stage to canvas */
document.getElementById('saveSnap').addEventListener('click', async ()=>{
  const dataUrl = await renderSnapshot();
  gallery.push(dataUrl);
  localStorage.setItem(LS_KEYS.gallery, JSON.stringify(gallery));
  renderGallery();
  toast(_("savedSnap"));
  runConfetti();
  logEvent('snapshot_saved');
});

/* share snapshot via web share if available */
document.getElementById('shareSnap').addEventListener('click', async ()=>{
  const dataUrl = await renderSnapshot();
  if(navigator.canShare && navigator.canShare({files:[]})){
    const blob = dataURLtoBlob(dataUrl);
    const file = new File([blob], (state.name||'pip')+'.png', {type:'image/png'});
    try{
      await navigator.share({files:[file], title:'Pocket Pip', text:'My cozy Pip!'});
      toast('Shared');
    }catch(e){ toast('Share canceled'); }
  } else {
    // fallback: open image in new tab
    const w = window.open();
    w.document.write('<img src="'+dataUrl+'" style="max-width:100%;">');
  }
});

/* render snapshot by drawing onto a canvas */
async function renderSnapshot(){
  const w=640, h=760;
  const cvs = document.createElement('canvas'); cvs.width=w; cvs.height=h;
  const ctx = cvs.getContext('2d');
  // background
  ctx.fillStyle = state.themeNight ? '#081425' : '#fefefe';
  ctx.fillRect(0,0,w,h);
  // draw mascot: we'll draw simplified shapes
  ctx.save();
  ctx.translate(w/2,220);
  // body
  ctx.fillStyle = state.outfit==='blueScarf' ? '#c1f0ff' : '#ffd6e0';
  roundBlob(ctx, -120, -40, 240, 220);
  ctx.fill();
  // eyes and mouth
  ctx.fillStyle='#2b2b2b';
  ctx.beginPath(); ctx.ellipse(-20,20,12,14,0,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(20,20,12,14,0,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='#2b2b2b'; ctx.lineWidth=6; ctx.beginPath(); ctx.moveTo(-6,56); ctx.quadraticCurveTo(0,70,8,56); ctx.stroke();
  // accessory
  if(state.outfit==='pinkHat'){ ctx.fillStyle='#ff9fb1'; ctx.fillRect(-80,-120,160,40); ctx.fillStyle='#ff7aa5'; ctx.fillRect(-40,-140,80,24); }
  if(state.outfit==='blueScarf'){ ctx.fillStyle='#6fc6e8'; ctx.fillRect(-90,70,180,26); }
  ctx.restore();
  // draw stickers
  state.stickersOnStage.forEach(s=>{
    const x = 80 + (s.x || 0);
    const y = 140 + (s.y || 0);
    ctx.save();
    ctx.translate(x,y);
    ctx.rotate((s.rot||0)*Math.PI/180);
    ctx.scale(s.scale||1,s.scale||1);
    // draw sticker using its draw function into a temporary canvas and blit
    const tmp = document.createElement('canvas'); tmp.width=128; tmp.height=128;
    stickersData[s.id].draw(tmp.getContext('2d'),64,64,48);
    ctx.drawImage(tmp,-32,-32,64,64);
    ctx.restore();
  });
  // name tag
  ctx.fillStyle = '#111'; ctx.font='bold 34px sans-serif'; ctx.textAlign='center'; ctx.fillText(state.name, w/2, 70);
  // coins and affection
  ctx.fillStyle = '#000'; ctx.font='16px sans-serif'; ctx.textAlign='left'; ctx.fillText('‚ù§ '+state.affection, 16, 36);
  ctx.fillText('Coins: '+state.coins, 16, 56);
  // footer small
  ctx.fillStyle = '#666'; ctx.font='12px sans-serif'; ctx.textAlign='center'; ctx.fillText('Pocket Pip snapshot', w/2, h-20);
  return cvs.toDataURL('image/png');
}
function roundBlob(ctx,x,y,w,h){
  ctx.beginPath();
  ctx.ellipse(x + w/2, y + h/2, w/2, h/2, 0, 0, Math.PI*2);
}

/* convert dataURL to blob */
function dataURLtoBlob(dataurl) {
  var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
      bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
  while(n--){ u8arr[n] = bstr.charCodeAt(n); }
  return new Blob([u8arr], {type:mime});
}

/* ----- Stickers & Outfits draw functions ----- */
function drawStar(ctx,x,y,r){
  ctx.save();
  ctx.translate(x,y);
  ctx.beginPath();
  for(let i=0;i<5;i++){ ctx.lineTo(Math.cos((18+72*i)/180*Math.PI)*r, -Math.sin((18+72*i)/180*Math.PI)*r); ctx.lineTo(Math.cos((54+72*i)/180*Math.PI)*r*0.5, -Math.sin((54+72*i)/180*Math.PI)*r*0.5); }
  ctx.closePath();
  ctx.fillStyle='#ffdd57'; ctx.fill(); ctx.restore();
}
function drawHeart(ctx,x,y,r){
  ctx.save(); ctx.translate(x,y); ctx.scale(1,-1); ctx.beginPath();
  ctx.moveTo(0, r*0.6); ctx.bezierCurveTo(r, r*1.4, r*1.6, r*-0.2, 0, r*-1.4); ctx.bezierCurveTo(-r*1.6, r*-0.2, -r, r*1.4, 0, r*0.6);
  ctx.fillStyle='#ff9fb1'; ctx.fill(); ctx.restore();
}
function drawFlower(ctx,x,y,r){
  ctx.save(); ctx.translate(x,y);
  for(let i=0;i<6;i++){ ctx.rotate(Math.PI/3); ctx.beginPath(); ctx.ellipse(0,r*0.4,r*0.4,r*0.7,0,0,Math.PI*2); ctx.fillStyle='#ffd6e0'; ctx.fill(); }
  ctx.beginPath(); ctx.arc(0,0,r*0.3,0,Math.PI*2); ctx.fillStyle='#ff9fcb'; ctx.fill(); ctx.restore();
}
function drawSpark(ctx,x,y,r){
  ctx.save(); ctx.translate(x,y); ctx.fillStyle='#fff7c9'; ctx.beginPath(); ctx.moveTo(0,-r); ctx.lineTo(r*0.2,0); ctx.lineTo(r,0); ctx.lineTo(r*0.2,r*0.2); ctx.lineTo(0,r); ctx.lineTo(-r*0.2,r*0.2); ctx.lineTo(-r,0); ctx.lineTo(-r*0.2,0); ctx.closePath(); ctx.fill(); ctx.restore();
}
function drawMoon(ctx,x,y,r){
  ctx.save(); ctx.translate(x,y); ctx.beginPath(); ctx.arc(0,0,r,Math.PI*0.2,Math.PI*1.8,false); ctx.fillStyle='#fffbde'; ctx.fill(); ctx.restore();
}
function drawSun(ctx,x,y,r){
  ctx.save(); ctx.translate(x,y); ctx.beginPath(); ctx.arc(0,0,r*0.6,0,Math.PI*2); ctx.fillStyle='#ffd57a'; ctx.fill();
  for(let i=0;i<8;i++){ ctx.rotate(Math.PI/4); ctx.fillRect(r*0.6,-r*0.05,r*0.8,r*0.1); } ctx.restore();
}

/* outfits apply functions (inserts SVG shapes) */
function applyBase(parent){ parent.innerHTML=''; }
function applyPinkHat(parent){
  parent.innerHTML = `<g transform="translate(30,12)"><rect x="20" y="-6" rx="6" width="80" height="28" fill="#ff9fb1"/><rect x="46" y="-30" rx="12" width="40" height="32" fill="#ff7aa5"/></g>`;
}
function applyBlueScarf(parent){
  parent.innerHTML = `<g transform="translate(22,112)"><rect x="0" y="0" rx="8" width="120" height="18" fill="#6fc6e8"/><path d="M80 5 C100 10,120 18,110 26 C96 40,70 22,80 6z" fill="#6fc6e8" opacity="0.9"/></g>`;
}

/* ----- Gallery modal ----- */
function openGallery(){ modalGallery.classList.add('show'); modalGallery.setAttribute('aria-hidden','false'); populateGalleryGrid(); }
document.getElementById('closeGallery').addEventListener('click', ()=>{ modalGallery.classList.remove('show'); modalGallery.setAttribute('aria-hidden','true'); });

function populateGalleryGrid(){
  const grid = document.getElementById('galleryGrid'); grid.innerHTML='';
  JSON.parse(localStorage.getItem(LS_KEYS.gallery) || '[]').slice().reverse().forEach((d,i)=>{
    const div = document.createElement('div'); div.style.width='180px'; div.style.height='130px'; div.style.border='1px solid rgba(0,0,0,0.04)'; div.style.borderRadius='10px'; div.style.overflow='hidden';
    const img = document.createElement('img'); img.src=d; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
    div.appendChild(img);
    grid.appendChild(div);
  });
}

/* ----- Confetti ----- */
const confetti = [];
function runConfetti(){
  const cvs = modalConfettiCanvas;
  cvs.width = window.innerWidth; cvs.height = window.innerHeight;
  const ctx = cvs.getContext('2d');
  for(let i=0;i<60;i++) confetti.push({x:Math.random()*cvs.width,y:-Math.random()*200,vy:2+Math.random()*4, r:4+Math.random()*8, rot:Math.random()*360, color: randomPastel()});
  let anim;
  function loop(){
    ctx.clearRect(0,0,cvs.width,cvs.height);
    confetti.forEach((c,i)=>{
      c.y += c.vy; c.x += Math.sin((c.y+i)*0.05)*1.6; c.rot += 5;
      ctx.save(); ctx.translate(c.x,c.y); ctx.rotate(c.rot*Math.PI/180); ctx.fillStyle=c.color;
      ctx.fillRect(-c.r/2,-c.r/2,c.r,c.r);
      ctx.restore();
    });
    // remove offscreen
    while(confetti.length && confetti[0].y>cvs.height+50) confetti.shift();
    if(confetti.length) anim = requestAnimationFrame(loop); else cancelAnimationFrame(anim);
  }
  loop();
}
function randomPastel(){ const r = 180+Math.floor(Math.random()*40); const g = 150+Math.floor(Math.random()*80); const b=180+Math.floor(Math.random()*40); return `rgba(${r},${g},${b},0.95)`; }

/* ----- Utilities & Init ----- */
function init(){
  // add store & sticker ownership initial
  if(!state.stickersOwned) state.stickersOwned = ['star','heart'];
  saveState();
  updateUI();
  // attach outfit selection
  outfitSel.addEventListener('change', (e)=>{
    state.outfit = e.target.value; saveState(); renderStage(); logEvent('outfit_change');
  });
  // populate initial stickers from owned
  Object.keys(stickersData).forEach(k=>{ /* placeholder */ });
  // service worker registration (inline)
  registerSW();
  // set up mascot accessory on main SVG
  applyMainOutfit();
}
function applyMainOutfit(){
  const acc = document.querySelector('#mascotSVG #accessory');
  if(acc) { acc.innerHTML = ''; outfits[state.outfit].apply(acc); }
}

/* Service worker: inline via blob */
function registerSW(){
  if('serviceWorker' in navigator){
    const swCode = `
self.addEventListener('install', e=>{ self.skipWaiting(); });
self.addEventListener('activate', e=>{ self.clients.claim(); });
self.addEventListener('fetch', e=>{ /* offline safe for root snapshot data stored in localStorage */ });`;
    const blob = new Blob([swCode], {type:'text/javascript'});
    navigator.serviceWorker.register(URL.createObjectURL(blob)).then(()=>console.log('SW registered')).catch(()=>{/*ignore*/});
  }
}

/* Simple dataURL sticker draw helpers already above */

/* small helper: remove duplicates in arrays for owned items */
function unique(arr){ return Array.from(new Set(arr)); }

/* data initialization for store: show owned vs buy */
function renderStore(){
  storeList.innerHTML = '';
  storeItems.forEach(it=>{
    const row = document.createElement('div'); row.className='item';
    const thumb = document.createElement('div'); thumb.className='thumb';
    thumb.innerHTML = it.type==='outfit' ? '<svg width="44" height="44" viewBox="0 0 64 64"><circle cx="32" cy="24" r="8" fill="#ff9fb1"/><rect x="16" y="36" width="32" height="18" rx="4" fill="#ffd6e0"/></svg>' : '<div style="font-weight:800">üéÅ</div>';
    row.appendChild(thumb);
    const div = document.createElement('div'); div.style.flex='1';
    const title = document.createElement('div'); title.style.fontWeight='800'; title.textContent = it.name[state.lang] || it.name.en;
    const desc = document.createElement('div'); desc.className='small-muted'; desc.textContent = it.desc ? (it.desc[state.lang]||it.desc.en) : '';
    div.appendChild(title); div.appendChild(desc);
    row.appendChild(div);
    const buy = document.createElement('div'); buy.style.display='flex'; buy.style.flexDirection='column'; buy.style.alignItems='flex-end';
    const price = document.createElement('div'); price.className='coins'; price.textContent = it.cost;
    const btn = document.createElement('button'); btn.className='big-btn bouncy'; 
    if(it.type==='outfit' && state.outfitsOwned.includes(it.id)){ btn.textContent='Owned'; btn.disabled=true; } 
    else if(it.type==='stickerPack' && it.contents.every(c=>state.stickersOwned.includes(c))){ btn.textContent='Owned'; btn.disabled=true; }
    else { btn.textContent='Buy'; btn.onclick=()=>{ buyItem(it); } }
    buy.appendChild(price); buy.appendChild(btn);
    row.appendChild(buy);
    storeList.appendChild(row);
  });
}

/* small helpers to draw shapes on small canvas context (centered) already used above in draw functions */
function makeDemoStickerCanvas(id,size){
  const cvs = document.createElement('canvas'); cvs.width=cvs.height=size;
  const ctx = cvs.getContext('2d'); stickersData[id].draw(ctx,size/2,size/2,size/2-6);
  return cvs;
}

/* helper to show simple hint animations */
function tinyPulse(el){
  el.animate([{transform:'scale(1)'},{transform:'scale(1.06)'},{transform:'scale(1)'}],{duration:420,easing:'ease-out'});
}

/* init */
init();

/* small accessibility: keyboard shortcuts */
window.addEventListener('keydown',(e)=>{
  if(e.key==='f') document.getElementById('feedBtn').click();
  if(e.key==='g') document.getElementById('groomBtn').click();
  if(e.key==='p') document.getElementById('playBtn').click();
  if(e.key==='c') document.getElementById('photoBtn').click();
});

/* tiny animation: blink left eye on click */
document.getElementById('mascotWrap').addEventListener('click',(e)=>{
  const eyeL = document.querySelector('.eye-left');
  if(eyeL){ eyeL.classList.add('eye-blink'); setTimeout(()=>eyeL.classList.remove('eye-blink'),800); }
});

/* small init render */
updateUI();

/* utility to draw small sticker functions into canvas contexts (also used during snapshot rendering) */
(function attachStickerDrawers(){
  Object.keys(stickersData).forEach(k=>{
    // already attached in stickersData
  });
})();

/* prevent double-tap zoom on mobile quick taps */
let lastTouch = 0;
document.addEventListener('touchstart', function(e){
  const now = new Date().getTime();
  if(now - lastTouch <= 300) e.preventDefault();
  lastTouch = now;
}, {passive:false});
</script>
</body>
</html>