<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pok√©Mart Deluxe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b1220;
      --card: #141a2b;
      --surface: #1f2540;
      --accent: #ffcb05;
      --accent-2: #3f8cff;
      --text: #e6e6f0;
      --muted: #a5a8b8;
      --danger: #ff5c5c;
      --success: #4cd964;
      --focus: 0 0 0 3px rgba(63,140,255,.4);
      --radius: 14px;
      --shadow: 0 8px 20px rgba(0,0,0,.25);
      --glass: rgba(255,255,255,.06);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px circle at 20% -10%, rgba(63,140,255,.15), transparent 40%), radial-gradient(900px circle at 100% 0%, rgba(255,203,5,.15), transparent 40%), var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      line-height: 1.5;
      overflow-x: hidden;
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }

    /* Header */
    header {
      position: sticky; top: 0; z-index: 50;
      background: rgba(10,12,20,.95);
      border-bottom: 1px solid rgba(255,255,255,.08);
      backdrop-filter: saturate(1.2) blur(6px);
    }
    .header {
      display:flex; align-items:center; gap:14px; padding: 12px 16px;
    }
    .brand { display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.4px; }
    .brand .logo {
      width: 38px; height: 38px; display:grid; place-items:center;
      background: linear-gradient(135deg, #ffcc33 0%, #ff8a00 60%, #ff4343 100%);
      border-radius: 9px; box-shadow: inset 0 0 10px rgba(0,0,0,.25);
    }
    .brand .name { font-size: 1.05rem; }
    .search { flex:1; display:flex; align-items:center; gap:8px; min-width:200px; }
    .search input {
      width:100%; padding: 12px 14px; border-radius:999px; border:1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.08); color: var(--text);
    }
    .filters { display:flex; align-items:center; gap:8px; }
    select, .toggle {
      padding: 10px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.08); color: var(--text);
    }
    button.cart-btn {
      background: rgba(0,0,0,.4); border:1px solid rgba(255,255,255,.25);
      color: white; padding: 10px 14px; border-radius: 999px; cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
    }
    .badge { background: var(--accent); color:#000; padding: 2px 8px; border-radius:999px; font-weight:700; font-size: .8rem; }

    main { padding: 16px; }

    /* Grid */
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(210px, 1fr)); gap: 16px; }
    .card {
      background: linear-gradient(180deg, rgba(20,26,42,.95), rgba(20,26,42,.85));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      padding: 12px; display:flex; flex-direction:column; gap: 8px;
      transition: transform .25s ease, box-shadow .25s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,.25);
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(0,0,0,.35); }
    .card .image {
      height: 120px; display:grid; place-items:center;
      border-radius: 8px; background: linear-gradient(135deg, #2a2f58, #1a1f42);
      font-size: 42px;
    }
    .card h3 { margin: 0; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .card .category { font-size:.85rem; color: var(--muted); }
    .card .price { font-weight:700; font-size: 1.05rem; margin-top:4px; }
    .card button { margin-top: auto; padding: 10px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.2);
      background: rgba(0,0,0,.4); color: white; cursor: pointer;
    }
    .card button:hover { background: rgba(0,0,0,.55); }

    /* Cart Drawer */
    .cart-drawer {
      position: fixed; top: 0; right: 0; height: 100%; width: 360px;
      background: #0b1220; border-left: 1px solid rgba(255,255,255,.15);
      box-shadow: -4px 0 20px rgba(0,0,0,.3); transform: translateX(100%);
      transition: transform .25s ease-out; z-index: 60;
      display:flex; flex-direction:column;
    }
    .cart-drawer.open { transform: translateX(0); }
    .cart-header {
      padding: 14px; display:flex; align-items:center; justify-content: space-between;
      border-bottom:1px solid rgba(255,255,255,.1);
    }
    .cart-content { padding: 12px; overflow: auto; flex:1; display:flex; flex-direction:column; gap:8px; }
    .cart-item { display:flex; gap:8px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,.08); align-items:center; }
    .cart-thumb { width:48px; height:48px; border-radius:6px; display:grid; place-items:center;
      background: #1e254b; font-size: 22px;
    }
    .cart-item-info { min-width:0; display:flex; flex-direction:column; }
    .qty-controls { display:flex; align-items:center; gap:6px; }
    .qty-controls button { width:26px; height:26px; border-radius:6px; border:1px solid rgba(255,255,255,.25); background: rgba(255,255,255,.08); color:white; cursor:pointer; }
    .cart-total { padding:12px; border-top:1px solid rgba(255,255,255,.1); }
    .checkout-btn { width:100%; padding:12px; border-radius:999px; border:0; cursor:pointer;
      background: linear-gradient(135deg, var(--accent), #ffd31a); font-weight:700; color:#000;
    }
    .drawer-close { background: transparent; border:0; color:white; cursor:pointer; font-size:1.2rem; }

    /* Checkout form */
    .section { display:block; margin: 24px 0; padding: 16px; background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); border-radius: 12px; }
    .section h2 { margin:0 0 8px 0; font-size:1.15rem; }
    form { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    label { display:flex; flex-direction:column; gap:6px; font-weight:600; }
    input { padding: 10px; border-radius:6px; border:1px solid rgba(255,255,255,.25); background: rgba(0,0,0,.25); color:white; }
    .full { grid-column: span 2; }
    .note { font-size:.85rem; color:var(--muted); }
    .error { color: var(--danger); font-size:.85rem; }
    .success { color: var(--success); font-weight:700; }

    /* Receipt + Orders */
    .receipt { padding: 16px; background: rgba(0,0,0,.25); border-radius: 12px; border:1px solid rgba(255,255,255,.1); white-space: normal; }
    .order-id { font-family: monospace; font-weight:700; }

    /* Animations helpers */
    @keyframes pop {
      0% { transform: scale(0.6); opacity: 0; }
      60% { transform: scale(1.08); opacity: 1; }
      100% { transform: scale(1); }
    }
    @keyframes floaty {
      0% { transform: translateY(0); opacity: 1; }
      60% { transform: translateY(-20px); opacity: 0.9; }
      100% { transform: translateY(-40px); opacity: 0; }
    }
    .pulse { animation: pop .3s ease-out; }

    /* Confetti canvas */
    #confetti {
      pointer-events: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999;
      overflow: visible;
    }

    /* Accessibility helpers */
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }

    @media (max-width: 900px) {
      form { grid-template-columns: 1fr; }
      .section { margin: 12px 0; }
      .cart-drawer { width: 100%; }
    }

    /* Small sparkles for product cards on add */
    .sparkle {
      position: absolute; width: 10px; height: 10px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff, #ffd700 60%, rgba(255,223,0,0) 70%);
      pointer-events: none;
      animation: floaty 0.9s ease-out forwards;
    }
  </style>
</head>
<body>
  <header aria-label="Site header">
    <div class="container header">
      <div class="brand" aria-label="Pok√©Mart brand">
        <div class="logo" aria-label="Pok√©Mart logo">P</div>
        <div class="name">Pok√©Mart Deluxe</div>
      </div>

      <div class="search" role="search">
        <span class="sr-only">Search catalog</span>
        <input id="searchInput" type="search" placeholder="Search products..." aria-label="Search products" />
      </div>

      <div class="filters" aria-label="Filters">
        <select id="categoryFilter" aria-label="Filter by category"></select>
        <select id="sortFilter" aria-label="Sort catalog">
          <option value="featured" selected>Featured</option>
          <option value="price-asc">Price: Low to High</option>
          <option value="price-desc">Price: High to Low</option>
          <option value="name-asc">Name A-Z</option>
        </select>
      </div>

      <button id="cartToggle" class="cart-btn" aria-label="Open cart">
        üß∫ Cart <span id="cartCount" class="badge" aria-live="polite">0</span>
      </button>
    </div>
  </header>

  <main class="container" id="app">
    <section id="catalog" aria-labelledby="catalog-title" class="section" style="padding-bottom:8px;">
      <h2 id="catalog-title" style="margin:0 0 8px 0;">Catalog</h2>
      <div class="grid" id="productGrid" aria-label="Product catalog grid"></div>
      <div id="promoBar" class="section" style="display:none; padding:12px; margin:8px 0; text-align:center;">
        <strong>Promo!</strong> Use code POKEJOY for 10% off your cart today.
      </div>
    </section>

    <section class="section" aria-labelledby="checkout-title" id="checkoutSection" style="display:none;">
      <h2 id="checkout-title" style="margin:0 0 8px 0;">Checkout</h2>
      <p class="note" id="checkoutIntro" aria-live="polite">Enter your in-game card details to simulate payment. Enjoy a little celebration when done!</p>
      <form id="checkoutForm" autocomplete="off" aria-label="Checkout form" style="gap:12px;">
        <div>
          <label>
            Card Number
            <input id="cardNumber" type="text" inputmode="numeric" autocomplete="cc-number" placeholder="4242 4242 4242 4242" required />
          </label>
          <span class="error" id="cardNumberError" aria-live="polite"></span>
        </div>
        <div>
          <label>
            Expiry (MM/YY)
            <input id="cardExpiry" type="text" placeholder="MM/YY" pattern="^(0[1-9]|1[0-2])\\/([0-9]{2})$" required />
          </label>
          <span class="error" id="cardExpiryError" aria-live="polite"></span>
        </div>
        <div class="full">
          <label>
            CVV
            <input id="cardCVV" type="password" inputmode="numeric" maxlength="4" placeholder="CVV" required />
          </label>
          <span class="error" id="cardCVVError" aria-live="polite"></span>
        </div>

        <div class="full" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
          <label style="display:flex; gap:8px; align-items:center;">
            <input id="giftWrap" type="checkbox" />
            Gift Wrap (+$2.00)
          </label>
          <div class="note" id="promoApplied" aria-live="polite" style="min-width:180px; text-align:right;"></div>
        </div>

        <div class="full" style="text-align:right;">
          <div class="note" id="checkoutNote" aria-live="polite"></div>
          <button type="submit" class="checkout-btn" aria-label="Place order securely" style="min-width:180px;">Pay Securely</button>
        </div>
      </form>

      <div id="processing" class="section" style="display:none;">
        <h3 style="margin:0 0 8px 0;">Processing payment...</h3>
        <div aria-label="Processing indicator" role="status">‚è≥</div>
        <canvas id="confetti" width="0" height="0" aria-hidden="true"></canvas>
      </div>

      <div id="orderResult" class="section" style="display:none;">
        <h3 style="margin:0 0 8px 0;">Payment Successful</h3>
        <p>Your order has been placed. Here are the details:</p>
        <div id="receipt" class="receipt" aria-label="Order receipt"></div>
        <button id="backToShop" style="margin-top:8px;" class="checkout-btn" aria-label="Back to shop">Back to shop</button>
      </div>
    </section>
  </main>

  <!-- Cart Drawer -->
  <aside id="cartDrawer" class="cart-drawer" aria-label="Cart" aria-expanded="false" aria-hidden="true">
    <div class="cart-header">
      <strong>Cart</strong>
      <button class="drawer-close" id="drawerClose" aria-label="Close cart">‚úï</button>
    </div>
    <div class="cart-content" id="cartContent" aria-live="polite">
      <!-- items appended here -->
    </div>
    <div class="cart-total" aria-live="polite">
      <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
        <span>Subtotal</span><span id="cartSubtotal">$0.00</span>
      </div>
      <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
        <span>Est. Tax</span><span id="cartTax">$0.00</span>
      </div>
      <div style="display:flex; justify-content:space-between; font-weight:700;">
        <span>Total</span><span id="cartTotal">$0.00</span>
      </div>
      <button id="checkoutBtn" class="checkout-btn" aria-label="Proceed to checkout" style="margin-top:8px;">Checkout</button>
    </div>
  </aside>

  <script>
    // Data
    const PRODUCTS = [
      { id: 'p1', name: 'Pok√© Ball', category: 'Pok√© Balls', price: 199, emoji: 'üü†' },
      { id: 'p2', name: 'Great Ball', category: 'Pok√© Balls', price: 299, emoji: 'üîµ' },
      { id: 'p3', name: 'Ultra Ball', category: 'Pok√© Balls', price: 499, emoji: 'üü£' },
      { id: 'p4', name: 'Potion', category: 'Potions', price: 149, emoji: 'üß™' },
      { id: 'p5', name: 'Super Potion', category: 'Potions', price: 299, emoji: 'üß´' },
      { id: 'p6', name: 'Hyper Potion', category: 'Potions', price: 499, emoji: 'üíä' },
      { id: 'p7', name: 'Pok√©dex Card Pack', category: 'Cards', price: 899, emoji: 'üÉè' },
      { id: 'p8', name: 'Energy Card Pack', category: 'Cards', price: 799, emoji: '‚ö°' },
      { id: 'p9', name: 'Pok√©mon Plush', category: 'Toys', price: 899, emoji: 'üß∏' },
      { id: 'p10', name: 'Trainer Hat', category: 'Accessories', price: 799, emoji: 'üß¢' },
      { id: 'p11', name: 'Key Item Case', category: 'Accessories', price: 899, emoji: 'üóùÔ∏è' },
      { id: 'p12', name: 'Battle Deck Card', category: 'Cards', price: 1099, emoji: 'üÉè' },
      { id: 'p13', name: 'Thunder Shocker', category: 'Gadget', price: 1299, emoji: '‚ö°Ô∏è' },
      { id: 'p14', name: 'Mini Figure Set', category: 'Toys', price: 499, emoji: 'üéé' },
    ];

    // Globals
    const cartKey = 'pokemart_cart';
    const ordersKey = 'pokemart_orders';
    const promoKey = 'pokemart_promo';
    let cart = { items: [] }; // { productId, qty, price }
    let orders = [];
    let appliedPromo = '';

    // UI Elements
    const productGrid = document.getElementById('productGrid');
    const categoryFilter = document.getElementById('categoryFilter');
    const sortFilter = document.getElementById('sortFilter');
    const searchInput = document.getElementById('searchInput');
    const cartToggle = document.getElementById('cartToggle');
    const cartCount = document.getElementById('cartCount');
    const cartDrawer = document.getElementById('cartDrawer');
    const cartContent = document.getElementById('cartContent');
    const cartSubtotalEl = document.getElementById('cartSubtotal');
    const cartTaxEl = document.getElementById('cartTax');
    const cartTotalEl = document.getElementById('cartTotal');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const drawerClose = document.getElementById('drawerClose');
    const checkoutSection = document.getElementById('checkoutSection');
    const checkoutForm = document.getElementById('checkoutForm');
    const cardNumber = document.getElementById('cardNumber');
    const cardExpiry = document.getElementById('cardExpiry');
    const cardCVV = document.getElementById('cardCVV');
    const giftWrap = document.getElementById('giftWrap');
    const cardNumberError = document.getElementById('cardNumberError');
    const cardExpiryError = document.getElementById('cardExpiryError');
    const cardCVVError = document.getElementById('cardCVVError');
    const checkoutNote = document.getElementById('checkoutNote');
    const processing = document.getElementById('processing');
    const orderResult = document.getElementById('orderResult');
    const receiptDiv = document.getElementById('receipt');
    const backToShop = document.getElementById('backToShop');
    const promoApplied = document.getElementById('promoApplied');
    const confettiCanvas = document.getElementById('confetti');
    const promoBar = document.getElementById('promoBar');
    const promoIntro = document.getElementById('checkoutIntro');
    const promoCodeInput = null; // not user-editable in this version
    const promoBarVisible = promoBar.style.display !== 'none';

    // Confetti helper
    let confettiCtx, confettiTimer;
    function initConfetti() {
      confettiCtx = confettiCanvas.getContext('2d');
      resizeConfetti();
      window.addEventListener('resize', resizeConfetti);
    }
    function resizeConfetti() {
      confettiCanvas.width = window.innerWidth;
      confettiCanvas.height = window.innerHeight;
    }
    function launchConfetti(pieces = 60, colors = ['#ff5c5c','#ffd31a','#3f8cff','#4cd964','#ff8af6']) {
      // Draw simple confetti particles
      const w = confettiCanvas.width;
      const h = confettiCanvas.height;
      const particles = [];
      for (let i = 0; i < pieces; i++) {
        particles.push({
          x: Math.random() * w,
          y: -10,
          r: Math.random() * 6 + 4,
          c: colors[Math.floor(Math.random() * colors.length)],
          vy: Math.random() * 2 + 2,
          vx: (Math.random() - 0.5) * 3,
          rotation: Math.random() * 360,
          vr: Math.random() * 6 - 3
        });
      }
      const start = performance.now();
      function draw(t) {
        const dt = t - start;
        confettiCtx.clearRect(0,0,w,h);
        for (const p of particles) {
          p.x += p.vx;
          p.y += p.vy;
          p.rotation += p.vr;
          confettiCtx.save();
          confettiCtx.translate(p.x, p.y);
          confettiCtx.rotate(p.rotation * Math.PI/180);
          confettiCtx.fillStyle = p.c;
          confettiCtx.fillRect(-p.r/2, -p.r/2, p.r, p.r);
          confettiCtx.restore();
        }
        if (particles[0].y < h + 20) {
          requestAnimationFrame(draw);
        } else {
          confettiCtx.clearRect(0,0,w,h);
        }
      }
      requestAnimationFrame(draw);
    }

    // Init
    function saveCart() {
      localStorage.setItem(cartKey, JSON.stringify(cart));
      updateCartUI();
    }
    function loadCart() {
      const raw = localStorage.getItem(cartKey);
      if (raw) {
        try { cart = JSON.parse(raw); } catch { cart = { items: [] }; }
      }
      updateCartUI();
    }
    function loadOrders() {
      const raw = localStorage.getItem(ordersKey);
      if (raw) {
        try { orders = JSON.parse(raw); } catch { orders = []; }
      }
    }
    function saveOrders() {
      localStorage.setItem(ordersKey, JSON.stringify(orders));
    }
    function savePromo(code) {
      localStorage.setItem(promoKey, JSON.stringify({ code }));
    }
    function loadPromo() {
      const raw = localStorage.getItem(promoKey);
      if (raw) {
        try { const obj = JSON.parse(raw); appliedPromo = obj.code; } catch { appliedPromo = ''; }
      }
    }

    // Catalog rendering
    function populateCategories() {
      const cats = Array.from(new Set(PRODUCTS.map(p => p.category)));
      cats.sort();
      // Add "All" option
      categoryFilter.innerHTML = '<option value="">All categories</option>';
      cats.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        categoryFilter.appendChild(opt);
      });
    }

    function formatCurrency(n) {
      let amount = (n / 100);
      // apply promo discount if any
      if (appliedPromo === 'POKEMON') {
        amount = amount * 0.9;
      }
      return '$' + amount.toFixed(2);
    }

    function computeCartTotals() {
      let subtotal = 0;
      cart.items.forEach(item => {
        subtotal += item.qty * item.price;
      });
      if (document.getElementById('giftWrap')?.checked) {
        subtotal += 200; // $2.00 = 200 cents
      }
      // 8% tax
      const tax = Math.round(subtotal * 0.08);
      const total = subtotal + tax;
      return { subtotal, tax, total };
    }

    function renderCart() {
      cartContent.innerHTML = '';
      if (cart.items.length === 0) {
        const empty = document.createElement('div');
        empty.textContent = 'Your cart is empty. Add some Pok√©mon goodies!';
        empty.style.color = 'var(--muted)';
        cartContent.appendChild(empty);
      } else {
        cart.items.forEach(item => {
          const prod = PRODUCTS.find(p => p.id === item.productId);
          const row = document.createElement('div');
          row.className = 'cart-item';
          row.innerHTML = `
            <div class="cart-thumb" aria-label="Product image" style="font-size:20px; background:#1e254b;">
              ${prod.emoji ?? 'üéÅ'}
            </div>
            <div class="cart-item-info" style="min-width:0;">
              <div style="font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:180px;">
                ${prod.name}
              </div>
              <div style="font-size:.85rem; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:180px;">
                ${prod.category}
              </div>
              <div style="font-size:.9rem; font-weight:700;">${formatCurrency(item.qty * item.price)}</div>
            </div>
            <div class="qty-controls" aria-label="Quantity controls" role="group">
              <button data-id="${item.productId}" class="dec" aria-label="Decrease quantity">‚àí</button>
              <span style="min-width:22px; text-align:center; display:inline-block;">${item.qty}</span>
              <button data-id="${item.productId}" class="inc" aria-label="Increase quantity">Ôºã</button>
              <button data-id="${item.productId}" class="remove" aria-label="Remove item" style="margin-left:6px; background:transparent; border:0; color:var(--danger); font-weight:700;">‚úï</button>
            </div>
          `;
          cartContent.appendChild(row);
        });
      }
      const totals = computeCartTotals();
      cartSubtotalEl.textContent = formatCurrency(totals.subtotal);
      cartTaxEl.textContent = formatCurrency(totals.tax);
      cartTotalEl.textContent = formatCurrency(totals.total);
      cartCount.textContent = cart.items.reduce((s,i)=>s+i.qty,0);

      // Toggle transfer: if no items, hide checkout button
      if (cart.items.length > 0) {
        // enable
        checkoutBtn.disabled = false;
        checkoutBtn.style.opacity = '1';
      } else {
        checkoutBtn.disabled = true;
        checkoutBtn.style.opacity = '0.6';
      }
    }

    function updateCartUI() { renderCart(); }

    // Catalog rendering
    function renderCatalog(filterCategory = '', search = '', sortMode = 'featured') {
      productGrid.innerHTML = '';
      const q = search.trim().toLowerCase();
      let items = PRODUCTS.filter(p => {
        const byCat = filterCategory ? p.category === filterCategory : true;
        const bySearch = q ? (p.name.toLowerCase().includes(q) || p.category.toLowerCase().includes(q)) : true;
        return byCat && bySearch;
      });

      // sort
      if (sortMode === 'price-asc') items = items.sort((a,b)=> a.price - b.price);
      else if (sortMode === 'price-desc') items = items.sort((a,b)=> b.price - a.price);
      else if (sortMode === 'name-asc') items = items.sort((a,b)=> a.name.localeCompare(b.name));
      // featured: keep given order
      items.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="image" aria-label="${p.name} image" title="${p.name}">${p.emoji ?? 'üéÅ'}</div>
          <h3>${p.name}</h3>
          <div class="category" aria-label="Category">${p.category}</div>
          <div class="price" aria-label="Price">${formatCurrency(p.price)}</div>
          <button data-id="${p.id}" aria-label="Add ${p.name} to cart">Add to cart</button>
        `;
        productGrid.appendChild(card);
        const btn = card.querySelector('button');
        btn.addEventListener('click', () => {
          addToCart(p.id);
        });
        // subtle tilt on hover
        card.addEventListener('mousemove', (e) => {
          const rX = false;
        });
      });
    }

    // Cart actions
    function addToCart(productId) {
      const existing = cart.items.find(i => i.productId === productId);
      const prod = PRODUCTS.find(p => p.id === productId);
      const price = prod.price;
      if (existing) existing.qty += 1;
      else cart.items.push({ productId, qty: 1, price });
      saveCart();

      // fly animation
      const btn = document.querySelector(`button[data-id="${productId}"]`);
      if (btn) flyToCart(btn, prod.emoji ?? 'üéØ');

      flashMessage('Added to cart');
      // small sparkle near product
      createSparkles(productId);
    }

    function flashMessage(msg) {
      checkoutNote.textContent = msg;
      setTimeout(() => { checkoutNote.textContent = ''; }, 1200);
    }

    function flyToCart(fromElem, emoji) {
      const rectFrom = fromElem.getBoundingClientRect();
      const img = document.createElement('div');
      img.className = 'sparkle';
      img.style.left = (rectFrom.left + rectFrom.width/2) + 'px';
      img.style.top = (rectFrom.top + rectFrom.height/2) + 'px';
      img.style.background = 'radial-gradient(circle at 30% 30%, #fff, #ffd700 60%, rgba(255,215,0,0) 70%)';
      document.body.appendChild(img);
      const cartRect = cartDrawer.getBoundingClientRect();
      const targetX = cartRect.left + 20;
      const targetY = cartRect.top + 40;
      const vx = targetX - (rectFrom.left + rectFrom.width/2);
      const vy = targetY - (rectFrom.top + rectFrom.height/2);
      img.animate([
        { transform: 'translate(0,0)', opacity: 1 },
        { transform: `translate(${vx}px, ${vy}px) scale(0.4)`, opacity: 0.9 }
      ], {
        duration: 700,
        easing: 'ease-in',
      }).onfinish = () => img.remove();
    }

    function createSparkles(productId) {
      const prod = PRODUCTS.find(p => p.id === productId);
      const count = 6;
      for (let i = 0; i < count; i++) {
        const s = document.createElement('span');
        s.className = 'sparkle';
        s.style.left = Math.random() * window.innerWidth + 'px';
        s.style.top = (Math.random() * 100) + 'px';
        s.style.background = 'radial-gradient(circle at 30% 30%, #fff, #ffd700 60%, rgba(255,215,0,0) 70%)';
        document.body.appendChild(s);
        s.style.transition = 'opacity 0.8s ease-out, transform 0.8s ease-out';
        requestAnimationFrame(() => {
          s.style.transform = `translate(${(Math.random()-0.5)*200}px, ${-Math.random()*180}px)`;
          s.style.opacity = '0';
        });
        setTimeout(() => s.remove(), 1000);
      }
    }

    // Cart interactions
    cartContent.addEventListener('click', (e) => {
      const t = e.target;
      if (t.classList.contains('inc') || t.classList.contains('dec')) {
        const pid = t.dataset.id;
        const item = cart.items.find(i => i.productId === pid);
        if (!item) return;
        if (t.classList.contains('inc')) item.qty += 1;
        else {
          item.qty -= 1;
          if (item.qty <= 0) cart.items = cart.items.filter(i => i.productId !== pid);
        }
        saveCart();
      } else if (t.classList.contains('remove')) {
        const pid = t.dataset.id;
        cart.items = cart.items.filter(i => i.productId !== pid);
        saveCart();
      }
    });

    // Filters handling
    categoryFilter.addEventListener('change', () => {
      renderCatalog(categoryFilter.value, searchInput.value, sortFilter.value);
    });
    searchInput.addEventListener('input', () => {
      renderCatalog(categoryFilter.value, searchInput.value, sortFilter.value);
    });
    sortFilter.addEventListener('change', () => {
      renderCatalog(categoryFilter.value, searchInput.value, sortFilter.value);
    });

    // Drawer
    function openCart() {
      cartDrawer.classList.add('open');
      cartDrawer.setAttribute('aria-expanded', 'true');
      cartDrawer.setAttribute('aria-hidden', 'false');
    }
    function closeCart() {
      cartDrawer.classList.remove('open');
      cartDrawer.setAttribute('aria-expanded', 'false');
      cartDrawer.setAttribute('aria-hidden', 'true');
    }

    cartToggle.addEventListener('click', () => {
      if (cartDrawer.classList.contains('open')) closeCart();
      else {
        openCart();
        // ensure UI updated
        updateCartUI();
      }
    });
    drawerClose.addEventListener('click', () => closeCart());

    // Checkout flow
    checkoutBtn.addEventListener('click', () => {
      if (cart.items.length === 0) {
        flashMessage('Your cart is empty');
        return;
      }
      subtotalHint();
      checkoutSection.style.display = 'block';
      document.getElementById('checkoutSection').scrollIntoView({ behavior: 'smooth' });
      cardNumber.focus();
    });

    function subtotalHint() {
      const totals = computeCartTotals();
      if (totals.subtotal > 0 && appliedPromo) {
        flashMessage('Promo applied');
      }
    }

    function clearErrors() {
      cardNumberError.textContent = '';
      cardExpiryError.textContent = '';
      cardCVVError.textContent = '';
    }

    function luhnCheck(cardNum) {
      const num = cardNum.replace(/\D/g, '');
      let sum = 0;
      let shouldDouble = false;
      for (let i = num.length - 1; i >= 0; i--) {
        let digit = parseInt(num.charAt(i), 10);
        if (shouldDouble) {
          digit *= 2;
          if (digit > 9) digit -= 9;
        }
        sum += digit;
        shouldDouble = !shouldDouble;
      }
      return (sum % 10) === 0;
    }

    function validateCard() {
      clearErrors();
      const numRaw = cardNumber.value.replace(/\s+/g, '');
      if (!numRaw || !/^[0-9]{13,19}$/.test(numRaw) || !luhnCheck(numRaw)) {
        cardNumberError.textContent = 'Invalid card number.';
        return false;
      }
      const expiry = cardExpiry.value.trim();
      if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(expiry)) {
        cardExpiryError.textContent = 'Expiry must be MM/YY';
        return false;
      }
      if (!/^\d{3,4}$/.test(cardCVV.value.trim())) {
        cardCVVError.textContent = 'CVV must be 3 or 4 digits';
        return false;
      }
      return true;
    }

    checkoutForm.addEventListener('submit', (e) => {
      e.preventDefault();
      if (!validateCard()) return;
      const gift = giftWrap.checked;
      // store promo used (simulate)
      if (appliedPromo) promoApplied.textContent = 'Promo: ' + appliedPromo;
      // Show processing
      processing.style.display = 'block';
      orderResult.style.display = 'none';
      // Disable form
      checkoutForm.querySelectorAll('input, button').forEach(el => el.disabled = true);
      const total = Math.max(0, computeCartTotals().total);
      // Simulate processing
      setTimeout(() => {
        // Create order
        const orderId = 'PM-' + Math.random().toString(36).slice(2,7).toUpperCase();
        const orderItems = cart.items.map(ci => {
          const p = PRODUCTS.find(p => p.id === ci.productId);
          return { id: p.id, name: p.name, qty: ci.qty, price: ci.price };
        });
        const order = {
          id: orderId,
          date: new Date().toISOString(),
          items: orderItems,
          total
        };
        orders.unshift(order);
        saveOrders();
        // Clear cart
        cart.items = [];
        saveCart();
        // Show receipt
        showReceipt(order);
        // confetti celebration
        launchConfetti();
      }, 1100);
    });

    function showReceipt(order) {
      processing.style.display = 'none';
      checkoutForm.style.display = 'none';
      orderResult.style.display = 'block';
      let promoLabel = appliedPromo ? `<div>Promo: ${appliedPromo}</div>` : '';
      let html = `
        <p>Order Number: <span class="order-id">${order.id}</span></p>
        <p>Date: ${new Date(order.date).toLocaleString()}</p>
        ${promoLabel}
        <hr />
        <div aria-label="Order items" style="max-height:200px; overflow:auto;">
          ${order.items.map(it => `<div style="display:flex; justify-content:space-between; padding:6px 0;">
            <span>${it.name} √ó ${it.qty}</span><span>${formatCurrency(it.qty * it.price)}</span>
          </div>`).join('')}
        </div>
        <hr />
        <div style="display:flex; justify-content:space-between; font-weight:700;">
          <span>Total</span><span>${formatCurrency(order.total)}</span>
        </div>
      `;
      receiptDiv.innerHTML = html;
      receiptDiv.scrollIntoView({ behavior: 'smooth' });
    }

    backToShop.addEventListener('click', () => {
      orderResult.style.display = 'none';
      checkoutForm.reset();
      // re-enable and hide checkout
      checkoutForm.querySelectorAll('input, button').forEach(el => el.disabled = false);
      document.getElementById('checkoutSection').style.display = 'none';
      // Return to catalog
      document.getElementById('catalog').scrollIntoView({ behavior: 'smooth' });
      // reset promo bar
      promoApplied.textContent = '';
    });

    // Init
    function init() {
      // Build catalog
      populateCategories();
      // Load cart/orders
      loadCart();
      loadOrders();
      loadPromo();
      appliedPromo = appliedPromo || '';
      renderCatalog(categoryFilter.value, searchInput.value, sortFilter.value);
      // Show promo bar briefly
      if (!appliedPromo) {
        promoBar.style.display = 'block';
        promoBar.textContent = 'Promo: Use POKEMON by checkout for 10% off.';
      } else {
        promoBar.style.display = 'block';
      }
      initConfetti();
      // Seed: apply promo automatically if existed
      if (appliedPromo) promoApplied.textContent = 'Promo: ' + appliedPromo;
    }

    // Hook up initial load
    window.addEventListener('DOMContentLoaded', init);

    // Accessibility niceties
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && cartDrawer.classList.contains('open')) {
        closeCart();
      }
    });

  </script>

  <!-- Small decorative script to ensure confetti canvas exists and animations stable -->
</body>
</html>