<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sip & Glass Match - Deluxe</title>
<style>
  :root {
    --bg: #1e1b1f;
    --panel: #2a232b;
    --drk: #141618;
    --accent: #6bd6ff;
    --text: #f3f3f3;
    --gold: #ffd700;
    --green: #3bd58a;
  }
  html, body {
    height: 100%;
    margin: 0;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto;
    background: radial-gradient(circle at 30% -10%, #2a1a3d44, transparent 40%), #0e0a0f;
    color: var(--text);
    overflow: hidden;
  }
  /* gentle parallax backdrop */
  .parallaxBG {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, rgba(40,0,60,.25), rgba(0,60,120,.15) 40%, transparent 60%);
    background-size: 200% 200%;
    animation: driftBG 60s linear infinite;
    pointer-events: none;
    z-index: 0;
  }
  @keyframes driftBG { 0%{background-position:0% 0%} 100%{background-position:100% 100%} }

  .wrap {
    display: grid;
    grid-template-rows: auto 1fr auto;
    height: 100%;
    width: 100%;
    position: relative;
    z-index: 1;
  }
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.0));
    border-bottom: 1px solid #ffffff22;
    gap: 12px;
  }
  .brand {
    display: flex; align-items: center; gap: 12px;
  }
  .brand .logo {
    width: 32px; height: 32px; border-radius: 8px;
    background: conic-gradient(from 180deg at 50% 50%, #66e, #6f6 40%, #e6f 60%, #66e 100%);
    box-shadow: 0 0 8px #6bd6ff88;
  }
  .brand h1 { font-size: 16px; margin: 0; letter-spacing: .3px; }
  .controls { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .control {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 6px 10px; border-radius: 8px; background:#ffffff11; border:1px solid #ffffff22;
    font-size: 12px;
  }
  select, input[type="range"] { accent-color: #66e; }
  .scoreboard {
    display: flex; gap: 14px; align-items: center;
  }
  .badge {
    padding: 6px 10px; border-radius: 8px; background:#ffffff12; border:1px solid #ffffff22; font-size:12px;
  }
  .panelTitle {
    font-size: 12px; text-transform: uppercase; opacity: .8;
  }
  main.game-area {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    padding: 12px;
    height: calc(100% - 140px);
  }
  .panel {
    position: relative;
    background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.12));
    border: 1px solid #ffffff22;
    border-radius: 12px;
    padding: 12px;
    overflow: hidden;
  }
  .panel h2 {
    margin: 0 0 8px 0; font-size: 14px; letter-spacing: .4px; text-transform: uppercase; opacity: .9;
  }
  .drinks-area, .glasses-area {
    position: relative;
    height: calc(100% - 32px);
    border-radius: 8px;
    overflow: hidden;
    background: rgba(0,0,0,.15);
  }
  .drink, .glass {
    position: absolute;
    width: 110px; height: 60px; border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    color: #000; user-select: none; touch-action: none;
    cursor: grab;
    box-shadow: 0 6px 12px rgba(0,0,0,.25);
    transition: transform .15s ease, opacity .15s ease;
  }
  .drink.dragging { opacity: .65; cursor: grabbing; transform: scale(1.04); z-index: 1000; }
  .drink .label { position: absolute; bottom: -18px; font-size: 11px; color: #fff; text-shadow: 0 1px 2px #000; white-space: nowrap; }
  .glass {
    width: 140px; height: 110px; border-radius: 14px; display: flex; align-items: center; justify-content: center;
    color: #fff; font-weight: bold; font-size: 12px; text-shadow: 0 1px 2px rgba(0,0,0,.6);
    border: 2px solid #fff2; box-shadow: inset 0 0 0 rgba(0,0,0,0);
    transition: transform .3s ease;
  }
  .glass.pass { outline: 4px solid #fff; outline-offset: -6px; animation: pulse 1s infinite; }
  @keyframes pulse { 0%{outline-color:#fff2} 50%{outline-color:#fff} 100%{outline-color:#fff2} }

  /* hints */
  .hint {
    position: absolute; pointer-events: none;
    width: 120px; height: 60px; border-radius: 12px;
    border: 3px dashed #fff6; animation: hint 1.4s ease-in-out infinite;
  }
  @keyframes hint { 0%{opacity:0} 50%{opacity:1} 100%{opacity:0} }

  .overlay {
    position: absolute; inset: 0; display: none; align-items: center; justify-content: center;
    background: rgba(0,0,0,.5); z-index: 999;
  }
  .modal {
    background: #111319; padding: 20px; border-radius: 12px; text-align: center; max-width: 90%; color: #fff;
    border: 1px solid #ffffff33;
  }
  .stars { display: inline-flex; gap: 4px; margin: 8px 0; }
  .star { width: 18px; height: 18px; display: inline-block; background: transparent; }
  .star.active { background: radial-gradient(circle at 30% 30%, #ffd700 0 50%, transparent 51%), yellow; mask: none; }
  .btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    padding: 10px 14px; border-radius: 8px; border: none; cursor: pointer;
    background: #6bd6ff; color: #001018; font-weight: bold;
    transition: transform .15s ease;
  }
  .btn.secondary { background: #ffffff22; color: #fff; }
  .btn:active { transform: scale(0.98); }

  /* particles canvas */
  canvas#particleCanvas { position: absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:0; }

  /* color-blind visuals toggle hint badge */
  .cb-dlid { display: inline-block; width: 18px; height: 18px; border-radius: 4px; margin-right: 6px; vertical-align: middle; }

  /* settings panel - modal-like */
  .settingsPanel {
    position: fixed; right: 16px; top: 60px; width: 320px; max-width: calc(100% - 32px);
    background: #0b0b12; border: 1px solid #ffffff33; border-radius: 12px; padding: 12px;
    display: none; z-index: 1001;
  }
  .settingsPanel h3 { margin: 6px 0 12px; font-size: 14px; text-transform: uppercase; letter-spacing: .4px; }
  .settingsPanel .row { display:flex; align-items:center; justify-content: space-between; padding:6px 0; gap:8px; }
  .settingsPanel label { font-size:12px; color:#ddd; }
  .settingsPanel input[type="range"] { width: 120px; }
  .settingsPanel .close { float:right; cursor:pointer; padding:4px 8px; border-radius:6px; background:#ffffff11; border:1px solid #ffffff33; }

  /* pause overlay */
  #pauseOverlay {
    position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
    background: rgba(0,0,0,.6); z-index: 1002;
  }
  #pauseOverlay .modal { padding: 22px; min-width: 260px; }
  #pauseOverlay .btn { margin: 6px; }
  /* responsive tweaks */
  @media (max-width: 980px) {
    main.game-area { grid-template-columns: 1fr; height: auto; }
    .drinks-area, .glasses-area { height: 420px; }
  }
</style>
</head>
<body>
<div class="parallaxBG" aria-hidden="true"></div>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-label="Sip & Glass logo"></div>
      <h1>Sip & Glass Match Deluxe</h1>
    </div>
    <div class="controls" aria-label="Game controls">
      <div class="control" title="Difficulty">
        Difficulty
        <select id="difficulty" aria-label="Difficulty select" style="background:#00000033; color:white; border:1px solid #ffffff44; border-radius:6px; padding:4px;">
          <option value="Easy">Easy</option>
          <option value="Medium" selected>Medium</option>
          <option value="Hard">Hard</option>
        </select>
      </div>
      <div class="control" title="Color Blind">
        Color Blind
        <input type="checkbox" id="cb" aria-label="Color Blind mode" />
      </div>
      <div class="control" title="Volume">
        Volume
        <input type="range" id="volume" min="0" max="1" step="0.01" value="0.8" style="width:120px;">
      </div>
      <button class="btn" id="hintBtn" title="Hint (limited)">Hint</button>
      <button class="btn" id="startBtn" title="Start Level">Play</button>
      <button class="btn" id="settingsBtn" title="Settings" style="background:#ffffff22;">Settings</button>
      <button class="btn" id="pauseBtn" title="Pause/Resume" style="background:#ffffff33;">Pause</button>
    </div>
  </header>

  <main class="game-area" aria-label="Game area">
    <section class="panel" id="drinksPanel" aria-label="Drinks area">
      <h2 class="panelTitle">Drinks</h2>
      <div class="drinks-area" id="drinksArea"></div>
    </section>

    <section class="panel" id="glassesPanel" aria-label="Glasses area">
      <h2 class="panelTitle">Glasses</h2>
      <div class="glasses-area" id="glassesArea"></div>
    </section>
    <canvas id="particleCanvas"></canvas>
  </main>

  <footer style="padding:12px 16px; display:flex; justify-content:space-between; align-items:center; border-top:1px solid #ffffff22; background:#00000011;">
    <div id="levelWrap" class="badge" style="display:flex; align-items:center; gap:8px;">
      Level <span id="levelInfo" style="font-weight:bold;">1</span>
    </div>
    <div class="scoreboard" aria-label="Scoreboard" style="gap:8px;">
      <div class="badge" title="Coins">Coins: <span id="coins">0</span></div>
      <div class="badge" title="Score">Score: <span id="score">0</span></div>
      <div class="badge" title="Hints left">Hints: <span id="hintCount">2</span></div>
      <div class="badge" id="multiplierBadge" title="Combo multiplier">Combo x1</div>
    </div>
  </footer>
</div>

<!-- Settings Panel -->
<div class="settingsPanel" id="settingsPanel" aria-label="Settings panel">
  <button class="close" id="closeSettings">X</button>
  <h3>Settings</h3>
  <div class="row">
    <label for="diffPanel">Difficulty</label>
    <select id="diffPanel" aria-label="Difficulty select panel">
      <option value="Easy">Easy</option>
      <option value="Medium" selected>Medium</option>
      <option value="Hard">Hard</option>
    </select>
  </div>
  <div class="row">
    <label>Color Blind</label>
    <input type="checkbox" id="cbPanel" />
  </div>
  <div class="row">
    <label>Particle Density</label>
    <input type="range" id="particleDensity" min="0" max="200" value="80">
  </div>
  <div class="row">
    <label>Ambient Theme</label>
    <select id="themePanel" aria-label="Theme select">
      <option value="Neon" selected>Neon</option>
      <option value="Classic">Classic</option>
      <option value="Dream">Dream</option>
    </select>
  </div>
</div>

<!-- Pause Overlay -->
<div id="pauseOverlay" aria-label="Pause overlay">
  <div class="modal" style="min-width:260px;">
    <h3 style="margin:0 0 8px;">Paused</h3>
    <p style="margin:6px 0 12px;">Take a breath. When you're ready, resume the level.</p>
    <div style="display:flex; justify-content:center; gap:8px;">
      <button class="btn" id="resumeBtn">Resume</button>
      <button class="btn secondary" id="restartBtn">Restart Level</button>
    </div>
  </div>
</div>

<!-- End overlay (reused) -->
<div class="overlay" id="endOverlay" aria-hidden="true" style="display:none;">
  <!-- content injected dynamically -->
</div>

<script>
(function(){
  // Game data
  const DRINKS = [
    { id:'orange', name:'Orange', color:'#FF8C00', pattern:'circle' },
    { id:'lemon', name:'Lemonade', color:'#FFD700', pattern:'triangle' },
    { id:'grape', name:'Grape Soda', color:'#7A5BD8', pattern:'square' },
    { id:'pineapple', name:'Pineapple Crush', color:'#F4C430', pattern:'diamond' },
    { id:'watermelon', name:'Watermelon Splash', color:'#E11D6E', pattern:'circle' },
    { id:'blueberry', name:'Blueberry Burst', color:'#3B6BD6', pattern:'star' },
    { id:'mango', name:'Mango Mania', color:'#FDBA3D', pattern:'circle' },
    { id:'coconut', name:'Coconut Cooler', color:'#D2B48C', pattern:'square' },
    { id:'strawberry', name:'Strawberry Spark', color:'#E0184A', pattern:'triangle' },
    { id:'mint', name:'Mint Mojito', color:'#2ECC71', pattern:'diamond' }
  ];

  // Settings & state
  let currentLevel = 1;
  let coins = 0;
  let score = 0;
  let matchedCount = 0;
  let totalPairs = 0;
  let draggingDrink = null;
  let dragGhost = null;
  let offsetX = 0, offsetY = 0;
  let levelTimeLimit = 60; // seconds (base)
  let timeLeft = 60;
  let timerId = null;
  let hintsLeft = 2;
  let difficulty = 'Medium';
  let colorBlind = false;
  let volume = 0.8;
  let unlockedSkins = 0;

  // UI elements
  const drinksArea = document.getElementById('drinksArea');
  const glassesArea = document.getElementById('glassesArea');
  const levelInfo = document.getElementById('levelInfo');
  const coinsEl = document.getElementById('coins');
  const scoreEl = document.getElementById('score');
  const hintCountEl = document.getElementById('hintCount');
  const multiplierEl = document.getElementById('multiplierBadge');
  const startBtn = document.getElementById('startBtn');
  const hintBtn = document.getElementById('hintBtn');
  const difficultySel = document.getElementById('difficulty');
  const cbToggle = document.getElementById('cb');
  const volumeSlider = document.getElementById('volume');
  const particleCanvas = document.getElementById('particleCanvas');
  const ctxP = particleCanvas.getContext('2d');
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsPanel = document.getElementById('settingsPanel');
  const closeSettings = document.getElementById('closeSettings');
  const diffPanel = document.getElementById('diffPanel');
  const cbPanel = document.getElementById('cbPanel');
  const particleDensity = document.getElementById('particleDensity');
  const themePanel = document.getElementById('themePanel');
  const resumeBtn = document.getElementById('resumeBtn');
  const restartBtn = document.getElementById('restartBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const endOverlay = document.getElementById('endOverlay');
  const levelWrap = document.getElementById('levelWrap');
  const levelOverlay = document.getElementById('endOverlay');
  const levelContainer = document.querySelector('body');

  // audio
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  let masterGain = audioCtx.createGain();
  masterGain.gain.value = volume;
  masterGain.connect(audioCtx.destination);
  let ambienceOsc = null;

  // combo / streak
  let combo = 1;
  let lastMatchTs = 0;
  let isPaused = false;
  let levelStarted = false;

  // localStorage helpers
  const LS = {
    get: (k, d) => {
      try { return JSON.parse(localStorage.getItem(k)) ?? d; } catch(e) { return d; }
    },
    set: (k, v) => localStorage.setItem(k, JSON.stringify(v))
  };

  // Init
  function init() {
    // load persistent state
    currentLevel = LS.get('sip_level', 1);
    coins = LS.get('sip_coins', 0);
    score = LS.get('sip_score', 0);
    unlockedSkins = LS.get('sip_skins', 0);
    difficulty = LS.get('sip_diff', 'Medium');
    colorBlind = LS.get('sip_cb', false);
    volume = LS.get('sip_vol', 0.8);
    volumeSlider.value = volume;
    cbToggle.checked = colorBlind;
    difficultySel.value = difficulty;
    coinsEl.textContent = coins;
    scoreEl.textContent = score;
    hintCountEl.textContent = 2;
    levelInfo.textContent = `${currentLevel}`;
    multiplierEl.textContent = 'Combo x1';
    // apply cb visual
    applyColorBlind(colorBlind);
    // ambient ambience
    startAmbience();
    // start first run
    generateLevel(currentLevel, true);
  }

  function startAmbience() {
    if (ambienceOsc) return;
    ambienceOsc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    ambienceOsc.type = 'sine';
    ambienceOsc.frequency.value = 60;
    ambienceOsc.connect(g);
    g.connect(masterGain);
    g.gain.value = 0.08;
    ambienceOsc.start();
  }

  function applyColorBlind(on) {
    document.body.dataset.cb = on ? '1' : '0';
  }

  // Level generation
  function generateLevel(level, freshRun) {
    // clear previous
    clearDrinksAndGlasses();
    matchedCount = 0;
    totalPairs = 0;
    hintsLeft = Math.max(1, 2 - Math.floor((level-1)/6)); // fewer hints as you advance
    hintCountEl.textContent = hintsLeft;
    combo = 1;
    lastMatchTs = 0;
    multiplierEl.textContent = 'Combo x1';

    // Difficulty adjustments
    const diff = difficulty;
    if (diff === 'Easy') {
      levelTimeLimit = 60;
    } else if (diff === 'Medium') {
      levelTimeLimit = 50;
    } else {
      levelTimeLimit = 40;
    }

    // number of pairs grows with level
    const pairCount = Math.min(6, 2 + Math.min( level, 6 )); // caps at 6
    totalPairs = pairCount;

    // select unique drinks
    const pool = [...DRINKS];
    shuffleArray(pool);
    const chosen = pool.slice(0, pairCount);

    // create glasses with matching ids
    createGlasses(chosen);

    // create drinks with random positions in left area
    createDrinks(chosen);

    // reset timer
    resetTimer();
    // show initial animations
    animateIntro();
  }

  function animateIntro() {
    // subtle float-in effect for drinks
    const drinks = drinksArea.querySelectorAll('.drink');
    drinks.forEach((d, i) => {
      d.style.opacity = '0';
      d.style.transform = 'translateY(20px)';
      setTimeout(() => {
        d.style.transition = 'opacity .4s ease, transform .6s cubic-bezier(.2,.9,.2,1)';
        d.style.opacity = '1';
        d.style.transform = 'translateY(0)';
      }, i * 40);
    });
  }

  function createGlasses(items) {
    glassesArea.innerHTML = '';
    const panelW = glassesArea.clientWidth;
    const panelH = glassesArea.clientHeight;
    const count = items.length;
    const spacingX = Math.max(180, panelW / (count + 1));
    const baseY = panelH * 0.25;
    items.forEach((it, idx) => {
      const glass = document.createElement('div');
      glass.className = 'glass';
      glass.dataset.name = it.id;
      glass.style.left = `${Math.min(panelW - 120, Math.max(40, (idx+1) * spacingX)) - 70}px`;
      glass.style.top = `${baseY}px`;
      glass.style.background = it.color;
      if (colorBlind) {
        const icon = document.createElement('span');
        icon.style.position = 'absolute';
        icon.style.right = '8px';
        icon.style.bottom = '8px';
        icon.style.width = '16px';
        icon.style.height = '16px';
        icon.style.borderRadius = '3px';
        icon.style.background = '#fff';
        icon.style.opacity = '0.9';
        glass.appendChild(icon);
      }
      const label = document.createElement('div');
      label.style.position = 'absolute';
      label.style.bottom = '-18px';
      label.style.left = '50%';
      label.style.transform = 'translateX(-50%)';
      label.style.fontSize = '11px';
      label.style.color = '#fff';
      label.textContent = it.name;
      glass.appendChild(label);

      glassesArea.appendChild(glass);
    });
  }

  function createDrinks(items) {
    drinksArea.innerHTML = '';
    const panelW = drinksArea.clientWidth;
    const panelH = drinksArea.clientHeight;
    const count = items.length;
    const spacingX = Math.max(140, panelW / (count + 1));
    const baseY = panelH * 0.25;

    items.forEach((it, idx) => {
      const drink = document.createElement('div');
      drink.className = 'drink';
      drink.dataset.name = it.id;
      drink.style.background = it.color;
      drink.style.left = '0px';
      drink.style.top = '0px';
      const lab = document.createElement('div');
      lab.className = 'label';
      lab.textContent = it.name;
      drink.appendChild(lab);

      const rx = Math.random() * (panelW - 120);
      const ry = baseY + (Math.random() * (panelH * 0.4));
      drink.style.transform = `translate(${rx}px, ${ry}px)`;

      drinksArea.appendChild(drink);
      drink.addEventListener('pointerdown', onPointerDown);
    });
  }

  function clearDrinksAndGlasses() {
    drinksArea.innerHTML = '';
    glassesArea.innerHTML = '';
  }

  // drag handlers
  function onPointerDown(e) {
    if (isPaused || !levelStarted) return;
    if (draggingDrink) return;
    const el = e.currentTarget;
    if (el.classList.contains('matched')) return;
    draggingDrink = el;
    dragGhost = el.cloneNode(true);
    dragGhost.style.position = 'fixed';
    dragGhost.style.pointerEvents = 'none';
    dragGhost.style.margin = '0';
    dragGhost.style.zIndex = '9999';
    dragGhost.style.transform = 'translate(0px,0px)';
    document.body.appendChild(dragGhost);
    el.style.opacity = '0.4';
    const rect = el.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
    moveGhost(e.clientX, e.clientY);
    window.addEventListener('pointermove', onPointerMove);
    window.addEventListener('pointerup', onPointerUp);
  }

  function onPointerMove(e) {
    if (!dragGhost) return;
    moveGhost(e.clientX, e.clientY);
  }

  function moveGhost(clientX, clientY) {
    const x = clientX - offsetX;
    const y = clientY - offsetY;
    dragGhost.style.left = x + 'px';
    dragGhost.style.top = y + 'px';
  }

  function onPointerUp(e) {
    if (!draggingDrink) return;
    const pick = document.elementFromPoint(e.clientX, e.clientY);
    let targetGlass = pick;
    while (targetGlass && !targetGlass.classList?.contains('glass')) {
      targetGlass = targetGlass.parentElement;
    }

    if (targetGlass && targetGlass.dataset.name === draggingDrink.dataset.name) {
      // correct drop
      handleCorrectMatch(draggingDrink, targetGlass);
    } else {
      // incorrect
      handleIncorrectDrop(draggingDrink);
    }

    endDrag();
  }

  function endDrag() {
    if (dragGhost) {
      dragGhost.remove();
      dragGhost = null;
    }
    if (draggingDrink) {
      draggingDrink.style.opacity = '1';
      draggingDrink = null;
    }
    window.removeEventListener('pointermove', onPointerMove);
    window.removeEventListener('pointerup', onPointerUp);
  }

  function handleCorrectMatch(drinkEl, glassEl) {
    // marker
    drinkEl.classList.add('matched');
    glassEl.classList.add('pass');
    // smooth move to glass center
    const glassRect = glassEl.getBoundingClientRect();
    const drinkRect = drinkEl.getBoundingClientRect();
    const gx = glassRect.left + glassRect.width / 2 - drinkEl.offsetWidth / 2;
    const gy = glassRect.top + glassRect.height / 2 - drinkEl.offsetHeight / 2;
    drinkEl.style.transition = 'transform .4s ease';
    drinkEl.style.transform = `translate(${gx - drinkRect.left}px, ${gy - drinkRect.top}px)`;
    // spawn particles at glass center
    spawnParticles(glassRect.left + glassRect.width/2, glassRect.top + glassRect.height/2, drinkEl.style.background);
    // play sound
    playTone(420, 0.08);
    // combo logic
    const now = Date.now();
    if (now - lastMatchTs <= 2000) {
      combo = Math.min(4, combo + 1);
    } else {
      combo = 1;
    }
    lastMatchTs = now;
    multiplierEl.textContent = `Combo x${combo}`;
    // update score/coins
    const gain = 100 * combo;
    score += gain;
    scoreEl.textContent = score;
    coins += 5 * combo;
    coinsEl.textContent = coins;
    // check level completion
    matchedCount++;
    if (matchedCount >= totalPairs) {
      levelCompleted();
    }
  }

  function handleIncorrectDrop(drinkEl) {
    playTone(220, 0.12);
    // shake animation
    drinkEl.style.transition = 'transform .15s ease';
    drinkEl.style.transform = 'translateX(-6px)';
    setTimeout(() => {
      drinkEl.style.transform = 'translateX(0px)';
    }, 150);
  }

  function resetTimer() {
    clearInterval(timerId);
    timeLeft = levelTimeLimit;
    timerId = setInterval(() => {
      if (isPaused) return;
      timeLeft--;
      if (timeLeft <= 0) {
        clearInterval(timerId);
        levelFailed();
      }
    }, 1000);
  }

  function levelFailed() {
    showEndOverlay(false);
  }

  function levelCompleted() {
    clearInterval(timerId);
    const used = levelTimeLimit - timeLeft;
    let stars = 1;
    const ratio = timeLeft / levelTimeLimit;
    if (ratio >= 0.66) stars = 3;
    else if (ratio >= 0.33) stars = 2;
    // reward
    coins += stars * 10;
    coinsEl.textContent = coins;
    score += stars * 150;
    scoreEl.textContent = score;
    if (stars > 1) {
      unlockedSkins++;
      LS.set('sip_skins', unlockedSkins);
    }
    showEndOverlay(true, stars);
  }

  function showEndOverlay(success, stars=0) {
    endOverlay.style.display = 'flex';
    endOverlay.innerHTML = '';
    endOverlay.style.position = 'fixed';
    endOverlay.style.inset = '0';
    endOverlay.style.background = 'rgba(0,0,0,.6)';
    endOverlay.style.zIndex = '999';
    endOverlay.style.alignItems = 'center';
    endOverlay.style.justifyContent = 'center';
    // modal content
    const modal = document.createElement('div');
    modal.className = 'modal';
    const msg = document.createElement('div');
    msg.style.fontSize = '20px';
    msg.style.fontWeight = 'bold';
    msg.style.marginBottom = '8px';
    msg.textContent = success ? 'Level Complete!' : 'Time Up!';
    modal.appendChild(msg);

    const starRow = document.createElement('div');
    starRow.className = 'stars';
    for (let i = 0; i < 3; i++) {
      const s = document.createElement('span');
      s.className = 'star';
      if (success && i < stars) {
        s.classList.add('active');
      }
      starRow.appendChild(s);
    }
    modal.appendChild(starRow);

    const info = document.createElement('div');
    info.style.fontSize = '12px';
    info.style.opacity = '.85';
    info.style.marginTop = '6px';
    info.textContent = `Coins: ${coins}  Score: ${score}`;
    modal.appendChild(info);

    const btnRow = document.createElement('div');
    btnRow.style.marginTop = '12px';
    btnRow.style.display = 'flex';
    btnRow.style.justifyContent = 'center';
    const nextBtn = document.createElement('button');
    nextBtn.className = 'btn';
    nextBtn.textContent = 'Next Level';
    nextBtn.addEventListener('click', () => {
      endOverlay.style.display = 'none';
      endOverlay.innerHTML = '';
      endOverlay.style.zIndex = '0';
      currentLevel++;
      LS.set('sip_level', currentLevel);
      levelInfo.textContent = currentLevel;
      generateLevel(currentLevel, false);
      endOverlay.style.display = 'none';
      // auto-continue
      startBtn.disabled = false;
    });
    btnRow.appendChild(nextBtn);

    const retryBtn = document.createElement('button');
    retryBtn.className = 'btn';
    retryBtn.style.marginLeft = '8px';
    retryBtn.textContent = 'Retry Level';
    retryBtn.addEventListener('click', () => {
      endOverlay.style.display = 'none';
      endOverlay.innerHTML = '';
      endOverlay.style.zIndex = '0';
      generateLevel(currentLevel, false);
    });
    btnRow.appendChild(retryBtn);

    modal.appendChild(btnRow);
    endOverlay.appendChild(modal);
  }

  // particles
  let particles = [];
  let animRunning = false;

  function spawnParticles(x, y, color) {
    for (let i = 0; i < 22; i++) {
      particles.push({
        x: x,
        y: y,
        vx: (Math.random() - 0.5) * 3,
        vy: (Math.random() - 0.5) * 3,
        life: 60 + Math.random() * 40,
        color: color || '#fff'
      });
    }
    if (!animRunning) {
      animRunning = true;
      requestAnimationFrame(animateParticles);
    }
  }

  function animateParticles() {
    const w = particleCanvas.clientWidth;
    const h = particleCanvas.clientHeight;
    ctxP.clearRect(0,0,w,h);
    particles.forEach((p, idx) => {
      p.x += p.vx;
      p.y += p.vy;
      p.life -= 1;
      ctxP.globalAlpha = Math.max(0, p.life / 100);
      ctxP.fillStyle = p.color;
      ctxP.fillRect(p.x, p.y, 2, 2);
    });
    particles = particles.filter(p => p.life > 0 && p.x > -10 && p.x < w+10 && p.y > -10 && p.y < h+10);
    if (particles.length > 0) {
      requestAnimationFrame(animateParticles);
    } else {
      ctxP.clearRect(0,0,w,h);
      animRunning = false;
    }
  }

  // helpers
  function shuffleArray(a) {
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
  }

  function playTone(freq, duration=0.1) {
    // simple beeper
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.frequency.value = freq;
    osc.type = 'sine';
    osc.connect(g);
    g.connect(masterGain);
    const now = audioCtx.currentTime;
    g.gain.setValueAtTime(0.0, now);
    g.gain.linearRampToValueAtTime(0.25, now + 0.01);
    g.gain.exponentialRampToValueAtTime(0.001, now + duration);
    osc.start(now);
    osc.stop(now + duration + 0.02);
  }

  // interactions: start/pause/settings
  startBtn.addEventListener('click', () => {
    if (!levelStarted) {
      levelStarted = true;
      startBtn.disabled = true;
      generateLevel(currentLevel, false);
      resetTimer();
    } else {
      // toggle pause via start button as pause
      togglePause();
    }
  });

  hintBtn.addEventListener('click', () => {
    if (hintsLeft <= 0) return;
    const remainingGlass = Array.from(glassesArea.querySelectorAll('.glass:not(.pass):not(.matched)'));
    const remainingDrinks = Array.from(drinksArea.querySelectorAll('.drink:not(.matched)'));
    if (remainingGlass.length === 0 || remainingDrinks.length === 0) return;
    const glass = remainingGlass[Math.floor(Math.random() * remainingGlass.length)];
    const name = glass.dataset.name;
    const drink = remainingDrinks.find(d => d.dataset.name === name);
    if (glass && drink) {
      glass.style.outline = '3px solid #fff';
      glass.style.transition = 'outline .2s';
      setTimeout(() => { glass.style.outline = ''; }, 400);
      drink.style.transition = 'transform .2s';
      drink.style.transform = 'scale(1.08)';
      setTimeout(() => { drink.style.transform = ''; }, 200);
      hintsLeft--;
      hintCountEl.textContent = hintsLeft;
      playTone(260, 0.08);
    }
  });

  function togglePause() {
    if (!levelStarted) return;
    isPaused = !isPaused;
    const overlay = document.getElementById('pauseOverlay');
    if (isPaused) {
      overlay.style.display = 'flex';
      // pause timer
      if (timerId) clearInterval(timerId);
    } else {
      overlay.style.display = 'none';
      resetTimer();
    }
  }

  pauseBtn.addEventListener('click', togglePause);
  resumeBtn.addEventListener('click', () => {
    isPaused = false;
    document.getElementById('pauseOverlay').style.display = 'none';
    resetTimer();
  });
  restartBtn.addEventListener('click', () => {
    document.getElementById('pauseOverlay').style.display = 'none';
    isPaused = false;
    generateLevel(currentLevel, false);
    resetTimer();
  });

  // Settings panel
  settingsBtn.addEventListener('click', () => {
    settingsPanel.style.display = settingsPanel.style.display === 'none' || settingsPanel.style.display === '' ? 'block' : 'none';
  });
  closeSettings.addEventListener('click', () => { settingsPanel.style.display = 'none'; });
  diffPanel && (diffPanel.value = difficulty);
  cbPanel && (cbPanel.checked = colorBlind);
  document.getElementById('diffPanel').addEventListener('change', (e) => {
    difficulty = e.target.value;
    LS.set('sip_diff', difficulty);
  });
  document.getElementById('cbPanel').addEventListener('change', (e) => {
    colorBlind = e.target.checked;
    LS.set('sip_cb', colorBlind);
    applyColorBlind(colorBlind);
  });
  particleDensity.addEventListener('input', (e) => {
    const v = parseInt(e.target.value, 10);
    // scale particle count roughly by density
    // For simplicity, adjust global hint duration or spawn count via a simple policy
    // We'll touch spawn amount on next match
    // store value
    LS.set('sip_density', v);
  });
  themePanel.addEventListener('change', (e) => {
    // just visual cue, could change CSS theme later
    const v = e.target.value;
    // placeholder: no-op for now
    LS.set('sip_theme', v);
  });

  volumeSlider.addEventListener('input', (e) => {
    volume = parseFloat(e.target.value);
    LS.set('sip_vol', volume);
    masterGain.gain.value = volume;
  });

  // Resize canvas to container
  function resizeCanvas() {
    particleCanvas.width = particleCanvas.clientWidth;
    particleCanvas.height = particleCanvas.clientHeight;
  }
  window.addEventListener('resize', () => {
    resizeCanvas();
  });
  window.addEventListener('load', () => {
    resizeCanvas();
    init();
  });

  // Accessibility: keyboard quick hint
  window.addEventListener('keydown', (ev) => {
    if (ev.key.toLowerCase() === 'p') togglePause();
  });

})();
</script>
</body>
</html>