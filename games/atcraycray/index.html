<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATTINY13 Demo - Live Simulation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #00ff88;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .main-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }

        .panel h2 {
            color: #00ff88;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-align: center;
        }

        /* ATTINY13 Chip Visualization */
        .chip-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .chip {
            width: 200px;
            height: 300px;
            background: #2a2a2a;
            border: 3px solid #555;
            border-radius: 10px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .chip::before {
            content: 'ATTINY13A';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #888;
            font-size: 14px;
            font-weight: bold;
        }

        .chip-notch {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 15px;
            background: #1a1a1a;
            border-radius: 0 0 15px 15px;
        }

        .pin {
            position: absolute;
            width: 8px;
            height: 25px;
            background: #888;
            transition: background 0.3s;
        }

        .pin.left { left: -8px; }
        .pin.right { right: -8px; }

        .pin.active { background: #00ff88; box-shadow: 0 0 10px #00ff88; }

        .pin-label {
            position: absolute;
            font-size: 10px;
            color: #aaa;
        }

        .pin-label.left { left: -45px; }
        .pin-label.right { right: -45px; }

        /* LEDs */
        .led-display {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
        }

        .led-container {
            text-align: center;
        }

        .led {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 10px;
            position: relative;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.3), transparent);
            transition: all 0.1s ease;
        }

        .led::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: inherit;
            filter: blur(20px);
            opacity: 0;
            transition: opacity 0.1s;
        }

        .led.on::after {
            opacity: 1;
        }

        .led.red {
            background-color: #330000;
            border: 2px solid #660000;
        }

        .led.red.on {
            background-color: #ff0000;
            border-color: #ff6666;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.8), 0 0 60px rgba(255, 0, 0, 0.4);
        }

        .led.green {
            background-color: #003300;
            border: 2px solid #006600;
        }

        .led.green.on {
            background-color: #00ff00;
            border-color: #66ff66;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.8), 0 0 60px rgba(0, 255, 0, 0.4);
        }

        .led.blue {
            background-color: #000033;
            border: 2px solid #000066;
        }

        .led.blue.on {
            background-color: #0088ff;
            border-color: #66bbff;
            box-shadow: 0 0 30px rgba(0, 136, 255, 0.8), 0 0 60px rgba(0, 136, 255, 0.4);
        }

        .led-label {
            font-size: 14px;
            color: #aaa;
            margin-top: 5px;
        }

        .pwm-bar {
            width: 100%;
            height: 8px;
            background: #222;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .pwm-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00ccff);
            transition: width 0.1s;
        }

        /* Controls */
        .controls {
            margin: 20px 0;
        }

        .control-group {
            margin: 15px 0;
        }

        .control-label {
            display: block;
            margin-bottom: 8px;
            color: #00ff88;
            font-weight: bold;
        }

        .button {
            background: linear-gradient(135deg, #00ff88, #00ccff);
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            width: 100%;
        }

        .button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.5);
        }

        .button:active {
            transform: scale(0.95);
            background: linear-gradient(135deg, #00ccff, #00ff88);
        }

        .slider {
            width: 100%;
            height: 40px;
            -webkit-appearance: none;
            background: #222;
            border-radius: 20px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #00ff88, #00ccff);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .slider::-moz-range-thumb {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #00ff88, #00ccff);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            border: none;
        }

        /* State Display */
        .state-display {
            text-align: center;
            font-size: 24px;
            padding: 20px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #00ff88;
        }

        .state-name {
            font-size: 32px;
            color: #00ff88;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            margin-bottom: 10px;
        }

        .state-progress {
            width: 100%;
            height: 20px;
            background: #222;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 15px;
        }

        .state-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00ccff);
            transition: width 0.1s linear;
            border-radius: 10px;
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .stat {
            background: rgba(0, 255, 136, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .stat-value {
            font-size: 32px;
            color: #00ff88;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        /* Console */
        .console {
            background: #000;
            border: 2px solid #00ff88;
            border-radius: 10px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .console-line {
            margin: 2px 0;
            color: #0f0;
        }

        .console-line.interrupt {
            color: #ff0;
        }

        .console-line.state {
            color: #0ff;
            font-weight: bold;
        }

        .console-line.error {
            color: #f00;
        }

        /* Animation indicator */
        .running-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff88;
            animation: pulse 1s infinite;
            margin-right: 10px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* Waveform display */
        .waveform {
            width: 100%;
            height: 100px;
            background: #000;
            border: 1px solid #333;
            border-radius: 5px;
            margin: 10px 0;
        }

        canvas {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><span class="running-indicator"></span>ATTINY13 Live Simulation</h1>

        <div class="main-display">
            <!-- Left Panel: Hardware Display -->
            <div class="panel">
                <h2>Hardware Visualization</h2>

                <div class="chip-container">
                    <div class="chip">
                        <div class="chip-notch"></div>
                        <!-- Left pins -->
                        <div class="pin left" id="pin1" style="top: 50px;"><span class="pin-label left">PB5/RST</span></div>
                        <div class="pin left" id="pin2" style="top: 100px;"><span class="pin-label left">PB3</span></div>
                        <div class="pin left" id="pin3" style="top: 150px;"><span class="pin-label left">PB4</span></div>
                        <div class="pin left" id="pin4" style="top: 200px;"><span class="pin-label left">GND</span></div>
                        <!-- Right pins -->
                        <div class="pin right" id="pin5" style="top: 50px;"><span class="pin-label right">PB0</span></div>
                        <div class="pin right" id="pin6" style="top: 100px;"><span class="pin-label right">PB1</span></div>
                        <div class="pin right" id="pin7" style="top: 150px;"><span class="pin-label right">PB2</span></div>
                        <div class="pin right" id="pin8" style="top: 200px;"><span class="pin-label right">VCC</span></div>
                    </div>
                </div>

                <div class="led-display">
                    <div class="led-container">
                        <div class="led red" id="led-red"></div>
                        <div class="led-label">Red LED (PB0)</div>
                        <div class="pwm-bar"><div class="pwm-fill" id="pwm-red" style="width: 0%;"></div></div>
                        <div class="led-label" id="pwm-red-value">PWM: 0%</div>
                    </div>
                    <div class="led-container">
                        <div class="led green" id="led-green"></div>
                        <div class="led-label">Green LED (PB1)</div>
                        <div class="pwm-bar"><div class="pwm-fill" id="pwm-green" style="width: 0%;"></div></div>
                        <div class="led-label" id="pwm-green-value">PWM: 0%</div>
                    </div>
                    <div class="led-container">
                        <div class="led blue" id="led-blue"></div>
                        <div class="led-label">Blue LED (PB2)</div>
                        <div class="led-label" id="blue-status">Digital: OFF</div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Controls -->
            <div class="panel">
                <h2>Interactive Controls</h2>

                <div class="controls">
                    <div class="control-group">
                        <label class="control-label">Push Button (PB3)</label>
                        <button class="button" id="button-pb3" onmousedown="pressButton()" onmouseup="releaseButton()">
                            PRESS & HOLD
                        </button>
                    </div>

                    <div class="control-group">
                        <label class="control-label">Potentiometer (PB4): <span id="pot-value">50%</span></label>
                        <input type="range" min="0" max="100" value="50" class="slider" id="potentiometer" oninput="updatePot(this.value)">
                    </div>

                    <div class="control-group">
                        <label class="control-label">Simulation Speed</label>
                        <input type="range" min="1" max="100" value="50" class="slider" id="speed-control" oninput="updateSpeed(this.value)">
                        <div class="led-label">Speed: <span id="speed-value">50x</span></div>
                    </div>
                </div>

                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="timer-ticks">0</div>
                        <div class="stat-label">Timer Ticks</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="button-presses">0</div>
                        <div class="stat-label">Button Presses</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="adc-value">512</div>
                        <div class="stat-label">ADC Reading</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- State Display -->
        <div class="panel full-width">
            <div class="state-display">
                <div class="state-name" id="state-name">STATE_INIT</div>
                <div class="led-label">State <span id="state-number">0</span> of 8 ‚Ä¢ Time in state: <span id="state-time">0.0</span>s / 1.7s</div>
                <div class="state-progress">
                    <div class="state-progress-bar" id="state-progress" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <!-- Console Output -->
        <div class="panel full-width">
            <h2>System Console</h2>
            <div class="console" id="console">
                <div class="console-line state">üöÄ ATTINY13 Demo Starting...</div>
                <div class="console-line">‚öôÔ∏è  Initializing peripherals...</div>
                <div class="console-line">‚úÖ Timer0 configured (Fast PWM, Prescaler=8)</div>
                <div class="console-line">‚úÖ ADC enabled (Free-running, 4 channels)</div>
                <div class="console-line">‚úÖ Analog Comparator enabled</div>
                <div class="console-line">‚úÖ Pin Change Interrupt enabled (PB3, PB4)</div>
                <div class="console-line">‚úÖ Global interrupts enabled</div>
                <div class="console-line state">‚ñ∂Ô∏è  Entering main loop...</div>
            </div>
        </div>
    </div>

    <script>
        // State machine
        const states = [
            'STATE_INIT',
            'STATE_PWM_DEMO',
            'STATE_ADC_SCAN',
            'STATE_COMPARATOR_TEST',
            'STATE_EEPROM_OPS',
            'STATE_SLEEP_TEST',
            'STATE_BIT_MANIP_DEMO',
            'STATE_WDT_TEST',
            'STATE_GPIO_PATTERN'
        ];

        let currentState = 0;
        let timerTicks = 0;
        let buttonPresses = 0;
        let adcValue = 512;
        let potValue = 50;
        let speedMultiplier = 50;
        let stateStartTime = Date.now();
        let buttonPressed = false;
        let blueState = false;

        // PWM values
        let pwmRed = 128;
        let pwmGreen = 64;

        // Update functions
        function updatePot(value) {
            potValue = parseInt(value);
            adcValue = Math.floor((potValue / 100) * 1023);
            document.getElementById('pot-value').textContent = potValue + '%';
            document.getElementById('adc-value').textContent = adcValue;
            log(`üìä ADC: Potentiometer changed to ${potValue}% (ADC=${adcValue})`);
        }

        function updateSpeed(value) {
            speedMultiplier = parseInt(value);
            document.getElementById('speed-value').textContent = speedMultiplier + 'x';
        }

        function pressButton() {
            if (!buttonPressed) {
                buttonPressed = true;
                buttonPresses++;
                blueState = !blueState;
                document.getElementById('button-presses').textContent = buttonPresses;
                log(`üîò INTERRUPT: Pin Change on PB3 (Button press #${buttonPresses})`, 'interrupt');
                updateLEDs();
            }
        }

        function releaseButton() {
            buttonPressed = false;
        }

        function log(message, type = 'normal') {
            const console = document.getElementById('console');
            const line = document.createElement('div');
            line.className = 'console-line ' + type;
            line.textContent = message;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;

            // Keep console manageable
            if (console.children.length > 100) {
                console.removeChild(console.firstChild);
            }
        }

        function updateLEDs() {
            const redLED = document.getElementById('led-red');
            const greenLED = document.getElementById('led-green');
            const blueLED = document.getElementById('led-blue');

            // Red LED (PWM)
            const redBrightness = pwmRed / 255;
            if (redBrightness > 0.1) {
                redLED.classList.add('on');
                redLED.style.opacity = redBrightness;
            } else {
                redLED.classList.remove('on');
            }
            document.getElementById('pwm-red').style.width = (redBrightness * 100) + '%';
            document.getElementById('pwm-red-value').textContent = 'PWM: ' + Math.round(redBrightness * 100) + '%';

            // Green LED (PWM)
            const greenBrightness = pwmGreen / 255;
            if (greenBrightness > 0.1) {
                greenLED.classList.add('on');
                greenLED.style.opacity = greenBrightness;
            } else {
                greenLED.classList.remove('on');
            }
            document.getElementById('pwm-green').style.width = (greenBrightness * 100) + '%';
            document.getElementById('pwm-green-value').textContent = 'PWM: ' + Math.round(greenBrightness * 100) + '%';

            // Blue LED (Digital)
            if (blueState) {
                blueLED.classList.add('on');
                document.getElementById('blue-status').textContent = 'Digital: ON';
            } else {
                blueLED.classList.remove('on');
                document.getElementById('blue-status').textContent = 'Digital: OFF';
            }

            // Update pin indicators
            document.getElementById('pin5').classList.toggle('active', redBrightness > 0.5);
            document.getElementById('pin6').classList.toggle('active', greenBrightness > 0.5);
            document.getElementById('pin7').classList.toggle('active', blueState);
        }

        function executeState() {
            switch(currentState) {
                case 0: // STATE_INIT
                    pwmRed = 0;
                    pwmGreen = 0;
                    break;

                case 1: // STATE_PWM_DEMO
                    // Sweep PWM
                    const progress = (timerTicks % 256) / 255;
                    pwmRed = Math.floor(progress * 255);
                    pwmGreen = 255 - Math.floor(progress * 255);
                    break;

                case 2: // STATE_ADC_SCAN
                    // ADC controls red LED
                    pwmRed = Math.floor(adcValue / 4);
                    pwmGreen = 128;
                    break;

                case 3: // STATE_COMPARATOR_TEST
                    // Green LED blinks based on comparator
                    pwmGreen = (timerTicks % 32) > 16 ? 255 : 0;
                    break;

                case 4: // STATE_EEPROM_OPS
                    // Use stored ADC value
                    pwmRed = Math.floor(adcValue / 4);
                    if (timerTicks % 256 === 0) {
                        log('üíæ EEPROM: Writing ADC value ' + adcValue);
                    }
                    break;

                case 5: // STATE_SLEEP_TEST
                    // Brief dim
                    pwmRed = 32;
                    pwmGreen = 32;
                    break;

                case 6: // STATE_BIT_MANIP_DEMO
                    // Gray code pattern
                    const grayIndex = (timerTicks % 256) >> 3;
                    const gray = grayIndex ^ (grayIndex >> 1);
                    pwmRed = (gray & 0x01) ? 255 : 0;
                    pwmGreen = (gray & 0x02) ? 255 : 0;
                    blueState = (gray & 0x04) !== 0;
                    break;

                case 7: // STATE_WDT_TEST
                    // Watchdog test
                    pwmRed = 100;
                    pwmGreen = 100;
                    if (timerTicks % 256 === 0) {
                        log('üêï WDT: Reset watchdog');
                    }
                    break;

                case 8: // STATE_GPIO_PATTERN
                    // Binary counting
                    const count = (timerTicks % 256) >> 2;
                    pwmRed = (count & 0x01) ? 255 : 0;
                    pwmGreen = (count & 0x02) ? 255 : 0;
                    blueState = (count & 0x04) !== 0;
                    break;
            }
        }

        // Main simulation loop
        function mainLoop() {
            // Increment timer (faster based on speed multiplier)
            timerTicks += speedMultiplier;
            document.getElementById('timer-ticks').textContent = timerTicks % 256;

            // Every 256 ticks, advance state
            if (timerTicks % 256 === 0 && timerTicks > 0) {
                currentState = (currentState + 1) % states.length;
                document.getElementById('state-name').textContent = states[currentState];
                document.getElementById('state-number').textContent = currentState;
                stateStartTime = Date.now();
                log(`üîÑ State transition: ${states[currentState]}`, 'state');
            }

            // Update state progress
            const stateTime = (Date.now() - stateStartTime) / 1000;
            document.getElementById('state-time').textContent = stateTime.toFixed(1);
            const stateProgress = Math.min((stateTime / 1.7) * 100, 100);
            document.getElementById('state-progress').style.width = stateProgress + '%';

            // Execute current state logic
            executeState();

            // Update display
            updateLEDs();

            // Log interrupts periodically
            if (timerTicks % 1000 === 0) {
                log(`‚è±Ô∏è  INTERRUPT: Timer0 overflow (tick=${timerTicks})`, 'interrupt');
            }

            if (timerTicks % 500 === 0) {
                log(`üìä INTERRUPT: ADC conversion complete (CH${(timerTicks/500) % 4}, value=${adcValue})`, 'interrupt');
            }
        }

        // Start simulation
        log('üé¨ Simulation started at ' + speedMultiplier + 'x speed', 'state');
        setInterval(mainLoop, 10); // Run at 100Hz
    </script>
</body>
</html>