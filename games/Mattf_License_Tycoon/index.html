<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mattf License Tycoon - Expanded</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0e1117;
      --card: #181e27;
      --text: #e6e6e6;
      --muted: #aab2c5;
      --accent: #4bd4b4;
      --danger: #ff6b6b;
      --warning: #ffd166;
      --grid-gap: 14px;
      --font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    * { box-sizing: border-box; }

    html, body { height: 100%; }

    body {
      margin: 0;
      background: radial-gradient(circle at 20% -10%, rgba(75,212,180,.15), transparent 40%),
                  radial-gradient(circle at 100% 0%, rgba(109, 89, 255, .15), transparent 40%),
                  var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      font-size: var(--font-size, 14px);
      overflow-x: hidden;
    }

    /* Layout */
    .container {
      display: grid;
      grid-template-columns: 360px 1fr 420px;
      gap: 14px;
      padding: 14px;
      min-height: 100vh;
    }

    .card {
      background: linear-gradient(180deg, rgba(24,30,39,.95), rgba(24,30,39,.75) 60%), var(--card);
      border: 1px solid #2b3240;
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
      position: relative;
      overflow: hidden;
    }

    h1 { font-size: 20px; margin: 0 0 8px; }

    h2 { font-size: 16px; margin: 6px 0; }

    .section-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }

    .license-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }

    .license {
      border: 1px solid #2a3243;
      border-radius: 10px;
      padding: 10px;
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 10px;
      align-items: center;
      background: rgba(12,16,25,.6);
      transition: transform .25s ease;
    }
    .license:hover { transform: translateY(-1px); }
    .license.locked { opacity: .5; filter: grayscale(0.5); }

    .license h3 { margin: 0 0 6px; font-size: 14px; }
    .license .meta { font-size: 12px; color: var(--muted); }

    .row { display: flex; align-items: center; gap: 6px; }

    .btn {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #3a4764;
      background: #2f3b70;
      color: white;
      cursor: pointer;
      font-weight: 600;
      transition: transform .15s ease;
    }
    .btn.secondary { background: #2b2f45; }
    .btn.danger { background: #6b2336; border-color: #6b2336; }
    .btn.success { background: #2e9e6e; border-color: #2e9e6e; }

    .input, input[type="number"] {
      padding: 6px 8px; border-radius: 6px; border: 1px solid #3a4764;
      background: #0e1220; color: white; width: 90px;
    }

    .panel { display: grid; gap: 8px; }

    .ledger, .analytics, .alerts { height: 100%; display: grid; grid-template-rows: auto 1fr; gap: 8px; }

    .list { max-height: 190px; overflow: auto; padding: 4px; border-radius: 6px; border: 1px solid #2b3240; background: rgba(0,0,0,.15); }

    #chart { width: 100%; height: 180px; background: rgba(0,0,0,.15); border-radius: 6px; display: block; }

    .muted { color: var(--muted); }

    .badge { padding: 2px 6px; border-radius: 6px; background: rgba(75,212,180,.25); color: #bff5e3; font-size: 12px; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

    .hidden { display: none; }

    .tutorial { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: flex; align-items: center; justify-content: center; padding: 20px; z-index: 999; }
    .tutorial .panel { max-width: 720px; width: 100%; padding: 20px; }

    .kbd { font-family: ui-monospace,SFMono-Regular,Monaco; padding: 2px 6px; border-radius: 6px; background: rgba(255,255,255,.15); }

    @media (max-width: 1100px) {
      .container { grid-template-columns: 1fr; grid-auto-rows: min-content; }
    }

    /* Tiny animations */
    @keyframes floatPop {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      60% { transform: translateY(-20px) scale(1.08); opacity: 0.9; }
      100% { transform: translateY(-40px) scale(0.95); opacity: 0; }
    }

    .float-pair {
      position: fixed;
      z-index: 9999;
      pointer-events: none;
      color: #b9ffd7;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(0,0,0,.5);
      animation: floatPop 1.2s ease forwards;
    }

    .pulse {
      animation: pulse 0.4s ease;
    }
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 rgba(0,0,0,0); }
      50% { transform: scale(1.08); box-shadow: 0 0 15px rgba(75,212,180,.8); }
      100% { transform: scale(1); box-shadow: 0 0 0 rgba(0,0,0,0); }
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <!-- Left: License Shop -->
    <section class="card panel" id="licenseShop" aria-label="License Shop">
      <div class="section-title">
        <h2>License Shop</h2>
        <span class="badge" id="unlockStatus">Tip: New licenses unlock with cash milestones.</span>
      </div>
      <div class="license-grid" id="licenseList"></div>
      <div class="grid-2" style="margin-top:6px;">
        <div class="muted">Cash on hand: <strong id="cashDisplay"></strong></div>
        <div class="muted" style="text-align:right;">Tick: <strong id="tickDisplay"></strong></div>
      </div>
      <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
        <button class="btn" id="saveBtn" aria-label="Save game">Save</button>
        <button class="btn secondary" id="loadBtn" aria-label="Load game">Load</button>
        <button class="btn secondary" id="exportBtn" aria-label="Export save">Export</button>
        <button class="btn secondary" id="importBtn" aria-label="Import save">Import</button>
        <span class="muted" style="font-size:12px;">Autosave every 60s</span>
      </div>
    </section>

    <!-- Center: Market & Controls -->
    <section class="card panel" id="marketPanel" aria-label="Market">
      <div class="panel-header" style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Market Overview</h2>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn" id="pauseBtn" aria-label="Pause or resume simulation">Pause</button>
          <button class="btn secondary" id="settingsBtn" aria-label="Open settings">Settings</button>
        </div>
      </div>
      <div class="grid-2" style="gap:12px;">
        <div class="card" style="padding:12px;">
          <div class="muted" style="font-size:12px;">Global Demand Boost</div>
          <div id="demandBoost" style="font-weight:700; font-size:16px;">0%</div>
          <div class="muted" style="margin-top:6px;">Upgrades can increase demand across licenses.</div>
        </div>
        <div class="card" style="padding:12px;">
          <div class="muted" style="font-size:12px;">Audit Risk</div>
          <div id="auditRisk" style="font-weight:700; font-size:16px;">0%</div>
          <div class="muted" style="margin-top:6px;">Higher prices and demand raise audit risk; penalties may apply.</div>
        </div>
      </div>

      <div class="grid-2" style="margin-top:8px;">
        <div class="card" style="padding:12px;">
          <strong>Projected Revenue This Tick:</strong>
          <div id="projRevenue" style="font-size:22px; margin-top:6px;">$0</div>
          <div class="muted" id="projDetails" style="font-size:12px; margin-top:6px;">Sales per license will auto-calculate.</div>
        </div>
        <div class="card" style="padding:12px;">
          <strong>Penalties (Audits):</strong>
          <div id="projPenalty" style="font-size:22px; margin-top:6px;">$0</div>
          <div class="muted" style="margin-top:6px;">Audit penalties may apply per tick.</div>
        </div>
      </div>

      <canvas id="chart" aria-label="Cash history chart" width="800" height="180" style="width:100%; height:180px; margin-top:6px;"></canvas>
    </section>

    <!-- Right: Ledger & Analytics -->
    <section class="card panel ledger" id="ledgerPanel" aria-label="Ledger">
      <div class="panel-header" style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Ledger</h2>
        <div class="muted" style="font-size:12px;">R: Reputation</div>
      </div>
      <div class="grid-2" style="align-items:start;">
        <div class="card" style="padding:10px;">
          <div class="muted" style="font-size:12px;">Cash</div>
          <div id="cashValue" style="font-size:28px; font-weight:700;">$0</div>
          <div class="muted" style="margin-top:6px;">Liquidity to invest, pay penalties, and buy licenses.</div>
        </div>
        <div class="card" style="padding:10px;">
          <div class="muted" style="font-size:12px;">Reputation</div>
          <div id="repValue" style="font-size:28px; font-weight:700;">60</div>
          <div class="muted" style="margin-top:6px;">Affects demand sensitivity and audit risk.</div>
        </div>
      </div>

      <div class="grid-2" style="margin-top:8px;">
        <div class="card" style="padding:10px;">
          <div class="muted" style="font-size:12px;">Total Licenses Owned</div>
          <div id="totalLicenses" style="font-size:22px; font-weight:700;">0</div>
        </div>
        <div class="card" style="padding:10px;">
          <div class="muted" style="font-size:12px;">Penalties This Run</div>
          <div id="penaltiesThisRun" style="font-size:22px; font-weight:700; color:var(--danger);">$0</div>
        </div>
      </div>

      <div class="card" style="padding:10px;">
        <div class="section-title" style="margin-bottom:6px;">
          <h2>Upgrades</h2>
          <span class="badge" id="upgradeStatus"></span>
        </div>
        <div class="grid-2" style="gap:8px;">
          <div class="card" style="padding:8px;">
            <div class="muted" style="font-size:12px;">Audit Shield</div>
            <div id="auditShieldInfo" style="font-weight:700; font-size:16px;">Not owned</div>
            <button class="btn" id="buyAuditShieldBtn" aria-label="Buy Audit Shield">Buy (1000)</button>
          </div>
          <div class="card" style="padding:8px;">
            <div class="muted" style="font-size:12px;">Pricing Insight</div>
            <div id="pricingInsightInfo" style="font-weight:700; font-size:16px;">Not owned</div>
            <button class="btn" id="buyPricingInsightBtn" aria-label="Buy Pricing Insight">Buy (1500)</button>
          </div>
        </div>
      </div>

      <div class="card" style="padding:10px;">
        <div class="section-title">
          <h2>Alerts</h2>
          <span class="muted" style="font-size:12px;">Activity feed</span>
        </div>
        <div class="list" id="alertsList" aria-live="polite" style="max-height: 160px;"></div>
      </div>
    </section>
  </div>

  <!-- Tutorial Overlay (optional) -->
  <div id="tutorial" class="tutorial hidden" aria-hidden="true">
    <div class="card panel" role="dialog" aria-label="Tutorial">
      <h2>Tutorial: Mattf License Tycoon</h2>
      <ol id="tutorialSteps" style="margin:0 0 6px 16px;">
        <li>Buy licenses from the License Shop to build your inventory.</li>
        <li>Set sale prices for each license. Higher prices may reduce demand and increase audit risk.</li>
        <li>Revenue comes from selling licenses. Penalties may apply if audits occur.</li>
        <li>Unlock new license types and upgrades as you grow profit.</li>
        <li>Use the Analytics to monitor cash flow, risk, and licenses.</li>
      </ol>
      <div class="grid-2" style="justify-content:flex-end;">
        <button class="btn" id="closeTutorialBtn" aria-label="Close tutorial">Got it</button>
      </div>
      <div class="muted" style="margin-top:6px; font-size:12px;">Tip: Use the font size slider in accessibility to enlarge text.</div>
      <div style="margin-top:6px;">
        <label class="muted" for="fontSize">Font size</label>
        <input type="range" id="fontSize" min="12" max="20" value="14" />
      </div>
    </div>
  </div>

  <script>
    // Core state
    let cash = 1200;
    let reputation = 60; // 0-100
    let tick = 0;
    let paused = false;

    // Licenses
    const licenses = [
      {
        id: 'coast',
        name: 'Mattf Coastal Permit',
        region: 'Coastline',
        baseCost: 100,
        inventory: 0,
        price: 15,
        unlocked: true, // start available
        baseDemand: 40,
        priceImpact: 0.7
      },
      {
        id: 'river',
        name: 'Mattf River Permit',
        region: 'Rivers',
        baseCost: 250,
        inventory: 0,
        price: 25,
        unlocked: false,
        baseDemand: 60,
        priceImpact: 0.9
      },
      {
        id: 'arctic',
        name: 'Mattf Arctic License',
        region: 'Arctic',
        baseCost: 500,
        inventory: 0,
        price: 40,
        unlocked: false,
        baseDemand: 80,
        priceImpact: 1.1
      }
    ];

    // Global progression
    let globalDemandBoost = 0; // multiplicative on baseDemand
    const upgrades = {
      auditShield: { owned: false, cost: 1000, effect: 0.6 }, // reduces penalties by 60%
      pricingInsight: { owned: false, cost: 1500, effect: 0.2 }, // increases demand by 20%
      marketingCampaign: { owned: false, cost: 1200, effect: 0.15 }, // additional boost to demand
      taxRelief: { owned: false, cost: 800, effect: 0.5 } // reduces penalties by half
    };

    // UI refs
    const licenseListEl = document.getElementById('licenseList');
    const cashDisplayEl = document.getElementById('cashDisplay');
    const tickDisplayEl = document.getElementById('tickDisplay');
    const unlockStatusEl = document.getElementById('unlockStatus');
    const projRevenueEl = document.getElementById('projRevenue');
    const projPenaltyEl = document.getElementById('projPenalty');
    const demandBoostEl = document.getElementById('demandBoost');
    const auditRiskEl = document.getElementById('auditRisk');
    const chartEl = document.getElementById('chart');
    const cashValueEl = document.getElementById('cashValue');
    const repValueEl = document.getElementById('repValue');
    const totalLicensesEl = document.getElementById('totalLicenses');
    const penaltiesThisRunEl = document.getElementById('penaltiesThisRun');
    const upgradeStatusEl = document.getElementById('upgradeStatus');
    const auditShieldInfoEl = document.getElementById('auditShieldInfo');
    const pricingInsightInfoEl = document.getElementById('pricingInsightInfo');
    const buyAuditShieldBtn = document.getElementById('buyAuditShieldBtn');
    const buyPricingInsightBtn = document.getElementById('buyPricingInsightBtn');
    const alertsListEl = document.getElementById('alertsList');
    const pauseBtn = document.getElementById('pauseBtn');
    const fontSizeSlider = document.getElementById('fontSize');
    const fontSizeRoot = document.documentElement;
    const saveBtn = document.getElementById('saveBtn');
    const loadBtn = document.getElementById('loadBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const tutorialEl = document.getElementById('tutorial');
    const closeTutorialBtn = document.getElementById('closeTutorialBtn');
    const cashHistoryCanvas = chartEl; // alias

    // Analytics
    let cashHistory = [cash];
    const MAX_HISTORY = 120;

    // Floating text function
    function spawnFloatingCash(x, y, amount) {
      const el = document.createElement('div');
      el.className = 'float-pair';
      el.style.left = (x || window.innerWidth/2) + 'px';
      el.style.top = (y || window.innerHeight/2) + 'px';
      el.textContent = '+$' + Math.abs(Math.floor(amount)).toLocaleString();
      document.body.appendChild(el);
      // remove after animation ends
      setTimeout(() => el.remove(), 1200);
    }

    function formatMoney(n) {
      const sign = n < 0 ? '-' : '';
      const v = Math.abs(n);
      return sign + '$' + v.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
    }

    function clamp(n, a, b) {
      return Math.max(a, Math.min(b, n));
    }

    function pushAlert(text) {
      const div = document.createElement('div');
      div.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
      alertsListEl.prepend(div);
      // keep last 60
      while (alertsListEl.children.length > 60) alertsListEl.removeChild(alertsListEl.lastChild);
    }

    function updateLicenseUI() {
      licenseListEl.innerHTML = '';
      licenses.forEach(l => {
        const unlockedNow = l.unlocked;
        const card = document.createElement('div');
        card.className = 'license' + (unlockedNow ? '' : ' locked');
        card.style.display = 'grid';
        card.style.gridTemplateColumns = '1.2fr 0.8fr';
        card.style.gridGap = '10px';
        card.style.alignItems = 'start';
        card.style.padding = '10px';
        card.style.borderRadius = '8px';
        card.style.border = '1px solid #2b3240';
        card.style.background = 'rgba(12,16,25,.6)';

        // Left: details
        const left = document.createElement('div');
        const title = document.createElement('h3');
        title.textContent = l.name;
        title.style.margin = '0 0 6px';
        const region = document.createElement('div');
        region.className = 'muted';
        region.style.fontSize = '12px';
        region.textContent = 'Region: ' + l.region;
        left.appendChild(title);
        left.appendChild(region);

        // Right: controls
        const right = document.createElement('div');
        right.style.display = 'grid';
        right.style.gridTemplateRows = 'auto auto auto';
        right.style.gap = '6px';
        right.style.justifyItems = 'end';
        right.style.alignItems = 'center';

        // Inventory and price
        const invLine = document.createElement('div');
        invLine.className = 'row';
        const invLabel = document.createElement('span');
        invLabel.textContent = 'Inventory: ';
        const invValue = document.createElement('strong');
        invValue.textContent = l.inventory;
        invValue.id = 'inv-' + l.id;
        invValue.style.marginRight = '6px';
        const priceLabel = document.createElement('span');
        priceLabel.textContent = 'Price: $';
        const priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.value = l.price;
        priceInput.min = 0;
        priceInput.className = 'input';
        priceInput.style.width = '90px';
        priceInput.addEventListener('change', () => {
          const newPrice = parseFloat(priceInput.value) || 0;
          l.price = newPrice;
          updateMarketPanel();
        });
        invLine.appendChild(invLabel);
        invLine.appendChild(invValue);
        invLine.appendChild(priceLabel);
        invLine.appendChild(priceInput);

        // Buy button
        const buyBtn = document.createElement('button');
        buyBtn.className = 'btn';
        buyBtn.textContent = 'Buy License';
        buyBtn.disabled = cash < l.baseCost;
        buyBtn.addEventListener('click', () => {
          if (cash >= l.baseCost) {
            cash -= l.baseCost;
            l.inventory += 1;
            // little celebration
            card.classList.add('pulse');
            setTimeout(() => card.classList.remove('pulse'), 400);
            updateAllUI();
            pushAlert(`Bought 1 ${l.name} for ${formatMoney(l.baseCost)}.`);
            updateLicenseUI();
            spawnFloatingCash(window.innerWidth/2, window.innerHeight/2, l.baseCost);
          } else {
            pushAlert('Not enough cash to buy license.');
          }
        });

        // Unlock status
        const lockStatus = document.createElement('span');
        lockStatus.className = 'muted';
        lockStatus.style.fontSize = '12px';
        lockStatus.textContent = unlockedNow ? 'Unlocked' : 'Locked';
        lockStatus.style.marginTop = '6px';
        lockStatus.style.display = 'block';

        right.appendChild(invLine);
        right.appendChild(buyBtn);
        right.appendChild(lockStatus);

        card.appendChild(left);
        card.appendChild(right);
        licenseListEl.appendChild(card);
      });

      unlockStatusEl.textContent = 'Profit unlocks new licenses as you grow';
      updateUpgradeStatus();
      // unlock rules are checked in tick or when cash crosses thresholds
    }

    function updateMarketPanel() {
      // Derived values
      let totalProjectedRevenue = 0;
      let totalProjectedSales = 0;
      let totalInventory = 0;
      licenses.forEach(l => {
        if (!l.unlocked) return;
        const demand = Math.max(0, l.baseDemand * (1 + globalDemandBoost) - l.price * l.priceImpact);
        const sales = Math.min(l.inventory, Math.floor(demand));
        totalProjectedSales += sales;
        totalProjectedRevenue += sales * l.price;
        totalInventory += l.inventory;
      });
      projRevenueEl.textContent = formatMoney(totalProjectedRevenue);
      // Recalculate audit risk, more complex dynamics can be added
      demandBoostEl.textContent = (globalDemandBoost * 100).toFixed(0) + '%';
      // Audit risk
      const baseAudit = 0.02;
      let demandTotal = licenses.reduce((sum, l) => {
        if (!l.unlocked) return sum;
        const d = Math.max(0, l.baseDemand * (1 + globalDemandBoost) - l.price * l.priceImpact);
        return sum + Math.max(0, d);
      }, 0);
      let auditProbability = baseAudit + (demandTotal / 1000) + (getTotalActivePrice() / 1000) - (reputation / 100) * 0.01;
      auditProbability = clamp(auditProbability, 0, 0.25);
      auditRiskEl.textContent = Math.round(auditProbability * 100) + '%';
      totalLicensesEl.textContent = totalInventory;
    }

    function getTotalActivePrice() {
      let sum = 0;
      licenses.forEach(l => { if (l.unlocked) sum += l.price; });
      return sum;
    }

    function updateLedgerUI() {
      cashDisplayEl.textContent = formatMoney(cash);
      cashValueEl.textContent = '$' + cash.toLocaleString();
      repValueEl.textContent = Math.max(0, Math.round(reputation));
      totalLicensesEl.textContent = licenses.reduce((a, l) => a + l.inventory, 0);
      penaltiesThisRunEl.textContent = formatMoney(0);
    }

    function updateAllUI() {
      updateLicenseUI();
      updateMarketPanel();
      updateLedgerUI();
      updateUpgradeStatus();
      updateAccessibility();
    }

    function updateUpgradeStatus() {
      const owned = upgrades.auditShield.owned || upgrades.pricingInsight.owned || upgrades.marketingCampaign.owned || upgrades.taxRelief.owned;
      upgradeStatusEl.textContent = owned ? 'Upgrades Active' : 'No Upgrades';
      auditShieldInfoEl.textContent = upgrades.auditShield.owned ? 'Owned' : 'Not owned';
      pricingInsightInfoEl.textContent = upgrades.pricingInsight.owned ? 'Owned' : 'Not owned';
    }

    function unlockNewLicenses() {
      // Unlock River at 2000 cash, Arctic at 10000
      const river = licenses.find(l => l.id === 'river');
      const arctic = licenses.find(l => l.id === 'arctic');
      if (!river.unlocked && cash >= 2000) {
        river.unlocked = true;
        pushAlert('New license unlocked: Mattf River Permit!');
        updateAllUI();
      }
      if (!arctic.unlocked && cash >= 10000) {
        arctic.unlocked = true;
        pushAlert('New license unlocked: Mattf Arctic License!');
        updateAllUI();
      }
    }

    function updateAlertsList() { /* placeholder for future */ }

    // Tick simulation
    let penaltiesThisTick = 0;
    function tickStep() {
      if (paused) return;
      tick += 1;

      let revenueThisTick = 0;
      let penaltyThisTick = 0;

      // Revenue from sales
      licenses.forEach(l => {
        if (!l.unlocked) return;
        // Simple demand if there's inventory
        const demand = Math.max(0, l.baseDemand * (1 + globalDemandBoost) - l.price * l.priceImpact);
        const sales = Math.min(l.inventory, Math.floor(demand * 0.6)); // keep steady sales
        const revenue = sales * l.price;
        l.inventory -= sales;
        revenueThisTick += revenue;
      });

      cash += revenueThisTick;
      // Floating cash animation if revenue>0
      if (revenueThisTick > 0) spawnFloatingCash();

      // Penalties / audits
      const totalInventory = licenses.reduce((a,l)=>a+l.inventory,0);
      const demandTotal = licenses.reduce((sum,l)=> {
        if (!l.unlocked) return sum;
        const d = Math.max(0, l.baseDemand * (1 + globalDemandBoost) - l.price * l.priceImpact);
        return sum + Math.max(0, d);
      }, 0);
      let auditProbability = 0.02 + (totalInventory * 0.0005) + (demandTotal / 8000) - (reputation / 100) * 0.01;
      auditProbability = clamp(auditProbability, 0, 0.25);

      if (Math.random() < auditProbability) {
        let basePenalty = Math.floor((revenueThisTick > 0 ? revenueThisTick * (0.25 + Math.random() * 0.55) : 0) );
        if (upgrades.auditShield.owned) basePenalty = Math.floor(basePenalty * (1 - upgrades.auditShield.effect));
        if (basePenalty > 0) {
          cash -= basePenalty;
          penaltiesThisTick += basePenalty;
          reputation = Math.max(0, reputation - (10 + Math.floor(Math.random() * 8)));
          pushAlert(`Audit triggered! Penalty: ${formatMoney(basePenalty)}; Reputation dropped.`);
        }
      }

      // Upsert upgrades: MarketingCampaign boosts demand
      if (upgrades.marketingCampaign.owned) {
        globalDemandBoost = Math.min(0.9, globalDemandBoost + upgrades.marketingCampaign.effect);
      }

      // Random market shifts
      if (Math.random() < 0.04) {
        const delta = (Math.random() < 0.5 ? -0.05 : 0.05);
        globalDemandBoost = clamp(globalDemandBoost + delta, -0.2, 0.9);
        pushAlert('Market sentiment shift; demand boost adjusted by ' + Math.round(delta * 100) + '%');
      }

      // Unlock new licenses progressively
      unlockNewLicenses();

      // Update UI and history
      updateAllUI();
      penaltiesThisTick = penaltyThisTick;
      cashHistory.push(cash);
      if (cashHistory.length > MAX_HISTORY) cashHistory.shift();
      drawChart();
    }

    // Chart rendering
    function drawChart() {
      const ctx = chartEl.getContext('2d');
      if (!ctx) return;
      const w = chartEl.width;
      const h = chartEl.height;
      ctx.clearRect(0, 0, w, h);

      // grid
      ctx.fillStyle = 'rgba(0,0,0,0)';
      ctx.fillRect(0,0,w,h);

      // axes
      ctx.strokeStyle = 'rgba(255,255,255,.15)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(0, h-1);
      ctx.lineTo(w, h-1);
      ctx.stroke();

      // line
      const data = cashHistory.slice(-MAX_HISTORY);
      const maxVal = Math.max(1, ...data);
      const minVal = Math.min(...data);
      const range = maxVal - minVal || 1;
      const pad = 6;
      const innerW = w - pad * 2;
      const step = innerW / Math.max(1, data.length - 1);

      ctx.lineWidth = 2;
      ctx.strokeStyle = '#4bd4b4';
      ctx.beginPath();
      data.forEach((v, i) => {
        const x = pad + i * step;
        const y = h - pad - ((v - minVal) / range) * (h - pad * 2);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();

      // label
      if (data.length > 0) {
        ctx.fillStyle = '#fff';
        ctx.font = '12px sans-serif';
        const lastX = pad + (data.length - 1) * step;
        const lastY = h - pad - ((data[data.length - 1] - minVal) / range) * (h - pad * 2);
        ctx.fillText('$' + Math.floor(data[data.length - 1]).toLocaleString(), lastX + 6, lastY - 4);
      }
    }

    // Accessibility: font size
    function updateAccessibility() {
      document.documentElement.style.fontSize = fontSizeSlider.value + 'px';
    }

    // Initialize
    function init() {
      updateLicenseUI();
      updateAllUI();
      tickInterval = setInterval(tickStep, 1000);
      // autosave
      autosaveInterval = setInterval(() => saveGame(), 60000);
    }

    // Pause / resume
    pauseBtn.addEventListener('click', () => {
      paused = !paused;
      pauseBtn.textContent = paused ? 'Resume' : 'Pause';
      if (!paused) tickStep(); // quick update
    });

    // Upgrades
    buyAuditShieldBtn.addEventListener('click', () => {
      if (upgrades.auditShield.owned) return;
      if (cash >= upgrades.auditShield.cost) {
        cash -= upgrades.auditShield.cost;
        upgrades.auditShield.owned = true;
        updateUpgradeStatus();
        pushAlert('Audit Shield installed. Penalties reduced by 60% during audits.');
        updateAllUI();
      } else {
        pushAlert('Not enough cash to buy Audit Shield.');
      }
    });

    buyPricingInsightBtn.addEventListener('click', () => {
      if (upgrades.pricingInsight.owned) return;
      if (cash >= upgrades.pricingInsight.cost) {
        cash -= upgrades.pricingInsight.cost;
        upgrades.pricingInsight.owned = true;
        globalDemandBoost += upgrades.pricingInsight.effect;
        updateUpgradeStatus();
        pushAlert('Pricing Insight acquired. Global demand boosted.');
        updateAllUI();
      } else {
        pushAlert('Not enough cash to buy Pricing Insight.');
      }
    });

    // Marketing Campaign upgrade
    const marketingCampaignBtn = document.createElement('button');
    marketingCampaignBtn.className = 'btn';
    marketingCampaignBtn.textContent = 'Buy Marketing Campaign (1200)';
    marketingCampaignBtn.style.marginTop = '6px';
    marketingCampaignBtn.addEventListener('click', () => {
      if (upgrades.marketingCampaign.owned) return;
      if (cash >= upgrades.marketingCampaign.cost) {
        cash -= upgrades.marketingCampaign.cost;
        upgrades.marketingCampaign.owned = true;
        // boost demand baseline
        globalDemandBoost += upgrades.marketingCampaign.effect;
        updateUpgradeStatus();
        pushAlert('Marketing Campaign activated. Demand boosted.');
        updateAllUI();
      } else {
        pushAlert('Not enough cash to buy Marketing Campaign.');
      }
    });
    // Insert Marketing Campaign card to the upgrades area
    document.getElementById('ledgerPanel').querySelector('.section-title')?.after(marketingCampaignBtn);

    // Tax Relief upgrade
    const taxReliefBtn = document.createElement('button');
    taxReliefBtn.className = 'btn';
    taxReliefBtn.textContent = 'Buy Tax Relief (800)';
    taxReliefBtn.style.marginTop = '6px';
    taxReliefBtn.addEventListener('click', () => {
      if (upgrades.taxRelief.owned) return;
      if (cash >= upgrades.taxRelief.cost) {
        cash -= upgrades.taxRelief.cost;
        upgrades.taxRelief.owned = true;
        // reduce penalties by half
        upgrades.auditShield.effect = upgrades.auditShield.owned ? upgrades.auditShield.effect : 0.6;
        updateUpgradeStatus();
        pushAlert('Tax Relief activated. Penalties halved.');
        updateAllUI();
      } else {
        pushAlert('Not enough cash to buy Tax Relief.');
      }
    });
    marketingCampaignBtn.insertAdjacentElement('afterend', taxReliefBtn);

    // Font size accessibility
    fontSizeSlider.addEventListener('input', () => {
      updateAccessibility();
      document.documentElement.style.fontSize = fontSizeSlider.value + 'px';
    });

    // Save / Load
    function saveGame() {
      const state = {
        cash, reputation, tick, paused,
        licenses, globalDemandBoost, upgrades
      };
      localStorage.setItem('mt_game_v2', JSON.stringify(state));
      pushAlert('Game saved.');
    }
    function loadGame() {
      const s = localStorage.getItem('mt_game_v2');
      if (!s) { pushAlert('No save found.'); return; }
      try {
        const state = JSON.parse(s);
        Object.assign(window, state); // not strictly needed
        // Deeply restore
        cash = state.cash ?? cash;
        reputation = state.reputation ?? reputation;
        tick = state.tick ?? tick;
        paused = state.paused ?? paused;
        licenses.forEach((l,i) => {
          if (state.licenses?.[i]?.inventory != null) l.inventory = state.licenses[i].inventory;
          if (state.licenses?.[i]?.unlocked != null) l.unlocked = state.licenses[i].unlocked;
        });
        globalDemandBoost = state.globalDemandBoost ?? globalDemandBoost;
        Object.assign(upgrades, state.upgrades ?? upgrades);
        updateAllUI();
        pushAlert('Game loaded.');
      } catch (e) {
        pushAlert('Failed to load save.');
      }
    }

    saveBtn.addEventListener('click', saveGame);
    loadBtn.addEventListener('click', loadGame);

    exportBtn.addEventListener('click', () => {
      const s = JSON.stringify({ cash, reputation, tick, paused, licenses, globalDemandBoost, upgrades });
      navigator.clipboard.writeText(s).then(() => {
        pushAlert('Save data copied to clipboard.');
      });
    });

    importBtn.addEventListener('click', async () => {
      try {
        const text = prompt('Paste your save JSON here:');
        if (!text) return;
        const obj = JSON.parse(text);
        Object.assign(window, obj);
        cash = obj.cash ?? cash;
        reputation = obj.reputation ?? reputation;
        tick = obj.tick ?? tick;
        paused = obj.paused ?? paused;
        if (Array.isArray(obj.licenses)) {
          obj.licenses.forEach((ll, idx) => {
            if (licenses[idx]) {
              licenses[idx].inventory = ll.inventory ?? licenses[idx].inventory;
              licenses[idx].unlocked = ll.unlocked ?? licenses[idx].unlocked;
            }
          });
        }
        globalDemandBoost = obj.globalDemandBoost ?? globalDemandBoost;
        Object.assign(upgrades, obj.upgrades ?? upgrades);
        updateAllUI();
        pushAlert('Imported save.');
      } catch (e) {
        pushAlert('Invalid save data.');
      }
    });

    // Tutorial
    function showTutorial() {
      tutorialEl.classList.remove('hidden');
      tutorialEl.setAttribute('aria-hidden','false');
    }
    function hideTutorial() {
      tutorialEl.classList.add('hidden');
      tutorialEl.setAttribute('aria-hidden','true');
    }
    let shown = false;
    if (typeof localStorage !== 'undefined') {
      const seen = localStorage.getItem('mattf_tutorial_seen');
      if (!seen) {
        showTutorial();
        localStorage.setItem('mattf_tutorial_seen', '1');
        shown = true;
      }
    }

    closeTutorialBtn.addEventListener('click', () => {
      hideTutorial();
    });

    // Settings modal
    settingsBtn.addEventListener('click', () => {
      alert('Settings:\n- Pause/Resume simulation\n- Autosave every 60s\n- Font size adjuster in the overlay\nTip: Upgrades can boost demand and reduce penalties.');
    });

    // Auto-run after loading
    let tickInterval;
    let autosaveInterval;

    // Ensure initial UI
    updateAllUI();
    init();

    // Accessibility: default font size
    updateAccessibility();

    // Ensure canvas context
    if (chartEl.getContext) {
      const ctx = chartEl.getContext('2d');
      if (ctx) drawChart();
    }

    // Resize safeguard for canvas width on high DPI
    function resizeCanvas() {
      const dpr = window.devicePixelRatio || 1;
      chartEl.width = Math.floor(chartEl.clientWidth * dpr);
      chartEl.height = Math.floor(180 * dpr);
      const ctx = chartEl.getContext('2d');
      if (ctx) ctx.scale(dpr, dpr);
      drawChart();
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

  </script>
</body>
</html>