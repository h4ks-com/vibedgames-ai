<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mhats Global Market Simulator - Enhanced Edition</title>
  <style>
    :root {
      --bg: #0e111a;
      --panel: #191f2b;
      --muted: #9aa4b2;
      --accent: #4ecdc4;
      --green: #38d39f;
      --red: #e26a6a;
      --blue: #5cc0ff;
      --card: #1e232f;
      --glow: 0 0 20px rgba(78,205,196,.6);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: Inter, Arial, Roboto, sans-serif; background: radial-gradient(circle at 20% -10%, #1a2030 0%, #0e111a 60%), #0a0f1a; color: #e8eaf6; overflow-y: auto; }
    h1 { margin: 12px 0; font-size: 20px; letter-spacing: .5px; }
    #header { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid #1f2b44; position: sticky; top: 0; background: rgba(12,14,22,.95); z-index: 5; }
    #status { color: #a6aab8; margin-left: 12px; font-variant-numeric: tabular-nums; }
    #dayBadge { font-weight: bold; color: #e6f5ff; padding: 6px 10px; border-radius: 6px; background: #203b66; margin-right: 6px; box-shadow: var(--glow); }
    .btn { padding: 8px 12px; margin: 0 6px; border-radius: 8px; border: 1px solid #2b3e66; background: #1f2e56; color: #eaf7ff; cursor: pointer; transition: transform .2s ease, background .2s ease; }
    .btn.secondary { background:#2b2b2b; border-color:#3a3a3a; color:#dfe7f3; }
    .btn.success { background:#0f6048; border-color:#2d6b5a; color:#eafff8; }
    .btn.danger { background:#3a0f0f; border-color:#7a1a1a; }
    .btn:active { transform: translateY(1px) scale(0.98); }
    #container { display: grid; grid-template-columns: 1.25fr 1fr 0.95fr; gap: 12px; padding: 12px; min-height: calc(100vh - 60px); position: relative; }
    .panel { background: rgba(15,18,30,.95); border: 1px solid #2a3152; border-radius: 12px; padding: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.25); position: relative; overflow: hidden; }
    .panel h2 { margin: 0 0 8px; font-size: 15px; letter-spacing:.4px; text-transform: uppercase; color:#d7e0f6; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td { border-bottom: 1px solid #2a3152; padding: 6px 8px; text-align: left; vertical-align: middle; }
    th { color: #a8b3d6; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; }
    td .tag { display:inline-block; padding:2px 6px; border-radius: 5px; background:#2b2f53; color:#dbe6ff; font-size:11px; }
    #log { height: 230px; overflow-y: auto; background: #0b0f1a; border-radius: 6px; padding: 6px; border:1px solid #28334e; font-family: monospace; font-size: 11px; }
    .logLine { font-family: monospace; padding: 2px 0; color: #d6e0ff; }
    .row { display:flex; gap:8px; align-items:center; }
    .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
    .stat { display:flex; align-items:center; justify-content: space-between; padding:8px 6px; border-radius:6px; background:#1b2140; border:1px solid #2a3152; position: relative; overflow: hidden; }
    .stat .label { font-size:11px; color:#a8b3d6; }
    .stat .value { font-weight:700; font-size:14px; }
    .regionRow { font-size:12px; }
    input[type="number"] { width: 100%; padding: 6px; border-radius: 4px; border:1px solid #3a3a3a; background: #111; color:#fff; }
    input[type="range"] { width: 100%; }
    select { width: 100%; padding: 6px; border-radius: 4px; border:1px solid #3a3a3a; background: #111; color:#fff; }
    .muted { color:#a6a6a6; font-size: 12px; }
    .pulse { animation: pulse 1s ease-in-out infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 rgba(78,205,196,0.0); } 50% { box-shadow: 0 0 12px rgba(78,205,196,.8); } 100% { box-shadow: 0 0 0 rgba(78,205,196,0.0); } }
    .lowStock { background: #2a1932; animation: blink 0.7s step-start 0s infinite; }
    @keyframes blink { 50% { background: #3a1b2a; } }
    #bgCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 120px; pointer-events: none; z-index: 0; filter: saturate(1.2); opacity: .9; }
    /* Advanced options area */
    #advPanel { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 6px; border:1px dashed #2a3152; border-radius: 8px; margin-top: 6px; }
    #advPanel .card { padding:8px; border-radius:6px; background:#11172a; border:1px solid #2a3152; }
    @media (max-width: 1100px) {
      #container { grid-template-columns: 1fr; }
    }
    /* Confetti-like sparkles on events */
    .sparkle { position: absolute; width: 6px; height: 6px; pointer-events: none; opacity: 0; border-radius: 50%; transform: translate(-50%, -50%) scale(0.5); animation: sparkle 0.9s forwards; }
    @keyframes sparkle { 0% { opacity: 1; transform: translate(var(--dx), var(--dy)) scale(1); } 100% { opacity: 0; transform: translate(calc(var(--dx) * 1.4), calc(var(--dy) * 1.4)) scale(0.2); } }
  </style>
</head>
<body>
  <!-- Background canvas for subtle animations -->
  <canvas id="bgCanvas"></canvas>

  <div id="header">
    <div class="row" style="align-items:center;">
      <h1>Mhats Global Market Simulator - Enhanced Edition</h1>
      <span id="status"></span>
    </div>
    <div class="row" style="align-items:center;">
      <span id="dayBadge" title="Current simulated day">Day 1</span>
      <span class="muted" style="margin-right:8px;">Speed</span>
      <input id="speedSlider" type="range" min="0.5" max="3" step="0.1" value="1" style="width:180px;" />
      <span id="speedLabel" class="muted" style="min-width:60px; text-align:right;">1x</span>
      <button id="btnPlay" class="btn" title="Start simulation">Play</button>
      <button id="btnPause" class="btn secondary" title="Pause simulation" style="display:inline-block;">Pause</button>
      <button id="btnSave" class="btn secondary" title="Save game">Save</button>
      <button id="btnLoad" class="btn secondary" title="Load game">Load</button>
      <button id="btnReset" class="btn danger" title="Reset simulation">Reset</button>
    </div>
  </div>

  <div id="container">
    <!-- Global Stats -->
    <section class="panel" id="globalStats" aria-label="Global overview">
      <h2>Global Overview</h2>
      <div class="grid" id="globalStatsGrid">
        <!-- dynamic stats -->
      </div>
    </section>

    <!-- Regions -->
    <section class="panel" id="regionsPanel">
      <h2>Regional Markets</h2>
      <div style="overflow:auto;">
        <table id="regionsTable" aria-label="Regions table">
          <thead>
            <tr>
              <th>Region</th>
              <th>Price</th>
              <th>Demand Today</th>
              <th>Stock</th>
              <th>Backorders</th>
              <th>Lead / Ship</th>
              <th>Campaign</th>
              <th>In Transit</th>
              <th>Rating</th>
            </tr>
          </thead>
          <tbody id="regionsBody">
            <!-- filled by JS -->
          </tbody>
        </table>
      </div>
      <div id="regionLegend" class="muted" style="margin-top:6px;">Legend: Backorders increase urgency; campaigns adjust price and demand.</div>
    </section>

    <!-- Controls -->
    <section class="panel" id="controlsPanel" aria-label="Marketing, Production & Inventory">
      <h2>Marketing, Production & Inventory</h2>

      <div class="section" style="margin-bottom:8px;">
        <h3>Campaigns</h3>
        <div class="row" style="gap:6px;">
          <select id="regionCampaignSelect"></select>
          <input type="range" id="campaignDiscount" min="0" max="40" value="0" />
          <span class="muted" id="campaignDiscountLabel">0%</span>
        </div>
        <div class="row" style="gap:6px; align-items:center;">
          <input type="range" id="campaignDuration" min="1" max="28" value="7" />
          <span class="muted" id="campaignDurationLabel">7 days</span>
        </div>
        <button id="btnLaunchCampaign" class="btn success" style="width:100%; margin-top:6px;">Launch Campaign</button>
        <div id="campaignStatus" class="muted" style="margin-top:6px;"></div>
      </div>

      <hr style="border:none;height:1px;background:#2a3152;margin:6px 0;">

      <div class="section" style="margin-top:6px;">
        <h3>Production & Inventory</h3>
        <div class="row" style="gap:6px;">
          <select id="regionProdSelect"></select>
          <div style="flex:1;">
            <div class="row" style="gap:6px;">
              <label class="muted" style="width:140px;">Reorder Point</label>
              <input type="number" id="regionReorderPoint" min="0" value="200" />
            </div>
            <div class="row" style="gap:6px;">
              <label class="muted" style="width:140px;">Target Stock</label>
              <input type="number" id="regionTargetStock" min="0" value="800" />
            </div>
            <div class="row" style="gap:6px;">
              <label class="muted" style="width:140px;">Lead Time (days)</label>
              <input type="number" id="regionLeadTime" min="0" value="2" />
            </div>
            <div class="row" style="gap:6px;">
              <label class="muted" style="width:140px;">Shipping Time</label>
              <input type="number" id="regionShippingTime" min="0" value="2" />
            </div>
          </div>
        </div>
        <button id="btnUpdateRegion" class="btn" style="width:100%; margin-top:6px;">Apply Region Settings</button>
        <div class="muted" style="margin-top:6px;">Note: reorder will trigger production to raise stock up to Target Stock after Lead Time.</div>
      </div>

      <hr style="border:none;height:1px;background:#2a3152;margin:6px 0;">

      <div class="section" style="margin-top:6px;">
        <h3>Support & Returns</h3>
        <div class="row" style="gap:6px;">
          <button id="btnOpenSupport" class="btn">Open Support Center</button>
          <span class="muted" id="supportStatus" style="margin-left:6px;">No active tickets</span>
        </div>
        <div id="supportPanel" style="display:none; margin-top:6px;">
          <textarea id="supportMessage" rows="3" placeholder="Describe customer issue... (simulated)"></textarea>
          <button id="btnSubmitSupport" class="btn" style="margin-top:6px;">Submit</button>
        </div>
      </div>
    </section>

    <!-- Logs -->
    <section class="panel" id="logPanel" aria-label="Event log" style="grid-column: span 1 / span 1; min-width: 420px;">
      <h2 style="margin:0 0 6px;">Event Log</h2>
      <div id="log"></div>
    </section>
  </div>

  <!-- Advanced options / quick settings -->
  <section class="panel" id="advPanel" aria-label="Advanced options" style="margin: 12px; display: grid;">
    <div class="card" style="display:flex; gap:12px; align-items:center; justify-content:space-between;">
      <div class="muted" style="font-size:12px;">
        Advanced economy mode: enables random market shocks, tariffs, and demand volatility.
      </div>
      <button id="btnToggleShocks" class="btn secondary" title="Toggle random shocks on/off">Shocks: ON</button>
    </div>
  </section>

  <script>
    // Mhats Global Market Simulator - Enhanced Edition (vanilla JS)
    const regions = [];
    const regionIds = ['na','eu','apac','latam','mea'];

    let day = 1;
    let interval = null;
    let running = false;
    const LOG_LIMIT = 800;
    let shocksEnabled = true;
    let speed = 1;
    let tickIntervalMs = 1000;

    // Campaign definitions
    const toFixed = (n, d=0) => Number.parseFloat(n).toFixed(d);

    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

    function regionTemplate(opts) {
      return {
        id: opts.id,
        name: opts.name,
        basePrice: opts.basePrice,
        priceFactor: 0, // -discount/markup
        demandBase: opts.demandBase,
        demandMultiplier: 1,
        stock: opts.stock,
        reorderPoint: opts.reorderPoint,
        targetStock: opts.targetStock,
        leadTime: opts.leadTime,
        shippingTime: opts.shippingTime,
        inProduction: [], // {qty, readyDay}
        shipmentsInTransit: [], // {qty, eta}
        backorders: 0,
        campaign: null, // {daysLeft, discountPct}
        rating: opts.rating,
        supportTickets: [],
        returnsQueue: [],
        returnLeadTime: 2
      };
    }

    function initRegions() {
      const base = [
        { id:'na', name:'North America', basePrice:20, demandBase:60, stock:450, reorderPoint:120, targetStock:900, leadTime:2, shippingTime:2, rating:4.5 },
        { id:'eu', name:'Europe', basePrice:21, demandBase:50, stock:550, reorderPoint:150, targetStock:900, leadTime:3, shippingTime:3, rating:4.4 },
        { id:'apac', name:'Asia-Pacific', basePrice:22, demandBase:65, stock:650, reorderPoint:180, targetStock:1000, leadTime:3, shippingTime:4, rating:4.6 },
        { id:'latam', name:'Latin America', basePrice:18, demandBase:30, stock:400, reorderPoint:100, targetStock:700, leadTime:2, shippingTime:3, rating:4.2 },
        { id:'mea', name:'MEA', basePrice:19, demandBase:25, stock:300, reorderPoint:80, targetStock:600, leadTime:4, shippingTime:4, rating:4.1 }
      ];

      for (const r of base) {
        regions.push(regionTemplate(r));
      }
    }

    // UI helpers
    const logEl = document.getElementById('log');
    const dayEl = document.getElementById('dayBadge');
    const statusEl = document.getElementById('status');
    const btnPlay = document.getElementById('btnPlay');
    const btnPause = document.getElementById('btnPause');
    const globalStatsGrid = document.getElementById('globalStatsGrid');
    const regionsBody = document.getElementById('regionsBody');
    const regionCampaignSelect = document.getElementById('regionCampaignSelect');
    const campaignDiscount = document.getElementById('campaignDiscount');
    const campaignDiscountLabel = document.getElementById('campaignDiscountLabel');
    const campaignDuration = document.getElementById('campaignDuration');
    const campaignDurationLabel = document.getElementById('campaignDurationLabel');
    const btnLaunchCampaign = document.getElementById('btnLaunchCampaign');
    const campaignStatus = document.getElementById('campaignStatus');
    const regionProdSelect = document.getElementById('regionProdSelect');
    const regionReorderPoint = document.getElementById('regionReorderPoint');
    const regionTargetStock = document.getElementById('regionTargetStock');
    const regionLeadTime = document.getElementById('regionLeadTime');
    const regionShippingTime = document.getElementById('regionShippingTime');
    const btnUpdateRegion = document.getElementById('btnUpdateRegion');
    const supportBtn = document.getElementById('btnOpenSupport');
    const supportPanel = document.getElementById('supportPanel');
    const supportMessage = document.getElementById('supportMessage');
    const btnSubmitSupport = document.getElementById('btnSubmitSupport');
    const supportStatus = document.getElementById('supportStatus');
    const regionsTableBody = document.getElementById('regionsBody');
    const speedSlider = document.getElementById('speedSlider');
    const speedLabel = document.getElementById('speedLabel');
    const btnSave = document.getElementById('btnSave');
    const btnLoad = document.getElementById('btnLoad');
    const btnReset = document.getElementById('btnReset');
    const advPanel = document.getElementById('advPanel');
    const btnToggleShocks = document.getElementById('btnToggleShocks');
    const regionLegend = document.getElementById('regionLegend');
    const bgCanvas = document.getElementById('bgCanvas');
    const canvasCtx = bgCanvas.getContext('2d');

    function log(msg) {
      const t = new Date().toLocaleTimeString();
      const el = document.createElement('div');
      el.className = 'logLine';
      el.textContent = `[Day ${day}] ${msg}`;
      logEl.prepend(el);
      if (logEl.childNodes.length > LOG_LIMIT) logEl.removeChild(logEl.lastChild);
      // sparkles on log to enhance feedback
      spawnSparkles( eventTargetX() );
    }

    function eventTargetX() {
      // pseudo random x
      return Math.floor(Math.random() * window.innerWidth);
    }

    function spawnSparkles(x) {
      const count = 8;
      for (let i = 0; i < count; i++) {
        const s = document.createElement('span');
        s.className = 'sparkle';
        document.body.appendChild(s);
        const y = Math.floor(Math.random() * 80) + 20;
        s.style.left = (x || (window.innerWidth/2)) + 'px';
        s.style.top = -10 + 'px';
        const dx = (Math.random() * 80 - 40) + 'px';
        const dy = (Math.random() * 40) + 'px';
        s.style.setProperty('--dx', dx);
        s.style.setProperty('--dy', dy);
        s.style.background = ['#4ecdc4', '#ffd166', '#e76f51', '#118ab2', '#a3e635'][i % 5];
        s.style.opacity = 1;
        // remove after animation
        s.addEventListener('animationend', () => s.remove());
      }
    }

    function format(n) {
      return Number.isFinite(n) ? n.toLocaleString() : '0';
    }

    // Rendering
    function renderGlobalStats() {
      globalStatsGrid.innerHTML = '';
      const totalStock = regions.reduce((a,r)=>a+r.stock,0);
      const totalBackorders = regions.reduce((a,r)=>a+r.backorders,0);
      const totalInTransit = regions.reduce((a,r)=>a+r.shipmentsInTransit.reduce((aa,s)=>aa+s.qty,0),0);
      const avgRating = regions.reduce((a,r)=>a + r.rating, 0) / regions.length;

      const stats = [
        {label:'Day', value: day},
        {label:'Total Stock', value: totalStock},
        {label:'In Transit', value: totalInTransit},
        {label:'Backorders', value: totalBackorders},
        {label:'Avg Rating', value: toFixed(avgRating,2)}
      ];

      stats.forEach(s => {
        const div = document.createElement('div');
        div.className = 'stat';
        div.innerHTML = `<span class="label">${s.label}</span><span class="value">${s.value}</span>`;
        globalStatsGrid.appendChild(div);
      });
    }

    function renderRegionsTable() {
      regionsTableBody.innerHTML = '';
      regions.forEach(r => {
        const todayDemand = Math.round(r.demandBase * r.demandMultiplier * (0.9 + Math.random()*0.6));
        const inTransitQty = r.shipmentsInTransit.reduce((a, s) => a + s.qty, 0);
        const price = Math.max(0.01, r.basePrice * (1 + r.priceFactor));
        const campaignActive = r.campaign ? `Active (${r.campaign.daysLeft}d)` : 'None';
        const rating = r.rating.toFixed(2);

        const tr = document.createElement('tr');
        tr.className = 'regionRow';
        if (r.backorders > 0) tr.classList.add('lowStock');
        tr.innerHTML = `
          <td>${r.name}</td>
          <td>$${toFixed(price,2)}</td>
          <td>${todayDemand}</td>
          <td>${format(r.stock)}</td>
          <td>${format(r.backorders)}</td>
          <td>${r.leadTime}d / ${r.shippingTime}d</td>
          <td><span class="tag">${campaignActive}</span></td>
          <td>${format(inTransitQty)}</td>
          <td>${rating}</td>
        `;
        // hover highlight for animation
        tr.addEventListener('mouseenter', ()=> tr.style.background = '#1b2342');
        tr.addEventListener('mouseleave', ()=> tr.style.background = 'transparent');
        regionsTableBody.appendChild(tr);
      });
    }

    function populateRegionSelectors() {
      regionCampaignSelect.innerHTML = '';
      regionProdSelect.innerHTML = '';
      regions.forEach(r => {
        const opt1 = document.createElement('option');
        opt1.value = r.id;
        opt1.textContent = r.name;
        regionCampaignSelect.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = r.id;
        opt2.textContent = r.name;
        regionProdSelect.appendChild(opt2);
      });
      regionCampaignSelect.value = regions[0].id;
      regionProdSelect.value = regions[0].id;
    }

    function renderCampaignControls() {
      const region = regions.find(r => r.id === regionCampaignSelect.value);
      if (!region) return;
      if (region.campaign) {
        campaignStatus.textContent = `Campaign active: -${region.campaign.discountPct || 0}% price; days left ${region.campaign.daysLeft}`;
      } else {
        campaignStatus.textContent = 'No active campaign';
      }
      campaignDiscount.value = region.campaign ? region.campaign.discountPct : 0;
      campaignDiscountLabel.textContent = (region.campaign ? region.campaign.discountPct : 0) + '%';
      campaignDuration.value = region.campaign ? region.campaign.daysLeft : 7;
      campaignDurationLabel.textContent = (region.campaign ? region.campaign.daysLeft : 7) + ' days';
    }

    function renderRegionInputs() {
      const reg = regions.find(r => r.id === regionProdSelect.value);
      if (!reg) return;
      regionReorderPoint.value = reg.reorderPoint;
      regionTargetStock.value = reg.targetStock;
      regionLeadTime.value = reg.leadTime;
      regionShippingTime.value = reg.shippingTime;
    }

    // Simulation logic
    function tick() {
      day++;
      dayEl.textContent = 'Day ' + day;

      // 1) process deliveries due today (eta == day)
      regions.forEach(r => {
        const due = r.shipmentsInTransit.filter(s => s.eta === day);
        let deliveredQty = 0;
        if (due.length > 0) {
          deliveredQty = due.reduce((a,s)=>a+s.qty,0);
          r.stock += deliveredQty;
          log(`Delivery in ${r.name}: ${deliveredQty} units (ETA day ${day})`);
          r.shipmentsInTransit = r.shipmentsInTransit.filter(s => s.eta !== day);
          if (deliveredQty > 0) {
            const returnsChance = 0.04;
            if (Math.random() < returnsChance) {
              const retQty = Math.max(1, Math.round(deliveredQty * 0.15));
              r.returnsQueue.push({qty: retQty, eta: day + r.returnLeadTime});
              log(`Returns scheduled in ${r.name}: ${retQty} units (in ${r.returnLeadTime}d)`);
            }
          }
        }
        const dueReturn = r.returnsQueue.filter(x => x.eta === day);
        dueReturn.forEach(rr => {
          r.stock += rr.qty;
          log(`Return arrived in ${r.name}: ${rr.qty} units`);
        });
        r.returnsQueue = r.returnsQueue.filter(x => x.eta !== day);
      });

      // 2) forecast demand today and fulfill from stock
      regions.forEach(r => {
        const demandToday = Math.max(1, Math.round(r.demandBase * r.demandMultiplier * (0.9 + Math.random()*0.6)));
        const available = r.stock;
        const fulfill = Math.min(available, demandToday);
        const remaining = demandToday - fulfill;
        if (fulfill > 0) {
          r.stock -= fulfill;
          const eta = day + r.shippingTime;
          if (fulfill > 0) {
            r.shipmentsInTransit.push({qty: fulfill, eta});
            log(`Fulfilled ${fulfill} units in ${r.name}; ETA ${eta}`);
          }
        }
        if (remaining > 0) {
          r.backorders += remaining;
          log(`Backorder in ${r.name}: ${remaining} units (unfulfilled today)`);
        }
      });

      // 3) production & stock replenishment (reorder when stock <= reorderPoint)
      regions.forEach(r => {
        const readyBatches = r.inProduction.filter(b => b.readyDay <= day);
        readyBatches.forEach(b => { r.stock += b.qty; });
        r.inProduction = r.inProduction.filter(b => b.readyDay > day);

        // check reorder
        if (r.stock <= r.reorderPoint) {
          const needed = r.targetStock - r.stock;
          if (needed > 0) {
            const readyDay = day + r.leadTime;
            r.inProduction.push({qty: needed, readyDay});
            log(`Production queued for ${r.name}: ${needed} units, ready Day ${readyDay}`);
          }
        }
      });

      // 4) campaign updates
      regions.forEach(r => {
        if (r.campaign) {
          r.campaign.daysLeft -= 1;
          if (r.campaign.daysLeft <= 0) {
            r.campaign = null;
            r.priceFactor = 0;
            r.demandMultiplier = 1;
            log(`Campaign ended in ${r.name}`);
          }
        }
      });

      // 5) Update UI
      refreshUI();

      // 6) Support auto-notifications
      const totalBackordersAll = regions.reduce((a,r)=>a+r.backorders,0);
      if (totalBackordersAll > 50) {
        log('Notice: High backorders detected. Consider increasing production or expediting shipments.');
        supportStatus.textContent = 'High backorders; proactive outreach suggested';
      } else {
        supportStatus.textContent = 'Stable order flow';
      }

      // 7) Ratings drift due to returns
      regions.forEach(r => {
        if (r.returnsQueue.length > 0 || r.backorders > 0) {
          r.rating = clamp(r.rating - 0.01, 1, 5);
        } else {
          r.rating = clamp(r.rating + 0.02, 1, 5);
        }
      });

      // update day label
      dayEl.textContent = 'Day ' + day;
      // subtle UI animation
      dayEl.style.transform = 'scale(1.05)';
      setTimeout(()=> dayEl.style.transform = 'scale(1.0)', 120);
    }

    function start() {
      if (interval) clearInterval(interval);
      interval = setInterval(() => {
        tick();
      }, tickIntervalMs);
      running = true;
      statusEl.textContent = 'Running';
      btnPlay.disabled = true;
      btnPause.disabled = false;
      // gentle feedback
      document.body.style.filter = 'saturate(1.05)';
      setTimeout(()=> document.body.style.filter = '', 120);
    }

    function stop() {
      if (interval) clearInterval(interval);
      interval = null;
      running = false;
      statusEl.textContent = 'Paused';
      btnPlay.disabled = false;
      btnPause.disabled = true;
      document.body.style.filter = '';
    }

    // Campaign logic
    btnLaunchCampaign.addEventListener('click', () => {
      const regionId = regionCampaignSelect.value;
      const region = regions.find(r => r.id === regionId);
      if (!region) return;
      const discount = parseInt(campaignDiscount.value) || 0;
      const duration = parseInt(campaignDuration.value) || 7;
      if (discount <= 0) {
        log(`Campaign not launched: discount must be > 0%`);
        return;
      }
      region.campaign = { daysLeft: duration, discountPct: discount };
      region.priceFactor = -discount / 100;
      region.demandMultiplier = 1 + (discount / 100) * 0.8;
      log(`Campaign launched in ${region.name}: -${discount}% price for ${duration}d; demand +${Math.round((discount/100)*80)}% (approx)` );
      // confetti-like sparkles
      spawnSparkles(window.innerWidth/2);
      refreshUI();
    });

    btnUpdateRegion.addEventListener('click', () => {
      const rid = regionProdSelect.value;
      const r = regions.find(x => x.id === rid);
      if (!r) return;
      const newRO = parseInt(regionReorderPoint.value) || r.reorderPoint;
      const newTarget = parseInt(regionTargetStock.value) || r.targetStock;
      const newLead = parseInt(regionLeadTime.value) || r.leadTime;
      const newShip = parseInt(regionShippingTime.value) || r.shippingTime;

      r.reorderPoint = newRO;
      r.targetStock = newTarget;
      r.leadTime = newLead;
      r.shippingTime = newShip;

      log(`Region settings updated for ${r.name}: reorder ${newRO}, target ${newTarget}, lead ${newLead}d, shipping ${newShip}d`);
      refreshUI();
    });

    btnOpenSupport.addEventListener('click', () => {
      const isOpen = supportPanel.style.display === 'block';
      supportPanel.style.display = isOpen ? 'none' : 'block';
      supportStatus.textContent = isOpen ? 'Support closed' : 'Support center opened';
    });

    btnSubmitSupport.addEventListener('click', () => {
      const msg = supportMessage.value.trim();
      if (msg.length === 0) return;
      log('Support: Customer message logged - "' + msg + '"');
      supportMessage.value = '';
      supportPanel.style.display = 'none';
      supportStatus.textContent = 'Support ticket submitted';
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key.toLowerCase() === ' '){
        e.preventDefault();
        if (!running) start(); else stop();
      }
    });

    // Save / Load / Reset
    function saveGame() {
      const data = {
        day,
        regions,
        speed,
        shocksEnabled
      };
      localStorage.setItem('mhats_game_save', JSON.stringify(data));
      log('Game saved.');
    }

    function loadGame() {
      try {
        const data = JSON.parse(localStorage.getItem('mhats_game_save'));
        if (!data) { log('No save found.'); return; }
        day = data.day || 1;
        // restore regions deeply
        for (let i=0; i<regions.length; i++){
          Object.assign(regions[i], data.regions ? data.regions[i] : {});
        }
        speed = data.speed ?? 1;
        shocksEnabled = data.shocksEnabled ?? true;
        tickIntervalMs = Math.floor(1000 / speed);
        dayEl.textContent = 'Day ' + day;
        speedSlider.value = speed;
        speedLabel.textContent = speed.toFixed(1) + 'x';
        log('Game loaded.');
        refreshUI();
      } catch (err) {
        log('Load failed: ' + err.message);
      }
    }

    function resetGame() {
      localStorage.removeItem('mhats_game_save');
      // reset to initial
      day = 1;
      dayEl.textContent = 'Day ' + day;
      regions.forEach(r => {
        r.stock = r.stock; // keep starting stock
        r.backorders = 0;
        r.shipmentsInTransit = [];
        r.inProduction = [];
        r.campaign = null;
        r.priceFactor = 0;
        r.demandMultiplier = 1;
        r.rating = r.rating; // keep
        r.returnsQueue = [];
      });
      log('Game reset to starting conditions.');
      refreshUI();
    }

    btnSave.addEventListener('click', saveGame);
    btnLoad.addEventListener('click', loadGame);
    btnReset.addEventListener('click', resetGame);

    // Advanced options toggle
    btnToggleShocks.addEventListener('click', () => {
      shocksEnabled = !shocksEnabled;
      btnToggleShocks.textContent = 'Shocks: ' + (shocksEnabled ? 'ON' : 'OFF');
      log('Shocks ' + (shocksEnabled ? 'enabled' : 'disabled'));
      refreshUI();
    });

    // Confetti sparkles in header when campaign launched (triggered in tick)
    function spawnSparklesCenter() {
      spawnSparkles(window.innerWidth/2);
    }

    // Subtle animated background for container
    function resizeCanvas() {
      const w = window.innerWidth;
      const h = 120;
      bgCanvas.width = w;
      bgCanvas.height = h;
    }

    function drawBackground() {
      // animated faint waves
      const w = bgCanvas.width;
      const h = bgCanvas.height;
      canvasCtx.clearRect(0,0,w,h);
      const t = Date.now() / 1000;
      for (let i=0; i<6; i++) {
        const y = h * (i/6) + Math.sin((t*0.7) + i)*6;
        canvasCtx.strokeStyle = `rgba(78,205,196,${0.12 + i*0.02})`;
        canvasCtx.lineWidth = 2;
        canvasCtx.beginPath();
        for (let x=0; x<w; x+=4){
          const yy = y + Math.sin((x*0.01) + t*1.2 + i)*6;
          if (x===0) canvasCtx.moveTo(x, yy);
          else canvasCtx.lineTo(x, yy);
        }
        canvasCtx.stroke();
      }
      requestAnimationFrame(drawBackground);
    }

    // Initial setup
    function initUI() {
      dayEl.textContent = 'Day ' + day;
      btnPause.disabled = true;
      // populate regions
      populateRegionSelectors();
      renderGlobalStats();
      renderRegionsTable();
      renderCampaignControls();
      renderRegionInputs();
      refreshUI();

      // speed UI
      speedSlider.value = 1;
      speedLabel.textContent = '1x';
      tickIntervalMs = Math.floor(1000 / speed);
      // apply initial
    }

    function refreshUI() {
      renderGlobalStats();
      renderRegionsTable();
      renderCampaignControls();
      renderRegionInputs();
    }

    // Initialize
    function initRegions() { initRegionsInternal(); }

    // Keep original initialization separate
    function initRegionsInternal() {
      // setup regions
      // If already created, skip
      if (regions.length > 0) return;
      const base = [
        { id:'na', name:'North America', basePrice:20, demandBase:60, stock:450, reorderPoint:120, targetStock:900, leadTime:2, shippingTime:2, rating:4.5 },
        { id:'eu', name:'Europe', basePrice:21, demandBase:50, stock:550, reorderPoint:150, targetStock:900, leadTime:3, shippingTime:3, rating:4.4 },
        { id:'apac', name:'Asia-Pacific', basePrice:22, demandBase:65, stock:650, reorderPoint:180, targetStock:1000, leadTime:3, shippingTime:4, rating:4.6 },
        { id:'latam', name:'Latin America', basePrice:18, demandBase:30, stock:400, reorderPoint:100, targetStock:700, leadTime:2, shippingTime:3, rating:4.2 },
        { id:'mea', name:'MEA', basePrice:19, demandBase:25, stock:300, reorderPoint:80, targetStock:600, leadTime:4, shippingTime:4, rating:4.1 }
      ];
      for (const b of base) regions.push(regionTemplate(b));
    }

    // Init
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('load', () => {
      initRegionsInternal();
      initUI();
      resizeCanvas();
      drawBackground();
      log('Simulation initialized. Global markets configured for 5 regions. Production, inventory, and marketing modules ready.');
      // start idle
      renderGlobalStats();
      renderRegionsTable();
      renderCampaignControls();
      renderRegionInputs();
      refreshUI();
    });

    // Bind UI events
    btnPlay.addEventListener('click', () => {
      if (!running) {
        btnPlay.disabled = true;
        btnPause.disabled = false;
        start();
      }
    });
    btnPause.addEventListener('click', () => {
      if (running) {
        btnPlay.disabled = false;
        btnPause.disabled = true;
        stop();
      }
    });

    speedSlider.addEventListener('input', () => {
      speed = parseFloat(speedSlider.value);
      tickIntervalMs = Math.max(100, Math.floor(1000 / speed));
      speedLabel.textContent = speed.toFixed(1) + 'x';
      if (running) {
        // restart timer with new speed
        stop();
        start();
      }
    });

    // initialize default
    initRegionsInternal();

  </script>
</body>
</html>