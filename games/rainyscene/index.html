<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Rainy Night VR Scene</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <style>
        body { margin: 0; }
        a-scene { height: 100vh; background-color: gray; } /* Setting the background color to gray */
        .window { color: yellow; }
    </style>
</head>
<body>
    <!-- Background Audio -->
    <audio id="background-music" autoplay loop>
        <source src="http://kathy.torontocast.com:1730/stream" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <a-scene>
        <!-- Ambient Lights -->
        <a-entity light="type: ambient; intensity: 0.2"></a-entity>
        <a-entity light="type: directional; intensity: 0.5; position: 0 10 0"></a-entity>

        <!-- Rain Effect -->
        <a-entity id="rain" position="0 10 0">
            <a-entity particle-system="texture: https://cdn.rawgit.com/seng777/aframe-rain/master/rain.png; particleCount: 2500; emissionRate: 150; color: blue; colorMap: 0.2 0.2 0.5; transparency: 0.4; alive: 1;"></a-entity>
        </a-entity>

        <!-- 100-storey building -->
        <a-box position="0 5 -10" depth="5" height="200" width="5" color="#555" castShadow receiveShadow></a-box>

        <!-- Randomly Lit Windows -->
        <script>
            AFRAME.registerComponent('building-windows', {
                init: function () {
                    for (let i = 0; i < 100; i++) {
                        const windowId = "window-" + i;
                        const isLightOn = Math.random() >= 0.5;
                        const windowColor = isLightOn ? 'yellow' : 'black';
                        const windowPosY = i * 2; // 2 units height per storey
                        const windowEl = document.createElement('a-plane');
                        windowEl.setAttribute('id', windowId);
                        windowEl.setAttribute('position', `0 ${windowPosY} -10.1`);
                        windowEl.setAttribute('width', '4');
                        windowEl.setAttribute('height', '1.5');
                        windowEl.setAttribute('color', windowColor);
                        windowEl.setAttribute('opacity', '0.9');
                        this.el.sceneEl.appendChild(windowEl);
                    }
                }
            });
            document.querySelector('a-scene').setAttribute('building-windows', '');
        </script>

        <!-- Car Entity Passing by -->
        <a-entity id="car" geometry="primitive: box; width: 1; height: 0.5; depth: 0.5" material="color: red" position="5 0.25 -10"></a-entity>
        
        <!-- Front Headlights -->
        <a-sphere position="5.2 0.5 -10.3" radius="0.15" color="#FFFF99" opacity="1"></a-sphere> <!-- Left Front Headlight -->
        <a-sphere position="4.8 0.5 -10.3" radius="0.15" color="#FFFF99" opacity="1"></a-sphere> <!-- Right Front Headlight -->
        
        <!-- Back Headlights -->
        <a-sphere position="5.2 0.5 -9.7" radius="0.15" color="#FFFF99" opacity="1"></a-sphere> <!-- Left Back Headlight -->
        <a-sphere position="4.8 0.5 -9.7" radius="0.15" color="#FFFF99" opacity="1"></a-sphere> <!-- Right Back Headlight -->

        <script>
            let positionZ = -20;

            function moveCar() {
                positionZ += 0.1;
                if (positionZ > 10) {
                    positionZ = -20;
                }
                document.getElementById('car').setAttribute('position', `5 ${0.25} ${positionZ}`);
                
                // Update headlight positions
                const headlights = [
                    { x: 5.2, z: -10.3 }, // Left Front
                    { x: 4.8, z: -10.3 }, // Right Front
                    { x: 5.2, z: -9.7 },  // Left Back
                    { x: 4.8, z: -9.7 },  // Right Back
                ];
                
                headlights.forEach(({ x, z }) => {
                    const headlight = document.querySelector(`a-sphere[position="${x} 0.5 ${z}"]`);
                    headlight.setAttribute('position', `${x} 0.5 ${z + positionZ + 0.3}`); // Update based on car position
                });
                
                requestAnimationFrame(moveCar);
            }
            moveCar();         
        </script>

        <!-- Water Droplets -->
        <script>
            const dropletCount = 500;
            const droplets = [];

            function createDroplet() {
                const droplet = document.createElement('a-sphere');
                const randomX = (Math.random() - 0.5) * 10; // Random X position
                droplet.setAttribute('position', `${randomX} 10 ${-5}`); // Start from the top
                droplet.setAttribute('radius', '0.05');
                droplet.setAttribute('color', 'blue');
                droplet.setAttribute('opacity', '0.7');
                droplet.setAttribute('dynamic-body', ''); // Make it a physics object (for falling)
                droplets.push(droplet);
                document.querySelector('a-scene').appendChild(droplet);
            }

            function resetDroplet(droplet) {
                const randomX = (Math.random() - 0.5) * 10; // Random X position
                droplet.setAttribute('position', `${randomX} 10 ${-5}`); // Reset to the top
            }

            function fallDroplet(droplet) {
                const fallRate = Math.random() * 20 + 50; // Randomize falling speed
                const animate = () => {
                    const position = droplet.getAttribute('position');
                    if (position.y <= 0) {
                        resetDroplet(droplet);
                    } else {
                        droplet.setAttribute('position', `${position.x} ${position.y - 0.1} ${position.z}`);
                    }
                    setTimeout(animate, fallRate); // Schedule next fall step
                };
                animate();
            }

            for (let i = 0; i < dropletCount; i++) {
                createDroplet();
                // Randomize the start time for each droplet
                setTimeout(() => {
                    fallDroplet(droplets[i]);
                }, Math.random() * 2000); // Randomize initial delay between 0 and 2000ms
            }
        </script>

        <!-- Floor with Black and Gray Splotches -->
        <script>
            const floorSplotchCount = 100; // Number of splotches
            for (let i = 0; i < floorSplotchCount; i++) {
                const splotch = document.createElement('a-plane');
                const randomX = (Math.random() - 0.5) * 20; // Random X position
                const randomZ = (Math.random() - 0.5) * 20; // Random Z position
                splotch.setAttribute('position', `${randomX} 0 ${randomZ}`); // Set position
                splotch.setAttribute('width', '2'); // Width of the splotch
                splotch.setAttribute('height', '2'); // Height of the splotch
                splotch.setAttribute('color', Math.random() < 0.5 ? 'black' : 'gray'); // Random color
                splotch.setAttribute('opacity', '0.8'); // Slightly transparent
                splotch.setAttribute('rotation', '0 0 0'); // No rotation
                document.querySelector('a-scene').appendChild(splotch); // Add to scene
            }
        </script>
    </a-scene>
</body>
</html>
