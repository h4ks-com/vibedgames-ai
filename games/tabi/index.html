<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Unique ID Page</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 2rem;
    background: #f0f4f8;
    color: #333;
  }
  header {
    margin-bottom: 1.5rem;
  }
  h1 {
    margin: 0 0 0.5rem 0;
    font-size: 1.8rem;
  }
  #unique-id {
    font-weight: bold;
    color: #1a73e8;
  }
  a.button {
    display: inline-block;
    margin-top: 1.5rem;
    padding: 0.5rem 1rem;
    text-decoration: none;
    background: #1a73e8;
    color: white;
    border-radius: 4px;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  a.button:hover, a.button:focus {
    background: #155ab6;
  }
</style>
</head>
<body>
<header>
  <h1>Unique Page ID</h1>
  <div>This page's unique ID is: <span id="unique-id"></span></div>
</header>

<a href="#" id="open-new-tab" class="button">Open New Tab with Derived Unique ID</a>

<script>
(() => {
  // Helper: Generate a random integer 0 <= n < max
  function randInt(max) {
    return Math.floor(Math.random() * max);
  }

  // Generate a unique ID based on random number + current time, format: <random 8 hex digits>-<timestamp in ms base36>
  function generateRootId() {
    // random 4 bytes hex
    const r = randInt(0xffffffff).toString(16).padStart(8,"0");
    const t = Date.now().toString(36);
    return r + '-' + t;
  }

  // Generate a derived unique ID based on originID + current time
  // Format: originID + substr(hash) + timestamp-base36
  // Hash originID with simple hash function (FNV-1a 32bit) for a short hex string
  function fnv1aHash(str) {
    let hash = 2166136261;
    for(let i=0; i < str.length; i++) {
      hash ^= str.charCodeAt(i);
      hash += (hash << 1) + (hash << 4) + (hash << 7) + (hash << 8) + (hash << 24);
    }
    // convert to unsigned 32bit
    return (hash >>> 0).toString(16).padStart(8, "0");
  }

  function generateDerivedId(originId) {
    const hash = fnv1aHash(originId).slice(0,6); // 6 hex chars hash fragment
    const t = Date.now().toString(36);
    return originId + '-' + hash + '-' + t;
  }

  // Location hash will store the unique id for the page
  // If no hash, generate a root id and set location.hash = rootId (using history.replaceState)
  // If hash exists, show it

  function getIdFromHash() {
    let h = location.hash;
    if(h && h.startsWith('#') && h.length > 1) {
      return decodeURIComponent(h.slice(1));
    }
    return null;
  }

  function setHashId(id, replace = false) {
    const newHash = '#' + encodeURIComponent(id);
    if(replace) {
      history.replaceState(null, '', newHash);
    } else {
      location.hash = newHash;
    }
  }

  // Initialize
  let currentId = getIdFromHash();
  if(!currentId) {
    currentId = generateRootId();
    setHashId(currentId, true);
  }

  // Show ID in UI
  const idSpan = document.getElementById('unique-id');
  idSpan.textContent = currentId;

  // On click open new tab with derived ID
  document.getElementById('open-new-tab').addEventListener('click', e => {
    e.preventDefault();
    const newId = generateDerivedId(currentId);
    // Construct URL with new hash
    const url = location.origin + location.pathname + '#' + encodeURIComponent(newId);
    window.open(url, '_blank');
  });
})();
</script>
</body>
</html>
