<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Valware's Beans Leaderboard - Enhanced</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f1220;
      --card: rgba(27, 23, 64, 0.95);
      --text: #e9e1ff;
      --muted: #b9a6d6;
      --accent: #7bd389;
      --red: #ff6b6b;
      --green: #34c759;
      --yellow: #ffd166;
      --border: #2b214b;
      --shadow: 0 8px 24px rgba(0,0,0,.25);
      --glow: 0 0 0 rgba(123, 211, 137, 0);
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; background: radial-gradient(circle at 20% -10%, rgba(123,211,137,.15), transparent 40%), radial-gradient(circle at 100% 0%, rgba(123,211,137,.15), transparent 40%), linear-gradient(135deg, rgba(18,8,40,.8), rgba(18,8,40,.7) 60%), var(--bg); color: var(--text); font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; overflow-x: hidden; }
    @keyframes floaty {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-6px); }
      100% { transform: translateY(0px); }
    }
    html { height: 100%; }
    .bgBeads {
      position: fixed; left: 0; top: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 0;
      background-image: radial-gradient(circle at 10px 10px, rgba(255,255,255,.25) 0 2px, transparent 3px),
                        radial-gradient(circle at 40px 40px, rgba(0,0,0,.1) 0 2px, transparent 3px);
      opacity: .25;
      filter: saturate(1.2);
      animation: floaty 6s ease-in-out infinite;
    }
    .container { position: relative; z-index: 1; max-width: 1100px; margin: 20px auto; padding: 0 16px; }
    header { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 12px; padding: 12px 14px; border: 1px solid var(--border); border-radius: 12px; background: rgba(18,8,40,.85); box-shadow: var(--shadow); }
    header h1 { margin: 0; font-size: 1.25rem; letter-spacing: .5px; }
    .summary { font-size: .92rem; color: var(--muted); }
    .summary strong { color: #a3ffce; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .controls input[type="checkbox"] { transform: scale(1.1); }
    button { background: linear-gradient(135deg, #5f2bd3 0%, #7a4af4 100%); color: white; border: 0; padding: 9px 12px; border-radius: 8px; cursor: pointer; font-weight: 700; transition: transform .08s ease, box-shadow .2s ease; }
    button.secondary { background: linear-gradient(135deg, #2b1b62 0%, #4a2a9e 100%); }
    button.danger { background: linear-gradient(135deg, #8b0a0a 0%, #b4000d 100%); }
    button.small { padding: 6px 8px; font-size: 12px; border-radius: 6px; }
    button.import { background: linear-gradient(135deg, #1e7bd6 0%, #2b9df0 100%); }
    button.export { background: linear-gradient(135deg, #2b9a1e 0%, #4bd45a 100%); }
    input, select { padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border); background: #24154b; color: #fff; }
    input[type="number"] { width: 90px; }
    input[placeholder] { opacity:.9; }

    .content { display: grid; grid-template-columns: 1.15fr 0.85fr; gap: 16px; align-items: start; margin-top: 14px; position: relative; }
    @media (max-width: 920px) {
      .content { grid-template-columns: 1fr; }
    }
    .panel { background: rgba(18, 8, 40, .92); border: 1px solid var(--border); border-radius: 12px; padding: 12px; position: relative; overflow: hidden; }
    .panel:hover { transform: translateY(-1px); transition: transform .2s ease; }

    h2 { margin: 6px 6px 12px; font-size: 1rem; color: #e6d7ff; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #2b214b; text-align: left; font-size: 14px; }
    th { color: #d6c2ff; font-weight: 600; font-size: 13px; }
    tr:hover td { background: rgba(123,211,137,.08); }

    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: rgba(123,211,137,.2); color: #aaf3cc; font-weight: 700; font-size: 11px; }

    .green { color: #9affb4; }
    .red { color: #ffb3b3; }
    .neutral { color: #ddd; }

    .trend { font-size: 12px; margin-left: 6px; }
    .gap { font-weight: 600; }

    .profileRow { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; align-items: center; padding: 6px 0; border-bottom: 1px dashed rgba(255,255,255,.15); }
    .profileRow .name { font-weight: 600; }
    .profileRow .beans { color: var(--muted); }

    .profilesList { display: grid; gap: 6px; }
    .addProfile { display: flex; gap: 6px; align-items: center; margin-top: 8px; }

    .seedNote { color: var(--muted); font-size: 12px; margin-left: 6px; }

    .beansDelta { animation: pop 600ms ease; color: #9affc4; font-weight: 700; }
    @keyframes pop {
      0% { transform: scale(0.9); opacity: .0; }
      40% { transform: scale(1.15); opacity: 1; }
      100% { transform: scale(1); }
    }

    .confettiCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 40vh; pointer-events: none; z-index: 999; }
    @keyframes pulse {
      0% { transform: scale(1); opacity: .9; }
      50% { transform: scale(1.08); opacity: 1; }
      100% { transform: scale(1); opacity: .9; }
    }
    .pulse { animation: pulse 0.5s ease; }
    /* small bean icon under header for charm */
    .beanIcon {
      display: inline-block; width: 20px; height: 20px; background: radial-gradient(circle at 30% 30%, #fff 0 20%, transparent 21%), radial-gradient(circle at 70% 70%, #2bd17a 0 20%, transparent 21%), #6bdc93;
      border-radius: 50%; margin-right: 6px; vertical-align: middle; animation: bob 2s ease-in-out infinite;
    }
    @keyframes bob { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
  </style>
</head>
<body>
  <div class="bgBeads" aria-hidden="true"></div>

  <div class="container">
    <header>
      <div>
        <h1>Valware's Beans Leaderboard</h1>
        <div class="summary" id="summaryLine">
          <span class="beanIcon" aria-label="bean icon"></span>Valware Beans: <strong id="valwareBeans" style="color:#a3ffce">0</strong> |
          Rank Gap: <span id="rankGap" class="badge">-</span> |
          Live: <span id="liveStatus" style="color:#9affc1">Off</span>
        </div>
      </div>
      <div class="controls" role="group" aria-label="controls">
        <label><input id="toggleLive" type="checkbox" /> Live updates</label>
        <label>Interval: <input id="intervalInput" type="number" min="1" value="5" /> s</label>
        <button id="btnSeed" title="Seed dataset" class="import">Seed Dataset</button>
        <button id="btnReset" class="danger" title="Reset data">Reset Data</button>
        <button id="btnExport" class="export" title="Export JSON">Export JSON</button>
        <button id="btnImport" class="import" title="Import JSON">Import JSON</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>
    </header>

    <div class="content" aria-label="content panels">
      <section class="panel leaderboardPanel" aria-label="Leaderboard panel">
        <h2>Leaderboard</h2>
        <table id="leaderboard" aria-label="Leaderboard">
          <thead>
            <tr>
              <th>#</th>
              <th>Player</th>
              <th>Beans</th>
              <th>Change</th>
              <th>Valware Gap</th>
              <th>Trend</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody"></tbody>
        </table>
      </section>

      <section class="panel profilesPanel" aria-label="Profiles panel">
        <h2>Profiles</h2>
        <div id="profilesList" class="profilesList"></div>

        <div class="addProfile" style="margin-top:12px;">
          <input id="newName" placeholder="New player name" />
          <input id="newBeans" type="number" min="0" value="0" placeholder="Initial beans" />
          <button id="btnAddPlayer" title="Add player">Add Player</button>
        </div>

        <div style="margin-top:12px;">
          <input id="serverURL" placeholder="Server URL (optional)" style="width:40%;" />
          <button id="btnSync" class="secondary" title="Sync with server">Sync</button>
          <button id="btnSeedFromServer" class="secondary" title="Seed from server">Seed from Server</button>
        </div>

        <p class="seedNote">Note: Local data persists via localStorage. Server sync is optional and uses a simple JSON POST/GET interface when provided.</p>
      </section>
    </div>
  </div>

  <canvas id="confetti" class="confettiCanvas" width="0" height="0" aria-label="celebration" hidden></canvas>

  <script>
    // Data and persistence
    const storageKey = 'beansLeaderboard_v1';
    let players = [];

    // Seed dataset (enhanced)
    function seedDataset() {
      const seed = [
        { id: 'valware', name: 'Valware', beans: 65 },
        { id: 'p1', name: 'Astra', beans: 42 },
        { id: 'p2', name: 'Bram', beans: 39 },
        { id: 'p3', name: 'Cara', beans: 58 },
        { id: 'p4', name: 'Dax', beans: 25 },
        { id: 'p5', name: 'Elowen', beans: 33 },
        { id: 'p6', name: 'Finn', beans: 20 },
        { id: 'p7', name: 'Gale', beans: 47 },
        { id: 'p8', name: 'Hikari', beans: 14 },
        { id: 'p9', name: 'Iris', beans: 7 }
      ];
      // normalize
      const existsVal = seed.find(p => p.name.toLowerCase() === 'valware');
      if (existsVal) existsVal.id = 'valware';
      players = seed.map(p => ({
        id: p.id,
        name: p.name,
        beans: Math.max(0, Number(p.beans) || 0),
        prevBeans: Number.isFinite(p.prevBeans) ? p.prevBeans : Number(p.beans)
      }));
      saveToStorage();
      renderAll(true);
      burstConfetti(); // celebration
    }

    function loadFromStorage() {
      const raw = localStorage.getItem(storageKey);
      if (raw) {
        try {
          const obj = JSON.parse(raw);
          if (Array.isArray(obj.players)) {
            players = obj.players.map(p => ({
              id: p.id,
              name: p.name,
              beans: Number(p.beans) || 0,
              prevBeans: Number(p.prevBeans) || 0
            }));
            renderAll();
            updateValwareSnapshot();
            return;
          }
        } catch (e) {
          // fallthrough
        }
      }
      // seed default if nothing
      seedDataset();
    }

    function saveToStorage() {
      const payload = { players: players };
      localStorage.setItem(storageKey, JSON.stringify(payload));
    }

    // Helpers
    function findValware() {
      return players.find(p => p.name.toLowerCase() === 'valware' || p.id === 'valware');
    }

    function updateValwareSnapshot() {
      const v = findValware();
      const valwareBeans = v ? v.beans : 0;
      document.getElementById('valwareBeans').textContent = valwareBeans;
      const sorted = getSortedPlayers();
      const rank = sorted.findIndex(p => p.id === (v && v.id)) + 1;
      if (v) {
        const ahead = rank > 0 ? rank - 1 : 0;
        document.getElementById('rankGap').textContent = `Rank ${rank} of ${sorted.length}${ahead > 0 ? ` • ahead by ${ahead}` : ''}`;
      } else {
        document.getElementById('rankGap').textContent = '-';
      }
      document.getElementById('liveStatus').textContent = document.getElementById('toggleLive').checked ? 'On' : 'Off';
    }

    function getSortedPlayers() {
      return players.slice().sort((a,b) => b.beans - a.beans || a.name.localeCompare(b.name));
    }

    // Rendering
    function renderLeaderboard() {
      const tbody = document.getElementById('leaderboardBody');
      tbody.innerHTML = '';
      const sorted = getSortedPlayers();
      const valware = findValware();
      const valwareBeans = valware ? valware.beans : 0;

      sorted.forEach((p, index) => {
        const rank = index + 1;
        const delta = (typeof p.prevBeans === 'number') ? p.beans - p.prevBeans : 0;
        const gap = valwareBeans - p.beans;
        const tr = document.createElement('tr');

        // rank
        const tdRank = document.createElement('td');
        tdRank.textContent = rank;
        tr.appendChild(tdRank);

        // name
        const tdName = document.createElement('td');
        tdName.textContent = p.name;
        if (p.id === 'valware') tdName.innerHTML = 'Valware <span class="badge" title="Valware profile">V</span>';
        tr.appendChild(tdName);

        // beans
        const tdBeans = document.createElement('td');
        const spanBeans = document.createElement('span');
        spanBeans.textContent = p.beans;
        if (delta > 0) spanBeans.className = 'beansDelta';
        tdBeans.appendChild(spanBeans);
        tr.appendChild(tdBeans);

        // change
        const tdChange = document.createElement('td');
        if (typeof p.prevBeans === 'number') {
          const sign = delta > 0 ? '+' : (delta < 0 ? '' : '');
          tdChange.innerHTML = `<span style="font-weight:600">${delta >= 0 ? '+' : ''}${delta}</span> <span class="trend" style="color:${delta>0?'#9affc4':'#ff9e9e'}">${delta>0?'▲':(delta<0?'▼':'·')}</span>`;
        } else {
          tdChange.textContent = '-';
        }
        tr.appendChild(tdChange);

        // valware gap
        const tdGap = document.createElement('td');
        const gapColor = gap > 0 ? '#9affc4' : (gap < 0 ? '#ff9e9e' : '#d6d6d6');
        tdGap.innerHTML = `<span style="color:${gapColor};font-weight:700">${gap >= 0 ? '+' : ''}${gap}</span>`;
        tr.appendChild(tdGap);

        // trend
        const tdTrend = document.createElement('td');
        if (typeof p.prevBeans === 'number') {
          const t = p.beans - p.prevBeans;
          if (t > 0) tdTrend.innerHTML = '▲';
          else if (t < 0) tdTrend.innerHTML = '▼';
          else tdTrend.innerHTML = '•';
          tdTrend.className = 'trend';
          tdTrend.style.color = t > 0 ? '#9affc4' : (t < 0 ? '#ff9e9e' : '#d0d0d0');
        } else {
          tdTrend.textContent = '-';
        }
        tr.appendChild(tdTrend);

        tbody.appendChild(tr);
      });

      updateValwareSnapshot();
      // keep profiles in sync
      renderProfiles();
      // small pulse on table for life
      tablePulse();
    }

    function renderAll(forceSeed = false) {
      renderLeaderboard();
      // optional extra visuals
      if (forceSeed) burstConfetti();
    }

    // Profiles rendering and actions
    function adjustPlayer(id, delta) {
      const p = players.find(x => x.id === id);
      if (!p) return;
      p.prevBeans = p.beans;
      p.beans = Math.max(0, p.beans + (delta || 0));
      saveToStorage();
      renderAll();
    }

    function setPlayerBeans(id, value) {
      const p = players.find(x => x.id === id);
      if (!p) return;
      p.prevBeans = p.beans;
      p.beans = Math.max(0, Number(value) || 0);
      saveToStorage();
      renderAll();
    }

    function removePlayer(id) {
      players = players.filter(p => p.id !== id);
      saveToStorage();
      renderAll();
    }

    function renderProfiles() {
      const container = document.getElementById('profilesList');
      container.innerHTML = '';
      const sorted = players.slice().sort((a,b) => b.beans - a.beans || a.name.localeCompare(b.name));
      sorted.forEach(p => {
        const row = document.createElement('div');
        row.className = 'profileRow';
        row.dataset.id = p.id;
        row.innerHTML = `
          <div>
            <span class="name">${p.name}</span> - Beans: <strong>${p.beans}</strong>
          </div>
          <div>
            <button class="btn small" data-id="${p.id}" data-delta="-5">-5</button>
            <button class="btn small" data-id="${p.id}" data-delta="-1">-1</button>
            <button class="btn small" data-id="${p.id}" data-delta="1">+1</button>
            <button class="btn small" data-id="${p.id}" data-delta="5">+5</button>
          </div>
          <div>
            <input type="number" class="setInput" data-id="${p.id}" min="0" placeholder="Set" style="width:90px" />
            <button class="btn small set" data-id="${p.id}">Set</button>
            <button class="btn small remove" data-id="${p.id}">Remove</button>
          </div>
        `;
        container.appendChild(row);
      });

      // Bind events
      container.querySelectorAll('button[data-id]').forEach(btn => {
        const id = btn.dataset.id;
        const delta = btn.dataset.delta;
        if (typeof delta !== 'undefined' && delta !== null) {
          btn.addEventListener('click', () => {
            adjustPlayer(id, Number(delta));
          });
        }
        btn.addEventListener('click', (e) => {
          const el = e.target;
          if (el.classList.contains('remove')) {
            if (confirm('Remove this player?')) {
              removePlayer(id);
            }
          } else if (el.classList.contains('set')) {
            const input = container.querySelector(`input.setInput[data-id="${id}"]`);
            if (input) {
              const val = Number(input.value || 0);
              setPlayerBeans(id, val);
              input.value = '';
            }
          }
        });
      });
    }

    // Live updates
    let liveInterval = null;
    function startLiveUpdates(intervalSec) {
      if (liveInterval) clearInterval(liveInterval);
      liveInterval = setInterval(() => {
        // copy prev
        players.forEach(p => {
          p.prevBeans = p.beans;
        });
        // small random activity
        const nonValware = players.filter(p => p.name.toLowerCase() !== 'valware');
        nonValware.forEach(p => {
          if (Math.random() < 0.30) {
            const delta = Math.floor(Math.random() * 3) - 1; // -1..+1
            p.beans = Math.max(0, p.beans + delta);
          }
        });
        saveToStorage();
        renderAll();
      }, intervalSec * 1000);
    }

    // Server sync (optional)
    async function syncToServer() {
      const url = document.getElementById('serverURL').value.trim();
      if (!url) {
        alert('Please enter a server URL to sync.');
        return;
      }
      try {
        const payload = { players };
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('Server responded with ' + res.status);
        alert('Sync successful.');
      } catch (e) {
        alert('Sync failed: ' + (e.message || e));
      }
    }

    async function seedFromServer() {
      const url = document.getElementById('serverURL').value.trim();
      if (!url) {
        alert('Enter a server URL to fetch seed data.');
        return;
      }
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Server error: ' + res.status);
        const data = await res.json();
        if (Array.isArray(data.players)) {
          players = data.players.map(p => ({
            id: p.id || ('p_' + Date.now() + Math.random().toString(36).slice(2)),
            name: String(p.name || 'Player'),
            beans: Number(p.beans) || 0,
            prevBeans: Number(p.prevBeans) || 0
          }));
          saveToStorage();
          renderAll();
          alert('Seed loaded from server.');
        } else {
          alert('Server returned no valid players data.');
        }
      } catch (e) {
        alert('Failed to seed from server: ' + (e.message || e));
      }
    }

    // Confetti burst (simple canvas particles)
    let confettiActive = false;
    function burstConfetti() {
      const c = document.getElementById('confetti');
      const ctx = c.getContext('2d');
      c.width = window.innerWidth;
      c.height = Math.floor(window.innerHeight * 0.4);
      c.hidden = false;

      const colors = ['#ff4d4d','#ffd166','#7bd389','#4cc9f0','#a29bfe','#f472b6'];
      const particles = Array.from({ length: 120 }).map(() => ({
        x: Math.random() * c.width,
        y: -Math.random() * 20,
        vx: (Math.random() - 0.5) * 4,
        vy: Math.random() * 4 + 2,
        color: colors[Math.floor(Math.random() * colors.length)],
        w: Math.random() * 6 + 4,
        h: Math.random() * 8 + 6,
        tilt: Math.random() * 20 - 10,
        rotation: Math.random() * 360
      }));

      let t0 = performance.now();
      confettiActive = true;

      function frame(now) {
        const dt = Math.min(32, now - (t0 || now));
        t0 = now;
        ctx.clearRect(0,0,c.width,c.height);
        particles.forEach(p => {
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.04; // gravity
          p.rotation += 6;
          if (p.y > c.height) {
            p.y = -10;
            p.x = Math.random() * c.width;
            p.vy = Math.random() * 4 + 2;
          }
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rotation * Math.PI/180);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
          ctx.restore();
        });
        if (now - t0 < 1600) {
          requestAnimationFrame(frame);
        } else {
          confettiActive = false;
          c.hidden = true;
        }
      }
      requestAnimationFrame(frame);
    }

    // Init
    function tablePulse() {
      // little pulse glow on table
      const el = document.getElementById('leaderboard');
      if (!el) return;
      el.classList.remove('pulse');
      void el.offsetWidth; // reflow
      el.classList.add('pulse');
      setTimeout(() => el.classList.remove('pulse'), 600);
    }

    function initEventBindings() {
      document.getElementById('btnSeed').addEventListener('click', seedDataset);
      document.getElementById('btnReset').addEventListener('click', () => {
        if (confirm('Reset all data? This will clear local changes.')) {
          localStorage.removeItem(storageKey);
          players = [];
          renderAll();
        }
      });

      // Live toggle
      const toggleLive = document.getElementById('toggleLive');
      const intervalInput = document.getElementById('intervalInput');
      toggleLive.addEventListener('change', () => {
        const on = toggleLive.checked;
        document.getElementById('liveStatus').textContent = on ? 'On' : 'Off';
        if (on) {
          const sec = Math.max(1, Number(intervalInput.value || 5));
          startLiveUpdates(sec);
        } else {
          if (liveInterval) clearInterval(liveInterval);
          liveInterval = null;
        }
      });

      intervalInput.addEventListener('change', () => {
        const sec = Math.max(1, Number(intervalInput.value || 5));
        if (toggleLive.checked) {
          startLiveUpdates(sec);
        }
        document.getElementById('liveStatus').textContent = toggleLive.checked ? 'On' : 'Off';
      });

      // Add player
      document.getElementById('btnAddPlayer').addEventListener('click', () => {
        const nameEl = document.getElementById('newName');
        const beansEl = document.getElementById('newBeans');
        const name = (nameEl.value || '').trim();
        const beans = Number(beansEl.value || 0);
        if (!name) {
          alert('Please enter a name.');
          return;
        }
        const id = 'p_' + Date.now() + Math.random().toString(36).slice(2);
        const newP = { id, name, beans: Math.max(0, beans), prevBeans: Math.max(0, beans) };
        players.push(newP);
        nameEl.value = '';
        beansEl.value = '0';
        saveToStorage();
        renderAll();
        burstConfetti();
      });

      // Server sync buttons
      document.getElementById('btnSync').addEventListener('click', syncToServer);
      document.getElementById('btnSeedFromServer').addEventListener('click', seedFromServer);
      document.getElementById('btnExport').addEventListener('click', exportJSON);
      document.getElementById('btnImport').addEventListener('click', () => document.getElementById('importFile').click());
      document.getElementById('importFile').addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(reader.result);
            if (Array.isArray(data.players)) {
              players = data.players.map(p => ({
                id: p.id || ('p_' + Date.now() + Math.random().toString(36).slice(2)),
                name: String(p.name || 'Player'),
                beans: Number(p.beans) || 0,
                prevBeans: Number(p.prevBeans) || 0
              }));
              saveToStorage();
              renderAll();
              burstConfetti();
              alert('Imported dataset.');
            } else {
              alert('Invalid data format.');
            }
          } catch (err) {
            alert('Failed to parse JSON: ' + err.message);
          }
        };
        reader.readAsText(f);
      });

      // Profile interactions delegated by rendering
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      // Bind quick ripple on buttons
      function addRipple(e) {
        const el = e.currentTarget;
        const r = document.createElement('span');
        r.style.position = 'absolute';
        r.style.left = (e.clientX - el.getBoundingClientRect().left) + 'px';
        r.style.top = (e.clientY - el.getBoundingClientRect().top) + 'px';
        r.style.width = r.style.height = '100px';
        r.style.borderRadius = '50%';
        r.style.pointerEvents = 'none';
        r.style.transform = 'translate(-50%, -50%)';
        r.style.background = 'radial-gradient(circle, rgba(255,255,255,.6) 0%, rgba(255,255,255,0) 40%)';
        r.style.opacity = '0.8';
        r.style.filter = 'blur(0.4px)';
        r.style.animation = 'fadeout 600ms ease';
        el.style.overflow = 'visible';
        el.appendChild(r);
        setTimeout(() => r.remove(), 600);
      }
      // CSS for ripple
      const style = document.createElement('style');
      style.textContent = '@keyframes fadeout { from {opacity:0.8;} to {opacity:0; transform: scale(1.4);} }';
      document.head.appendChild(style);

      // Attach ripple to all existing plus future buttons by delegation
      document.addEventListener('click', (ev) => {
        const t = ev.target;
        if (t.tagName === 'BUTTON' || t.closest('button')) {
          const btn = t.tagName === 'BUTTON' ? t : t.closest('button');
          if (btn) {
            addRipple({ currentTarget: btn, clientX: ev.clientX, clientY: ev.clientY });
          }
        }
      });

      // Bind actions
      document.getElementById('btnSeed').addEventListener('click', seedDataset);
      document.getElementById('btnReset').addEventListener('click', () => {
        if (confirm('Reset all data? This will clear local changes.')) {
          localStorage.removeItem(storageKey);
          players = [];
          renderAll();
        }
      });

      // Live toggle
      const toggleLive = document.getElementById('toggleLive');
      const intervalInput = document.getElementById('intervalInput');
      toggleLive.addEventListener('change', () => {
        const on = toggleLive.checked;
        document.getElementById('liveStatus').textContent = on ? 'On' : 'Off';
        if (on) {
          const sec = Math.max(1, Number(intervalInput.value || 5));
          startLiveUpdates(sec);
        } else {
          if (liveInterval) clearInterval(liveInterval);
          liveInterval = null;
        }
      });

      intervalInput.addEventListener('change', () => {
        const sec = Math.max(1, Number(intervalInput.value || 5));
        if (toggleLive.checked) {
          startLiveUpdates(sec);
        }
        document.getElementById('liveStatus').textContent = toggleLive.checked ? 'On' : 'Off';
      });

      // Add player
      document.getElementById('btnAddPlayer').addEventListener('click', () => {
        const nameEl = document.getElementById('newName');
        const beansEl = document.getElementById('newBeans');
        const name = (nameEl.value || '').trim();
        const beans = Number(beansEl.value || 0);
        if (!name) {
          alert('Please enter a name.');
          return;
        }
        const id = 'p_' + Date.now();
        const newP = { id, name, beans: Math.max(0, beans), prevBeans: Math.max(0, beans) };
        players.push(newP);
        nameEl.value = '';
        beansEl.value = '0';
        saveToStorage();
        renderAll();
      });

      // Server sync buttons
      document.getElementById('btnSync').addEventListener('click', syncToServer);
      document.getElementById('btnSeedFromServer').addEventListener('click', seedFromServer);

      // Export/Import
      document.getElementById('btnExport').addEventListener('click', exportJSON);

      // Import button triggers file input
      document.getElementById('btnImport').addEventListener('click', () => document.getElementById('importFile').click());

      // Import file change
      document.getElementById('importFile').addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(reader.result);
            if (Array.isArray(data.players)) {
              players = data.players.map(p => ({
                id: p.id || ('p_' + Date.now() + Math.random().toString(36).slice(2)),
                name: String(p.name || 'Player'),
                beans: Number(p.beans) || 0,
                prevBeans: Number(p.prevBeans) || 0
              }));
              saveToStorage();
              renderAll();
              burstConfetti();
              alert('Imported dataset.');
            } else {
              alert('Invalid data format.');
            }
          } catch (err) {
            alert('Failed to parse JSON: ' + err.message);
          }
        };
        reader.readAsText(f);
      });

      // Profiles initial render
      loadFromStorage();
      renderAll();
    });

    // Export JSON
    function exportJSON() {
      const payload = { players };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'beans_leaderboard.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    }

    // Confetti burst used on seed or import
    // Init
    window.addEventListener('resize', () => {
      const c = document.getElementById('confetti');
      if (!c.hidden) {
        c.width = window.innerWidth;
        c.height = Math.floor(window.innerHeight * 0.4);
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      // initial setup
      initEventBindings();
      loadFromStorage();
      renderAll();
    });
  </script>
</body>
</html>