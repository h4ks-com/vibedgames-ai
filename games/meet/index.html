<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Calling App</title>
    <style>
        body { font-family: Arial, sans-serif; }
        #localVideo, #remoteVideo { width: 45%; border: 1px solid black; }
        #videosContainer { display: flex; justify-content: space-around; margin: 20px; }
        #controls { margin-top: 10px; }
        button { padding: 10px; }
    </style>
</head>
<body>

<h1>WebRTC Calling App</h1>
<div id="videosContainer">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
</div>
<div id="controls">
    <button id="startCall">Start Call</button>
    <button id="hangUp" disabled>Hang Up</button>
</div>

<script>
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const startCallButton = document.getElementById('startCall');
const hangUpButton = document.getElementById('hangUp');

let localStream;
let peerConnection;
const ICE_SERVERS = { iceServers: [{ urls: 'turn:turn.server.url:3478', username: 'user', credential: 'pass' }] }; // Replace with valid TURN server
const IRC_SERVER = "irc.h4ks.com";
const IRC_PORT = 8097;
const CHANNEL = "#webrtc";
let ircSocket;

// Connect to the IRC server
function connectIRC() {
    ircSocket = new WebSocket(`wss://${IRC_SERVER}:${IRC_PORT}`);
    
    ircSocket.onopen = () => {
        ircSocket.send(`NICK WebRTCClient`);
        ircSocket.send(`USER WebRTCClient 0 * :WebRTC Client`);
        ircSocket.send(`JOIN ${CHANNEL}`);
    };

    ircSocket.onmessage = (message) => {
        const msg = message.data;
        if(msg.startsWith(":")) {
            const parts = msg.split(' ');
            // Handle PING messages
            if (parts[1] === 'PING') {
                ircSocket.send(`PONG ${parts[2]}`);
            }
        } else {
            handleSignalingMessage(msg);
        }
    };
}

// Start the call
startCallButton.onclick = async () => {
    startCallButton.disabled = true;
    hangUpButton.disabled = false;

    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;

    peerConnection = new RTCPeerConnection(ICE_SERVERS);
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    peerConnection.onicecandidate = event => {
        if (event.candidate) {
            sendSignal({ "ice": event.candidate });
        }
    };

    peerConnection.ontrack = event => {
        remoteVideo.srcObject = event.streams[0];
    };

    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    
    sendSignal({ "offer": peerConnection.localDescription });
};

// Handle incoming signaling messages
function handleSignalingMessage(message) {
    const data = JSON.parse(message);
    
    if (data.answer) {
        peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
    }

    if (data.ice) {
        peerConnection.addIceCandidate(new RTCIceCandidate(data.ice)).catch(e => console.error('Error adding received ice candidate', e));
    }
}

// Send signaling messages via IRC
function sendSignal(message) {
    ircSocket.send(JSON.stringify(message));
}

// Hang up the call
hangUpButton.onclick = () => {
    peerConnection.close();
    localStream.getTracks().forEach(track => track.stop());
    startCallButton.disabled = false;
    hangUpButton.disabled = true;
};

// Connect to IRC on page load
connectIRC();
</script>

</body>
</html>
