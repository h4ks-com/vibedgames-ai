<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VibeMind - Enhanced</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0e0f14;
      --panel: #141923;
      --panel2: #1e2340;
      --text: #e9e9ef;
      --accent: #7bd389;
      --danger: #e76f51;
      --sub: #a8b3cf;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: Inter, Arial, sans-serif; background: radial-gradient(circle at 30% 20%, #1b2030 0%, #0e0f14 60%), #0e0f14; color: var(--text); overflow: hidden; }

    #wrap { display: grid; grid-template-columns: 320px 1fr 320px; gap: 12px; padding: 12px; height: calc(100vh - 24px); }
    #leftPane, #rightPane { background: linear-gradient(#1a1f3a, #0f1222); border-radius: 12px; padding: 12px; overflow: auto; position: relative; }
    #centerPane { position: relative; background: #0b0f1a; border-radius: 12px; padding: 0; overflow: hidden; display: grid; place-items: center; }

    h2 { margin: 6px 0 12px; font-size: 16px; color: #cbd5e1; }
    .section { border: 1px solid #2a2f60; border-radius: 10px; padding: 10px; margin-bottom: 12px; background: rgba(6,10,30,.6); }

    /* Game area */
    #gameArea { width: 100%; height: 100%; position: relative; min-height: 520px; background: linear-gradient(#0a0e1a,#0a0f22); border-radius: 10px; overflow: hidden; }

    .grid { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: linear-gradient(to right, rgba(255,255,255,.04) 1px, transparent 1px), linear-gradient(to bottom, rgba(255,255,255,.04) 1px, transparent 1px); background-size: 40px 40px; pointer-events: none; filter: saturate(1.1); animation: drift 20s linear infinite; opacity:.8; }
    @keyframes drift { from { background-position: 0 0; } to { background-position: 40px 40px; } }

    .player { position: absolute; width: 28px; height: 28px; background: #5cc8ff; border-radius: 6px; left: 50%; transform: translate(-50%, -50%); top: 50%; display: grid; place-items: center; box-shadow: 0 0 0 2px rgba(0,0,0,.15); z-index: 3; animation: bob 2.8s ease-in-out infinite; }
    @keyframes bob { 0%,100% { transform: translate(-50%, -50%) translateY(0); } 50% { transform: translate(-50%, -50%) translateY(-6px);} }

    .char { position: absolute; width: 28px; height: 28px; border-radius: 6px; display: grid; place-items: center; font-size: 12px; color: #fff; transform: translate(-50%, -50%); pointer-events: none; z-index: 2; }
    .char .name { font-size: 9px; position: absolute; bottom: -16px; white-space: nowrap; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,.6); }

    .tag { position: absolute; top: -10px; right: -10px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid rgba(255,255,255,.6); }

    .range { position: absolute; border-radius: 50%; width: 0; height: 0; /* dynamic via JS */ }

    .card { border-radius: 8px; padding: 8px; margin-bottom: 8px; background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); }
    .card h3 { margin: 0 0 6px; font-size: 13px; color: #e5e7eb; }
    .meter { height: 8px; background: rgba(255,255,255,.15); border-radius: 6px; overflow: hidden; }
    .bar { height: 100%; width: 0%; background: #7bd389; }

    .bar.trust { background: linear-gradient(90deg, #4ade80, #16a34a); }
    .bar.joy { background: linear-gradient(90deg, #f472b6, #ec4899); }
    .bar.anxiety { background: linear-gradient(90deg, #f59e0b, #f87171); }

    /* Dialogue */
    #dialogue { position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); width: 420px; max-width: calc(100% - 24px); background: rgba(10,12,25,.95); border: 1px solid #2a2f60; border-radius: 10px; padding: 12px; display: none; z-index: 5; }
    #dialogue h4 { margin: 0 0 6px; font-size: 14px; }
    #dialogue p { margin: 6px 0; font-size: 14px; color: #e6e6e6; min-height: 38px; }
    .options { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .btn { padding: 8px 12px; border-radius: 6px; border: 1px solid #2a2f60; background: #1f254a; color: #fff; cursor: pointer; font-size: 13px; }
    .btn:hover { background: #2a2f60; }
    .btn.secondary { background: #2a2f60; }
    #subtitle { position: absolute; bottom: -22px; left: 0; right: 0; text-align: center; font-size: 12px; color: #cbd5e1; opacity: .9; }

    /* Toggles and controls */
    label.switch { display: inline-flex; align-items: center; cursor: pointer; gap: 8px; }
    input[type="checkbox"] { appearance: none; width: 40px; height: 22px; background: #6b7280; border-radius: 999px; position: relative; outline: none; }
    input[type="checkbox"]:checked { background: #34d399; }
    input[type="checkbox"]::after { content: ""; width: 18px; height: 18px; background: #fff; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: transform .2s; }
    input[type="checkbox"]:checked::after { transform: translateX(18px); }

    select, button, input[type="button"] { font-family: inherit; font-size: 14px; }
    input[type="range"] { width: 100%; }

    .row { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin: 6px 0; }

    .alt { background: #1a1f3a; color: #e2e8f0; border: 1px solid #2a2f60; padding: 8px; border-radius: 6px; }

    .hidden { display: none; }

    .title { font-weight: bold; font-size: 14px; margin-bottom: 6px; }

    /* End overlay */
    #endOverlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,.8); color:#fff; display:none; align-items:center; justify-content:center; padding:20px; z-index: 20; }
    #endOverlay .panel { background:#0b0f1a; border-radius:12px; padding:20px; border:1px solid #2a2f60; max-width: 600px; text-align:center; }
    #endOverlay h2 { margin:0 0 8px; }

    /* Sparkles and ambient particles */
    .sparkle { position: absolute; width: 6px; height: 6px; border-radius: 50%; pointer-events: none; opacity: 0.95; animation: rise 1.8s ease-out forwards; z-index: 2; }
    @keyframes rise { 0% { transform: translateY(0) scale(1); opacity: 0.95; } 100% { transform: translateY(-60px) translateX(var(--dx, 0px)) scale(0.6); opacity: 0; } }

    .aura { position: absolute; width: 120px; height: 120px; border-radius: 50%; left: -60px; top: -60px; pointer-events: none; filter: blur(6px); opacity: .25; z-index:0; }

    /* End of enhancements badge */
    .badge { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,.35); color:#fff; padding:6px 8px; border-radius: 6px; font-size: 11px; }

  </style>
</head>
<body>
  <div id="wrap">
    <aside id="leftPane" class="section" aria-label="Privacy and difficulty">
      <div class="title">Privacy & Safety</div>
      <div class="row" style="align-items:center;">
        <span>Mind Reading</span>
        <label class="switch">
          <input type="checkbox" id="globalConsent" checked>
          <span></span>
        </label>
      </div>
      <div class="card" style="margin-top:6px;">
        <strong>Consent per character</strong>
        <div id="consentList" style="margin-top:6px;">
          <!-- dynamically filled -->
        </div>
      </div>

      <div class="card" style="margin-top:8px;">
        <div class="row">
          <span>Subtitles</span>
          <label class="switch">
            <input type="checkbox" id="subtitles" checked>
            <span></span>
          </label>
        </div>
      </div>

      <div class="card" style="margin-top:8px;">
        <div class="row">
          <span>Difficulty</span>
          <select id="difficulty">
            <option value="easy">Easy</option>
            <option value="normal" selected>Normal</option>
            <option value="hard">Hard</option>
          </select>
        </div>
        <div style="font-size:12px; color:#cbd5e1; margin-top:6px;">
          Easy: slower mood drift, fewer misreads. Hard: quicker drift, more misreads.
        </div>
      </div>

      <div class="card" id="advancedCard" style="margin-top:8px;">
        <div class="title" style="margin-bottom:6px;">Advanced Options</div>
        <div class="row" style="align-items:center; gap:8px;">
          <span>Visual Intensity</span>
          <input type="range" id="visIntensity" min="0" max="100" value="60" />
        </div>
        <div class="row" style="align-items:center; gap:8px;">
          <span>Interaction Radius</span>
          <input type="range" id="radius" min="40" max="200" value="135" />
        </div>
        <div class="row" style="align-items:center; gap:8px;">
          <span>Auto Dialogue</span>
          <label class="switch">
            <input type="checkbox" id="autoDialogue" checked>
            <span></span>
          </label>
        </div>
        <div class="row" style="align-items:center; gap:8px;">
          <span>Ambient Sparks</span>
          <label class="switch">
            <input type="checkbox" id="sparks" checked>
            <span></span>
          </label>
        </div>
      </div>

      <button id="endGame" class="btn" style="width:100%; margin-top:6px;">End Game / See Ending</button>
    </aside>

    <section id="centerPane" aria-label="Game area">
      <div id="gameArea" tabindex="0" aria-label="Game board">
        <div class="grid"></div>
        <div id="player" class="player" title="You"></div>
        <!-- Characters -->
        <div id="ava" class="char" style="background:#7c3aed; z-index:4" title="Ava the coder"><div class="name">Ava</div><div class="tag" style="background: #34d399;"></div><div class="aura" style="background: radial-gradient(circle at center, rgba(124,58,237,.7), transparent 60%);"></div></div>
        <div id="kai" class="char" style="background:#f59e0b; z-index:4" title="Kai the musician"><div class="name">Kai</div><div class="tag" style="background: #34d399;"></div><div class="aura" style="background: radial-gradient(circle at center, rgba(245,158,11,.7), transparent 60%);"></div></div>
        <div id="mira" class="char" style="background:#e11d48; z-index:4" title="Mira the scientist"><div class="name">Mira</div><div class="tag" style="background: #34d399;"></div><div class="aura" style="background: radial-gradient(circle at center, rgba(225,29,72,.7), transparent 60%);"></div></div>

        <div id="dialogue" aria-label="Dialogue window">
          <h4 id="dialogueName"></h4>
          <p id="dialogueText"></p>
          <div class="options" id="dialogueOptions"></div>
          <div id="subtitle" aria-live="polite"></div>
        </div>

        <!-- ambient sparkles container -->
        <div id="sparkleLayer" aria-hidden="true" style="position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none;"></div>

      </div>
      <div class="badge" id="hintBadge" style="opacity:.9; display:none;">Hold E near a character to talk</div>
    </section>

    <aside id="rightPane" class="section" aria-label="Thoughts">
      <div class="title">Mind-Reading HUD</div>
      <div id="readingArea"></div>
      <div class="card" style="margin-top:8px;">
        <div class="row">
          <span>Notes</span>
          <span id="notesCount" style="font-variant-numeric: tabular-nums;">0</span>
        </div>
        <div id="notes" style="font-size:12px; color:#cbd5e1; margin-top:6px;">Listen to subtle cues. Misreads may occur on Hard mode.</div>
      </div>
    </aside>
  </div>

  <div id="endOverlay" role="dialog" aria-label="Ending">
    <div class="panel">
      <h2>Ending Preview</h2>
      <p id="endingText" style="font-size:14px; line-height:1.4;"></p>
      <button class="btn" id="restart" style="margin-top:8px;">Restart</button>
    </div>
  </div>

<script>
(function(){
  // Core state
  const r = Math.max;
  // Extended world: characters with more nuanced mood and drift
  const chars = [
    { id: 'ava', name: 'Ava', color: '#7c3aed',
      pos: {x: 140, y: 120}, consent: true,
      mood: { trust: 40, joy: 60, anxiety: 20 }, drift: {trust: 0, joy: 0, anxiety: 0},
      lastThought: '', thoughts: '' },
    { id: 'kai', name: 'Kai', color: '#f59e0b',
      pos: {x: 420, y: 170}, consent: true,
      mood: { trust: 60, joy: 40, anxiety: 40 }, drift: {trust: 0, joy: 0, anxiety: 0},
      lastThought: '', thoughts: '' },
    { id: 'mira', name: 'Mira', color: '#e11d48',
      pos: {x: 260, y: 340}, consent: true,
      mood: { trust: 50, joy: 30, anxiety: 60 }, drift: {trust: 0, joy: 0, anxiety: 0},
      lastThought: '', thoughts: '' }
  ];

  const player = { x: 260, y: 260, speed: 6 };
  let globalConsent = true;
  let subtitlesOn = true;
  let difficulty = 'normal';
  let misreadProb = { easy: 0.05, normal: 0.15, hard: 0.28 };
  let autoDialogue = true;
  let visIntensity = 60;
  let interactionRadius = 135;
  let sparksEnabled = true;

  // DOM refs
  const gameArea = document.getElementById('gameArea');
  const playerEl = document.getElementById('player');
  const avaEl = document.getElementById('ava');
  const kaiEl = document.getElementById('kai');
  const miraEl = document.getElementById('mira');
  const readingArea = document.getElementById('readingArea');
  const consentList = document.getElementById('consentList');
  const globalConsentEl = document.getElementById('globalConsent');
  const dialogueEl = document.getElementById('dialogue');
  const dialogueName = document.getElementById('dialogueName');
  const dialogueText = document.getElementById('dialogueText');
  const dialogueOptions = document.getElementById('dialogueOptions');
  const endOverlay = document.getElementById('endOverlay');
  const endingText = document.getElementById('endingText');
  const restartBtn = document.getElementById('restart');
  const endGameBtn = document.getElementById('endGame');
  const subtitlesEl = document.getElementById('subtitle');
  const notesEl = document.getElementById('notes');
  const notesCountEl = document.getElementById('notesCount');
  const difficultyEl = document.getElementById('difficulty');
  const advancedCard = document.getElementById('advancedCard');
  const visIntensityEl = document.getElementById('visIntensity');
  const radiusEl = document.getElementById('radius');
  const autoDialogueEl = document.getElementById('autoDialogue');
  const sparksEl = document.getElementById('sparks');
  const hintBadge = document.getElementById('hintBadge');
  const sparkleLayer = document.getElementById('sparkleLayer');
  const sparkleLayerContainer = sparkleLayer; // alias

  // Helpers
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.sqrt(dx*dx+dy*dy); }

  // Init consent list
  function renderConsentList(){
    consentList.innerHTML = '';
    chars.forEach((c,i)=>{
      const d = document.createElement('div');
      d.className = 'row';
      d.style.alignItems = 'center';
      d.style.justifyContent = 'space-between';
      d.style.padding = '6px 0';
      d.style.borderBottom = '1px dashed rgba(255,255,255,.08)';

      const label = document.createElement('span');
      label.textContent = c.name;
      label.style.color = '#e8eaf6';

      const ctrl = document.createElement('label');
      ctrl.className = 'switch';
      ctrl.innerHTML = '<input type="checkbox" id="consent_'+c.id+'\" '+(c.consent?'checked':'')+'>';
      // Fix innerHTML escaping glitch
      ctrl.innerHTML = '<input type="checkbox" id="consent_'+c.id+'\"" '+(c.consent?'checked':'')+'>';
      const cb = ctrl.querySelector('input');
      cb.addEventListener('change', (e)=>{
        c.consent = e.target.checked;
      });

      d.appendChild(label);
      d.appendChild(ctrl);
      consentList.appendChild(d);
    });
  }

  // Initialize
  function init(){
    renderConsentList();
    renderCharacters(true);
  }

  // Mood-to-color helper
  function moodToColor(mood){
    const {trust, joy, anxiety} = mood;
    if(trust>=joy && trust>=anxiety) return '#34d399';
    if(joy>=trust && joy>=anxiety) return '#f472b6';
    return '#f59e0b';
  }

  // Reading logic
  function getThoughtForChar(c){
    const base = [];
    const {trust, joy, anxiety} = c.mood;
    if(anxiety>60){
      base.push("Worried about the deadline.");
      base.push("I feel pressured and tense.");
    } else if(trust>60){
      base.push("I trust this collaboration.");
      base.push("This feels like a good team moment.");
    }  else if(joy>50){
      base.push("I'm enjoying this conversation.");
      base.push("There's positive energy here.");
    } else {
      base.push("I'm thinking this could go either way.");
      base.push("I'm keeping my guard up.");
    }
    const text = base[Math.floor(Math.random()*base.length)];
    const reading = shouldMisread() ? misreadOf(text) : text;
    c.lastThought = text;
    c.thoughts = reading;
    return reading;
  }

  function misreadOf(t){
    const twists = [
      "The vibe says we're on the same page.",
      "I might be misreading the tension.",
      "Perhaps I’m projecting confidence where there is doubt.",
      "Their silence could mean agreement, or it could be caution."
    ];
    return twists[Math.floor(Math.random()*twists.length)];
  }

  function shouldMisread(){
    const p = misreadProb[difficulty] || 0.15;
    return Math.random() < p;
  }

  // Reading UI
  function updateReadingUI(){
    if(!globalConsent) {
      readingArea.innerHTML = '';
      notesEl.textContent = "Mind reading disabled.";
      notesCountEl.textContent = 0;
      return;
    }
    readingArea.innerHTML = '';
    let count = 0;
    const rad = interactionRadius;

    chars.forEach((c)=>{
      const inRange = globalConsent && c.consent && dist(player, c.pos) <= rad;
      if(inRange){
        const el = document.createElement('div');
        el.className = 'card';
        el.style.border = '1px solid rgba(255,255,255,.15)';
        el.style.background = 'rgba(10,12,28,.92)';
        el.style.padding = '8px';
        el.style.marginBottom = '8px';
        el.style.display = 'flex';
        el.style.flexDirection = 'column';
        el.style.gap = '6px';
        el.style.minWidth = '240px';
        el.style.maxWidth = '280px';

        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.justifyContent = 'space-between';
        header.style.alignItems = 'center';
        header.innerHTML = `<strong style="font-size:12px; color:#e8eaf6;">${c.name}</strong><span style="font-size:12px; color:#93c5fd;">In range</span>`;
        el.appendChild(header);

        const moodPill = document.createElement('div');
        moodPill.style.fontSize = '12px';
        moodPill.style.color = '#e5e7eb';
        const {trust, joy, anxiety} = c.mood;
        const predominant = (trust>=joy && trust>=anxiety) ? 'trust' : (joy>=trust && joy>=anxiety) ? 'joy' : 'anxiety';
        moodPill.textContent = `Mood: Trust ${Math.round(trust)} • Joy ${Math.round(joy)} • Anxiety ${Math.round(anxiety)} (${predominant})`;
        el.appendChild(moodPill);

        const cue = document.createElement('div');
        cue.style.width = '12px'; cue.style.height = '12px';
        cue.style.borderRadius = '50%';
        cue.style.alignSelf = 'flex-start';
        cue.style.background = moodToColor(c.mood);
        el.appendChild(cue);

        const thought = document.createElement('div');
        thought.style.fontSize = '12px';
        thought.style.color = '#e8e9f2';
        thought.style.minHeight = '22px';
        const reading = getThoughtForChar(c);
        thought.textContent = reading;
        el.appendChild(thought);

        readingArea.appendChild(el);
        count++;
      }
    });
    notesEl.textContent = "Real-time readings update with proximity. Misreads vary by difficulty.";
    notesCountEl.textContent = count;
  }

  // Update character visuals
  function renderCharacters(force=false){
    // player
    playerEl.style.left = player.x + 'px';
    playerEl.style.top = player.y + 'px';

    // characters
    const map = { ava: avaEl, kai: kaiEl, mira: miraEl };
    chars.forEach(ch => {
      const el = map[ch.id];
      el.style.left = ch.pos.x + 'px';
      el.style.top = ch.pos.y + 'px';
      const inRange = globalConsent && ch.consent && dist(player, ch.pos) <= interactionRadius;
      if(inRange){
        el.style.filter = 'saturate(1.4) brightness(1.05)';
        if(!el._ring){
          const ring = document.createElement('div');
          ring.style.position = 'absolute';
          ring.style.width = '140px';
          ring.style.height = '140px';
          ring.style.borderRadius = '50%';
          ring.style.border = '2px solid rgba(123,211,137,.6)';
          ring.style.left = '-56px';
          ring.style.top = '-56px';
          ring.style.pointerEvents = 'none';
          ring.style.boxShadow = '0 0 12px rgba(123,211,137,.6)';
          el.appendChild(ring);
          el._ring = ring;
        }
      } else {
        el.style.filter = 'saturate(1)';
        if(el._ring){
          el.removeChild(el._ring);
          el._ring = null;
        }
      }
    });

    // ambient sparks maybe
    if(sparksEnabled && Math.random() < 0.15){
      spawnAmbientSpark(player.x + (Math.random()*80-40), player.y + (Math.random()*80-40), '#7bd389');
    }
  }

  // Ambient spark generation
  function spawnAmbientSpark(x, y, color){
    const spark = document.createElement('div');
    spark.className = 'sparkle';
    spark.style.left = (x) + 'px';
    spark.style.top = (y) + 'px';
    spark.style.background = color;
    spark.style.setProperty('--dx', (Math.random()*40-20) + 'px');
    sparkleLayer.appendChild(spark);
    spark.addEventListener('animationend', ()=> spark.remove());
  }

  // Dialogue system
  function nearCharacter(){
    let nearest = null, best = 999;
    chars.forEach(c=>{
      const d = dist(player, c.pos);
      if(d < best && d <= interactionRadius && c.consent && globalConsent){
        best = d;
        nearest = c;
      }
    });
    return nearest;
  }

  function openDialogue(target){
    if(!target) return;
    dialogueEl.style.display = 'block';
    dialogueName.textContent = target.name;
    if(subtitlesOn){
      subtitlesEl.textContent = target.name + ' is speaking...';
    } else {
      subtitlesEl.textContent = '';
    }

    const opts = [];
    opts.push({id:'o1', text: 'Compliment your work', delta: { trust: 6 + Math.round(target.mood.joy*0.05), joy: 2 }});
    opts.push({id:'o2', text: 'Ask about concerns', delta: { trust: 2 + Math.round((100-target.mood.anxiety)*0.04), anxiety: -2 }});
    opts.push({id:'o3', text: 'Push for a deadline', delta: { trust: -4, anxiety: 4 }});
    if(target.mood.trust < 40){
      opts.push({id:'o4', text: 'Reassure them about support', delta: { trust: +8, anxiety: -2 }});
    }
    if(target.mood.anxiety > 60){
      opts.push({id:'o5', text: 'Give them space and time', delta: { trust: +6, anxiety: -4 }});
    }

    dialogueOptions.innerHTML = '';
    opts.forEach(o=>{
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = o.text;
      btn.addEventListener('click', ()=>{
        applyDialogueEffect(target, o.delta);
        closeDialogueWithNote(target, o.text);
      });
      dialogueOptions.appendChild(btn);
    });
  }

  function closeDialogueWithNote(target, optionText){
    const note = document.createElement('div');
    note.style.fontSize = '12px';
    note.style.color = '#cbd5e1';
    note.style.marginTop = '6px';
    note.textContent = `You chose: "${optionText}". They respond based on their inner state.`;
    dialogueText.textContent = note.textContent;
  }

  function applyDialogueEffect(target, delta){
    if(delta.trust){
      target.mood.trust = clamp(target.mood.trust + delta.trust, 0, 100);
    }
    if(delta.joy){
      target.mood.joy = clamp(target.mood.joy + delta.joy, 0, 100);
    }
    if(delta.anxiety){
      target.mood.anxiety = clamp(target.mood.anxiety + delta.anxiety, 0, 100);
    }
    const lines = [
      "Interesting perspective. I appreciate the clarity.",
      "That makes sense. I'm feeling more confident.",
      "I'll need to think about it, but I trust your instincts.",
      "I still have some concerns, but this helps."
    ];
    const line = lines[Math.floor(Math.random()*lines.length)];
    if(subtitlesOn){
      dialogueText.textContent = line;
    } else {
      dialogueText.textContent = '';
    }
    renderCharacters();
    updateReadingUI();
  }

  // Endings
  function computeEnding(){
    const avgTrust = (chars[0].mood.trust + chars[1].mood.trust + chars[2].mood.trust) / 3;
    const avgJoy = (chars[0].mood.joy + chars[1].mood.joy + chars[2].mood.joy) / 3;
    const misreads = Math.round((difficulty==='easy'?0:1) + (difficulty==='hard'?2:0) + Math.random()*1);
    let ending = '';
    if(avgTrust > 65 && avgJoy > 50){
      ending = 'VibeMind triumphant: a trusted web of allies. You’ve formed strong alliances with Ava, Kai, and Mira.';
    } else if(avgTrust > 40){
      ending = 'Partial harmony: some trust remains, but you may need to refine your approach to win everyone over.';
    } else {
      ending = 'Tenuous alliances: misreads and missteps have eroded trust. The path forward is uncertain.';
    }
    ending += ` (Estimated misreads: ${misreads})`;
    return ending;
  }

  function showEnding(){
    endOverlay.style.display = 'flex';
    endingText.textContent = computeEnding();
  }

  // End game controls
  endGameBtn.addEventListener('click', showEnding);
  restartBtn.addEventListener('click', ()=>{
    location.reload();
  });

  // UI toggles
  window.addEventListener('keydown', (e)=>{
    if(e.key.toLowerCase() === 'e'){
      const near = nearCharacter();
      if(near){
        openDialogue(near);
      }
    }
  });

  // Movement
  const keys = {};
  window.addEventListener('keydown', (e)=>{
    if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','w','a','s','d'].includes(e.key)){
      e.preventDefault();
    }
    keys[e.key] = true;
  });
  window.addEventListener('keyup', (e)=>{ keys[e.key] = false; });

  function movePlayer(){
    let moved = false;
    if(keys.ArrowLeft || keys.a){ player.x -= player.speed; moved = true; }
    if(keys.ArrowRight || keys.d){ player.x += player.speed; moved = true; }
    if(keys.ArrowUp || keys.w){ player.y -= player.speed; moved = true; }
    if(keys.ArrowDown || keys.s){ player.y += player.speed; moved = true; }
    player.x = clamp(player.x, 20, 620);
    player.y = clamp(player.y, 20, 420);
    if(moved){
      renderCharacters();
    }
  }

  // Ambient handlers
  function loop(){
    const now = Date.now();
    // mood drift
    updateMoodDrift(0.016);
    // maybe spawn ambient sparkles
    if(sparksEnabled){
      if(Math.random() < 0.8) {
        const angle = Math.random()*Math.PI*2;
        const r = 120 + Math.random()*120;
        const x = player.x + Math.cos(angle)*r;
        const y = player.y + Math.sin(angle)*r;
        spawnAmbientSpark(x, y, '#7bd389');
      }
    }
    updateReadingUI();
    moveStep();
    requestAnimationFrame(loop);
  }

  function moveStep(){
    movePlayer();
    renderCharacters();
  }

  function updateMoodDrift(dt){
    if(!globalConsent) return;
    const rad = interactionRadius;
    chars.forEach((c)=>{
      const inRange = dist(player, c.pos) <= rad && c.consent && globalConsent;
      if(inRange){
        const driftAmt = (difficulty==='easy') ? 0.8 : (difficulty==='normal') ? 1.2 : 2.0;
        c.mood.trust = clamp(c.mood.trust + (Math.random()-0.5)*driftAmt, 0, 100);
        c.mood.joy = clamp(c.mood.joy + (Math.random()-0.5)*driftAmt, 0, 100);
        c.mood.anxiety = clamp(c.mood.anxiety + (Math.random()-0.5)*driftAmt, 0, 100);
      }
    });
  }

  // End overlay close
  endOverlay.addEventListener('click', (ev)=>{ if(ev.target.id === 'endOverlay'){ endOverlay.style.display='none'; } });

  // UI: global consent toggle
  globalConsentEl.addEventListener('change', (e)=>{
    globalConsent = e.target.checked;
    renderCharacters();
    updateReadingUI();
  });

  // Difficulty and advanced options
  difficultyEl.addEventListener('change', (e)=>{
    difficulty = e.target.value;
    misreadProb = { easy: 0.05, normal: 0.15, hard: 0.28 };
    updateReadingUI();
  });

  visIntensity = parseInt(localStorage.getItem('vibe_vis') || visIntensity, 10);
  if(!isNaN(visIntensity)){
    visIntensity = Math.max(0, Math.min(100, visIntensity));
  }

  // Advanced controls bindings
  visIntensityEl.addEventListener('input', (e)=>{
    visIntensity = parseInt(e.target.value,10);
    localStorage.setItem('vibe_vis', visIntensity);
    // impact: alter aura glow and spark speed
    const auras = document.querySelectorAll('.aura');
    auras.forEach(a => {
      a.style.opacity = (0.15 + visIntensity/900).toFixed(2);
    });
  });

  radiusEl.addEventListener('input', (e)=>{
    interactionRadius = parseInt(e.target.value,10);
    localStorage.setItem('vibe_radius', interactionRadius);
    hintBadge.style.display = 'block';
    setTimeout(()=>hintBadge.style.display='none', 1500);
  });

  autoDialogueEl && autoDialogueEl.addEventListener('change', (e)=>{ autoDialogue = e.target.checked; });

  sparksEl.addEventListener('change', (e)=>{ sparksEnabled = e.target.checked; });

  // Initial
  init();
  renderCharacters(true);
  updateReadingUI();
  setInterval(updateReadingUI, 600);
  requestAnimationFrame(loop);

  // End overlay close on outside click
  endOverlay.addEventListener('click', (ev)=>{
    if(ev.target.id === 'endOverlay'){ endOverlay.style.display='none'; }
  });

  // Accessibility: Space to pause (toggle override)
  let paused = false;
  window.addEventListener('keydown', (e)=>{
    if(e.code === 'Space'){
      paused = !paused;
      if(paused){
        // freeze
      } else {
        requestAnimationFrame(loop);
      }
    }
  });

  // End overlay restart
  document.getElementById('restart').addEventListener('click', ()=> location.reload());

  // Final tweaks: show hint when near a character
  setInterval(()=> {
    const near = nearCharacter();
    if(near){
      hintBadge.style.display = 'block';
      hintBadge.textContent = `Press E to talk to ${near.name}`;
    } else {
      hintBadge.style.display = 'none';
    }
  }, 500);

  // Initial positions and ambient
  renderCharacters(true);
})();
</script>
</body>
</html>