<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mattf License Tycoon: Got It Button Edition - Deluxe</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #141a2b;
      --text: #f5f7ff;
      --muted: #a6b3d8;
      --accent: #4cc9f0;
      --green: #38f0a0;
      --red: #ff5c7d;
      --shadow: 0 12px 28px rgba(0,0,0,.25);
      --radius: 14px;
      --chip: #1f2a44;
      --chipText: #dbeafe;
      --high: #f8fafc;
      --highText: #0b1020;
      --coin: #ffd84d;
    }
    .high-contrast {
      --bg: #000;
      --card: #111;
      --text: #fff;
      --muted: #ddd;
      --accent: #10b981;
      --chip: #333;
      --shadow: 0 6px 16px rgba(0,0,0,.8);
      --cc: #fff;
    }
    @keyframes floaty {
      0% { transform: translateY(0px) translateX(0); }
      50% { transform: translateY(-8px) translateX(4px); }
      100% { transform: translateY(0px) translateX(0); }
    }
    @keyframes pop {
      0% { transform: scale(0.6); opacity: 0; }
      60% { transform: scale(1.15); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    @keyframes coin {
      from { transform: translateY(0) translateX(0); opacity: 1; }
      to { transform: translateY(-40px) translateX(60px); opacity: 0; }
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(circle at 20% -10%, rgba(68, 76, 235, .15), transparent 40%), linear-gradient(#0b1020, #0a0f1d 40%, #0a0f1d);
      color: var(--text);
      overflow-x: hidden;
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 20px; }

    .scene { display: none; min-height: 100vh; padding: 20px 0; align-items: stretch; }
    .scene.active { display: flex; flex-direction: column; }

    .card {
      background: linear-gradient(#141a2b, #0f1624);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      border: 1px solid rgba(255,255,255,.05);
    }

    h1, h2 { margin: 0 0 12px; }
    p { margin: 8px 0; color: var(--muted); }

    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

    .btn { appearance: none; border: 0; padding: 12px 16px; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 14px;
      transition: transform .1s ease, background-color .2s ease; }
    .btn:active { transform: scale(.98); }
    .btn-primary { background: #4cc9f0; color: #051222; }
    .btn-secondary { background: #1e2a44; color: #dbeafe; }
    .btn-success { background: #22c55e; color: white; }
    .btn-danger { background: #f87171; color: white; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }

    .loader { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(0,0,0,.2); border-top-color: #fff; border-radius: 50%; margin-left: 8px; animation: spin 0.8s linear infinite; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .badge { display: inline-flex; align-items: center; padding: 6px 10px; border-radius: 999px; background: #2b3450; color: #eaf2ff; font-size: 12px; }

    .grid { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 16px; align-items: stretch; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .stat { padding: 12px; border-radius: 10px; background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); }
    .stat .label { font-size: 12px; color: var(--muted); }
    .stat .value { font-size: 20px; font-weight: 700; margin-top: 4px; }

    #overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.5); z-index: 40; padding: 16px; }
    #overlay.active { display: flex; }
    .tip { background: #0b1220; border-radius: 12px; padding: 16px; max-width: 680px; width: 100%; color: #e6eaff; box-shadow: var(--shadow); }
    .tip h3 { margin-top: 0; }

    /* Floating chips / visuals */
    .floating-chip { position: absolute; top: -20px; font-size: 22px; animation: floaty 4s ease-in-out infinite; opacity: .9; filter: drop-shadow(0 6px 6px rgba(0,0,0,.4)); }
    .floating-coin { position: absolute; width: 14px; height: 14px; background: radial-gradient(circle at 30% 30%, #fff 0%, #ffd24d 40%, #e6b400 80%); border-radius: 50%; animation: coin 1.8s ease-out forwards; pointer-events: none; }

    /* Scene elements for aesthetics */
    .header { display:flex; justify-content: space-between; align-items: center; padding: 6px 0 14px; }

    .money { font-family: ui-monospace,SFMono-Regular,Consolas,"Liberation Mono",monospace; font-weight: 800; }

    .backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; }

    .float-area { position: relative; height: 180px; }

    .live-region { position: fixed; left: -9999px; width: 1px; height: 1px; overflow: hidden; }

    /* High contrast focus ring */
    :focus-visible { outline: 3px solid #4cc9f0; outline-offset: 2px; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="live-region" aria-live="polite" id="live-region"></div>

  <div class="container header" style="position: relative;">
    <div style="display:flex; align-items:center; gap:12px;">
      <span style="font-size:22px; font-weight:800; letter-spacing:.5px;">Mattf License Tycoon</span>
      <span id="status-compact" class="badge" aria-label="Status badge" style="background:#2a2f66;">Ready</span>
    </div>
    <div class="float-area" style="width:320px; height:40px; position: relative;">
      <!-- Floating license icons -->
      <span class="floating-chip" style="left: 0; opacity:.9; animation-delay:0s;">üìú</span>
      <span class="floating-chip" style="left: 32px; animation-delay:.8s;">üéüÔ∏è</span>
      <span class="floating-chip" style="left: 64px; animation-delay:1.6s;">üßæ</span>
      <span class="floating-chip" style="left: 92px; animation-delay:2.2s;">üìÉ</span>
    </div>
  </div>

  <!-- License Terms Screen -->
  <section id="scene-license" class="scene active" aria-label="License Terms Screen" role="region" style="padding-top: 12px;">
    <div class="container" style="flex:1;">
      <div class="card" style="padding:20px; position:relative; overflow:hidden;">
        <div class="row" style="justify-content: space-between;">
          <h2 style="margin:0;">Mattf License Tycoon</h2>
          <span class="badge" aria-label="License edition badge">Got It Button Edition</span>
        </div>
        <hr style="border:none; height:1px; background:#2b3450; margin:12px 0;">
        <p style="flex:1;">
          Welcome to a modern tycoon twist. Read through the license terms, press Got It to proceed to the main menu, then start your licensing empire.
        </p>
        <div class="row" style="margin-top:10px;">
          <button id="btnGotIt" class="btn btn-primary" aria-label="Got It: accept terms and continue">
            Got It
          </button>
          <span id="gotItStatus" class="badge" style="visibility:hidden;" aria-live="polite"></span>
        </div>
      </div>
    </div>

    <!-- onboarding overlay/tutorial -->
    <div id="onboard" class="overlay" aria-label="Tutorial overlay" role="dialog">
      <div class="tip">
        <h3>Welcome to Mattf Tycoon!</h3>
        <p>This quick onboarding will guide you through the Got It flow. Click Got It to move to the main menu, then Start Game to begin.</p>
        <ul>
          <li>Got It on the license screen advances you to the main menu.</li>
          <li>From the main menu, press Start Game to load the simulation scene.</li>
          <li>Adjust price with the slider to influence demand and revenue. Upgrade wisely!</li>
        </ul>
        <div class="row" style="justify-content:flex-end;">
          <button id="overlayGotIt" class="btn btn-secondary" aria-label="Begin game after onboarding">Got It</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Menu -->
  <section id="scene-main-menu" class="scene" aria-label="Main Menu" role="region" style="padding-top:12px;">
    <div class="container" style="display:flex; flex-direction:column; gap:14px;">
      <div class="card" style="padding:20px;">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <h1 style="font-size:28px; margin:0;">Mattf License Tycoon</h1>
          <span class="badge" id="menu-status" aria-label="Status badge" style="background:#2a2f66;">Ready</span>
        </div>
        <p style="margin-top:6px;">Start building your licensing empire. Manage money, licenses, and upgrades to dominate the market.</p>
        <div class="row" style="gap:8px;">
          <button id="btnStartGame" class="btn btn-primary" aria-label="Start Game">Start Game</button>
          <button id="btnQuickSave" class="btn btn-secondary" aria-label="Quick Save">Quick Save</button>
          <button id="btnToggleContrast" class="btn btn-secondary" aria-label="Toggle high contrast mode">High Contrast</button>
          <span id="saveIndicator" class="badge" aria-live="polite" style="visibility:hidden;">Saved</span>
        </div>
      </div>

      <div class="grid" aria-label="Overview panels" style="gap:20px;">
        <!-- Left: Overview -->
        <div class="panel card" style="padding:16px;">
          <div class="row" style="justify-content:space-between;">
            <strong>Overview</strong>
            <span class="badge" id="sceneMainMenuMoney" aria-label="Money" style="font-weight:700;"></span>
          </div>
          <div class="stats" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; margin-top:8px;">
            <div class="stat" aria-label="Licenses owned">
              <div class="label">Licenses Owned</div>
              <div class="value" id="statLicenses">0</div>
            </div>
            <div class="stat" aria-label="Price per license">
              <div class="label">Current Price</div>
              <div class="value" id="statPrice">$0</div>
            </div>
            <div class="stat" aria-label="Demand level">
              <div class="label">Demand Level</div>
              <div class="value" id="statDemand">0%</div>
            </div>
            <div class="stat" aria-label="Marketing level">
              <div class="label">Marketing Level</div>
              <div class="value" id="statMarketing">0</div>
            </div>
          </div>
        </div>

        <!-- Right: Milestones and Autosave -->
        <div class="panel card" style="padding:16px;">
          <strong>Milestones & Autosave</strong>
          <p style="color:var(--muted); margin:6px 0 0;">Autosave activates when you hit key monetary milestones.</p>
          <ul id="milestoneList" style="margin:8px 0 0; padding-left:18px;">
            <li>1000, 10000, 100000 credits autosave automatically</li>
          </ul>
          <div class="row" style="margin-top:8px;">
            <span class="badge" aria-label="Autosave status" id="milestonesStatus">Autosave: Off</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Game Screen -->
  <section id="scene-game" class="scene" aria-label="Game Screen" role="region" style="padding-top:12px;">
    <div class="container" style="display:flex; flex-direction:column; gap:14px;">
      <div class="card" style="padding:16px;">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <h2 style="margin:0;">License Tycoon Arena</h2>
          <span class="badge" id="moneyBadge" aria-label="Money" style="font-weight:800;">Money: $0</span>
        </div>

        <div class="grid" style="gap:14px; align-items:stretch; margin-top:8px;">
          <!-- Left: Market -->
          <div class="panel card" style="padding:16px;">
            <div class="row" style="justify-content:space-between; align-items:center;">
              <strong>Market & Stock</strong>
              <span class="badge" id="sceneGameLicenses" aria-label="Licenses">Licenses: 0</span>
            </div>

            <div class="stat" style="margin-top:8px;">
              <div class="label">Price per License</div>
              <div class="value" id="sceneGamePrice">$0</div>
            </div>

            <div class="stat" style="margin-top:8px;">
              <div class="label">Demand</div>
              <div style="width:100%; height:10px; background:#1f2a44; border-radius:6px; overflow:hidden;">
                <div id="demandBar" style="width:0%; height:100%; background:#10b981;"></div>
              </div>
            </div>

            <div class="stat" style="margin-top:8px;">
              <div class="label">Estimated Revenue per Tick</div>
              <div class="value" id="sceneGameRev">$0</div>
            </div>

            <div class="row" style="margin-top:6px;">
              <span class="badge" aria-label="Upgrades count" id="sceneUpgradesLabel">Upgrades: 0</span>
            </div>
          </div>

          <!-- Right: Actions -->
          <div class="panel card" style="padding:16px; min-width: 280px;">
            <strong>Actions</strong>
            <div class="row" style="margin-top:6px; align-items:center;">
              <button id="btnAcquire" class="btn btn-success" aria-label="Acquire License">Acquire License</button>
              <span class="badge" id="licenseCostLabel" aria-label="License cost">Cost: $0</span>
            </div>

            <div class="row" style="margin-top:8px; align-items:center;">
              <span class="label" style="font-size:12px; color:var(--muted);">Price</span>
            </div>
            <div class="row" aria-label="Price slider">
              <input id="priceSlider" type="range" min="5" max="40" step="1" value="10" aria-label="Price per license" />
              <span class="badge" id="priceValue" aria-label="Current price">$10</span>
            </div>

            <hr style="border:none; height:1px; background:#2b3450; margin:10px 0;">

            <strong>Upgrades</strong>
            <div class="row" style="gap:8px; flex-wrap:wrap;">
              <button id="upgradeMarketing" class="btn btn-secondary" aria-label="Upgrade Marketing">Marketing Upgrade</button>
              <span class="badge" id="upgradeMarketingCost" aria-label="Marketing upgrade cost">$0</span>
            </div>
            <div class="row" style="gap:8px; margin-top:6px; flex-wrap:wrap;">
              <button id="upgradeAutomation" class="btn btn-secondary" aria-label="Upgrade Automation">Automation Upgrade</button>
              <span class="badge" id="upgradeAutomationCost" aria-label="Automation upgrade cost">$0</span>
            </div>
            <div class="row" style="gap:8px; margin-top:6px; flex-wrap:wrap;">
              <button id="upgradeBulk" class="btn btn-secondary" aria-label="Upgrade Bulk Licensing">Bulk Licensing Upgrade</button>
              <span class="badge" id="upgradeBulkCost" aria-label="Bulk upgrade cost">$0</span>
            </div>

            <hr style="border:none; height:1px; background:#2b3450; margin:10px 0;">

            <div class="row" style="gap:8px; flex-wrap:wrap;">
              <button id="btnPause" class="btn btn-secondary" aria-label="Pause/Resume game">Pause</button>
              <button id="btnSave" class="btn btn-secondary" aria-label="Manual Save">Save</button>
            </div>
          </div>
        </div>
      </div>

      <!-- bottom status -->
      <div class="card" style="padding:12px;">
        <div class="row" style="justify-content: space-between; align-items: center;">
          <div class="badge" aria-label="Milestones status" id="milestonesStatusBottom">Milestones: 0/3 saved</div>
          <div class="row" style="gap:8px;">
            <span class="badge" aria-label="Last save time" id="lastSave">Last Save: N/A</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Minimal audio: simple beep via Web Audio -->
  <script>
    // App state
    const STATE = {
      money: 0,
      licenses: 0,
      price: 10,
      upgrades: {
        marketing: 0,
        automation: 0,
        bulk: 0
      },
      playing: false,
      tickMsBase: 250,
      lastTs: 0,
      accumulator: 0, // ms
      licenseBaseCost: 50,
      milestones: [1000, 10000, 100000],
      savedMilestones: {},
      lastSaveTime: null,
      highContrast: false,
      sfx: true
    };

    // UI elements
    const sceneLicense = document.getElementById('scene-license');
    const sceneMainMenu = document.getElementById('scene-main-menu');
    const sceneGame = document.getElementById('scene-game');
    const liveRegion = document.getElementById('live-region');

    const btnGotIt = document.getElementById('btnGotIt');
    const onboard = document.getElementById('onboard');
    const overlayGotIt = document.getElementById('overlayGotIt');
    const btnStartGame = document.getElementById('btnStartGame');
    const btnQuickSave = document.getElementById('btnQuickSave');
    const btnToggleContrast = document.getElementById('btnToggleContrast');
    const menuStatus = document.getElementById('menu-status');
    const moneyBadge = document.getElementById('moneyBadge');
    const sceneMainMenuMoney = document.getElementById('sceneMainMenuMoney');
    const statLicenses = document.getElementById('statLicenses');
    const statPrice = document.getElementById('statPrice');
    const statDemand = document.getElementById('statDemand');
    const statMarketing = document.getElementById('statMarketing');
    const milestoneList = document.getElementById('milestoneList');
    const milestonesStatus = document.getElementById('milestonesStatus');
    const milestonesStatusBottom = document.getElementById('milestonesStatusBottom');
    const lastSave = document.getElementById('lastSave');
    const saveIndicator = document.getElementById('saveIndicator');

    // Game scene elements
    const sceneGameLicenses = document.getElementById('sceneGameLicenses');
    const sceneGamePrice = document.getElementById('sceneGamePrice');
    const demandBar = document.getElementById('demandBar');
    const sceneGameRev = document.getElementById('sceneGameRev');
    const btnAcquire = document.getElementById('btnAcquire');
    const licenseCostLabel = document.getElementById('licenseCostLabel');
    const priceSlider = document.getElementById('priceSlider');
    const priceValue = document.getElementById('priceValue');
    const upgradeMarketing = document.getElementById('upgradeMarketing');
    const upgradeMarketingCost = document.getElementById('upgradeMarketingCost');
    const upgradeAutomation = document.getElementById('upgradeAutomation');
    const upgradeAutomationCost = document.getElementById('upgradeAutomationCost');
    const upgradeBulk = document.getElementById('upgradeBulk');
    const upgradeBulkCost = document.getElementById('upgradeBulkCost');
    const btnPause = document.getElementById('btnPause');
    const btnSave = document.getElementById('btnSave');
    const milestonesStatusBottomEl = document.getElementById('milestonesStatusBottom');
    const lastSaveGame = lastSave;

    // Game loop helpers
    let tickIntervalActive = null;
    let lastTs = performance.now();
    let paused = false;

    // Visual particle container (within game area)
    const sceneGameContainer = document.querySelector('#scene-game .container');
    function spawnCoinFx(x, y, amount) {
      // create a few coin particles rising from (x,y) near the left panel
      for (let i = 0; i < 6; i++) {
        const el = document.createElement('div');
        el.className = 'floating-coin';
        el.style.left = (x + Math.random() * 120) + 'px';
        el.style.top = (y + Math.random() * 40) + 'px';
        el.style.opacity = '0.9';
        el.style.animationDuration = (1.2 + Math.random() * 0.6) + 's';
        sceneGameContainer.appendChild(el);
        // auto remove
        setTimeout(() => el.remove(), 1800);
      }
    }

    // Helpers
    function moneyFormat(n) {
      return '$' + (n < 1e6 ? Math.floor(n).toLocaleString() : (n / 1e6).toFixed(2) + 'M');
    }

    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

    // Compute demand from price
    function computeDemand() {
      const minP = 5, maxP = 40;
      const p = STATE.price;
      let t = 1 - (p - minP) / (maxP - minP);
      t = clamp(t, 0, 1);
      // small seasonal wiggle
      const season = 0.05 * Math.sin(performance.now() / 1000);
      return clamp(t + season, 0, 1);
    }

    function computeLicenseCost() {
      // Exponential price per license
      const base = STATE.licenseBaseCost;
      const c = base * Math.pow(1.15, STATE.licenses);
      // apply bulk discount-ish? We'll keep simple
      return Math.ceil(c);
    }

    function updateUI() {
      // main menu
      sceneMainMenuMoney.textContent = moneyFormat(STATE.money);
      statLicenses.textContent = STATE.licenses;
      statPrice.textContent = '$' + STATE.price.toFixed(0);
      const demand = computeDemand();
      statDemand.textContent = Math.round(demand * 100) + '%';
      statMarketing.textContent = STATE.upgrades.marketing;

      // game scene
      sceneGameLicenses.textContent = 'Licenses: ' + STATE.licenses;
      sceneGamePrice.textContent = '$' + STATE.price.toFixed(0);
      const dPct = Math.round(demand * 100);
      demandBar.style.width = dPct + '%';
      // revenue per tick
      const revenueTick = STATE.licenses * STATE.price * (1 + STATE.upgrades.marketing * 0.25) * demand;
      sceneGameRev.textContent = '$' + Math.floor(revenueTick).toLocaleString();
      // upgrade costs
      upgradeMarketingCost.textContent = '$' + Math.round(200 * Math.pow(1.6, STATE.upgrades.marketing)).toLocaleString();
      upgradeAutomationCost.textContent = '$' + Math.round(300 * Math.pow(1.65, STATE.upgrades.automation)).toLocaleString();
      upgradeBulkCost.textContent = '$' + Math.round(500 * Math.pow(1.7, STATE.upgrades.bulk)).toLocaleString();
      licenseCostLabel.textContent = 'Cost: ' + moneyFormat(computeLicenseCost());
      priceValue.textContent = '$' + STATE.price.toFixed(0);
      moneyBadge.textContent = 'Money: ' + moneyFormat(STATE.money);
      sceneMainMenuMoney.textContent = moneyFormat(STATE.money);

      // milestones
      const savedCount = Object.values(STATE.savedMilestones).filter(v => v).length;
      milestonesStatus.textContent = `Milestones: ${savedCount}/${STATE.milestones.length} saved`;
      milestonesStatusBottom.textContent = `Milestones: ${savedCount}/${STATE.milestones.length} saved`;
      lastSave.textContent = STATE.lastSaveTime ? ('Last Save: ' + new Date(STATE.lastSaveTime).toLocaleTimeString()) : 'Last Save: N/A';
    }

    function saveGame() {
      const data = {
        money: STATE.money,
        licenses: STATE.licenses,
        price: STATE.price,
        upgrades: STATE.upgrades,
        lastSaveTime: Date.now(),
        version: 1
      };
      try {
        localStorage.setItem('licenseTycoonSave', JSON.stringify(data));
        STATE.lastSaveTime = data.lastSaveTime;
        lastSave.textContent = 'Last Save: ' + new Date(data.lastSaveTime).toLocaleTimeString();
        saveIndicator.style.visibility = 'visible';
        setTimeout(() => { saveIndicator.style.visibility = 'hidden'; }, 1000);
      } catch (e) { /* ignore */ }
    }

    function loadGame() {
      try {
        const raw = localStorage.getItem('licenseTycoonSave');
        if (raw) {
          const data = JSON.parse(raw);
          if (data && data.version === 1) {
            STATE.money = data.money;
            STATE.licenses = data.licenses;
            STATE.price = data.price;
            STATE.upgrades = data.upgrades;
            STATE.lastSaveTime = data.lastSaveTime;
            lastSave.textContent = 'Last Save: ' + new Date(STATE.lastSaveTime).toLocaleTimeString();
          }
        }
      } catch (e) { /* ignore */ }
    }

    // Onboarding overlay handlers
    btnGotIt.addEventListener('click', () => {
      btnGotIt.disabled = true;
      btnGotIt.textContent = 'Processing';
      const loader = document.createElement('span');
      loader.className = 'loader';
      btnGotIt.appendChild(loader);
      setTimeout(() => {
        btnGotIt.removeChild(loader);
        btnGotIt.textContent = 'Got It';
        showScene('menu');
        btnStartGame.focus();
        btnGotIt.disabled = false;
      }, 700);
    });

    overlayGotIt.addEventListener('click', () => {
      localStorage.setItem('mt_showed_onboard', '1');
      onboarding.style.display = 'none';
      // not hiding sceneLicense; handled by flow
    });

    // Scene toggling helper
    function showScene(target) {
      [sceneLicense, sceneMainMenu, sceneGame].forEach(s => s.classList.remove('active'));
      if (target === 'license') sceneLicense.classList.add('active');
      if (target === 'menu') sceneMainMenu.classList.add('active');
      if (target === 'game') sceneGame.classList.add('active');
      // Focus
      requestAnimationFrame(() => {
        if (target === 'menu') btnStartGame.focus();
        if (target === 'game') btnAcquire.focus();
      });
    }

    // Onboarding activation
    let onboarding = document.getElementById('onboard');
    function init() {
      const showed = localStorage.getItem('mt_showed_onboard');
      if (!showed) {
        onboarding.classList.add('active');
      } else {
        onboarding.classList.remove('active');
      }
      loadGame();
      showScene('license');
      updateUI();
      // accessibility: announce
      liveRegion.textContent = 'Welcome. Read license terms and press Got It to continue.';
    }

    // Tick loop with requestAnimationFrame
    function tick(dt) {
      if (paused) return;
      // recalc dynamic tick ms based on automation
      const tickMs = Math.max(60, STATE.tickMsBase * Math.pow(0.8, STATE.upgrades.automation));
      STATE.accumulator += dt;
      while (STATE.accumulator >= tickMs) {
        // revenue per tick
        const demand = computeDemand();
        const revenueTick = STATE.licenses * STATE.price * (1 + STATE.upgrades.marketing * 0.25) * demand;
        const moneyGain = Math.floor(revenueTick);
        if (moneyGain > 0) {
          STATE.money += moneyGain;
          // coin FX per event
          // spawn few coins from left side
          spawnCoinFx(40 + Math.random() * 60, 60 + Math.random() * 40, moneyGain);
        }
        STATE.accumulator -= tickMs;
        // autosave on milestones
        checkMilestones();
      }
      if (STATE.money !== STATE._prevMoney) {
        STATE._prevMoney = STATE.money;
        updateUI();
      }
      // update lastSaveTime hint
      updateUI();
      // screen reader hints
      liveRegion.textContent = `Money updated to ${moneyFormat(STATE.money.toFixed ? STATE.money.toFixed(0) : STATE.money)}`;
      requestAnimationFrame(loop);
    }

    function loop(now) {
      const dt = Math.max(0, now - (STATE._last || now));
      STATE._last = now;
      tick(dt);
    }

    // Milestones
    function checkMilestones() {
      STATE.milestones.forEach((m, idx) => {
        if (!STATE.savedMilestones[idx] && STATE.money >= m) {
          STATE.savedMilestones[idx] = true;
          saveIndicator.style.visibility = 'visible';
          setTimeout(() => saveIndicator.style.visibility = 'hidden', 1000);
          saveGame();
        }
      });
      const savedCount = Object.values(STATE.savedMilestones).filter(v => v).length;
      milestonesStatus.textContent = `Milestones: ${savedCount}/${STATE.milestones.length} saved`;
      milestonesStatusBottom.textContent = `Milestones: ${savedCount}/${STATE.milestones.length} saved`;
      // update UI
      updateUI();
    }

    // Actions
    function acquireLicense() {
      const cost = computeLicenseCost();
      const perClick = 1 + STATE.upgrades.bulk;
      if (STATE.money >= cost) {
        STATE.money -= cost;
        STATE.licenses += perClick;
        // visual burst
        spawnCoinFx(80, 110, cost);
        updateUI();
      } else {
        flashBtn(btnAcquire);
      }
    }

    function flashBtn(btn) {
      const orig = btn.style.backgroundColor;
      btn.style.backgroundColor = '#f87171';
      setTimeout(() => btn.style.backgroundColor = orig, 120);
    }

    function buyUpgrade(type) {
      let cost;
      if (type === 'marketing') {
        cost = Math.round(200 * Math.pow(1.6, STATE.upgrades.marketing));
        if (STATE.money >= cost) {
          STATE.money -= cost;
          STATE.upgrades.marketing += 1;
        }
      } else if (type === 'automation') {
        cost = Math.round(300 * Math.pow(1.65, STATE.upgrades.automation));
        if (STATE.money >= cost) {
          STATE.money -= cost;
          STATE.upgrades.automation += 1;
        }
      } else if (type === 'bulk') {
        cost = Math.round(500 * Math.pow(1.7, STATE.upgrades.bulk));
        if (STATE.money >= cost) {
          STATE.money -= cost;
          STATE.upgrades.bulk += 1;
        }
      }
      updateUI();
    }

    function togglePause() {
      paused = !paused;
      btnPause.textContent = paused ? 'Resume' : 'Pause';
    }

    function quickSave() {
      saveGame();
    }

    function toggleHighContrast() {
      STATE.highContrast = !STATE.highContrast;
      if (STATE.highContrast) {
        document.body.classList.add('high-contrast');
        btnToggleContrast.textContent = 'Normal Contrast';
        // apply accessible background tint
      } else {
        document.body.classList.remove('high-contrast');
        btnToggleContrast.textContent = 'High Contrast';
      }
      updateUI();
    }

    // Initialize
    function initUIBindings() {
      btnGotIt.addEventListener('click', () => {
        // handled above in HTML
      });
      overlayGotIt.addEventListener('click', () => {
        localStorage.setItem('mt_showed_onboard', '1');
        onboarding.style.display = 'none';
      });

      btnStartGame.addEventListener('click', () => {
        sceneGame.style.display = '';
        showScene('game');
        // start loop
        if (!STATE._loop) {
          STATE._loop = true;
          STATE._last = performance.now();
          // kickoff
          requestAnimationFrame(loop);
        }
        paused = false;
        btnAcquire.focus();
      });

      btnQuickSave.addEventListener('click', quickSave);
      btnToggleContrast.addEventListener('click', toggleHighContrast);

      btnAcquire.addEventListener('click', acquireLicense);
      priceSlider.addEventListener('input', (e) => {
        STATE.price = Number(e.target.value);
        priceValue.textContent = '$' + STATE.price.toFixed(0);
        updateUI();
      });

      upgradeMarketing.addEventListener('click', () => buyUpgrade('marketing'));
      upgradeAutomation.addEventListener('click', () => buyUpgrade('automation'));
      upgradeBulk.addEventListener('click', () => buyUpgrade('bulk'));

      btnPause.addEventListener('click', togglePause);
      btnSave.addEventListener('click', saveGame);

      // keyboard shortcuts
      btnAcquire.addEventListener('keydown', (e) => { if (e.key === 'Enter') acquireLicense(); });
      btnStartGame.addEventListener('keydown', (e) => { if (e.key === 'Enter') btnStartGame.click(); });

      // Init last
      STATE._prevMoney = STATE.money;
    }

    // Build UI update wrappers
    function moneyTickPreview() { /* reserved for future */ }

    // Scenes wiring
    function showLicenseOnFirstLoad() {
      // ensure onboarding overlay has an accessible initial message
      onboarding.style.display = 'flex';
      overlayGotIt.addEventListener('click', overlayGotIt);
    }

    // Init
    initUIBindings();
    init();
    // Build initial values
    updateUI();

    // Accessibility: live announcements on visibility change
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        liveRegion.textContent = `Money is ${moneyFormat(STATE.money)}. Licenses: ${STATE.licenses}.`;
      }
    });

    // Start with license screen
    function showSceneLicense() { showScene('license'); }
    // Expose some functions to global for debugging (optional)
    window.__state__ = STATE;
    window.__updateUI__ = updateUI;
  </script>

</body>
</html>