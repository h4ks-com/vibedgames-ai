<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Runa — Neon Orb Prototype</title>
  <style>
    :root{
      --bg:#000;
      --orb:#6d9ff7; /* custom blue */
      --input-bg: rgba(255,255,255,0.04);
      --glass: rgba(255,255,255,0.06);
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;overflow:hidden}
    .main-layout{display:grid;grid-template-rows:auto 1fr auto; height:100vh; position:relative;z-index:3}
    .stage{display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:100%;gap:20px;padding:24px;box-sizing:border-box;position:relative;z-index:3;pointer-events:auto}
    .canvas-wrap{position:fixed;top:0;left:0;width:100vw;height:100vh;background:transparent;z-index:0;pointer-events:none}
    canvas{display:block;width:100%;height:100%;background:transparent;filter:blur(12px)}

    .input-row{display:flex;gap:10px;align-items:center;width:min(780px,92vw);pointer-events:auto;justify-self:center;padding:0 24px}
    .text-input{flex:1;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:var(--input-bg);color:#eaf6ff;outline:none;font-size:16px;pointer-events:auto}
    .send{padding:12px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,#2bb1ff22,#3aa0ff22);color:#eaf6ff;cursor:pointer;pointer-events:auto}
    .label{font-size:13px;color:#9fdcff;margin-bottom:6px;text-align:center;grid-row:1;padding:24px 24px 0 24px;align-self:center}

    .small-note{font-size:12px;color:#7aaedb;text-align:center;margin-top:6px}
    
    /* Chat area styling */
    .chat-area{
      grid-row: 2;
      padding: 20px;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      gap: 16px;
      pointer-events: auto;
      position: relative;
      z-index: 2;
    }
    
    /* Message bubbles with enhanced glass effect */
    .message{
      max-width:45%;
      padding:16px 20px;
      border-radius:20px;
      font-size:13px;
      line-height:1.5;
      position:relative;
      backdrop-filter:blur(20px);
      -webkit-backdrop-filter:blur(20px);
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 8px 32px rgba(0,0,0,0.3), 
                 inset 0 1px 0 rgba(255,255,255,0.2),
                 0 1px 0 rgba(255,255,255,0.1);
      word-wrap:break-word;
      animation:messageSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      pointer-events:auto;
    }
    
    @keyframes messageSlideIn {
      from { opacity: 0; transform: translateY(20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    .message.user{
      background:linear-gradient(135deg, rgba(57,176,255,0.2), rgba(57,176,255,0.1));
      color:#eaf6ff;
      align-self:flex-end;
      margin-left:auto;
      border-color:rgba(57,176,255,0.4);
    }
    
    .message.user::before{
      content:'';
      position:absolute;
      top:16px;
      right:-8px;
      width:0;
      height:0;
      border-left:8px solid rgba(57,176,255,0.2);
      border-top:8px solid transparent;
      border-bottom:8px solid transparent;
      filter:drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }
    
    .message.assistant{
      background:linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
      color:#9fdcff;
      align-self:flex-start;
      margin-right:auto;
      border-color:rgba(159,220,255,0.3);
    }
    
    .message.assistant::before{
      content:'';
      position:absolute;
      top:16px;
      left:-8px;
      width:0;
      height:0;
      border-right:8px solid rgba(255,255,255,0.12);
      border-top:8px solid transparent;
      border-bottom:8px solid transparent;
      filter:drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }
    
    /* Typing indicator */
    .typing-indicator {
      max-width: 45%;
      padding: 16px 20px;
      border-radius: 20px;
      background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(159,220,255,0.3);
      align-self: flex-start;
      margin-right: auto;
      animation: messageSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      pointer-events: auto;
    }
    
    .typing-dots {
      display: flex;
      gap: 4px;
    }
    
    .typing-dots span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #9fdcff;
      animation: typingDots 1.4s infinite ease-in-out;
    }
    
    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typingDots {
      0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
      40% { opacity: 1; transform: scale(1); }
    }
    
    /* Windows Loading Spinner */
    .windows-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 20px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .windows-spinner.active {
      opacity: 1;
    }
    
    .windows-spinner::before {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      border: 2px solid transparent;
      border-top: 2px solid #39b0ff;
      border-radius: 50%;
      animation: windowsSpin 1s linear infinite;
    }
    
    @keyframes windowsSpin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* subtle glow effect for the canvas container when orb is active */
    .glow{box-shadow:0 8px 40px rgba(57,176,255,0.06) inset, 0 6px 40px rgba(57,176,255,0.06)}
  </style>
</head>
<body>
  <div class="main-layout">
    <div class="label">Runa — Responsive UnrealIRCd Network Agent</div>

    <!-- Chat area -->
    <div class="chat-area" id="chatMessages"></div>

    <div class="input-row">
      <input id="userInput" class="text-input" placeholder="Talk to Runa" />
      <button id="sendBtn" class="send">Send</button>
    </div>
  </div>

  <div class="canvas-wrap glow" id="canvasWrap">
    <canvas id="runaCanvas"></canvas>
    <div class="windows-spinner" id="windowsSpinner"></div>
  </div>

<script>
const canvas = document.getElementById('runaCanvas');
const ctx = canvas.getContext('2d', { alpha: true });
let W, H, DPR;

function resize(){
  DPR = window.devicePixelRatio || 1;
  W = canvas.width = Math.floor(canvas.clientWidth * DPR);
  H = canvas.height = Math.floor(canvas.clientHeight * DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener('resize', resize);
resize();

// Config
const ORB_COLOR = '#6d9ff7';
const ORB_RADIUS = 6;
const TAIL_LENGTH = 75;
const FRICTION = 0.92;

// State machine
let state = 'idle';
let windowsLoadingAngle = 0;
let errorStartTime = 0;
let criticalErrorStartTime = 0;
let transitionStartTime = 0;
let transitionFromColor = ORB_COLOR;
let transitionToColor = ORB_COLOR;
let dvdVelocity = { x: 2, y: 1.5 };
let pipesDirection = { x: 1, y: 0 };
let pipesSpeed = 1.5;
let pipesSegmentLength = 0;
let errorSparks = [];
let networkNodes = [];
let networkDataPackets = [];
let networkHealthPulses = [];
let typewriterOrbs = [];
let fadingTypewriterOrbs = [];
let typewriterState = { cursor: { x: 0, y: 0, visible: true, blinkTime: 0 } };
let typewriterStartTime = 0;
let companionTrails = [[], []];
let companionLastTrailPos = [{x: 0, y: 0}, {x: 0, y: 0}]; 
let networkScanStartTime = 0;
let orb = {
  x: W/2, y: H/2, vx:0, vy:0, ax:0, ay:0, r:ORB_RADIUS, trail:[], color: ORB_COLOR
};

function rand(min,max){return Math.random()*(max-min)+min}
function ease(t){return (--t)*t*t+1} 
function interpolateColor(color1, color2, t) {
  const r1 = parseInt(color1.slice(1, 3), 16);
  const g1 = parseInt(color1.slice(3, 5), 16);
  const b1 = parseInt(color1.slice(5, 7), 16);
  
  const r2 = parseInt(color2.slice(1, 3), 16);
  const g2 = parseInt(color2.slice(3, 5), 16);
  const b2 = parseInt(color2.slice(5, 7), 16);
  
  const r = Math.round(r1 + (r2 - r1) * t);
  const g = Math.round(g1 + (g2 - g1) * t);
  const b = Math.round(b1 + (b2 - b1) * t);
  
  return `rgb(${r}, ${g}, ${b})`;
}

function addTrail(x,y,alpha){
  orb.trail.unshift({x,y,a:alpha});
  if(orb.trail.length>TAIL_LENGTH) orb.trail.pop();
}

let lastTrailX = 0, lastTrailY = 0;
function addTrailPoint(x, y, alpha) {
  const distance = Math.sqrt((x - lastTrailX) ** 2 + (y - lastTrailY) ** 2);
  if (distance > 1.5 || orb.trail.length === 0) {
    addTrail(x, y, alpha);
    lastTrailX = x;
    lastTrailY = y;
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);

  // draw trail
  if(orb.trail.length > 1) {
    ctx.globalCompositeOperation = 'lighter';
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    for(let i = 0; i < orb.trail.length - 1; i++) {
      const p1 = orb.trail[i];
      const p2 = orb.trail[i + 1];
      const t = i / (orb.trail.length - 1);
      
      const alpha = Math.pow(1 - t, 2);
      const thickness = orb.r * 2 * (0.1 + 0.9 * (1 - t));
      
      if(alpha > 0.01) {
        ctx.beginPath();
        ctx.globalAlpha = alpha * 0.8;
        ctx.strokeStyle = orb.color;
        ctx.lineWidth = thickness;
        ctx.moveTo(p2.x, p2.y);
        ctx.lineTo(p1.x, p1.y);
        ctx.stroke();
      }
    }
    ctx.globalAlpha = 1;
  }

  const g = ctx.createRadialGradient(orb.x, orb.y, orb.r*0.4, orb.x, orb.y, orb.r*6);
  g.addColorStop(0, 'rgba(57,176,255,0.22)');
  g.addColorStop(0.6, 'rgba(57,176,255,0.08)');
  g.addColorStop(1, 'rgba(57,176,255,0)');
  
  ctx.globalCompositeOperation = 'source-over';
  ctx.globalAlpha = 1;
  ctx.fillStyle = g;
  ctx.beginPath();
  ctx.arc(orb.x, orb.y, orb.r*6, 0, Math.PI*2);
  ctx.fill();

  ctx.beginPath();
  ctx.globalCompositeOperation = 'lighter';
  ctx.fillStyle = orb.color;
  ctx.globalAlpha = 1;
  ctx.arc(orb.x, orb.y, orb.r, 0, Math.PI*2);
  ctx.fill();

  ctx.beginPath();
  ctx.globalCompositeOperation = 'screen';
  ctx.globalAlpha = 0.9;
  ctx.fillStyle = 'rgba(255,255,255,0.9)';
  ctx.arc(orb.x - orb.r*0.35, orb.y - orb.r*0.35, orb.r*0.28, 0, Math.PI*2);
  ctx.fill();

  ctx.globalAlpha = 1;
}

let tick = 0;
function update(dt){
  tick += dt;
  orb.x += orb.vx;
  orb.y += orb.vy;
  orb.vx *= FRICTION;
  orb.vy *= FRICTION;

  orb.x = Math.max(18, Math.min(canvas.clientWidth-18, orb.x));
  orb.y = Math.max(18, Math.min(canvas.clientHeight-18, orb.y));
  
  addTrailPoint(orb.x, orb.y, 0.55);
}

let last = performance.now();
function loop(now){
  const dt = now - last;
  last = now;
  
  update(dt);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

const N8N_ENDPOINT = 'http://mita:5678/webhook/afa2b548-acd5-4157-bc51-3fc77548017e/chat';
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const chatMessages = document.getElementById('chatMessages');

function scrollToBottom() {
  requestAnimationFrame(() => {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  });
}

function parseMarkdown(text) {
  return text
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/__(.*?)__/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/_(.*?)_/g, '<em>$1</em>')
    .replace(/`(.*?)`/g, '<code style="background:rgba(255,255,255,0.1);padding:2px 4px;border-radius:3px;font-family:monospace;">$1</code>')
    .replace(/\n/g, '<br>')
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" style="color:#6d9ff7;text-decoration:underline;" target="_blank">$1</a>');
}

function setMessageContent(element, content) {
  const sanitizedContent = content
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;');
  
  element.innerHTML = parseMarkdown(sanitizedContent);
}

function addMessage(content, isUser = false) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
  
  setMessageContent(messageDiv, content);
  chatMessages.appendChild(messageDiv);
  
  scrollToBottom();
}

sendBtn.addEventListener('click', async ()=>{
  const text = userInput.value.trim();
  if(!text) return;
  
  addMessage(text, true);
  userInput.value = '';
  
  // Show typing indicator and simulate processing
  addMessage("Thinking...", false);
  await new Promise(resolve => setTimeout(resolve, 1000));

  // If N8N_ENDPOINT is configured, POST user input
  if(N8N_ENDPOINT){
    try{
      // Basic response simulation
      const response = await fetch(N8N_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({text})
      });
      const responseData = await response.json();
      addMessage(responseData.output, false);
    }catch(e){
      addMessage('Error: Could not connect to API.', false);
    }
  }
});

// start idle
setState('idle');

// initial placement
orb.x = canvas.clientWidth/2;
orb.y = canvas.clientHeight/2 - 10;
addTrailPoint(orb.x, orb.y, 0.9);
</script>
</body>
</html>
