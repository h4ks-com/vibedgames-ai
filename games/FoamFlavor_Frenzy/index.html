<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FoamFlavor Frenzy - Deluxe</title>
  <style>
    :root{
      --bg: #0f0f1a;
      --card: #141726;
      --panel: rgba(20,20,40,.95);
      --text: #f5f5f5;
      --muted: #c9c9d6;
      --accent: #6bd3ff;
      --spot: #ffffff;
      --shadow: 0 8px 26px rgba(0,0,0,.28);
      --glow: 0 0 14px rgba(107,211,255,.8);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color: var(--text);
      background: radial-gradient(circle at 20% -10%, rgba(255,255,255,.08), transparent 40%), 
                  radial-gradient(circle at 100% 0%, rgba(0,0,0,.25), transparent 40%), 
                  linear-gradient(135deg, #0e0b1a 0%, #0b0a1a 60%, #0a0d1a 100%), #0a0a0a;
      background-attachment: fixed;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 18px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.15);
      box-shadow: var(--shadow);
      position: sticky;
      top: 8px;
      z-index: 10;
      backdrop-filter: blur(4px);
    }
    .brand {
      display: flex; align-items: center; gap: 12px;
    }
    .brand .logo {
      width: 42px; height: 42px; border-radius: 12px;
      background: conic-gradient(from 180deg at 50% 50%, #ff5b9e, #ffd166, #6bd3ff, #8cffcb);
      box-shadow: inset 0 0 12px rgba(255,255,255,.6);
    }
    h1 { font-size: 1.15rem; margin: 0; letter-spacing: .4px; }
    .subtitle { color: var(--muted); font-size: .88rem; }

    .badge {
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      background: rgba(0,0,0,.25); color:#fff; font-weight:700;
    }

    main {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 18px;
      align-items: start;
      padding: 20px 0 60px;
    }

    .panel {
      background: linear-gradient(180deg, rgba(20,20,40,.92), rgba(20,20,40,.86));
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow);
      min-height: 520px;
      display: flex; flex-direction: column; gap: 14px;
      position: relative;
      overflow: hidden;
    }
    .title {
      font-size: 1.25rem; font-weight: 700; letter-spacing: .4px;
      display: flex; align-items: center; gap: 8px;
    }
    .subtitle { color: var(--muted); font-size: .95rem; }

    .colorCard {
      height: 200px; border-radius: 14px;
      display: grid; place-items: center;
      position: relative; overflow: hidden;
      border: 1px solid rgba(255,255,255,.25);
      background: #222;
      isolation: isolate;
      box-shadow: inset 0 0 40px rgba(255,255,255,.05);
    }
    .colorInner {
      width: 110px; height: 110px; border-radius: 50%;
      box-shadow: 0 6px 26px rgba(0,0,0,.6);
      border: 6px solid rgba(255,255,255,.8);
      background: #fff;
      position: relative;
      z-index: 2;
      transform: scale(1);
      transition: transform .25s ease;
    }
    .colorGlow {
      position:absolute; inset:0; border-radius: 50%;
      box-shadow: 0 0 40px 14px rgba(107,211,255,.25);
      filter: saturate(120%);
      pointer-events: none;
      animation: glowPulse 2s infinite;
      opacity:.9;
    }
    @keyframes glowPulse {
      0% { box-shadow: 0 0 20px 8px rgba(107,211,255,.18); opacity:.8; }
      50% { box-shadow: 0 0 40px 18px rgba(107,211,255,.5); opacity:1; }
      100% { box-shadow: 0 0 20px 8px rgba(107,211,255,.18); opacity:.8; }
    }

    .prompt { font-size: 1.02rem; font-weight: 600; }
    .hint { font-size: .95rem; color: #f2e; opacity: .92; }
    .grid {
      display: grid; grid-template-columns: repeat(2, 1fr);
      gap: 12px; margin-top: 8px;
    }
    .option {
      padding: 14px 14px;
      font-size: 1rem;
      border-radius: 12px;
      border: 2px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.08);
      color: #fff;
      cursor: pointer;
      text-align: left;
      min-height: 56px;
      display: flex; align-items: center;
      gap: 8px;
      transition: transform .08s ease, background .2s ease, border-color .2s;
    }
    .option:hover { transform: translateY(-1px); background: rgba(255,255,255,.14); }
    .option:focus { outline: 3px solid #fff; }
    .option.correct { background: rgba(34, 197, 94, .9); border-color: rgba(0,0,0,.2); }
    .option.wrong { background: rgba(239,68,68,.92); border-color: rgba(0,0,0,.2); }

    .feedback {
      font-size: 1rem; font-weight: 700;
      padding: 8px 12px; border-radius: 8px;
      display: inline-flex; align-items: center; gap: 8px;
      opacity: .95;
    }
    .celebrate {
      animation: pop 0.6s ease;
      color: #fff;
    }
    @keyframes pop {
      0% { transform: scale(0.9); opacity: .0; }
      60% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    aside.card {
      padding: 16px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.15);
      height: fit-content;
      position: sticky; top: 12px;
    }

    .btn {
      padding: 12px 14px; border-radius: 10px; border: 0;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: #00100a; font-weight: 800; cursor: pointer;
      box-shadow: 0 6px 14px rgba(0,0,0,.25);
      transition: transform .08s ease;
    }
    .btn.secondary {
      background: rgba(255,255,255,.1); color: #fff; border: 1px solid rgba(255,255,255,.3);
      font-weight: 700;
    }
    .btn:active { transform: translateY(1px) scale(0.99); }

    .hintTag {
      display:inline-flex; align-items: center; gap: 6px;
      padding: 6px 10px; border-radius: 999px;
      background: rgba(0,0,0,.25); color: #fff; font-weight: 700;
    }

    .footerNote { font-size: .8rem; color: var(--muted); text-align: center; margin-top: 6px; }

    @media (max-width: 860px){
      main { grid-template-columns: 1fr; }
    }

    /* Settings modal */
    .modal {
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: rgba(0,0,0,.55); z-index: 50;
    }
    .modal.active { display: flex; }
    .modalPanel {
      width: min(90%, 520px); background: #101228; border-radius: 14px;
      padding: 20px; border: 1px solid rgba(255,255,255,.25);
      box-shadow: 0 20px 40px rgba(0,0,0,.5);
    }
    .modal h3 { margin: 0 0 8px; }
    .row { display:flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,.08); }
    .toggle { appearance: none; width: 48px; height: 26px; border-radius: 999px; position: relative; background: #555; cursor: pointer; outline: none; }
    .toggle:after { content: ''; width: 22px; height: 22px; background: #fff; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: transform .2s ease; }
    .toggle:checked { background: #4cd37f; }
    .toggle:checked:after { transform: translateX(22px); }

    /* Confetti canvas overlay */
    #confettiCanvas {
      position: fixed; pointer-events: none; left: 0; top: 0;
      width: 100%; height: 100%; z-index: 40;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header aria-label="FoamFlavor Frenzy header">
      <div class="brand">
        <div class="logo" aria-label="FoamFlavor Frenzy logo"></div>
        <div>
          <h1>FoamFlavor Frenzy - Deluxe</h1>
          <div class="subtitle" style="font-size:.85rem; color:#d9d9d9;">Guess the foam flavor by its color. 40 flavors. 10 rounds per game. Deluxe edition with power-ups and visuals.</div>
        </div>
      </div>
      <div class="badge" id="badgeSettings" role="button" aria-label="Open settings">âš™ Settings</div>
      <div class="badge" aria-label="High score" id="badgeScore">High: 0</div>
    </header>

    <main>
      <section class="panel" id="gamePanel" aria-label="Flavor guessing panel">
        <div class="title" id="panelTitle">
          ðŸŽˆ Guess the Foam Flavor
          <span class="hintTag" id="hintBadge" hidden>Hint available</span>
        </div>

        <div class="colorCard" aria-label="Flavor color prompt" id="colorCard">
          <div class="colorGlow" id="colorGlow" aria-hidden="true"></div>
          <div class="colorInner" id="colorBall" aria-label="Flavor color circle"></div>
        </div>

        <div class="prompt" id="promptText" aria-live="polite">
          Which flavor matches this color?
        </div>

        <div class="hint" id="hintText" aria-live="polite" hidden>Hint: First letter is <strong id="hintLetter"></strong></div>

        <div class="grid" id="optionsGrid" aria-label="Flavor options grid">
          <!-- Buttons generated dynamically -->
        </div>

        <div style="display:flex; gap:10px; align-items:center; margin-top: 6px;">
          <button class="btn" id="btnHint" aria-label="Use hint (costs points)">Hint (-15)</button>
          <button class="btn secondary" id="btnSkip" aria-label="Skip round">Skip Round</button>
        </div>

        <div id="feedback" class="feedback" aria-live="polite" style="margin-top:8px; visibility:hidden;"></div>

        <div style="margin-top:auto; display:flex; align-items:center; gap:12px;">
          <span class="subtitle" style="color: #9bd4ff;">Tip: press 1-4 to guess. Space to skip. H to toggle hint.</span>
        </div>
      </section>

      <aside class="card" aria-label="Progress and details" style="align-self: start;">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
          <strong>Progress</strong>
          <span id="progressRound" class="hintTag" aria-label="Round progress">Round 1 / 10</span>
        </div>
        <div id="progressLog" style="font-family: ui-monospace, SFMono-Regular, monospace; font-size:.9rem; color:#e7e7e7; height: 180px; overflow:auto; padding-right:6px;">
          <!-- quick log of rounds -->
        </div>
        <hr style="border:0; height:1px; background: rgba(255,255,255,.15); margin:8px 0;" />
        <div style="display:flex; gap:8px; flex-wrap: wrap;">
          <button class="btn secondary" id="btnRestart" aria-label="Restart game">Restart</button>
          <button class="btn secondary" id="btnInfo" aria-label="Show how to play">How to play</button>
          <button class="btn secondary" id="btnShare" aria-label="Share score">Share</button>
        </div>
        <p class="footerNote" id="footerNote" style="margin-top:8px;">
          Accessibility: large tappable targets, high contrast colors, and keyboard shortcuts (1-4, H, Space).
        </p>
      </aside>
    </main>
  </div>

  <canvas id="confettiCanvas" aria-label="Confetti overlay"></canvas>

  <!-- Settings modal -->
  <div class="modal" id="settingsModal" aria-hidden="true" role="dialog" aria-label="Settings dialog">
    <div class="modalPanel">
      <h3>Game Settings</h3>
      <div class="row">
        <span>Difficulty</span>
        <select id="selDifficulty" style="padding:6px 8px; border-radius:6px; background:#111; color:#fff;">
          <option value="easy">Easy (8 rounds)</option>
          <option value="normal" selected>Normal (10 rounds)</option>
          <option value="hard">Hard (12 rounds)</option>
        </select>
      </div>
      <div class="row">
        <span>Show Hint</span>
        <input type="checkbox" id="chkShowHint" checked style="transform: translateY(2px);" />
      </div>
      <div class="row">
        <span>Sound</span>
        <input type="checkbox" id="chkSound" checked style="transform: translateY(2px);" />
      </div>
      <div class="row">
        <span>Neon Glow on Color Ball</span>
        <input type="checkbox" id="chkNeon" checked style="transform: translateY(2px);" />
      </div>
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:12px;">
        <button class="btn secondary" id="btnSettingsClose" aria-label="Close settings">Close</button>
        <button class="btn" id="btnSettingsSave" aria-label="Save settings">Save</button>
      </div>
    </div>
  </div>

  <script>
    // Flavor data (40 flavors)
    const FLAVORS = [
      {id:1, name:"Vanilla Cloud", color:"#F3E5AB"},
      {id:2, name:"Chocolate Thunder", color:"#8B5E3C"},
      {id:3, name:"Strawberry Swirl", color:"#FF6384"},
      {id:4, name:"Minty Mirage", color:"#2ECC71"},
      {id:5, name:"Mango Tango", color:"#FFC107"},
      {id:6, name:"Blueberry Burst", color:"#4A90E2"},
      {id:7, name:"Cookies & Cream", color:"#DADADA"},
      {id:8, name:"Caramel Crunch", color:"#C27D36"},
      {id:9, name:"Pistachio Paradise", color:"#7BAF7A"},
      {id:10, name:"Coffee Latte", color:"#795548"},
      {id:11, name:"Salted Caramel Sea", color:"#A05A2C"},
      {id:12, name:"Raspberry Ripple", color:"#E21C6D"},
      {id:13, name:"Lemon Zest", color:"#FFD54F"},
      {id:14, name:"Coconut Cream", color:"#FFF5E1"},
      {id:15, name:"Bubblegum Pop", color:"#FF4D8A"},
      {id:16, name:"Banana Blast", color:"#F6C343"},
      {id:17, name:"Blackberry Bliss", color:"#8A2BE2"},
      {id:18, name:"Cocoa Caramel Swirl", color:"#7A3B2F"},
      {id:19, name:"Cherry Jubilee", color:"#D01C1F"},
      {id:20, name:"Pistachio Praline", color:"#98E063"},
      {id:21, name:"Hazelnut Heaven", color:"#654321"},
      {id:22, name:"Peach Passion", color:"#FFDAB9"},
      {id:23, name:"Pineapple Pop", color:"#FFD166"},
      {id:24, name:"Kiwi Kick", color:"#9ACD32"},
      {id:25, name:"Watermelon Wave", color:"#FC5A8D"},
      {id:26, name:"Green Tea Glow", color:"#3CB371"},
      {id:27, name:"Lavender Dream", color:"#B49DFF"},
      {id:28, name:"Cotton Candy Cloud", color:"#F8BBD0"},
      {id:29, name:"Almond Amaretto", color:"#D2B48C"},
      {id:30, name:"Strawberry Banana Cream", color:"#FF7A9D"},
      {id:31, name:"Mango Mystery", color:"#FF9933"},
      {id:32, name:"Galaxy Grape", color:"#6A5ACD"},
      {id:33, name:"Lavender Lemonade", color:"#D8B4FF"},
      {id:34, name:"Honeycomb Twist", color:"#E4A017"},
      {id:35, name:"Orange Sunrise", color:"#FF8C00"},
      {id:36, name:"Raspberry Lemonade", color:"#FF6347"},
      {id:37, name:"Vanilla Caramel Crunch", color:"#E3D0B6"},
      {id:38, name:"Pineapple Coconut Breeze", color:"#FFE87C"},
      {id:39, name:"Strawberry Kiwi Fizz", color:"#FF385C"},
      {id:40, name:"Maple Walnut Swirl", color:"#8D6E63"}
    ];

    // Game state
    const TOTAL_ROUNDS_DEFAULT = 10;
    const STORAGE_KEY_PROGRESS = "ff_deluxe_progress_v1";
    const STORAGE_KEY_SETTINGS = "ff_deluxe_settings_v1";

    let currentRoundIndex = 0;
    let currentTarget = null;
    let currentOptions = [];
    let roundStartTime = 0;
    let score = 0;
    let hintsUsedThisRound = false;
    let audioCtx = null;
    let soundEnabled = true;
    let neonEnabled = true;
    let showHintOption = true;
    let difficulty = "normal"; // easy, normal, hard
    let totalRounds = TOTAL_ROUNDS_DEFAULT;

    // Progress / stats
    let progress = {
      highScore: 0,
      gamesPlayed: 0,
      totalScore: 0
    };

    // UI elements
    const statScore     = document.getElementById("badgeScore");
    const badgeSettings = document.getElementById("badgeSettings");
    const progressRound = document.getElementById("progressRound");
    const colorCard     = document.getElementById("colorCard");
    const colorBall     = document.getElementById("colorBall");
    const colorGlow     = document.getElementById("colorGlow");
    const promptText    = document.getElementById("promptText");
    const hintText      = document.getElementById("hintText");
    const hintLetter    = document.getElementById("hintLetter");
    const hintBadge     = document.getElementById("hintBadge");
    const optionsGrid   = document.getElementById("optionsGrid");
    const feedbackDiv   = document.getElementById("feedback");
    const btnHint       = document.getElementById("btnHint");
    const btnSkip       = document.getElementById("btnSkip");
    const progressLog   = document.getElementById("progressLog");
    const btnRestart    = document.getElementById("btnRestart");
    const btnInfo       = document.getElementById("btnInfo");
    const btnShare      = document.getElementById("btnShare");
    const footerNote    = document.getElementById("footerNote");

    // Settings modal
    const settingsModal = document.getElementById("settingsModal");
    const btnSettingsSave = document.getElementById("btnSettingsSave");
    const btnSettingsClose = document.getElementById("btnSettingsClose");
    const selDifficulty = document.getElementById("selDifficulty");
    const chkShowHint = document.getElementById("chkShowHint");
    const chkSound = document.getElementById("chkSound");
    const chkNeon = document.getElementById("chkNeon");

    // Init
    function init() {
      loadProgress();
      loadSettings();
      attachEventHandlers();
      updateHeader();
      logProgress("Welcome! FoamFlavor Frenzy Deluxe loaded.");
      startGame(false);
    }

    function attachEventHandlers() {
      // Keyboard shortcuts
      window.addEventListener("keydown", (e) => {
        if (settingsModal.classList.contains("active")) {
          // ignore shortcuts when settings open
          return;
        }
        if (e.key >= "1" && e.key <= "4") {
          const idx = parseInt(e.key) - 1;
          handleChoice(idx);
        } else if (e.key === " ") {
          e.preventDefault();
          nextRound(true); // space to skip
        } else if (e.key.toLowerCase() === "h") {
          if (showHintOption) useHint();
        } else if (e.key.toLowerCase() === "s") {
          toggleSound();
        } else if (e.key.toLowerCase() === "m") {
          toggleNeon();
        } else if (e.key === "Escape") {
          // close hint
          hintText.style.visibility = "hidden";
        }
      });

      badgeSettings.addEventListener("click", () => openSettings());
      btnHint.addEventListener("click", () => useHint());
      btnSkip.addEventListener("click", () => nextRound(false));
      btnRestart.addEventListener("click", () => startGame(true));
      btnInfo.addEventListener("click", () => logProgress("How to play: Guess the flavor by color. Use 1-4 to answer. Hint costs 15 points. Difficulty alters rounds."));
      btnShare.addEventListener("click", () => shareScore());

      btnSettingsSave.addEventListener("click", () => saveSettingsAndClose());
      btnSettingsClose.addEventListener("click", () => closeSettings());

      // start confetti on first correct? We'll handle later
    }

    function updateHeader() {
      statScore.textContent = `High Score: ${Math.max(progress.highScore, score)}`;
      progressRound.textContent = `Round ${Math.min(currentRoundIndex+1, totalRounds)} / ${totalRounds}`;
      colorCard.setAttribute("aria-label", "Flavor color prompt");
    }

    function loadProgress() {
      const saved = localStorage.getItem(STORAGE_KEY_PROGRESS);
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          progress = Object.assign(progress, parsed);
        } catch (e) {
          console.warn("Failed to parse saved progress.", e);
        }
      }
      updateHeader();
    }

    function saveProgress() {
      localStorage.setItem(STORAGE_KEY_PROGRESS, JSON.stringify(progress));
      updateHeader();
    }

    function loadSettings() {
      const s = localStorage.getItem(STORAGE_KEY_SETTINGS);
      if (s) {
        try {
          const p = JSON.parse(s);
          difficulty = p.difficulty || difficulty;
          showHintOption = p.showHint != null ? p.showHint : showHintOption;
          soundEnabled = p.sound != null ? p.sound : soundEnabled;
          neonEnabled = p.neon != null ? p.neon : neonEnabled;
          // apply
          totalRounds = (difficulty === "easy" ? 8 : difficulty === "hard" ? 12 : 10);
          selDifficulty?.value && (selDifficulty.value = difficulty);
          chkShowHint.checked = !!showHintOption;
          chkSound.checked = !!soundEnabled;
          chkNeon.checked = !!neonEnabled;
        } catch (e) {
          console.warn("Could not parse settings.", e);
        }
      }
      // apply to UI
      applyVisuals();
    }

    function saveSettingsAndClose() {
      const newSettings = {
        difficulty: selDifficulty.value,
        showHint: chkShowHint.checked,
        sound: chkSound.checked,
        neon: chkNeon.checked
      };
      localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(newSettings));
      // apply
      difficulty = newSettings.difficulty;
      showHintOption = newSettings.showHint;
      soundEnabled = newSettings.sound;
      neonEnabled = newSettings.neon;
      totalRounds = (difficulty === "easy" ? 8 : difficulty === "hard" ? 12 : 10);
      closeSettings();
      // restart round with new settings
      logProgress("Settings updated. Restarting game with new difficulty.");
      startGame(true);
    }

    function openSettings() {
      // set current UI states
      selDifficulty.value = difficulty;
      chkShowHint.checked = showHintOption;
      chkSound.checked = soundEnabled;
      chkNeon.checked = neonEnabled;
      settingsModal.classList.add("active");
      settingsModal.setAttribute("aria-hidden", "false");
    }

    function closeSettings() {
      settingsModal.classList.remove("active");
      settingsModal.setAttribute("aria-hidden", "true");
    }

    function applyVisuals() {
      // neon toggles glow
      if (!neonEnabled) {
        colorBall.style.boxShadow = "none";
      } else {
        colorBall.style.boxShadow = "0 0 0 rgba(0,0,0,0)";
      }
      // hint visibility
      hintBadge.hidden = showHintOption ? false : true;
    }

    function startGame(reset=false) {
      score = 0;
      currentRoundIndex = 0;
      hintsUsedThisRound = false;
      if (reset) {
        progress.gamesPlayed = 0;
        progress.totalScore = 0;
        progress.highScore = 0;
        saveProgress();
      }
      // à¹‚à¸«à¸¥à¸”
      nextRound();
      updateHeader();
      logProgress("New game started.");
    }

    function nextRound(skip=false) {
      currentRoundIndex++;
      if (currentRoundIndex > totalRounds) {
        endGame();
        return;
      }
      hintsUsedThisRound = false;
      // generate round
      generateRound();
      renderRoundUI();
      roundStartTime = Date.now();
      hintBadge.hidden = showHintOption ? false : true;
      hintText.style.visibility = "hidden";
      hintLetter.textContent = "";
      hintText.innerHTML = "";
      feedbackDiv.style.visibility = "hidden";
      // reset option styles
      optionsGrid.querySelectorAll(".option").forEach(btn => {
        btn.classList.remove("correct","wrong");
        btn.style.pointerEvents = "auto";
      });
      logProgress(`Round ${currentRoundIndex} started.`);
      updateHeader();
    }

    function endGame() {
      renderEndScreen();
      progress.gamesPlayed += 1;
      progress.totalScore += score;
      if (score > progress.highScore) progress.highScore = score;
      saveProgress();
      logProgress(`Game finished. Final score: ${score}.`);
    }

    function renderEndScreen() {
      optionsGrid.innerHTML = "";
      const summary = document.createElement("div");
      summary.style.padding = "12px";
      summary.style.borderRadius = "10px";
      summary.style.background = "rgba(0,0,0,.25)";
      summary.style.textAlign = "center";
      summary.innerHTML = `
        <div style="font-size:1.2rem; font-weight:700; margin-bottom:6px;">Game Over</div>
        <div>Final Score: <strong>${score}</strong></div>
        <div>Rounds Completed: ${totalRounds} / ${totalRounds}</div>
        <div style="margin-top:8px;">
          <button class="btn" id="btnPlayAgain" aria-label="Play again">Play Again</button>
        </div>
      `;
      const panel = document.getElementById("gamePanel");
      panel.appendChild(summary);
      const btnPlayAgain = document.getElementById("btnPlayAgain");
      btnPlayAgain.addEventListener("click", () => {
        // remove summary
        summary.remove();
        startGame(true);
      });
      // confetti on end
      triggerConfetti(120);
    }

    function renderRoundUI() {
      // set color ball to target
      colorBall.style.background = currentTarget.color;
      // apply neon glow
      if (neonEnabled) {
        colorGlow.style.display = "block";
        colorGlow.style.background = currentTarget.color;
      } else {
        colorGlow.style.display = "none";
      }
      // update prompt
      promptText.textContent = "Which flavor matches this color?";
      // ensure hint
      hintBadge.hidden = showHintOption ? false : true;
      // options
      optionsGrid.innerHTML = "";
      currentOptions.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.className = "option";
        btn.setAttribute("aria-label", "Option " + (idx+1) + ": " + opt.name);
        btn.innerHTML = `<span class="idx">${idx+1}.</span>${opt.name}`;
        btn.addEventListener("click", () => handleChoice(idx));
        btn.style.borderColor = "rgba(255,255,255,.25)";
        optionsGrid.appendChild(btn);
      });
      // focus first
      const firstBtn = optionsGrid.querySelector(".option");
      firstBtn?.focus();
      logProgress(`Target flavor: color ${currentTarget.color} selected.`);
      // Update
      updateHeader();
    }

    function generateRound() {
      // pick random target
      const idxTarget = Math.floor(Math.random() * FLAVORS.length);
      currentTarget = FLAVORS[idxTarget];
      // ensure 3 distractors + target
      const indices = new Set([idxTarget]);
      while (indices.size < 4) {
        indices.add(Math.floor(Math.random() * FLAVORS.length));
      }
      currentOptions = Array.from(indices).map(i => FLAVORS[i]);
      // ensure target included
      if (!currentOptions.find(o => o.id === currentTarget.id)) {
        currentOptions[0] = currentTarget;
      }
      shuffleArray(currentOptions);
    }

    function shuffleArray(arr) {
      for (let i = arr.length -1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    function handleChoice(index) {
      // ignore if already answered
      if (feedbackDiv.style.visibility === "visible") return;
      const chosen = currentOptions[index];
      const isCorrect = chosen.id === currentTarget.id;
      const timeElapsed = (Date.now() - roundStartTime)/1000;
      let delta = 0;
      if (isCorrect) {
        delta = Math.max(10, Math.round(100 - timeElapsed * 8));
        score += delta;
        feedbackDiv.textContent = `Correct! +${delta} points (${timeElapsed.toFixed(1)}s)`;
        feedbackDiv.style.background = "rgba(34, 197, 94, .9)";
        feedbackDiv.classList.add("celebrate");
      } else {
        delta = 0;
        feedbackDiv.textContent = `Oops! It was "${currentTarget.name}".`;
        feedbackDiv.style.background = "rgba(239,68,68,.92)";
        feedbackDiv.classList.remove("celebrate");
      }
      feedbackDiv.style.color = "#fff";
      feedbackDiv.style.padding = "8px 12px";
      feedbackDiv.style.borderRadius = "8px";
      feedbackDiv.style.visibility = "visible";

      // disable choices
      optionsGrid.querySelectorAll(".option").forEach(btn => btn.style.pointerEvents = "none");

      // highlight
      optionsGrid.querySelectorAll(".option").forEach((btn, idx) => {
        const opt = currentOptions[idx];
        if (opt.id === currentTarget.id) {
          btn.classList.add(isCorrect ? "correct" : "wrong");
        } else if (idx === index) {
          btn.classList.add(isCorrect ? "" : "wrong");
        }
      });

      // sound
      playFeedbackSound(isCorrect);

      // hint effects
      if (isCorrect) {
        triggerConfetti(90);
      }

      // save
      saveProgress();

      // next round after delay
      setTimeout(() => {
        feedbackDiv.style.visibility = "hidden";
        if (currentRoundIndex >= totalRounds) {
          endGame();
        } else {
          nextRound(false);
        }
      }, 900);

      updateHeader();
      if (score > progress.highScore) {
        progress.highScore = score;
        statScore.textContent = `High Score: ${Math.max(progress.highScore, score)}`;
      }
    }

    function useHint() {
      if (!showHintOption) return;
      if (hintText.style.visibility === "visible") return;
      const firstLetter = currentTarget.name.charAt(0).toUpperCase();
      hintLetter.textContent = firstLetter;
      hintText.style.display = "block";
      hintText.style.visibility = "visible";
      hintText.innerHTML = `Hint: First letter is <strong>${firstLetter}</strong>`;
      const penalty = 15;
      score = Math.max(0, score - penalty);
      hintsUsedThisRound = true;
      renderInfoLine(`Hint used: first letter "${firstLetter}" -${penalty} points.`);
      // animation
      hintLetter.style.transition = "transform .2s ease";
      hintLetter.style.transform = "scale(1.3)";
      setTimeout(() => { hintLetter.style.transform = "scale(1)"; }, 250);
      updateHeader();
      playTone(520, 0.08);
    }

    function renderInfoLine(text) {
      const el = document.createElement("div");
      el.style.color = "#aee8ff";
      el.style.fontSize = ".9rem";
      el.style.opacity = ".95";
      el.style.marginTop = "6px";
      el.textContent = text;
      colorCard.appendChild(el);
      setTimeout(() => el.remove(), 2000);
    }

    function logProgress(text) {
      const div = document.createElement("div");
      div.textContent = text;
      progressLog.prepend(div);
      if (progressLog.childNodes.length > 200) {
        progressLog.removeChild(progressLog.lastChild);
      }
    }

    // Audio
    function ensureAudio() {
      if (!audioCtx) {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        audioCtx = ctx;
      }
    }
    function playTone(freq, duration=0.12, type="sine") {
      if (!soundEnabled) return;
      ensureAudio();
      const ctx = audioCtx;
      const osc = ctx.createOscillator();
      const g = ctx.createGain();
      osc.frequency.value = freq;
      osc.type = type;
      osc.connect(g);
      g.connect(ctx.destination);
      const now = ctx.currentTime;
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.3, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now + duration);
      osc.start(now);
      osc.stop(now + duration + 0.02);
    }
    function playFeedbackSound(isCorrect) {
      ensureAudio();
      if (isCorrect) {
        playTone(660, 0.12, "sine");
        setTimeout(() => playTone(880, 0.12, "triangle"), 60);
      } else {
        playTone(260, 0.18, "sine");
      }
    }

    // confetti
    function triggerConfetti(count) {
      const canvas = document.getElementById("confettiCanvas");
      const ctx = canvas.getContext("2d");
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      canvas.width = innerWidth * dpr;
      canvas.height = innerHeight * dpr;
      ctx.scale(dpr, dpr);
      const particles = [];
      const colors = ["#FF5B9E","#FFD166","#6BD3FF","#8AFFA0","#C27D36","#A05A2C"];
      for (let i = 0; i < count; i++) {
        particles.push({
          x: Math.random() * innerWidth,
          y: -20 - Math.random() * 20,
          vx: (Math.random() - 0.5) * 6,
          vy: Math.random() * 4 + 1,
          size: Math.random() * 6 + 6,
          color: colors[Math.floor(Math.random() * colors.length)],
          ttl: Math.random() * 60 + 60,
          rot: Math.random() * Math.PI * 2,
          vr: (Math.random() - 0.5) * 0.2
        });
      }
      let t = 0;
      const animate = () => {
        ctx.clearRect(0,0, innerWidth, innerHeight);
        t++;
        particles.forEach(p => {
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.04;
          p.rot += p.vr;
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
          ctx.restore();
        });
        particles.forEach((p, idx) => {
          if (p.y > innerHeight + 20) particles.splice(idx, 1);
        });
        if (particles.length > 0) requestAnimationFrame(animate);
        else {
          ctx.clearRect(0,0, innerWidth, innerHeight);
        }
      };
      animate();
      // cleanup after short time
      setTimeout(() => { ctx.clearRect(0,0, innerWidth, innerHeight); }, 1500);
    }

    // Utilities
    function shareScore() {
      const text = `FoamFlavor Frenzy Deluxe: Score ${score} in Round ${currentRoundIndex}/${totalRounds}! Can you beat me?`;
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          logProgress("Score copied to clipboard!");
        }).catch(() => logProgress("Unable to copy to clipboard."));
      } else {
        logProgress("Clipboard API not available.");
      }
    }

    // Init
    let initOnce = false;
    function bootstrap() {
      if (initOnce) return;
      initOnce = true;
      init();
      // glow loop to vibe
      const glow = document.getElementById("colorGlow");
      setInterval(() => {
        if (neonEnabled) {
          glow.style.opacity = (glow.style.opacity === "0.95" ? "0.75" : "0.95");
        }
      }, 600);
    }

    // Start
    bootstrap();

  </script>
</body>
</html>